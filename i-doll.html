<!DOCTYPE html>
<html>
<!--
Copyright 2010 by Dan Fabulich.

Dan Fabulich licenses this file to you under the
ChoiceScript License, Version 1.0 (the "License"); you may
not use this file except in compliance with the License. 
You may obtain a copy of the License at

 http://www.choiceofgames.com/LICENSE-1.0.txt

See the License for the specific language governing
permissions and limitations under the License.

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
either express or implied.
-->
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name = "viewport" content = "width = device-width, initial-scale = 1.0, maximum-scale = 1.0">
<!-- INSERT correct meta values -->
<!-- <title>Multiple Choice Example Game | My First ChoiceScript Game</title> -->

<script>window.version="UNKNOWN"</script>





<style id="dynamic"></style>





<!--[if IE 6]><style>.alertify-logs { position: absolute; }</style><![endif]-->
<meta name="apple-mobile-web-app-capable" content="yes" />
<script>
// INSERT store name; disabled by default because it's confusing for newbie authors
window.storeName = null;
//Scene.generatedFast = true;
var rootDir = "../";
</script>
<meta charset='UTF-8'>
<script>//
// Copyright (c) 2008, 2009 Paul Duncan (paul@pablotron.org)
// 
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
// 
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
//


/* 
 * The contents of gears_init.js; we need this because Chrome supports
 * Gears out of the box, but still requires this constructor.  Note that
 * if you include gears_init.js then this function does nothing.
 */
(function() {
  // We are already defined. Hooray!
  if (window.google && google.gears)
    return;

  // factory 
  var F = null;

  // Firefox
  if (typeof GearsFactory != 'undefined') {
    F = new GearsFactory();
  } else {
    // IE
    try {
      F = new ActiveXObject('Gears.Factory');
      // privateSetGlobalObject is only required and supported on WinCE.
      if (F.getBuildInfo().indexOf('ie_mobile') != -1)
        F.privateSetGlobalObject(this);
    } catch (e) {
      // Safari
      if ((typeof navigator.mimeTypes != 'undefined')
           && navigator.mimeTypes["application/x-googlegears"]) {
        F = document.createElement("object");
        F.style.display = "none";
        F.width = 0;
        F.height = 0;
        F.type = "application/x-googlegears";
        document.documentElement.appendChild(F);
      }
    }
  }

  // *Do not* define any objects if Gears is not installed. This mimics the
  // behavior of Gears defining the objects in the future.
  if (!F)
    return;

  // Now set up the objects, being careful not to overwrite anything.
  //
  // Note: In Internet Explorer for Windows Mobile, you can't add properties to
  // the window object. However, global objects are automatically added as
  // properties of the window object in all browsers.
  if (!window.google)
    google = {};

  if (!google.gears)
    google.gears = {factory: F};
})();

/**
 * Persist - top-level namespace for Persist library.
 * @namespace
 */
Persist = (function() {
  var VERSION = '0.2.0', P, B, esc, init, empty, ec;

  // easycookie 0.2.1 (pre-minified)
  // (see http://pablotron.org/software/easy_cookie/)
  ec = (function(){var EPOCH='Thu, 01-Jan-1970 00:00:01 GMT',RATIO=1000*60*60*24,KEYS=['expires','path','domain'],esc=escape,un=unescape,doc=document,me;var get_now=function(){var r=new Date();r.setTime(r.getTime());return r;}
var cookify=function(c_key,c_val){var i,key,val,r=[],opt=(arguments.length>2)?arguments[2]:{};r.push(esc(c_key)+'='+esc(c_val));for(i=0;i<KEYS.length;i++){key=KEYS[i];if(val=opt[key])
r.push(key+'='+val);}
if(opt.secure)
r.push('secure');return r.join('; ');}
var alive=function(){var k='__EC_TEST__',v=new Date();v=v.toGMTString();this.set(k,v);this.enabled=(this.remove(k)==v);return this.enabled;}
me={set:function(key,val){var opt=(arguments.length>2)?arguments[2]:{},now=get_now(),expire_at,cfg={};if(opt.expires){cfg.expires=new Date(now.getTime()+opt.expires*RATIO);cfg.expires=cfg.expires.toGMTString();}
var keys=['path','domain','secure'];for(i=0;i<keys.length;i++)
if(opt[keys[i]])
cfg[keys[i]]=opt[keys[i]];var r=cookify(key,val,cfg);doc.cookie=r;return val;},has:function(key){key=esc(key);var c=doc.cookie,ofs=c.indexOf(key+'='),len=ofs+key.length+1,sub=c.substring(0,key.length);return((!ofs&&key!=sub)||ofs<0)?false:true;},get:function(key){key=esc(key);var c=doc.cookie,ofs=c.indexOf(key+'='),len=ofs+key.length+1,sub=c.substring(0,key.length),end;if((!ofs&&key!=sub)||ofs<0)
return null;end=c.indexOf(';',len);if(end<0)
end=c.length;return un(c.substring(len,end));},remove:function(k){var r=me.get(k),opt={expires:EPOCH};doc.cookie=cookify(k,'',opt);return r;},keys:function(){var c=doc.cookie,ps=c.split('; '),i,p,r=[];for(i=0;i<ps.length;i++){p=ps[i].split('=');r.push(un(p[0]));}
return r;},all:function(){var c=doc.cookie,ps=c.split('; '),i,p,r=[];for(i=0;i<ps.length;i++){p=ps[i].split('=');r.push([un(p[0]),un(p[1])]);}
return r;},version:'0.2.1',enabled:false};me.enabled=alive.call(me);return me;}());

  // wrapper for Array.prototype.indexOf, since IE doesn't have it
  var index_of = (function() {
    if (Array.prototype.indexOf)
      return function(ary, val) { 
        return Array.prototype.indexOf.call(ary, val);
      };
    else
      return function(ary, val) {
        var i, l;

        for (i = 0, l = ary.length; i < l; i++)
          if (ary[i] == val)
            return i;

        return -1;
      };
  })();


  // empty function
  empty = function() { };

  /**
   * Escape spaces and underscores in name.  Used to generate a "safe"
   * key from a name.
   *
   * @private
   */
  esc = function(str) {
    return 'PS' + str.replace(/_/g, '__').replace(/ /g, '_s');
  };

  C = {
    /* 
     * Backend search order.
     * 
     * Note that the search order is significant; the backends are
     * listed in order of capacity, and many browsers
     * support multiple backends, so changing the search order could
     * result in a browser choosing a less capable backend.
     */ 
    search_order: [
      // TODO: air
      'cefStorage',
      'winOldStorage',
      'winStoreStorage',
      'macStorage',
      'iosStorage',
      'localChromeStorage',
      'androidStorage',
      'whatwg_db', 
      'localstorage',
      'globalstorage', 
      'cookie',
      'gears',
      'ie', 
      'flash'
    ],

    // valid name regular expression
    name_re: /^[a-z][a-z0-9_ -]+$/i,

    // list of backend methods
    methods: [
      'init', 
      'get', 
      'set', 
      'remove', 
      'load', 
      'save'
      // TODO: clear method?
    ],

    // sql for db backends (gears and db)
    sql: {
      version:  '1', // db schema version

      // XXX: the "IF NOT EXISTS" is a sqlite-ism; fortunately all the 
      // known DB implementations (safari and gears) use sqlite
      create:   "CREATE TABLE IF NOT EXISTS persist_data (k TEXT UNIQUE NOT NULL PRIMARY KEY, v TEXT NOT NULL)",
      get:      "SELECT v FROM persist_data WHERE k = ?",
      set:      "INSERT INTO persist_data(k, v) VALUES (?, ?)",
      remove:   "DELETE FROM persist_data WHERE k = ?" 
    },

    // default flash configuration
    flash: {
      // ID of wrapper element
      div_id:   '_persist_flash_wrap',

      // id of flash object/embed
      id:       '_persist_flash',

      // default path to flash object
      path: 'persist.swf',
      size: { w:1, h:1 },

      // arguments passed to flash object
      args: {
        autostart: true
      }
    } 
  };

  // built-in backends
  B = {
    // gears db backend
    // (src: http://code.google.com/apis/gears/api_database.html)
    gears: {
      // no known limit
      size:   -1,

      test: function() {
        // test for gears
        return (window.google && window.google.gears) ? true : false;
      },

      methods: {
        transaction: function(fn) {
          var db = this.db;

          // begin transaction
          db.execute('BEGIN').close();

          // call callback fn
          fn.call(this, db);

          // commit changes
          db.execute('COMMIT').close();
        },

        init: function() {
          var db;

          // create database handle (TODO: add schema version?)
          db = this.db = google.gears.factory.create('beta.database');

          // open database
          // from gears ref:
          //
          // Currently the name, if supplied and of length greater than
          // zero, must consist only of visible ASCII characters
          // excluding the following characters:
          //
          //   / \ : * ? " < > | ; ,
          //
          // (this constraint is enforced in the Store constructor)
          db.open(esc(this.name));

          // create table
          db.execute(C.sql.create).close();
        },

        get: function(key, fn, scope) {
          var r, sql = C.sql.get;

          // if callback isn't defined, then return
          if (!fn)
            return;

          // begin transaction
          this.transaction(function (t) {
            var is_valid, val;
            // exec query
            r = t.execute(sql, [key]);

            // check result and get value
            is_valid = r.isValidRow();
            val = is_valid ? r.field(0) : null;

            // close result set
            r.close();

            // call callback
            fn.call(scope || this, is_valid, val);
          });
        },

        set: function(key, val, fn, scope) {
          var rm_sql = C.sql.remove,
              sql    = C.sql.set, r;

          // begin set transaction
          this.transaction(function(t) {
            // exec remove query
            t.execute(rm_sql, [key]).close();

            // exec set query
            t.execute(sql, [key, val]).close();
            
            // run callback (TODO: get old value)
            if (fn)
              fn.call(scope || this, true, val);
          });
        },

        remove: function(key, fn, scope) {
          var get_sql = C.sql.get;
              sql = C.sql.remove,
              r, val = null, is_valid = false;

          // begin remove transaction
          this.transaction(function(t) {
            // if a callback was defined, then get the old
            // value before removing it
            if (fn) {
              // exec get query
              r = t.execute(get_sql, [key]);

              // check validity and get value
              is_valid = r.isValidRow();
              val = is_valid ? r.field(0) : null;

              // close result set
              r.close();
            }

            // exec remove query if no callback was defined, or if a
            // callback was defined and there was an existing value
            if (!fn || is_valid) {
              // exec remove query
              t.execute(sql, [key]).close();
            }

            // exec callback
            if (fn)
              fn.call(scope || this, is_valid, val);
          });
        } 
      }
    }, 

    cefStorage: {
      size:   -1,

      test: function() {
        return !!window.cefQuery;
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {

        },

        query: function(method, paramString, callback) {
          cefQuery({request:method+" "+paramString,
            onSuccess: function(response) {
              callback(true, response);
            },
            onFailure: function(error_code, error_message) {
              console.error(method + " error: " + error_message);
              callback(false);
            }
          });
        },

        get: function(key, fn, scope) {
          key = this.key(key);

          // if callback isn't defined, then return
          if (!fn)
            return;

          // get callback scope
          scope = scope || this;

          this.query("StorageGet", key, function(ok, results) {
            fn.call(scope, ok, results);
          });
        },

        set: function(key, val, fn, scope) {
          key = this.key(key);
          scope = scope || this;
          this.query("StorageSet", key + " " + val, function(ok){
            if (fn) fn.call(scope, ok, val);
          });
          return val;
        },

        // begin remove transaction
        remove: function(key, fn, scope) {
          key = this.key(key);
          scope = scope || this;
          this.query("StorageRemove", key, function(ok) {
            // return original value? meh
            if (fn) fn.call(scope, ok);
          });
        }
      }
    },

    // whatwg db backend (webkit, Safari 3.1+)
    // (src: whatwg and http://webkit.org/misc/DatabaseExample.html)
    whatwg_db: {
      // size based on DatabaseExample from above (should I increase
      // this?)
      size:   200 * 1024,

      test: function() {
        var name = 'PersistJS Test', 
            desc = 'Persistent database test.';

        // test for openDatabase
        if (!window.openDatabase)
          return false;

        // make sure openDatabase works
        // XXX: will this leak a db handle and/or waste space?
        if (!window.openDatabase(name, C.sql.version, desc, B.whatwg_db.size))
          return false;

        // return true
        return true;
      },

      methods: {
        transaction: function(fn) {
          // lazy create database table;
          // this is done here because there is no way to
          // prevent a race condition if the table is created in init()
          if (!this.db_created) {
            this.db.transaction(function(t) {
              // create table
              t.executeSql(C.sql.create, [], function() {
                this.db_created = true;
              });
            }, empty); // trap exception
          } 

          // execute transaction
          this.db.transaction(fn);
        },

        init: function() {
          // create database handle
          this.db = openDatabase(
            this.name, 
            C.sql.version, 
            this.o.about || ("Persistent storage for " + this.name),
            this.o.size || B.whatwg_db.size 
          );
        },

        get: function(key, fn, scope) {
          var sql = C.sql.get;

          // if callback isn't defined, then return
          if (!fn)
            return;

          // get callback scope
          scope = scope || this;

          // begin transaction
          this.transaction(function (t) {
            t.executeSql(sql, [key], function(t, r) {
              if (r.rows.length > 0)
                fn.call(scope, true, r.rows.item(0)['v']);
              else
                fn.call(scope, false, null);
            });
          });
        },

        set: function(key, val, fn, scope) {
          var rm_sql = C.sql.remove,
              sql    = C.sql.set;

          // begin set transaction
          this.transaction(function(t) {
            // exec remove query
            t.executeSql(rm_sql, [key], function() {
              // exec set query
              t.executeSql(sql, [key, val], function(t, r) {
                // run callback
                if (fn)
                  fn.call(scope || this, true, val);
              });
            });
          });

          return val;
        },

        // begin remove transaction
        remove: function(key, fn, scope) {
          var get_sql = C.sql.get;
              sql = C.sql.remove;

          this.transaction(function(t) {
            // if a callback was defined, then get the old
            // value before removing it
            if (fn) {
              // exec get query
              t.executeSql(get_sql, [key], function(t, r) {
                if (r.rows.length > 0) {
                  // key exists, get value 
                  var val = r.rows.item(0)['v'];

                  // exec remove query
                  t.executeSql(sql, [key], function(t, r) {
                    // exec callback
                    fn.call(scope || this, true, val);
                  });
                } else {
                  // key does not exist, exec callback
                  fn.call(scope || this, false, null);
                }
              });
            } else {
              // no callback was defined, so just remove the
              // data without checking the old value

              // exec remove query
              t.executeSql(sql, [key]);
            }
          });
        } 
      }
    }, 
    
    // globalstorage backend (globalStorage, FF2+, IE8+)
    // (src: http://developer.mozilla.org/en/docs/DOM:Storage#globalStorage)
    // https://developer.mozilla.org/En/DOM/Storage
    //
    // TODO: test to see if IE8 uses object literal semantics or
    // getItem/setItem/removeItem semantics
    globalstorage: {
      // (5 meg limit, src: http://ejohn.org/blog/dom-storage-answers/)
      size: 5 * 1024 * 1024,

      test: function() {
        try {
          if (window.globalStorage && window.globalStorage[this.o.domain]) return true;
        } catch (e) {}
        return false;
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = globalStorage[this.o.domain];
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          if (fn)
            fn.call(scope || this, true, this.store.getItem(key));
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          this.store.setItem(key, val);

          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          // get value
          val = this.store[key];

          // delete value
          this.store.removeItem(key);

          if (fn)
            fn.call(scope || this, (val !== null), val);
        } 
      }
    }, 
    
    // localstorage backend (globalStorage, FF2+, IE8+)
    // (src: http://www.whatwg.org/specs/web-apps/current-work/#the-localstorage)
    // also http://msdn.microsoft.com/en-us/library/cc197062(VS.85).aspx#_global
    localstorage: {
      // (unknown?)
      // ie has the remainingSpace property, see:
      // http://msdn.microsoft.com/en-us/library/cc197016(VS.85).aspx
      size: -1,

      test: function() {
        try {
          return window.localStorage ? true : false;
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = localStorage;
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          if (fn)
            fn.call(scope || this, true, this.store.getItem(key));
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          this.store.setItem(key, val);

          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          // get value
          val = this.store.getItem(key);

          // delete value
          this.store.removeItem(key);

          if (fn)
            fn.call(scope || this, (val !== null), val);
        } 
      }
    }, 

    // chrome packaged app storage
    // http://developer.chrome.com/stable/apps/storage.html
    localChromeStorage: {
      // (unknown?)
      // ie has the remainingSpace property, see:
      // http://msdn.microsoft.com/en-us/library/cc197016(VS.85).aspx
      size: -1,

      test: function() {
        try {
          return window.chrome && window.chrome.storage && window.chrome.storage.local;
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = chrome.storage.local;
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          scope = scope || this;
          this.store.get(key, function(val){
            if (fn) fn.call(scope, true, val[key]);
          });
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          var out = {};
          out[key] = val;
          if (fn) {
            scope = scope || this;  
            this.store.set(out, function(){
              fn.call(scope, true, val);
            });
          } else {
            this.store.set(out);
          }
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          if (fn) {
            // get value first
            scope = scope || this;
            this.store.get(key, function(val){
              this.store.remove(key, function(){
                fn.call(scope, (val[key] !== null), val[key]);
              });
            });
          } else {
            this.store.remove(key);
          }
        } 
      }
    }, 
    
    // DGF Fake local storage
    androidStorage: {
      // (unknown?)
      // ie has the remainingSpace property, see:
      // http://msdn.microsoft.com/en-us/library/cc197016(VS.85).aspx
      size: -1,

      test: function() {
        try {
          return window.androidStorage ? true : false;
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = androidStorage;
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          if (fn)
            fn.call(scope || this, true, this.store.getItem(key));
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          this.store.setItem(key, val);

          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          // get value
          val = this.store.getItem(key);

          // delete value
          this.store.removeItem(key);

          if (fn)
            fn.call(scope || this, (val !== null), val);
        } 
      }
    }, 

    // DGF iOS managed storage
    iosStorage: {
      size: -1,

      test: function() {
        try {
          return window.isIosApp ? true : false;
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {

        },

        callIos: function(scheme, path) {
          path = encodeURIComponent(path).replace(/[!~*')(]/g, function(match) {
            return "%" + match.charCodeAt(0).toString(16);
          });

          var url = scheme + "://" + path;
          var iframe = document.createElement("IFRAME");
          iframe.setAttribute("src", url);
          iframe.setAttribute("style", "display:none");
          document.documentElement.appendChild(iframe);
          iframe.parentNode.removeChild(iframe);
          iframe = null;
        },

        get: function(key, fn, scope) {
          if (!fn) return;
          // expand key
          key = this.key(key);

          var nonce = "storageget" + key + (+new Date);
          window[nonce] = function(value) {
            delete window[nonce];
            fn.call(scope || this, true, value);
          }
          this.callIos("storageget", key + " " + nonce);
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          var nonce = "storageset" + key + (+new Date);
          window[nonce] = function() {
            delete window[nonce];
            if (fn) fn.call(scope || this, true, val);
          }
          this.callIos("storageset", key + " " + nonce + " " + encodeURIComponent(val));
        },

        remove: function(key, fn, scope) {
          if (fn) {
            this.get(key, function(val) {
              this._remove(key, fn, scope, val);
            }, this);
          } else {
            this._remove(key, fn, scope);
          }
        },

        _remove: function(key, fn, scope, val) {
          var val;

          // expand key
          key = this.key(key);

          // delete value
          var nonce = "storagerem" + key + (+new Date);
          window[nonce] = function() {
            delete window[nonce];
            if (fn) fn.call(scope || this, (val !== null), val);
          }
          this.callIos("storagerem", key + " " + nonce);
        } 
      }
    }, 

    // DGF OSX managed storage
    macStorage: {
      size: -1,

      test: function() {
        try {
          return window.macStorage ? true : false;
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = macStorage;
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          if (fn)
            fn.call(scope || this, true, this.store.objectForKey_(key));
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          this.store.setObject_forKey_(val, key);

          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          // get value
          val = this.store.objectForKey_(key)

          // delete value
          this.store.removeObjectForKey_(key);

          if (fn)
            fn.call(scope || this, (val !== null), val);
        } 
      }
    }, 

    // DGF Old win app managed storage
    winOldStorage: {
      size: -1,

      test: function() {
        try {
          return window.external.IsWinOldApp();
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = window.external;
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          if (fn)
            fn.call(scope || this, true, this.store.GetValue(key));
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          this.store.SetValue(key, val);

          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          // get value
          val = this.store.GetValue(key)

          // delete value
          this.store.DeleteValue(key);

          if (fn)
            fn.call(scope || this, (val !== null), val);
        } 
      }
    }, 

      // DGF WinStore managed storage
    winStoreStorage: {
        size: -1,

        test: function () {
            try {
                return Windows.Storage.ApplicationData.current.roamingFolder;
            } catch (e) {
                return false;
            }
        },

        methods: {
            key: function (key) {
                return esc(this.name) + esc(key);
            },

            init: function () {
                var self = this;
                function doneLoadingWinStore() {
                  self.loaded = true;
                  for (var i = self.loadListeners.length - 1; i >= 0; i--) {
                    setTimeout(self.loadListeners[i], 0);
                  }
                }
                this.loaded = false;
                this.loadListeners = [];

                Windows.Storage.ApplicationData.current.roamingFolder
                  .createFileAsync("data.txt", Windows.Storage.CreationCollisionOption.openIfExists)
                  .then(function (file) {
                    self.file = file;
                    return Windows.Storage.FileIO.readTextAsync(file);
                  }).done(function (data) {
                    self.store = {};
                    if (data && typeof data == "string") {
                      var rows = data.split("\n");
                      for (var i = rows.length - 1; i >= 0; i--) {
                        var row = rows[i].split("\t");
                        self.store[row[0]] = decodeURIComponent(row[1]);
                      }
                    }
                    doneLoadingWinStore();
                  },
                  function(){
                    self.store = {};
                    doneLoadingWinStore();
                  });
            },

            get: function (key, fn, scope) {
                if (!this.loaded) {
                  var self = this;
                  this.loadListeners.push(function() {self.get(key, fn, scope)});
                  return;
                }
                // expand key
                key = this.key(key);

                if (fn)
                    fn.call(scope || this, true, this.store[key]);
            },

            set: function (key, val, fn, scope) {
                if (!this.loaded) {
                  var self = this;
                  this.loadListeners.push(function() {self.set(key, val, fn, scope)});
                  return;
                }
                // expand key
                key = this.key(key);

                // set value
                this.store[key] = val;
                this.writeAsync();

                if (fn)
                    fn.call(scope || this, true, val);
            },

            remove: function (key, fn, scope) {
                if (!this.loaded) {
                  var self = this;
                  this.loadListeners.push(function() {self.remove(key, fn, scope)});
                  return;
                }
                var val;

                // expand key
                key = this.key(key);

                // get value
                val = this.store[key];

                // delete value
                delete this.store[key];
                this.writeAsync();

                if (fn)
                    fn.call(scope || this, (val !== null), val);
            },

            writeAsync: function() {
              var output = [];
              for (var key in this.store) {
                output.push(key, '\t', encodeURIComponent(this.store[key]), '\n');
              }
              Windows.Storage.FileIO.writeTextAsync(this.file, output.join(''));
            }
        }
    },

    // IE backend
    ie: {
      prefix:   '_persist_data-',
      // style:    'display:none; behavior:url(#default#userdata);',

      // 64k limit
      size:     64 * 1024,

      test: function() {
        // make sure we're dealing with IE
        // (src: http://javariet.dk/shared/browser_dom.htm)
        return window.ActiveXObject ? true : false;
      },

      make_userdata: function(id) {
        var el = document.createElement('div');

        // set element properties
        // http://msdn.microsoft.com/en-us/library/ms531424(VS.85).aspx 
        // http://www.webreference.com/js/column24/userdata.html
        el.id = id;
        el.style.display = 'none';
        el.addBehavior('#default#userdata');

        // append element to body
        document.body.appendChild(el);

        // return element
        return el;
      },

      methods: {
        init: function() {
          var id = B.ie.prefix + esc(this.name);

          // save element
          this.el = B.ie.make_userdata(id);

          // load data
          if (this.o.defer)
            this.load();
        },

        get: function(key, fn, scope) {
          var val;

          // expand key
          key = esc(key);

          // load data
          if (!this.o.defer)
            this.load();

          // get value
          val = this.el.getAttribute(key);

          // call fn
          if (fn)
            fn.call(scope || this, val ? true : false, val);
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = esc(key);
          
          // set attribute
          this.el.setAttribute(key, val);

          // save data
          if (!this.o.defer)
            this.save();

          // call fn
          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = esc(key);

          // load data
          if (!this.o.defer)
            this.load();

          // get old value and remove attribute
          val = this.el.getAttribute(key);
          this.el.removeAttribute(key);

          // save data
          if (!this.o.defer)
            this.save();

          // call fn
          if (fn)
            fn.call(scope || this, val ? true : false, val);
        },

        load: function() {
          this.el.load(esc(this.name));
        },

        save: function() {
          this.el.save(esc(this.name));
        }
      }
    },

    // cookie backend
    // uses easycookie: http://pablotron.org/software/easy_cookie/
    cookie: {
      delim: ':',

      // 4k limit (low-ball this limit to handle browser weirdness, and 
      // so we don't hose session cookies)
      size: 4000,

      test: function() {
        // XXX: use easycookie to test if cookies are enabled
        return P.Cookie.enabled ? true : false;
      },

      methods: {
        key: function(key) {
          return this.name + B.cookie.delim + key;
        },

        get: function(key, fn, scope) {
          var val;

          // expand key 
          key = this.key(key);

          // get value
          val = ec.get(key);

          // call fn
          if (fn)
            fn.call(scope || this, val != null, val);
        },

        set: function(key, val, fn, scope) {
          // expand key 
          key = this.key(key);

          // save value
          ec.set(key, val, this.o);

          // call fn
          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, val, fn, scope) {
          var val;

          // expand key 
          key = this.key(key);

          // remove cookie
          val = ec.remove(key)

          // call fn
          if (fn)
            fn.call(scope || this, val != null, val);
        } 
      }
    },

    // flash backend (requires flash 8 or newer)
    // http://kb.adobe.com/selfservice/viewContent.do?externalId=tn_16194&sliceId=1
    // http://livedocs.adobe.com/flash/8/main/wwhelp/wwhimpl/common/html/wwhelp.htm?context=LiveDocs_Parts&file=00002200.html
    flash: {
      test: function() {
        // TODO: better flash detection
        if (!window.deconcept || !window.deconcept.SWFObjectUtil)
          return false;

        // get the major version
        var major = deconcept.SWFObjectUtil.getPlayerVersion().major;

        // check flash version (require 8.0 or newer)
        return (major >= 8) ? true : false;
      },

      methods: {
        init: function() {
          if (!B.flash.el) {
            var o, key, el, cfg = C.flash;

            // create wrapper element
            el = document.createElement('div');
            el.id = cfg.div_id;

            // FIXME: hide flash element
            // el.style.display = 'none';

            // append element to body
            document.body.appendChild(el);

            // create new swf object
            o = new deconcept.SWFObject(this.o.swf_path || cfg.path, cfg.id, cfg.size.w, cfg.size.h, '8');

            // set parameters
            for (key in cfg.args)
              o.addVariable(key, cfg.args[key]);

            // write flash object
            o.write(el);

            // save flash element
            B.flash.el = document.getElementById(cfg.id);
          }

          // use singleton flash element
          this.el = B.flash.el;
        },

        get: function(key, fn, scope) {
          var val;

          // escape key
          key = esc(key);

          // get value
          val = this.el.get(this.name, key);

          // call handler
          if (fn)
            fn.call(scope || this, val !== null, val);
        },

        set: function(key, val, fn, scope) {
          var old_val;

          // escape key
          key = esc(key);

          // set value
          old_val = this.el.set(this.name, key, val);

          // call handler
          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // get key
          key = esc(key);

          // remove old value
          val = this.el.remove(this.name, key);

          // call handler
          if (fn)
            fn.call(scope || this, true, val);
        }
      }
    }
  };

  /**
   * Test for available backends and pick the best one.
   * @private
   */
  var init = function() {
    var i, l, b, key, fns = C.methods, keys = C.search_order;

    // set all functions to the empty function
    for (i = 0, l = fns.length; i < l; i++) 
      P.Store.prototype[fns[i]] = empty;

    // clear type and size
    P.type = null;
    P.size = -1;

    // loop over all backends and test for each one
    for (i = 0, l = keys.length; !P.type && i < l; i++) {
      b = B[keys[i]];

      // test for backend
      try {
        if (b.test()) {
          // found backend, save type and size
          P.type = keys[i];
          P.size = b.size;

          // extend store prototype with backend methods
          for (key in b.methods)
            P.Store.prototype[key] = b.methods[key];
        }
      } catch (e) {}
    }

    // mark library as initialized
    P._init = true;
  };

  // create top-level namespace
  P = {
    // version of persist library
    VERSION: VERSION,

    // backend type and size limit
    type: null,
    size: 0,

    // XXX: expose init function?
    // init: init,

    add: function(o) {
      // add to backend hash
      B[o.id] = o;

      // add backend to front of search order
      C.search_order = [o.id].concat(C.search_order);

      // re-initialize library
      init();
    },

    remove: function(id) {
      var ofs = index_of(C.search_order, id);
      if (ofs < 0)
        return;

      // remove from search order
      C.search_order.splice(ofs, 1);

      // delete from lut
      delete B[id];

      // re-initialize library
      init();
    },

    // expose easycookie API
    Cookie: ec,

    // store API
    Store: function(name, o) {
      // verify name
      if (!C.name_re.exec(name))
        throw new Error("Invalid name");

      // XXX: should we lazy-load type?
      // if (!P._init)
      //   init();

      if (!P.type)
        throw new Error("No suitable storage found");

      o = o || {};
      this.name = name;

      // get domain (XXX: does this localdomain fix work?)
      o.domain = o.domain || location.host || 'localhost';
      
      // strip port from domain (XXX: will this break ipv6?)
      o.domain = o.domain.replace(/:\d+$/, '')

      // append localdomain to domains w/o '."
      // (see https://bugzilla.mozilla.org/show_bug.cgi?id=357323)
      // (file://localhost/ works, see: 
      // https://bugzilla.mozilla.org/show_bug.cgi?id=469192)
/* 
 *       if (!o.domain.match(/\./))
 *         o.domain += '.localdomain';
 */ 

      this.o = o;

      // expires in 2 years
      o.expires = o.expires || 365 * 2;

      // set path to root
      o.path = o.path || '/';

      // call init function
      this.init();
    } 
  };

  // init persist
  init();

  // return top-level namespace
  return P;
})();
/**
 * alertify
 * An unobtrusive customizable JavaScript notification system
 *
 * @author Fabien Doiron <fabien.doiron@gmail.com>
 * @copyright Fabien Doiron 2012
 * @license MIT <http://opensource.org/licenses/mit-license.php>
 * @link http://fabien-d.github.com/alertify.js/
 * @module alertify
 * @version 0.3.0
 */
(function(e,t){"use strict";var n=e.document,r;r=function(){var r={},i={},s=!1,o={ENTER:13,ESC:27,SPACE:32},u=[],a,f,l,c,h;return i={buttons:{holder:'<nav class="alertify-buttons">{{buttons}}</nav>',submit:'<button type="submit" class="alertify-button alertify-button-ok" id="alertify-ok" />{{ok}}</button>',ok:'<a href="#" class="alertify-button alertify-button-ok" id="alertify-ok">{{ok}}</a>',cancel:'<a href="#" class="alertify-button alertify-button-cancel" id="alertify-cancel">{{cancel}}</a>'},input:'<div class="alertify-text-wrapper"><input type="text" class="alertify-text" id="alertify-text"></div>',message:'<p class="alertify-message">{{message}}</p>',log:'<article class="alertify-log{{class}}">{{message}}</article>'},a=function(e){return n.getElementById(e)},r={labels:{ok:"OK",cancel:"Cancel"},delay:5e3,addListeners:function(r){var i=a("alertify-resetFocus"),s=a("alertify-ok")||t,u=a("alertify-cancel")||t,f=a("alertify-text")||t,l=a("alertify-form")||t,c=typeof s!="undefined",h=typeof u!="undefined",p=typeof f!="undefined",d="",v=this,m,g,y,b,w;m=function(e){typeof e.preventDefault!="undefined"&&e.preventDefault(),y(e),typeof f!="undefined"&&(d=f.value),typeof r=="function"&&r(!0,d)},g=function(e){typeof e.preventDefault!="undefined"&&e.preventDefault(),y(e),typeof r=="function"&&r(!1)},y=function(e){v.hide(),v.unbind(n.body,"keyup",b),v.unbind(i,"focus",w),p&&v.unbind(l,"submit",m),c&&v.unbind(s,"click",m),h&&v.unbind(u,"click",g)},b=function(e){var t=e.keyCode;t===o.SPACE&&!p&&m(e),t===o.ESC&&h&&g(e)},w=function(e){p?f.focus():h?u.focus():s.focus()},this.bind(i,"focus",w),c&&this.bind(s,"click",m),h&&this.bind(u,"click",g),this.bind(n.body,"keyup",b),p&&this.bind(l,"submit",m),e.setTimeout(function(){f?(f.focus(),f.select()):s.focus()},50)},bind:function(e,t,n){typeof e.addEventListener=="function"?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n)},build:function(e){var t="",n=e.type,r=e.message,s=e.cssClass||"";t+='<div class="alertify-dialog">',n==="prompt"&&(t+='<form id="alertify-form">'),t+='<article class="alertify-inner">',t+=i.message.replace("{{message}}",r),n==="prompt"&&(t+=i.input),t+=i.buttons.holder,t+="</article>",n==="prompt"&&(t+="</form>"),t+='<a id="alertify-resetFocus" class="alertify-resetFocus" href="#">Reset Focus</a>',t+="</div>";switch(n){case"confirm":t=t.replace("{{buttons}}",i.buttons.cancel+i.buttons.ok),t=t.replace("{{ok}}",this.labels.ok).replace("{{cancel}}",this.labels.cancel);break;case"prompt":t=t.replace("{{buttons}}",i.buttons.cancel+i.buttons.submit),t=t.replace("{{ok}}",this.labels.ok).replace("{{cancel}}",this.labels.cancel);break;case"alert":t=t.replace("{{buttons}}",i.buttons.ok),t=t.replace("{{ok}}",this.labels.ok);break;default:}return c.className="alertify alertify-show alertify-"+n+" "+s,l.className="alertify-cover",t},close:function(e,t){var n=t&&!isNaN(t)?+t:this.delay;this.bind(e,"click",function(){h.removeChild(e)}),setTimeout(function(){typeof e!="undefined"&&e.parentNode===h&&h.removeChild(e)},n)},dialog:function(e,t,r,i,o){f=n.activeElement;var a=function(){if(c&&c.scrollTop!==null)return;a()};if(typeof e!="string")throw new Error("message must be a string");if(typeof t!="string")throw new Error("type must be a string");if(typeof r!="undefined"&&typeof r!="function")throw new Error("fn must be a function");return typeof this.init=="function"&&(this.init(),a()),u.push({type:t,message:e,callback:r,placeholder:i,cssClass:o}),s||this.setup(),this},extend:function(e){if(typeof e!="string")throw new Error("extend method must have exactly one paramter");return function(t,n){return this.log(t,e,n),this}},hide:function(){u.splice(0,1),u.length>0?this.setup():(s=!1,c.className="alertify alertify-hide alertify-hidden",l.className="alertify-cover alertify-hidden",f?f.focus():null)},init:function(){n.createElement("nav"),n.createElement("article"),n.createElement("section"),l=n.createElement("div"),l.setAttribute("id","alertify-cover"),l.className="alertify-cover alertify-hidden",n.body.appendChild(l),c=n.createElement("section"),c.setAttribute("id","alertify"),c.className="alertify alertify-hidden",n.body.appendChild(c),h=n.createElement("section"),h.setAttribute("id","alertify-logs"),h.className="alertify-logs",n.body.appendChild(h),n.body.setAttribute("tabindex","0"),delete this.init},log:function(e,t,n){var r=function(){if(h&&h.scrollTop!==null)return;r()};return typeof this.init=="function"&&(this.init(),r()),this.notify(e,t,n),this},notify:function(e,t,r){var i=n.createElement("article");i.className="alertify-log"+(typeof t=="string"&&t!==""?" alertify-log-"+t:""),i.innerHTML=e,h.insertBefore(i,h.firstChild),setTimeout(function(){i.className=i.className+" alertify-log-show"},50),this.close(i,r)},set:function(e){var t;if(typeof e!="object"&&e instanceof Array)throw new Error("args must be an object");for(t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},setup:function(){var e=u[0];s=!0,c.innerHTML=this.build(e),typeof e.placeholder=="string"&&e.placeholder!==""&&(a("alertify-text").value=e.placeholder),this.addListeners(e.callback)},unbind:function(e,t,n){typeof e.removeEventListener=="function"?e.removeEventListener(t,n,!1):e.detachEvent&&e.detachEvent("on"+t,n)}},{alert:function(e,t,n){return r.dialog(e,"alert",t,"",n),this},confirm:function(e,t,n){return r.dialog(e,"confirm",t,"",n),this},extend:r.extend,init:r.init,log:function(e,t,n){return r.log(e,t,n),this},prompt:function(e,t,n,i){return r.dialog(e,"prompt",t,n,i),this},success:function(e,t){return r.log(e,"success",t),this},error:function(e,t){return r.log(e,"error",t),this},set:function(e){r.set(e)},labels:r.labels}},typeof define=="function"?define([],function(){return new r}):typeof e.alertify=="undefined"&&(e.alertify=new r)})(this);/*
 * Copyright 2010 by Dan Fabulich.
 * 
 * Dan Fabulich licenses this file to you under the
 * ChoiceScript License, Version 1.0 (the "License"); you may
 * not use this file except in compliance with the License. 
 * You may obtain a copy of the License at
 * 
 *  http://www.choiceofgames.com/LICENSE-1.0.txt
 * 
 * See the License for the specific language governing
 * permissions and limitations under the License.
 * 
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied.
 */

_global = this;

(function() {
  var userAgent, url, protocol;
  if (typeof window !== "undefined") {
    userAgent = navigator.userAgent;
    url = window.location.href;
    protocol = window.location.protocol;
  }
  _global.isWebOS = /webOS/.test(userAgent);
  _global.isMobile = _global.isWebOS || /Mobile/.test(userAgent);
  _global.isFile = /^file:/.test(url);
  _global.isXul = /^chrome:/.test(url);
  try {
    _global.greenworks = require('greenworks');
    _global.isGreenworks = true;
  } catch (ignored) {}
  _global.isWinOldApp = false;
  try {
    isWinOldApp = window.external.IsWinOldApp();
  } catch (ignored) {}
  _global.isWeb = !_global.isWinOldApp && /^https?:/.test(url);
  _global.isAndroid = /Android/.test(userAgent);
  _global.isSecureWeb = /^https:?$/.test(protocol);
  _global.isSafari = /Safari/.test(userAgent);
  _global.isIE = /(MSIE|Trident)/.test(userAgent);
  _global.isIPad = /iPad/.test(userAgent);
  _global.isKindleFire = /Kindle Fire/.test(userAgent);
  _global.isWinStoreApp = "ms-appx:" == protocol;
  _global.isCef = !!_global.cefQuery;
  _global.isNode = typeof process !== "undefined";
})();

_global.loadTime = new Date().getTime();

function callIos(scheme, path) {
  if (!_global.isIosApp) return;
  if (path) {
    path = encodeURIComponent(path).replace(/[!~*')(]/g, function(match) {
      return "%" + match.charCodeAt(0).toString(16);
    });
  } else {
    path = "";
  }
  setTimeout(function() {
    var iframe = document.createElement("IFRAME");
    iframe.setAttribute("src", scheme + "://" + path);
    iframe.setAttribute("style", "display:none");
    document.documentElement.appendChild(iframe);
    iframe.parentNode.removeChild(iframe);
    iframe = null;
  }, 0);
}

function safeCall(obj, fn) {
    if (!fn) return;
    var isHeadless = typeof window == "undefined";
    var debug = false || (!isHeadless && window.debug);
    if (isIE || isHeadless) {
        // just call through; onerror will be called and debugger will handle it
        if (typeof MSApp != "undefined") {
            if (obj) {
                MSApp.execUnsafeLocalFunction(function () { fn.call(obj); });
            } else {
                MSApp.execUnsafeLocalFunction(fn);
            }
        } else if (obj) {
            fn.call(obj);
        } else {
            fn.call();
        }
    } else {
        try {
            if (obj) {
                fn.call(obj);
            } else {
                fn.call();
            }
        } catch (e) {
            if (e.message) {
              window.onerror(e.message, e.fileName, e.lineNumber, e.stack);
            } else if (e.stack) {
              window.onerror(e.stack, e.fileName, e.lineNumber, e.stack);
            } else {
              window.onerror(toJson(e, '\n'));
            }

            if (window.console) {
              window.console.error(e);
              if (e.message) window.console.error("Message: " + e.message);
              if (e.stack) window.console.error("Stack: " + e.stack);
            }
            // Rethrow here so the debugger can handle it
            // On Firefox this causes a second prompt.  Meh!
            if (debug) throw e;
        }
    }
}

function safeCallback(callback) {
  return function() {
    safeCall(null, callback);
  };
}

function safeTimeout(fn, time) {
  setTimeout(function() {
    safeCall(null, fn);
  }, time);
}

function isDefined(x) {
    return "undefined" !== typeof x;
}

function jsonStringifyAscii(obj) {
  var stringified = JSON.stringify(obj, function replacer(key, value) {
    if (key == "scene") return undefined;
    return value;
  });
  var output = stringified.replace(/(.)/g, function(x) {
    var code = x.charCodeAt(0);
    if (code > 127 || code < 32) {
     var outCode = code.toString(16);
     switch (outCode.length) {
       case 4:
         return "\\u" + outCode;
       case 3:
         return "\\u0" + outCode;
       case 2:
         return "\\u00" + outCode;
       case 1:
         return "\\u000" + outCode;
       default:
         return x;
     }
    }
    return x;
  });
  return output;
}

function toJson(obj, standardized) {
 if (typeof JSON != "undefined" && JSON.stringify) {
  return jsonStringifyAscii(obj);
 }
 switch (typeof obj) {
  case 'object':
   if (obj) {
    var list = [];
    if (obj instanceof Array) {
     for (var i=0;i < obj.length;i++) {
      list.push(toJson(obj[i], standardized));
     }
     return '[' + list.join(',') + ']';
    } else {
     for (var prop in obj) {
      if (prop == "scene") continue;
      if (!standardized && /^[a-zA-Z][a-zA-Z_0-9]\w+$/.test(prop) && !/\b(abstract|boolean|break|byte|case|catch|char|class|comment|const|continue|debugger|default|delete|do|double|else|enum|export|extends|false|final|finally|float|for|function|goto|if|implements|import|in|instanceof|int|interface|label|long|native|new|null|package|private|protected|public|return|short|static|super|switch|synchronized|this|throws|transient|true|try|typeof|var|void|volatile|while|with)\b/.test(prop)) {
        list.push(prop + ':' + toJson(obj[prop], standardized));
      } else {
        list.push('"' + prop + '":' + toJson(obj[prop], standardized));
      }
     }
     return '{' + list.join(',') + '}';
    }
   } else {
    return 'null';
   }
   break;
  case 'string':
   var encoded = obj.replace(/(.)/g, function(x) {
     if (x == "'" || x == '"' || x == '\\') {
       return "\\" + x;
     }
     var code = x.charCodeAt(0);
     if (code > 127 || code < 32) {
       var outCode = code.toString(16);
       switch (outCode.length) {
         case 4:
           return "\\u" + outCode;
         case 3:
           return "\\u0" + outCode;
         case 2:
           return "\\u00" + outCode;
         case 1:
           return "\\u000" + outCode;
         default:
           return x;
       }
     }
     return x;
   });
   return '"' + encoded + '"';
  case 'number':
  case 'boolean':
   return String(obj);
  case 'function':
   return 'badfunction';
  case 'undefined':
    return 'undefined';
  default:
   throw new Error("invalid type: " + typeof obj);
 }
}

var loginUrlBase = "https://www.choiceofgames.com/api/";
function xhrAuthRequest(method, endpoint, callback) {
  var paramBuilder = new Array(arguments.length*3);
  for (var i = 3; i < arguments.length; i=i+2) {
    if (i > 3) paramBuilder.push("&");
    paramBuilder.push(arguments[i]);
    paramBuilder.push("=");
    paramBuilder.push(arguments[i+1]);
  }
  var params = paramBuilder.join("");
  var xhr = findXhr();
  if (method == "POST") {
    xhr.open(method, loginUrlBase + endpoint + ".php", true);
    xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");
  } else {
    xhr.open(method, loginUrlBase + endpoint + ".php?" + params, true);
  }

  var done = false;

  xhr.onreadystatechange = function() {
    if (done) return;
    if (xhr.readyState != 4) return;
    done = true;
    var ok = xhr.status == 200;
    var response = {};
    try {
      if (xhr.responseText) response = JSON.parse(xhr.responseText);
    } catch (e) {
      ok = false;
    }
    if (!ok && !response.error) response.error = "unknown error";
    if (callback) safeCall(null, function() {callback(ok, response);});
  };
  xhr.send(params);
}

function login(email, password, register, subscribe, callback) {
  xhrAuthRequest("POST", "login", callback, "email", encodeURIComponent(email), "password", encodeURIComponent(password), "register", register, "subscribe", subscribe);
}

function forgotPassword(email, callback) {
  xhrAuthRequest("POST", "forgot", callback, "email", encodeURIComponent(email));
}

function logout(callback) {
  document.cookie = 'login=0;path=/;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
  xhrAuthRequest("GET", "logout", callback);
  recordLogin(false);
  window.knownPurchases = null;
  if (typeof FB != "undefined" && FB.logout) FB.logout();
  if (typeof gapi != "undefined" && gapi.auth && gapi.auth.signOut) gapi.auth.signOut();
}

function recordLogin(registered, email, callback) {
  if (initStore()) {
    if (registered) recordEmail(email);
    window.store.set("login", registered, function() {safeCall(null, callback);});
    window.registered = registered;
  } else {
    safeTimeout(callback, 0);
  }
}

function getRemoteEmail(callback) {
  xhrAuthRequest("GET", "getuser", callback);
}

function saveCookie(callback, slot, stats, temps, lineNum, indent) {
    var value = computeCookie(stats, temps, lineNum, indent);
    return writeCookie(value, slot, callback);
}

function computeCookie(stats, temps, lineNum, indent) {
  var scene = stats.scene;
  delete stats.scene;
  if (scene) stats.sceneName = scene.name;
  var version = "UNKNOWN";
  if (typeof(window) != "undefined" && window && window.version) version = window.version;
  var value = toJson({version:version, stats:stats, temps:temps, lineNum: lineNum, indent: indent});
  stats.scene = scene;
  return value;
}

function writeCookie(value, slot, callback) {
  if (!window.pseudoSave) window.pseudoSave = {};
  if (!slot) {
    slot = "";
  }
  window.pseudoSave[slot] = value;
  if (!initStore()) {
    if (callback) safeTimeout(callback, 0);
    return;
  }
  window.store.set("state"+slot, value, safeCallback(callback));
}

function clearCookie(callback, slot) {
    writeCookie('', slot, safeCallback(callback));
}

function areSaveSlotsSupported() {
  return !!(initStore() && window.Persist.type != "cookie");
}

function recordSave(slot, callback) {
  if (!areSaveSlotsSupported()) {
    safeTimeout(callback, 0);
    return;
  }
  restoreObject(initStore(), "save_list", [], function (saveList) {
    saveList.push(slot);
    window.store.set("save_list", toJson(saveList), safeCallback(callback));
  });
}

function recordDirtySlots(slots, callback) {
  if (!areSaveSlotsSupported()) {
    safeTimeout(callback, 0);
    return;
  }
  restoreObject(initStore(), "dirty_save_list", [], function (saveList) {
    saveSet = {};
    for (var i = 0; i < saveList.length; i++) {
      saveSet[saveList[i]] = 1;
    }
    for (i = 0; i < slots.length; i++) {
      if (!saveSet[slots[i]]) saveList.push(slots[i]);
    }
    window.store.set("dirty_save_list", toJson(saveList), safeCallback(callback));
  });
}

function recordEmail(email, callback) {
  if (initStore()) {
    window.recordedEmail = email;
    window.store.set("email", email, safeCallback(callback));
  } else {
    safeTimeout(callback, 0);
  }
}

function fetchEmail(callback) {
  if (!initStore()) {
    safeTimeout(function(){callback("");}, 0);
    return;
  }
  // For some reason, this get seems to not respond sometimes
  // adding a fallback timeout
  window.store.get("email", function(ok, value) {
    safeCall(null, function() {
      if (ok) window.recordedEmail = value;
      if (!callback) return;
      var temp = callback;
      callback = null;
      if (ok && value) {
        temp(value);
      } else {
        temp("");
      }
    });
  });
  safeTimeout(function() {
    if (!callback) return;
    var temp = callback;
    callback = null;
    temp("");
  }, 1000);
}

function restoreObject(store, key, defaultValue, callback) {
  if (!store) {
    safeTimeout(function() {callback(defaultValue);}, 0);
    return;
  }
  store.get(key, function(ok, value) {
    var result = defaultValue;
    if (ok && value) {
      try{
        result = jsonParse(value);
      } catch (e) {}
    }
    safeCall(null, function() {callback(result);});
  });
}

function getDirtySaveList(callback) {
  restoreObject(initStore(), "dirty_save_list", [], function (slotList) {
    callback(slotList);
  });
}

function remoteSaveMerger(i, callback) {
  var remoteStore = new Persist.Store(window.remoteStoreNames[i]);
  restoreObject(remoteStore, "save_list", [], function (remoteSlotList) {
    fetchSavesFromSlotList(remoteStore, remoteSlotList, 0, [], function(remoteSaveList) {
      mergeRemoteSaves(remoteSaveList, 0/*recordDirty*/, function() {
        i++;
        if (i < window.remoteStoreNames.length) {
          remoteSaveMerger(i, callback);
        } else {
          callback.apply(null, arguments);
        }
      });
    });
  });
}

function getSaves(callback) {
  if (window.remoteStoreNames && window.remoteStoreNames.length) {
    remoteSaveMerger(0, callback);
  } else if (window.remoteStoreName && window.storeName != window.remoteStoreName) {
    var remoteStore = new Persist.Store(window.remoteStoreName);
    restoreObject(remoteStore, "save_list", [], function (remoteSlotList) {
      fetchSavesFromSlotList(remoteStore, remoteSlotList, 0, [], function(remoteSaveList) {
        mergeRemoteSaves(remoteSaveList, 0/*recordDirty*/, callback);
      });
    });
  } else {
    restoreObject(initStore(), "save_list", [], function (localSlotList) {
      fetchSavesFromSlotList(initStore(), localSlotList, 0, [], callback);
    });
  }
}

function fetchSavesFromSlotList(store, slotList, i, saveList, callback) {
  if (i >= slotList.length) {
    return safeCall(null, function() {callback(saveList);});
  }
  restoreObject(store, "state"+slotList[i], null, function(saveState) {
    if (saveState) {
      saveState.timestamp = slotList[i].substring(4/*"save".length*/);
      saveList.push(saveState);
    }
    fetchSavesFromSlotList(store, slotList, i+1, saveList, callback);
  });
}

function isWebSavePossible() {
  if (!initStore()) return false;
  if (/^http/.test(window.location.protocol)) {
    return document.domain == window.webSaveDomain || document.domain == "localhost";
  }
  // if it's a file URL with a valid store, either you're a 3rd party developer
  // who knows what you're doing, or you're a mobile app
  return true;
}


webSaveDomain = "www.choiceofgames.com";
webSaveUrl = "https://" + webSaveDomain + "/ajax_proxy.php/websave";

function submitRemoteSave(slot, email, subscribe, callback) {
  if (!isWebSavePossible()) return safeTimeout(function() { callback(false); });
  window.store.get("state"+slot, function(ok, value) {
    if (ok) {
      var timestamp = slot.substring(4/*"save".length*/);
      var xhr = findXhr();
      var gameName = window.remoteStoreName || window.storeName;
      var params = "email="+email+"&game="+gameName+"&realGame="+window.storeName+"&json="+encodeURIComponent(value)+"&timestamp="+ timestamp+"&subscribe="+subscribe;
      xhr.open("POST", webSaveUrl,true);
      xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");
      var done = false;

      xhr.onreadystatechange = function() {
        if (done) return;
        if (xhr.readyState != 4) return;
        done = true;
        var ok = xhr.status == 200;
        if (ok) {
          safeCall(null, function() {callback(true);});
        } else {
          recordDirtySlots([slot], function() {
            safeCall(null, function() {callback(false);});
          });
        }
      };
      xhr.send(params);
    } else {
      recordDirtySlots([slot], function() {
        asyncAlert("There was a problem uploading the saved game. This is probably a bug; please contact support@choiceofgames.com with code 17891.", function() {
          safeCall(null, function() {callback(false);});
        });
      });
    }
  });
}

function submitDirtySaves(dirtySaveList, email, callback) {
  function submitDirtySave(i) {
    if (dirtySaveList[i]) {
      submitRemoteSave(dirtySaveList[i], email, false, function(ok) {
        if (ok) {
          submitDirtySave(i+1);
        } else {
          safeCall(null, function() {callback(false);});
        }
      });
    } else {
      window.store.remove("dirty_save_list", function() {
        safeCall(null, function() {callback(true);});
      });
    }
  }
  submitDirtySave(0);
}

function submitAnyDirtySaves(callback) {
  if (!callback) callback = function(ok) {};
  try {
    getDirtySaveList(function(dirtySaveList) {
      if (dirtySaveList && dirtySaveList.length) {
        try {
          fetchEmail(function(email) {
            if (email) {
              submitDirtySaves(dirtySaveList, email, callback);
            } else {
              callback(false);
            }
          });
        } catch (e) {
          callback(false);
        }
      }
    });
  } catch (e) {
    callback(false);
  }
}

function getRemoteSaves(email, callback) {
  if (!isWebSavePossible()) {
    safeTimeout(function() {callback([]);}, 0);
    return;
  }
  var xhr = findXhr();
  var gameName = window.remoteStoreName || window.storeName;
  xhr.open("GET", webSaveUrl + "?email="+email+"&game="+gameName, true);
  var done = false;
  xhr.onreadystatechange = function() {
    if (done) return;
    if (xhr.readyState != 4) return;
    done = true;
    if (xhr.status != 200) {
      if (window.console) console.log("Couldn't load remote saves. " + xhr.status + ": " + xhr.responseText);
      safeCall(null, function() {callback(null);});
    } else {
      var result = xhr.responseText;
      result = jsonParse(result);
      var remoteSaveList = [];
      for (var i = 0; i < result.length; i++) {
        var save = result[i].json;
        save.timestamp = result[i].timestamp;
        remoteSaveList.push(save);
      }
      safeCall(null, function() {callback(remoteSaveList);});
    }
  };
  xhr.send();
}

function mergeRemoteSaves(remoteSaveList, recordDirty, callback) {
  if (!isWebSavePossible()) {
    safeTimeout(function() { callback([], 0, []); }, 0);
    return;
  }
  restoreObject(initStore(), "save_list", [], function (localSlotList) {
    fetchSavesFromSlotList(initStore(), localSlotList, 0, [], function(localSaveList) {
      var localSlotMap = {};
      for (var i = 0; i < localSlotList.length; i++) {
        localSlotMap[localSlotList[i]] = 1;
      }
      var remoteSlotMap = {};
      for (i = 0; i < remoteSaveList.length; i++) {
        remoteSlotMap["save"+remoteSaveList[i].timestamp] = 1;
      }
      var newRemoteSaves = 0;
      for (i = 0; i < remoteSaveList.length; i++) {
        var remoteSave = remoteSaveList[i];
        var slot = "save"+remoteSave.timestamp;
        if (!localSlotMap[slot]) {
          saveCookie(null, slot, remoteSave.stats, remoteSave.temps, remoteSave.lineNum, remoteSave.indent);
          localSlotList.push(slot);
          localSaveList.push(remoteSave);
          newRemoteSaves++;
        }
      }

      var dirtySaveList = [];
      for (i = 0; i < localSlotList.length; i++) {
        if (!remoteSlotMap[localSlotList[i]]) {
          dirtySaveList.push(localSlotList[i]);
        }
      }

      if (recordDirty) {
        window.store.set("dirty_save_list", toJson(dirtySaveList), finale);
      } else {
        finale();
      }

      function finale() {
        if (newRemoteSaves) {
          window.store.set("save_list", toJson(localSlotList), function() {
            safeCall(null, function() { callback(localSaveList, newRemoteSaves, dirtySaveList); });
          });
        } else {
          safeCall(null, function() {callback(localSaveList, newRemoteSaves, dirtySaveList);});
        }
      }
    });
  });
}

function delayBreakStart(callback) {
  var nowInSeconds = Math.floor(new Date().getTime() / 1000);
  if (!initStore()) {
    safeTimeout(function() {callback(nowInSeconds);}, 0);
    return;
  }
  window.store.get("delayBreakStart", function(ok, value) {
    var valueNum = value*1;
    safeCall(null, function() {
      if (ok && value && !isNaN(valueNum)) {
        callback(valueNum);
      } else {
        window.store.set("delayBreakStart", nowInSeconds);
        callback(nowInSeconds);
      }
    });
  });
}

function delayBreakEnd() {
  if (initStore()) window.store.remove("delayBreakStart");
}

function initStore() {
  if (!window.storeName) return false;
  if (window.store) return window.store;
  try {
    window.store = new Persist.Store(window.storeName);
  } catch (e) {}
  return window.store;
}
function loadAndRestoreGame(slot, forcedScene) {
  function valueLoaded(ok, value) {
    safeCall(null, function() {
      var state = null;
      if (ok && value && ""+value) {
        state = jsonParse(value);
      } else if (window.Persist.type == "androidStorage" && document.cookie) {
        return upgradeAndroidCookies(slot,forcedScene);
      }
      restoreGame(state, forcedScene);
    });
  }
  if (!slot) slot = "";
  if (window.pseudoSave && pseudoSave[""]) return valueLoaded(true, pseudoSave[""]);
  if (!initStore()) return restoreGame(null, forcedScene);
  window.store.get("state"+slot, valueLoaded);
}

// we used to use cookies on some Android devices; now we use androidStorage
function upgradeAndroidCookies(slot, forcedScene) {
  var ck = document.cookie;
  var components = ck.split("; ");
  function upgradeComponent(i) {
    if (!components[i]) {
      loadAndRestoreGame(slot, forcedScene);
      return;
    }
    var parts = components[i].split("=");
    var key = parts[0];
    var deletion = key + "=x; path=/; domain=localhost; expires=Thu, 01-Jan-1970 00:00:01 GMT";
    document.cookie = deletion;
    // key is in the format "storeName:actualKey"
    key = unescape(key).substring(window.storeName.length + 1);
    var value = unescape(parts[1]);
    window.store.set(key, value, function() {
      upgradeComponent(i+1);
    });
  }
  safeCall(this, function() {upgradeComponent(0);});
}

function isStateValid(state) {
  if (!state) return false;
  if (!state.stats) return false;
  if (!state.stats.sceneName) return false;
  return true;
}

function restartGame(shouldPrompt) {
  if (window.blockRestart) {
    asyncAlert("Please wait until the timer has run out.");
    return;
  }
  function actuallyRestart(result) {
    if (!result) return;
    submitAnyDirtySaves();
    clearCookie(function() {}, 'temp');
    clearCookie(function() {
      window.nav.resetStats(window.stats);
      clearScreen(restoreGame);
    }, "");
  }
  if (shouldPrompt) {
    asyncConfirm("Start over from the beginning?", actuallyRestart);
  } else {
    actuallyRestart(true);
  }
}

function restoreGame(state, forcedScene, userRestored) {
    var scene;
    var secondaryMode = null;
    var saveSlot = "";
    var forcedSceneLabel = null;
    if (/\|/.test(forcedScene)) {
      var parts = forcedScene.split("|");
      forcedScene = parts[0];
      forcedSceneLabel = parts[1];
    }
    if (forcedScene == "choicescript_stats") {
      secondaryMode = "stats";
      saveSlot = "temp";
    } else if (forcedScene == "choicescript_upgrade") {
      secondaryMode = "upgrade";
      saveSlot = "temp";
    }
    if (!isStateValid(state)) {
        var startupScene = forcedScene ? forcedScene : window.nav.getStartupScene();
        scene = new Scene(startupScene, window.stats, window.nav, {debugMode:window.debug, secondaryMode:secondaryMode, saveSlot:saveSlot});
    } else {
      if (forcedScene) state.stats.sceneName = forcedScene;
      window.stats = state.stats;
      // Someday, inflate the navigator using the state object
      scene = new Scene(state.stats.sceneName, state.stats, window.nav, {debugMode:state.debug || window.debug, secondaryMode:secondaryMode, saveSlot:saveSlot});
      if (!forcedScene) {
        scene.temps = state.temps;
        scene.lineNum = state.lineNum;
        scene.indent = state.indent;
      }
      if (userRestored) {
        scene.temps.choice_user_restored = true;
        if (state.stats._idoll_checkpoint) {
          scene.targetLabel = {label:state.stats._idoll_checkpoint, origin:"idoll_restore", originLine:0};
        }
      }
    }
    if (forcedSceneLabel !== null) {
      scene.targetLabel = {label:forcedSceneLabel, origin:"url", originLine:0}
    }
    safeCall(scene, scene.execute);
}

function redirectScene(sceneName, label, originLine) {
  var scene = new Scene(sceneName, window.stats, window.nav, {debugMode:window.debug});
  if (label) scene.targetLabel = {label:label, origin:"choicescript_stats", originLine:originLine};
  clearScreen(function() {scene.execute();});
}

tempStatWrites = {};

function transferTempStatWrites() {
  if (!_global.isIosApp) return;
  callIos("transferwrites", JSON.stringify(tempStatWrites));
}

function getCookieByName(cookieName, ck) {
    if (!ck) ck = window.document.cookie;
    if (!ck) return null;
    var ckPairs = ck.split(/;/);
    for (var i = 0; i < ckPairs.length; i++) {
        var ckPair = trim(ckPairs[i]);
        var ckNameValue = ckPair.split(/=/);
        var ckName = decodeURIComponent(ckNameValue[0]);
        if (ckName === cookieName) {
            return decodeURIComponent(ckNameValue[1]);
        }
    }
    return null;
}

function parseQueryString(str) {
  if (!str) return null;
  var map = {};
  var pairs = String(str).substring(1).split("&");
  var i = pairs.length;
  while (i--) {
    var pair = pairs[i];
    var parts = pair.split("=");
    map[parts[0]] = parts[1];
  }
  return map;
}
function trim(str) {
    if (str === null || str === undefined) return null;
    var result = str.replace(/^\s+/g, "");
    // strip leading
    return result.replace(/\s+$/g, "");
    // strip trailing
}


function findOptimalDomain(docDomain) {
    if (!docDomain) docDomain = document.domain;
    // localhost and 127.0.0.1 will cause cookie not to be set; just omit them, it works fine
    if (docDomain == "localhost" || docDomain == "127.0.0.1") return null;
    // ip address
    if (/^\d+\.\d+\.\d+\.\d+$/.test(docDomain)) return null;
    // dotcom
    var result = docDomain.match(/(\w+\.\w{3}$)/);
    if (result) return result[1];
    return null;
}

function num(x, line) {
    if (!line) line = "UNKNOWN";
    var x_num = parseFloat(x);
    if (isNaN(x_num)) throw new Error("line "+line+": Not a number: " + x);
    return x_num;
}

function bool(x, line) {
  if (!line) line = "UNKNOWN";
  if ("boolean" == typeof x) {
    return x;
  } else if ("true" === x) {
    return true;
  } else if ("false" === x) {
    return false;
  }
  throw new Error("line "+line+": Neither true nor false: " + x);
}

function findXhr() {
  var ieFile = isIE && isFile;
  if (window.XMLHttpRequest && !ieFile) return new window.XMLHttpRequest();
  var ids = ['Msxml2.XMLHTTP', 'Microsoft.XMLHTTP', 'Msxml2.XMLHTTP.4.0'];
  for (var i = 0; i < 3; i++) {
    try {
      return new ActiveXObject(ids[i]);
    } catch (e) {}
  }
  throw new Error("Couldn't create XHR object");
}

    crcTable = "00000000 77073096 EE0E612C 990951BA 076DC419 706AF48F E963A535 9E6495A3 0EDB8832 79DCB8A4 E0D5E91E 97D2D988 09B64C2B 7EB17CBD E7B82D07 90BF1D91 1DB71064 6AB020F2 F3B97148 84BE41DE 1ADAD47D 6DDDE4EB F4D4B551 83D385C7 136C9856 646BA8C0 FD62F97A 8A65C9EC 14015C4F 63066CD9 FA0F3D63 8D080DF5 3B6E20C8 4C69105E D56041E4 A2677172 3C03E4D1 4B04D447 D20D85FD A50AB56B 35B5A8FA 42B2986C DBBBC9D6 ACBCF940 32D86CE3 45DF5C75 DCD60DCF ABD13D59 26D930AC 51DE003A C8D75180 BFD06116 21B4F4B5 56B3C423 CFBA9599 B8BDA50F 2802B89E 5F058808 C60CD9B2 B10BE924 2F6F7C87 58684C11 C1611DAB B6662D3D 76DC4190 01DB7106 98D220BC EFD5102A 71B18589 06B6B51F 9FBFE4A5 E8B8D433 7807C9A2 0F00F934 9609A88E E10E9818 7F6A0DBB 086D3D2D 91646C97 E6635C01 6B6B51F4 1C6C6162 856530D8 F262004E 6C0695ED 1B01A57B 8208F4C1 F50FC457 65B0D9C6 12B7E950 8BBEB8EA FCB9887C 62DD1DDF 15DA2D49 8CD37CF3 FBD44C65 4DB26158 3AB551CE A3BC0074 D4BB30E2 4ADFA541 3DD895D7 A4D1C46D D3D6F4FB 4369E96A 346ED9FC AD678846 DA60B8D0 44042D73 33031DE5 AA0A4C5F DD0D7CC9 5005713C 270241AA BE0B1010 C90C2086 5768B525 206F85B3 B966D409 CE61E49F 5EDEF90E 29D9C998 B0D09822 C7D7A8B4 59B33D17 2EB40D81 B7BD5C3B C0BA6CAD EDB88320 9ABFB3B6 03B6E20C 74B1D29A EAD54739 9DD277AF 04DB2615 73DC1683 E3630B12 94643B84 0D6D6A3E 7A6A5AA8 E40ECF0B 9309FF9D 0A00AE27 7D079EB1 F00F9344 8708A3D2 1E01F268 6906C2FE F762575D 806567CB 196C3671 6E6B06E7 FED41B76 89D32BE0 10DA7A5A 67DD4ACC F9B9DF6F 8EBEEFF9 17B7BE43 60B08ED5 D6D6A3E8 A1D1937E 38D8C2C4 4FDFF252 D1BB67F1 A6BC5767 3FB506DD 48B2364B D80D2BDA AF0A1B4C 36034AF6 41047A60 DF60EFC3 A867DF55 316E8EEF 4669BE79 CB61B38C BC66831A 256FD2A0 5268E236 CC0C7795 BB0B4703 220216B9 5505262F C5BA3BBE B2BD0B28 2BB45A92 5CB36A04 C2D7FFA7 B5D0CF31 2CD99E8B 5BDEAE1D 9B64C2B0 EC63F226 756AA39C 026D930A 9C0906A9 EB0E363F 72076785 05005713 95BF4A82 E2B87A14 7BB12BAE 0CB61B38 92D28E9B E5D5BE0D 7CDCEFB7 0BDBDF21 86D3D2D4 F1D4E242 68DDB3F8 1FDA836E 81BE16CD F6B9265B 6FB077E1 18B74777 88085AE6 FF0F6A70 66063BCA 11010B5C 8F659EFF F862AE69 616BFFD3 166CCF45 A00AE278 D70DD2EE 4E048354 3903B3C2 A7672661 D06016F7 4969474D 3E6E77DB AED16A4A D9D65ADC 40DF0B66 37D83BF0 A9BCAE53 DEBB9EC5 47B2CF7F 30B5FFE9 BDBDF21C CABAC28A 53B39330 24B4A3A6 BAD03605 CDD70693 54DE5729 23D967BF B3667A2E C4614AB8 5D681B02 2A6F2B94 B40BBE37 C30C8EA1 5A05DF1B 2D02EF8D";

    /* Number */
    function crc32( /* String */ str, /* Number */ crc ) {
        if( !crc ) crc = 0;
        var n = 0; //a number between 0 and 255 
        var x = 0; //an hex number 

        crc = crc ^ (-1);
        for( var i = 0, iTop = str.length; i < iTop; i++ ) {
            n = ( crc ^ str.charCodeAt( i ) ) & 0xFF;
            x = "0x" + crcTable.substr( n * 9, 8 );
            crc = ( crc >>> 8 ) ^ x;
        }
        return crc ^ (-1);
    }

function simpleDateTimeFormat(date) {
  var day = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"][date.getDay()];
  var month = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][date.getMonth()];
  var minutes = date.getMinutes();
  if (minutes < 10) minutes = "0" + (""+minutes);
  var oneYearInMillis = 1000 * 60 * 60 * 24 * 365;
  var millisAgo = new Date().getTime() - date.getTime();
  var yearString = ""
  if (millisAgo > oneYearInMillis) {
    yearString = ", " + date.getFullYear();
  }
  return day + ", " + month + " " + date.getDate() + yearString + ", " + date.getHours() + ":" + minutes;
}

function jsonParse(str) {
  if (typeof JSON != "undefined") {
    try {
      return JSON.parse(str);
    } catch (e) {
      // try to handle unquoted keys
      try {
        return eval('('+str+')');
      } catch (e2) {
        // that might have failed because eval is forbidden
        try {
          eval("1");
        } catch (e3) {
          // eval forbidden; let's try a hack to fix unquoted keys
          var str2 = (str+"").replace(/([,\{])\s*(\w+)\s*\:/g, '$1"$2":');
          try {
            return JSON.parse(str2);
          } catch (e4) {}
        }
        // at this point, just report a clear error
        return JSON.parse(str);
      }
    }
  } else {
    return eval('('+str+')');
  }
}

function cefQuerySimple(method) {
  cefQuery({
    request:method,
    onSuccess: function(response) {console.log(method + " success");},
    onFailure: function(error_code, error_message) {console.error(method + " error: " + error_message);}
  });
}

shortMonthStrings = [null, "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/parse
// "Given a date string of "March 7, 2014", parse() assumes a local time zone, but given an
// ISO format such as "2014-03-07" it will assume a time zone of UTC for ES5 or local for
// ECMAScript 2015."
function parseDateStringInCurrentTimezone(YYYY_MM_DD, line) {
  var result = /^(\d{4})-(\d{2})-(\d{2})$/.exec(YYYY_MM_DD);
  if (!result) throw new Error("line "+line+": invalid date string " + YYYY_MM_DD);
  var fullYear = result[1];
  var oneBasedMonthNumber = parseInt(result[2],10);
  var dayOfMonth = parseInt(result[3],10);
  var shortMonthString = shortMonthStrings[oneBasedMonthNumber];
  return new Date(shortMonthString + " " + dayOfMonth + ", " + fullYear);
}
/*
 * Copyright 2010 by Dan Fabulich.
 *
 * Dan Fabulich licenses this file to you under the
 * ChoiceScript License, Version 1.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *  http://www.choiceofgames.com/LICENSE-1.0.txt
 *
 * See the License for the specific language governing
 * permissions and limitations under the License.
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied.
 */


function printx(msg, parent) {
    if (msg === null || msg === undefined || msg === "") return;
    if (!parent) parent = document.getElementById('text');
    if (msg == " ") {
      // IE7 doesn't like innerHTML that's nothing but " "
      parent.appendChild(document.createTextNode(" "));
      return;
    }
    msg = (msg+"").replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/\[n\/\]/g, '<br>')
      .replace(/\[b\]/g, '<b>')
      .replace(/\[\/b\]/g, '</b>')
      .replace(/\[i\]/g, '<i>')
      .replace(/\[\/i\]/g, '</i>');
    var frag = document.createDocumentFragment();
    temp = document.createElement('div');
    temp.innerHTML = msg;
    while (temp.firstChild) {
        frag.appendChild(temp.firstChild);
    }
    parent.appendChild(frag);
}

function println(msg, parent) {
    if (!parent) parent = document.getElementById('text');
    printx(msg, parent);
    var br = window.document.createElement("br");
    parent.appendChild(br);
}


function showStats() {
    if (document.getElementById('loading')) return;
    var button = document.getElementById("statsButton");
    if (button && button.innerHTML == "Return to the Game") {
      setButtonTitles();
      return clearScreen(loadAndRestoreGame);
    }
    setButtonTitles();
    var currentScene = window.stats.scene;
    var scene = new Scene("choicescript_stats", window.stats, this.nav, {secondaryMode:"stats", saveSlot:"temp"});
    main.innerHTML = "<div id='text'></div>";
    scene.execute();
}

function redirectFromStats(scene, label, originLine, callback) {
  if (window.isIosApp) {
    if (!label) label = "";
    callIos("redirectfromstats", scene + " " +label  + " " + originLine);
  } else if (window.isAndroidApp) {
    statsMode.redirectFromStats(scene, label || "", originLine);
  } else {
    safeTimeout(callback, 0);
  }
}

function showAchievements(hideNextButton) {
  if (document.getElementById('loading')) return;
  var button = document.getElementById("achievementsButton");
  if (!button) return;
  if (button.innerHTML == "Return to the Game") {
    setButtonTitles();
    return clearScreen(loadAndRestoreGame);
  }
  setButtonTitles();
  button.innerHTML = "Return to the Game";
  clearScreen(function() {
    checkAchievements(function() {
      printAchievements(document.getElementById("text"));
      if (!hideNextButton) printButton("Next", main, false, function() {
        setButtonTitles();
        clearScreen(loadAndRestoreGame);
      });
    });
  });
}

function showMenu() {
  if (document.getElementById('loading')) return;
  var button = document.getElementById("menuButton");
  if (!button) return;
  if (button.innerHTML == "Return to the Game") {
    button.innerHTML = "Menu";
    return clearScreen(loadAndRestoreGame);
  }
  setButtonTitles();
  button.innerHTML = "Return to the Game";
  function menu() {
    options = [
      {name:"Return to the game.", group:"choice", resume:true},
      /*{name:"View the credits.", group:"choice", credits:true},
      {name:"Play more games like this.", group:"choice", moreGames:true},
      {name:"Email us at " + getSupportEmail() + ".", group:"choice", contactUs:true},
      {name:"Share this game with friends.", group:"choice", share:true},
      {name:"Email me when new games are available.", group:"choice", subscribe:true},*/
      {name:"Make the text bigger or smaller.", group:"choice", fontSizeMenu:true},
      {name:"Change the background color.", group:"choice", background:true},
    ];
    printOptions([""], options, function(option) {
      if (option.resume) {
        setButtonTitles();
        return clearScreen(loadAndRestoreGame);
      } else if (option.credits) {
        absolutizeAboutLink();
        aboutClick();
      } else if (option.moreGames) {
        moreGames();
        curl();
      } else if (option.share) {
        clearScreen(function() {
          printShareLinks(document.getElementById("text"), "now");
          menu();
        });
      } else if (option.subscribe) {
        setButtonTitles();
        subscribeLink();
      } else if (option.contactUs) {
        window.location.href="mailto:"+getSupportEmail();
      } else if (option.fontSizeMenu) {
        fontSizeMenu();
      } else if (option.background) {
        backgroundColorMenu();
      }
    });
  }
  clearScreen(menu);
}

function setButtonTitles() {
  var button;
  button = document.getElementById("menuButton");
  if (button) {
    if (window.isWeb) {
      menuButton.innerHTML = "Settings";
    } else {
      button.innerHTML = "Menu";
    }
  }
  button = document.getElementById("statsButton");
  if (button) {
    button.innerHTML = "Show Stats";
  }
  button = document.getElementById("achievementsButton");
  if (button) {
    if (nav.achievementList.length) {
      button.style.display = "";
      button.innerHTML = "Achievements";
    } else {
      button.style.display = "none";
    }
  }
}

function fontSizeMenu() {
  clearScreen(function() {
    var text = document.getElementById("text");
    var oldZoom = getZoomFactor();
    text.innerHTML = "<p>Make the text bigger or smaller.</p>";
    options = [
      {name:"Return to the game.", group:"choice", resume:true},
      {name:"Make the text bigger.", group:"choice", bigger:true},
      {name:"Make the text smaller.", group:"choice", smaller:true},
    ];
    if (oldZoom <= 0.5) {
      options[options.length-1].unselectable = true;
    }
    if (oldZoom !== 1) {
      options.push({name:"Reset the text to its original size.", group:"choice", reset:true});
    }
    printOptions([""], options, function(option) {
      if (option.resume) {
        setButtonTitles();
        return clearScreen(loadAndRestoreGame);
      } else if (option.reset) {
        setZoomFactor(1);
        fontSizeMenu();
      } else {
        changeFontSize(option.bigger);
        fontSizeMenu();
      }
    })
  });
}

function textOptionsMenu() {
  clearScreen(function() {
    var text = document.getElementById("text");
    var oldZoom = getZoomFactor();
    text.innerHTML = "<p>Change the size and color of the text.</p>";
    options = [
      {name:"Return to the game.", group:"choice", resume:true},
      {name:"Make the text bigger.", group:"choice", bigger:true},
      {name:"Make the text smaller.", group:"choice", smaller:true},
    ];
    if (oldZoom <= 0.5) {
      options[options.length-1].unselectable = true;
    }
    if (oldZoom !== 1) {
      options.push({name:"Reset the text to its original size.", group:"choice", reset:true});
    }
    options.push(
      {name:"Use a black background.", group:"choice", color:"black"},
      {name:"Use a sepia background.", group:"choice", color:"sepia"},
      {name:"Use a white background.", group:"choice", color:"white"}
    );
    printOptions([""], options, function(option) {
      if (option.resume) {
        setButtonTitles();
        return clearScreen(loadAndRestoreGame);
      } else if (option.color) {
        changeBackgroundColor(option.color);
      } else if (option.reset) {
        setZoomFactor(1);
        textOptionsMenu();
      } else {
        changeFontSize(option.bigger);
        textOptionsMenu();
      }
      curl();
    })
    curl();
  });
}

function getZoomFactor() {
  if (document.body.style.zoom === undefined) {
    return window.zoomFactor || 1;
  } else {
    var zoomFactor = parseFloat(document.body.style.zoom);
    if (isNaN(zoomFactor)) zoomFactor = 1;
    return zoomFactor;
  }
}

function setZoomFactor(zoomFactor) {
  if (document.body.style.zoom === undefined) {
    var initialMaxWidth = 680;
    document.body.style.maxWidth = (initialMaxWidth / zoomFactor) + "px";
    document.body.style.transformOrigin = "center top";
    document.body.style.transform = "scale("+zoomFactor+")";
    window.zoomFactor = zoomFactor;
  } else {
    document.body.style.zoom = zoomFactor;
  }
  if (initStore()) store.set("preferredZoom", String(zoomFactor));
}

function changeFontSize(bigger) {
  var oldZoom = getZoomFactor();
  if (bigger) {
    setZoomFactor(oldZoom + 0.1);
  } else {
    setZoomFactor(oldZoom - 0.1);
  }
}

function changeBackgroundColor(color) {
  if (color === "sepia") {
    document.body.classList.remove("nightmode", "whitemode");
  } else if (color === "black") {
    document.body.classList.remove("whitemode");
    document.body.classList.add("nightmode");
  } else if (color === "white") {
    document.body.classList.remove("nightmode");
    document.body.classList.add("whitemode");
  }
  if (initStore()) store.set("preferredBackground", color);
}

function backgroundColorMenu() {
  clearScreen(function() {
    var text = document.getElementById("text");
    text.innerHTML = "<p>Change the background color.</p>";
    options = [
      {name:"Return to the game.", group:"choice", resume:true},
      {name:"Use a black background.", group:"choice", color:"black"},
      {name:"Use a sepia background.", group:"choice", color:"sepia"},
      {name:"Use a white background.", group:"choice", color:"white"},
    ];
    printOptions([""], options, function(option) {
      if (option.resume) {
        setButtonTitles();
        return clearScreen(loadAndRestoreGame);
      } else {
        changeBackgroundColor(option.color);
      }
    })
  });
}



function spell(num) {
  if (num > 99) return num;
  var smallNumbers = ["zero", "one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten", "eleven", "twelve", "thirteen", "fourteen", "fifteen", "sixteen", "seventeen", "eighteen", "nineteen"];
  var tens = ["zero", "ten", "twenty", "thirty", "forty", "fifty", "sixty", "seventy", "eighty", "ninety"];
  if (num < 20) {
    return smallNumbers[num];
  }
  var onesDigit = num % 10;
  if (onesDigit === 0) {
    return tens[num / 10];
  }
  var tensDigit = (num - onesDigit) / 10;
  return tens[tensDigit]+"-"+smallNumbers[onesDigit];
}

function printAchievements(target) {
  var unlockedBuffer = [];
  var lockedBuffer = [];
  var achievedCount = 0, hiddenCount = 0, score = 0, totalScore = 0;
  var totalAchievements = nav.achievementList.length;
  var buffer;
  for (var i = 0; i < totalAchievements; i++) {
    var name = nav.achievementList[i];
    var achievement = nav.achievements[name];
    var points = achievement.points;
    totalScore += points;

    var description;

    if (nav.achieved[name]) {
      achievedCount++;
      score += points;
      buffer = unlockedBuffer;
      description = achievement.earnedDescription;
    } else {
      if (achievement.visible) {
        buffer = lockedBuffer;
        description = achievement.preEarnedDescription;
      } else {
        hiddenCount++;
        continue;
      }
    }

    if (buffer.length) buffer.push("<br>");
    buffer.push("<b>");
    buffer.push(achievement.title.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'));
    buffer.push(":");
    buffer.push("</b> ");
    buffer.push(description.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;')
      .replace(/\[b\]/g, '<b>')
      .replace(/\[\/b\]/g, '</b>')
      .replace(/\[i\]/g, '<i>')
      .replace(/\[\/i\]/g, '</i>')
    );
    buffer.push(" (");
    buffer.push(points);
    buffer.push(" points)");
  }

  // What if there's exactly one achievement worth exactly one point?
  if (achievedCount === 0) {
    if (hiddenCount === 0) {
      buffer = ["You haven't unlocked any achievements yet. There are "+spell(totalAchievements)+" possible achievements, worth a total of "+totalScore+" points.<p>"];
    } else if (hiddenCount == 1) {
      buffer = ["You haven't unlocked any achievements yet. There are "+spell(totalAchievements)+" possible achievements (including one hidden achievement), worth a total of "+totalScore+" points.<p>"];
    } else if (hiddenCount == totalAchievements) {
      buffer = ["You haven't unlocked any achievements yet. There are "+spell(totalAchievements)+" hidden achievements, worth a total of "+totalScore+" points.<p>"];
    } else {
      buffer = ["You haven't unlocked any achievements yet. There are "+spell(totalAchievements)+" possible achievements (including "+spell(hiddenCount)+" hidden achievements), worth a total of "+totalScore+" points.<p>"];
    }
    if (lockedBuffer.length) {
      buffer.push.apply(buffer, lockedBuffer);
      buffer.push("<p>");
    }
  } else if (score == totalScore) {
    if (totalAchievements == 2) {
      buffer = ["Congratulations! You have unlocked both achievements, earning a total of "+score+" points, a perfect score.<p>"];
    } else {
      buffer = ["Congratulations! You have unlocked all "+spell(totalAchievements)+" achievements, earning a total of "+score+" points, a perfect score.<p>"];
    }
    buffer.push.apply(buffer, unlockedBuffer);
    buffer.push("<p>");
  } else {
    buffer = ["You have unlocked "+spell(achievedCount)+" out of "+spell(totalAchievements)+" possible achievements, earning you a score of "+score+" out of a possible "+totalScore+" points.<p>"];
    buffer.push.apply(buffer, unlockedBuffer);
    var remaining = totalAchievements-achievedCount;
    if (remaining == hiddenCount) {
      if (remaining == 1) {
        buffer.push("<p>There is still one hidden achievement remaining.<p>");
      } else {
        buffer.push("<p>There are still " + spell(remaining) + " hidden achievements remaining.<p>");
      }
    } else if (hiddenCount > 1) {
      buffer.push("<p>There are still "+spell(remaining)+" achievements remaining, including "+spell(hiddenCount)+" hidden achievements.<p>");
    } else if (hiddenCount == 1) {
      buffer.push("<p>There are still "+spell(remaining)+" achievements remaining, including one hidden achievement.<p>");
    } else if (remaining == 1) {
      buffer.push("<p>There is still one achievement remaining.<p>");
    } else {
      buffer.push("<p>There are still "+spell(remaining)+" achievements remaining.<p>");
    }
    if (lockedBuffer.length) {
      buffer.push.apply(buffer, lockedBuffer);
      buffer.push("<p>");
    }
  }

  target.innerHTML = buffer.join("");
}

// in the iOS app, display a page curl animation
function curl() {
  // TODO force a reflow before curling the page
  callIos("curl");
}

function asyncAlert(message, callback) {
  if (!callback) callback = function(){};
  if (window.isIosApp) {
    window.alertCallback = callback;
    callIos("alert", message);
  } else if (window.isAndroidApp) {
    setTimeout(function() {
      alert(message);
      if (callback) callback();
    }, 0);
  } else if (window.isWinOldApp) {
    setTimeout(function() {
      window.external.Alert(message);
      if (callback) callback();
    }, 0);
  } else {
    alertify.alert(message, function() {safeCall(null, callback);});
  }
}

function asyncConfirm(message, callback) {
  if (false/*window.isIosApp*/) {
    // TODO asyncConfirm
    window.confirmCallback = callback;
    callIos("confirm", message);
  } else if (window.isAndroidApp) {
    setTimeout(function() {
      var result = confirm(message);
      if (callback) callback(result);
    }, 0);
  } else if (window.isWinOldApp) {
    setTimeout(function() {
      var result = window.external.Confirm(message);
      if (callback) callback(result);
    }, 0);
  } else {
    alertify.confirm(message, function(result) {safeCall(null, callback(result));});
  }
}


function clearScreen(code) {
    // can't create div via innerHTML; div mysteriously doesn't show up on iOS
    main.innerHTML = "";
    var text = document.createElement("div");
    text.setAttribute("id", "text");
    main.appendChild(text);



    var useAjax = true;
    if (isWeb && window.noAjax) {
      useAjax = false;
    }

    if (useAjax) {
      doneLoading();
      setTimeout(function() {
        if (window.isChromeApp) {
          document.body.firstElementChild.scrollIntoView();
        } else {
          window.scrollTo(0,0);
          if (window.isIosApp || (window.isSafari && window.isMobile && !window.isAndroid)) {
            // focus on text for iOS Voiceover
            main.setAttribute("tabindex", "-1");
            main.focus();
          }
        }
      }, 0);
      safeCall(null, code);
    } else {
      if (!initStore()) alert("Your browser has disabled cookies; this game requires cookies to work properly.  Please re-enable cookies and refresh this page to continue.");
      startLoading();
      var form = window.document.createElement("form");
      var axn = window.location.protocol + "//" + window.location.host + window.location.pathname;
      form.setAttribute("action", axn);
      form.setAttribute("method", "POST");
      main.appendChild(form);
      form.submit();
    }
}

function safeSubmit(code) {
    return function safelySubmitted() {
        safeCall(code);
        return false;
    };
}

function startLoading() {
    var loading = document.getElementById('loading');
    if (!loading) {
      safeCall(null, function() {
        loading = document.createElement('div');
        loading.setAttribute("id", "loading");
        loading.innerHTML = "<p>Loading...</p><p>"+
          (/MSIE [67]/.test(navigator.userAgent)?"":"<img src=\"data:image/gif;base64,R0lGODlhgAAPAPEAAPf08WJhYMvJx2JhYCH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAgAAPAAACo5QvoIC33NKKUtF3Z8RbN/55CEiNonMaJGp1bfiaMQvBtXzTpZuradUDZmY+opA3DK6KwaQTCbU9pVHc1LrDUrfarq765Ya9u+VRzLyO12lwG10yy39zY11Jz9t/6jf5/HfXB8hGWKaHt6eYyDgo6BaH6CgJ+QhnmWWoiVnI6ddJmbkZGkgKujhplNpYafr5OooqGst66Uq7OpjbKmvbW/p7UAAAIfkECQoAAAAsAAAAAIAADwAAArCcP6Ag7bLYa3HSZSG2le/Zgd8TkqODHKWzXkrWaq83i7V5s6cr2f2TMsSGO9lPl+PBisSkcekMJphUZ/OopGGfWug2Jr16x92yj3w247bh6teNXseRbyvc0rbr6/x5Ng0op4YSJDb4JxhI58eliEiYYujYmFi5eEh5OZnXhylp+RiaKQpWeDf5qQk6yprawMno2nq6KlsaSauqS5rLu8cI69k7+ytcvGl6XDtsyzxcAAAh+QQJCgAAACwAAAAAgAAPAAACvpw/oIC3IKIUb8pq6cpacWyBk3htGRk1xqMmZviOcemdc4R2kF3DvfyTtFiqnPGm+yCPQdzy2RQMF9Moc+fDArU0rtMK9SYzVUYxrASrxdc0G00+K8ruOu+9tmf1W06ZfsfXJfiFZ0g4ZvEndxjouPfYFzk4mcIICJkpqUnJWYiYs9jQVpm4edqJ+lkqikDqaZoquwr7OtHqAFerqxpL2xt6yQjKO+t7bGuMu1L8a5zsHI2MtOySVwo9fb0bVQAAIfkECQoAAAAsAAAAAIAADwAAAsucP6CAt9zSErSKZyvOd/KdgZaoeaFpRZKiPi1aKlwnfzBF4jcNzDk/e7EiLuLuhzwqayfmaNnjCCGNYhXqw9qcsWjT++TqxIKp2UhOprXf7PoNrpyvQ3p8fAdu82o+O5w3h2A1+Nfl5geHuLgXhEZVWBeZSMnY1oh5qZnyKOhgiGcJKHqYOSrVmWpHGmpauvl6CkvhaUD4qejaOqvH2+doV7tSqdsrexybvMsZrDrJaqwcvSz9i9qM/Vxs7Qs6/S18a+vNjUx9/v1TAAAh+QQJCgAAACwAAAAAgAAPAAAC0Zw/oIC33NKKUomLxct4c718oPV5nJmhGPWwU9TCYTmfdXp3+aXy+wgQuRRDSCN2/PWAoqVTCSVxilQZ0RqkSXFbXdf3ZWqztnA1eUUbEc9wm8yFe+VguniKPbNf6mbU/ubn9ieUZ6hWJAhIOKbo2Pih58C3l1a5OJiJuflYZidpgHSZCOnZGXc6l3oBWrE2aQnLWYpKq2pbV4h4OIq1eldrigt8i7d73Ns3HLjMKGycHC1L+hxsXXydO9wqOu3brPnLXL3C640sK+6cTaxNflEAACH5BAkKAAAALAAAAACAAA8AAALVnD+ggLfc0opS0SeyFnjn7oGbqJHf4mXXFD2r1bKNyaEpjduhPvLaC5nJEK4YTKhI1ZI334m5g/akJacAiDUGiUOHNUd9ApTgcTN81WaRW++Riy6Tv/S4dQ1vG4ps4NwOaBYlOEVYhYbnplexyJf3ZygGOXkWuWSZuNel+aboV0k5GFo4+qN22of6CMoq2kr6apo6m5fJWCoZm+vKu2Hr6KmqiHtJLKebRhuszNlYZ3ncewh9J9z8u3mLHA0rvetrzYjd2Wz8bB6oNO5MLq6FTp2+bVUAACH5BAkKAAAALAAAAACAAA8AAALanD+ggLfc0opS0XeX2Fy8zn2gp40ieHaZFWHt9LKNO5eo3aUhvisj6RutIDUZgnaEFYnJ4M2Z4210UykQ8BtqY0yHstk1UK+/sdk63i7VYLYX2sOa0HR41S5wi7/vcMWP1FdWJ/dUGIWXxqX3xxi4l0g4GEl5yOHIBwmY2cg1aXkHSjZXmbV4uoba5kkqelbaapo6u0rbN/SZG7trKFv7e6savKTby4voaoVpNAysiXscV4w8fSn8fN1pq1kd2j1qDLK8yYy9/ff9mgwrnv2o7QwvGO1ND049UgAAIfkECQoAAAAsAAAAAIAADwAAAticP6CAt9zSilLRd2d8onvBfV0okp/pZdamNRi7ui3yyoo4Ljio42h+w6kgNiJt5kAaasdYE7D78YKlXpX6GWphxqTT210qK1Cf9XT2SKXbYvv5Bg+jaWD5ekdjU9y4+PsXRuZHRrdnZ5inVidAyCTXF+nGlVhpdjil2OE49hjICVh4qZlpibcDKug5KAlHOWqqR8rWCjl564oLFruIucaYGlz7+XoKe2wsIqxLzMxaxIuILIs6/JyLbZsdGF063Uu6vH2tXc79LZ1MLWS96t4JH/rryzhPWgAAIfkECQoAAAAsAAAAAIAADwAAAtWcP6CAt9zSilLRd2fEe4kPCk8IjqTonZnVsQ33arGLwLV8Kyeqnyb5C60gM2LO6MAlaUukwdbcBUspYFXYcla00KfSywRzv1vpldqzprHFoTv7bsOz5jUaUMer5vL+Mf7Hd5RH6HP2AdiUKLa41Tj1Acmjp0bJFuinKKiZyUhnaBd5OLnzSNbluOnZWQZqeVdIYhqWyop6ezoquTs6O0aLC5wrHErqGnvJibms3LzKLIYMe7xnO/yL7TskLVosqa1aCy3u3FrJbSwbHpy9fr1NfR4fUgAAIfkECQoAAAAsAAAAAIAADwAAAsqcP6CAt9zSilLRd2fEW7cnhKIAjmFpZla3fh7CuS38OrUR04p5Ljzp46kgMqLOaJslkbhbhfkc/lAjqmiIZUFzy2zRe5wGTdYQuKs9N5XrrZPbFu94ZYE6ms5/9cd7/T824vdGyIa3h9inJQfA+DNoCHeomIhWGUcXKFIH6RZZ6Bna6Zg5l8JnSamayto2WtoI+4jqSjvZelt7+URKpmlmKykM2vnqa1r1axdMzPz5LLooO326Owxd7Bzam4x8pZ1t3Szu3VMOdF4AACH5BAkKAAAALAAAAACAAA8AAAK/nD+ggLfc0opS0XdnxFs3/i3CSApPSWZWt4YtAsKe/DqzXRsxDqDj6VNBXENakSdMso66WzNX6fmAKCXRasQil9onM+oziYLc8tWcRW/PbGOYWupG5Tsv3TlXe9/jqj7ftpYWaPdXBzbVF2eId+jYCAn1KKlIApfCSKn5NckZ6bnJpxB2t1kKinoqJCrlRwg4GCs4W/jayUqamaqryruES2b72StsqgvsKlurDEvbvOx8mzgazNxJbD18PN1aUgAAIfkECQoAAAAsAAAAAIAADwAAArKcP6CAt9zSilLRd2fEWzf+ecgjlKaQWZ0asqPowAb4urE9yxXUAqeZ4tWEN2IOtwsqV8YkM/grLXvTYbV4PTZpWGYU9QxTxVZyd4wu975ZZ/qsjsPn2jYpatdx62b+2y8HWMTW5xZoSIcouKjYePeTh7TnqFcpabmFSfhHeemZ+RkJOrp5OHmKKapa+Hiyyokaypo6q1CaGDv6akoLu3DLmLuL28v7CdypW6vsK9vsE1UAACH5BAkKAAAALAAAAACAAA8AAAKjnD+ggLfc0opS0XdnxFs3/nkISI2icxokanVt+JoxC8G1fNOlm6tp1QNmZj6ikDcMrorBpBMJtT2lUdzUusNSt9qurvrlhr275VHMvI7XaXAbXTLLf3NjXUnP23/qN/n8d9cHyEZYpoe3p5jIOCjoFofoKAn5CGeZZaiJWcjp10mZuRkaSAq6OGmU2lhp+vk6iioay3rpSrs6mNsqa9tb+ntQAAA7AAAAAAAAAAAA\">")+
          "</p>";
        main.appendChild(loading);
      });
    }
}

function doneLoading() {
    var loading = document.getElementById('loading');
    if (loading) loading.parentNode.removeChild(loading);
    // TODO update header?
}

function setClass(element, classString) {
  element.setAttribute("class", classString);
  element.setAttribute("className", classString);
}

function printFooter() {
  // var footer = document.getElementById('footer');
  // We could put anything we want in the footer here, but perhaps we should avoid it.
  var statsButton = document.getElementById("statsButton");
  if (statsButton) {
    if (window.stats.scene.secondaryMode == "stats") {
      statsButton.innerHTML = "Return to the Game";
    } else {
      statsButton.innerHTML = "Show Stats";
      if (window.isAndroidApp && window.statsMode.get()) {
        showStats();
      }
    }
  }
  curl();
}

// retrieve value of HTML form
function getFormValue(name) {
    var field = document.forms[0][name];
    if (!field) return "";
    // may return either one field or an array of fields
    if (field.checked) return field.value;
    for (var i = 0; i < field.length; i++) {
        var element = field[i];
        if (element.checked) return element.value;
    }
    return null;
}

function printOptions(groups, options, callback) {
  var form = document.createElement("form");
  main.appendChild(form);
  var self = this;
  form.action="#";
  form.onsubmit = function() {
      safeCall(self, function() {
        var currentOptions = options;
        var option, group;
        for (var i = 0; i < groups.length; i++) {
            if (i > 0) {
                currentOptions = option.suboptions;
            }
            group = groups[i];
            if (!group) group = "choice";
            var value = getFormValue(group);
            if (value === null || value === undefined) {
              if (groups.length == 1) {
                asyncAlert("Please choose one of the available options first.");
              } else {
                var article = "a";
                if (/^[aeiou].*/i.test(group)) article = "an";
                asyncAlert("Please choose " + article + " " + group + " first.");
              }
              return;
            }
            option = currentOptions[value];
        }

        if (groups.length > 1 && option.unselectable) {
          asyncAlert("Sorry, that combination of choices is not allowed. Please select a different " + groups[groups.length-1] + ".");
          return;
        }
        safeCall(null, function() {callback(option);});
      });
      return false;
  };

  if (!options) throw new Error(this.lineMsg()+"undefined options");
  if (!options.length) throw new Error(this.lineMsg()+"no options");
  // global num will be used to assign accessKeys to the options
  var globalNum = 1;
  var currentOptions = options;
  var div = document.createElement("div");
  form.appendChild(div);
  setClass(div, "choice");
  for (var groupNum = 0; groupNum < groups.length; groupNum++) {
      var group = groups[groupNum];
      if (group) {
          var textBuilder = ["Select "];
          textBuilder.push(/^[aeiou]/i.test(group)?"an ":"a ");
          textBuilder.push(group);
          textBuilder.push(":");

          var p = document.createElement("p");
          p.appendChild(document.createTextNode(textBuilder.join("")));
          div.appendChild(p);
      }
      var checked = null;
      for (var optionNum = 0; optionNum < currentOptions.length; optionNum++) {
          var option = currentOptions[optionNum];
          if (!checked && !option.unselectable) checked = option;
          var isLast = (optionNum == currentOptions.length - 1);
          printOptionRadioButton(div, group, option, optionNum, globalNum++, isLast, checked == option);
      }
      // for rendering, the first options' suboptions should be as good as any other
      currentOptions = currentOptions[0].suboptions;
  }

  form.appendChild(document.createElement("br"));

  var useRealForm = false;
  if (useRealForm) {
    printButton("Next", form, false);
  } else {
    printButton("Next", main, false, function() {
      form.onsubmit();
    });
  }
}

function printOptionRadioButton(div, name, option, localChoiceNumber, globalChoiceNumber, isLast, checked) {
    var line = option.name;
    var unselectable = false;
    if (!name) unselectable = option.unselectable;
    var disabledString = unselectable ? " disabled" : "";
    var id = name + localChoiceNumber;
    if (!name) name = "choice";
    var radio;
    var div2 = document.createElement("div");
    var label = document.createElement("label");
    // IE doesn't allow you to dynamically specify the name of radio buttons
    if (!/^\w+$/.test(name)) throw new Error("invalid choice group name: " + name);
    label.innerHTML = "<input type='radio' name='"+name+
            "' value='"+localChoiceNumber+"' id='"+id+
            "' "+(checked?"checked":"")+disabledString+">";

    label.setAttribute("for", id);
    if (localChoiceNumber === 0) {
      if (isLast) {
        setClass(label, "onlyChild"+disabledString);
      } else {
        setClass(label, "firstChild"+disabledString);
      }
    } else if (isLast) {
      setClass(label, "lastChild"+disabledString);
    } else if (unselectable) {
      setClass(label, "disabled");
    }
    label.setAttribute("accesskey", globalChoiceNumber);
    if (!unselectable) {
      if (window.Touch) { // Make labels clickable on iPhone
          label.onclick = function labelClick(evt) {
              try {
                var target = evt.target;
                if (!/label/i.test(target.tagName)) return;
                var button = document.getElementById(target.getAttribute("for"));
                button.checked = true;
              } catch (e) {}
          };
      } else if (/MSIE 6/.test(navigator.userAgent)) {
        label.onclick = function labelClick() {
          try {
            var target = window.event.srcElement;
            if (!/label/i.test(target.tagName)) return;
            var button = document.getElementById(target.getAttribute("for"));
            button.checked = true;
          } catch (e) {}
        };
      }
    }
    printx(line, label);
    
    div2.appendChild(label);
    div.appendChild(div2);
}

function printImage(source, alignment, alt, invert) {
  var img = document.createElement("img");
  img.src = source;
  if (alt !== null && String(alt).length > 0) img.setAttribute("alt", alt);
  if (invert) {
    setClass(img, "invert align"+alignment);
  } else {
    setClass(img, "align"+alignment);
  }
  document.getElementById("text").appendChild(img);
}

function playSound(source) {
  for (var existingAudios = document.getElementsByTagName("audio"); existingAudios.length;) {
    existingAudios[0].parentNode.removeChild(existingAudios[0]);
  }
  var audio = document.createElement("audio");
  if (audio.play) {
    audio.setAttribute("src", source);
    document.body.appendChild(audio);
    audio.play();
  }
}

function printYoutubeFrame(slug) {
  var wrapper = document.createElement("div");
  setClass(wrapper, "videoWrapper");
  var iframe = document.createElement("iframe");
  iframe.width="560";
  iframe.height="315";
  iframe.src="https://www.youtube.com/embed/"+slug;
  iframe.setAttribute("frameborder", 0);
  iframe.setAttribute("allowfullscreen", true);
  wrapper.appendChild(iframe);
  document.getElementById("text").appendChild(wrapper);
}

function moreGames() {
    if (window.isIosApp) {
      window.location.href = "itms-apps://itunes.com/apps/choiceofgames";
    } else if (window.isAndroidApp) {
      if (window.isNookAndroidApp) {
        asyncAlert("Please search the Nook App Store for \"Choice of Games\" for more games like this!");
        return;
      }
      if (window.isAmazonAndroidApp) {
        var androidLink = document.getElementById('androidLink');
        if (androidLink && androidLink.href) {
          androidUrl = androidLink.href;
          var package = /id=([\.\w]+)/.exec(androidUrl)[1];
          window.location.href = "http://www.amazon.com/gp/mas/dl/android?p="+package+"&showAll=1&t=choofgam-20&ref=moreGames";
        } else {
          window.location.href = "http://www.amazon.com/gp/mas/dl/android?p=com.choiceofgames.dragon&showAll=1&t=choofgam-20&ref=moreGames";
        }
      } else {
        window.location.href = "market://search?q=pub:%22Choice+of+Games+LLC";
      }
    } else if (window.isSteamApp) {
      window.location.href = "https://www.choiceofgames.com/steam-curation.php";
    } else {
      try {
        if (window.isChromeApp) {
          window.open("https://www.choiceofgames.com/category/our-games/");
        } else {
          window.location.href = "https://www.choiceofgames.com/category/our-games/";
        }
      } catch (e) {
        // in xulrunner, this will be blocked, but it will trigger opening the external browser
      }
    }
}

function printShareLinks(target, now) {
  if (!target) target = document.getElementById('text');
  var msgDiv = document.createElement("div");
  if (window.isIosApp) {
    if (now) {
      callIos("share");
      return;
    }
    var button = document.createElement("button");
    button.appendChild(document.createTextNode("Share This Game"));
    button.onclick = function() {
      callIos("share");
    };
    msgDiv.appendChild(button);
    msgDiv.appendChild(document.createElement("br")); // insert our own paragraph break, to match <ul>
    msgDiv.appendChild(document.createElement("br"));
    target.appendChild(msgDiv);
    return;
  }

  var mobileMesg = "";
  if (window.isAndroidApp) {
    var androidLink = document.getElementById('androidLink');
    var androidUrl;
    if (window.isNookAndroidApp) {
      if (window.nookEan && nookEan != "UNKNOWN") {
        mobileMesg = "  <li><a href='choiceofgamesnook://"+window.nookEan+"'>Rate this app</a> in the Nook App Store</li>\n";
      }
    } else if (androidLink) {
      androidUrl = androidLink.href;
      if (androidUrl) {
        if (window.isAmazonAndroidApp) {
          var package = /id=([\.\w]+)/.exec(androidUrl)[1];
          androidUrl = "http://www.amazon.com/gp/mas/dl/android?p="+package+"&t=choofgam-20&ref=rate";
          mobileMesg = "  <li><a href='"+androidUrl+"'>Rate this app</a> in the Amazon Appstore</li>\n";
        } else {
          mobileMesg = "  <li><a href='"+androidUrl+"'>Rate this app</a> in the Google Play Store</li>\n";
        }

      }
    }
  } else if (/webOS/.test(navigator.userAgent) && window.isFile) {
    var palmLink = document.getElementById('palmLink');
    var palmUrl;
    if (palmLink) {
      palmUrl = palmLink.href;
      if (palmUrl) {
        mobileMesg = "  <li><a href='"+palmUrl+"'>Rate this app</a> in the Palm App Catalog</li>\n";
      }
    }
  } else if (window.isChromeApp) {
    var chromeLink = document.getElementById('chromeLink');
    var chromeUrl;
    if (chromeLink) {
      chromeUrl = chromeLink.href;
      if (chromeUrl) {
        mobileMesg = "  <li><a href='"+chromeUrl+"/reviews'>Rate this app</a> in the Chrome Web Store</li>\n";
      }
    }
  }

  var url = window.location.href;
  var links = document.getElementsByTagName("link");
  for (var i = links.length - 1; i >= 0; i--) {
    if (links[i].getAttribute("rel") == "canonical") {
      url = links[i].getAttribute("href") || url;
      break;
    }
  }

  if (/^\//.test(url)) {
    if (window.isWeb) {
      url = window.location.protocol + "//" + window.location.hostname + url;
    } else {
      url = "https://www.choiceofgames.com" + url;
    }
  }

  url = encodeURIComponent(url);
  var title = encodeURIComponent(document.title);
  var dataUriSupported = !/MSIE [67]/.test(navigator.userAgent);

  var shareLinkText = '<li>'+(dataUriSupported?'<img height="16" width="16" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAACNFBMVEUAAAD///8ASZIASpIKTI0KSIcWSX5lgZ1YcIhYbYIAUpsHTpAhVIEAWaUAWaIAVp4AU5wAVJsAVJgAUpYAUpUBWaQWU4cAYqoAXqUAW6MAXKMAWqIAXKAFXZ8IWZZihZ8AbrgAbrcAaK0AZaoDbLIFZakGZqoKbrMAb7gAbrYBc7tsm7mizecge62izuiizeYBbqgId7INh8QQdqgXg7kVeK0fgLROm8Kh0uyducgRf7QXi8MvlcRTrNdZsdlvt9qDs8l/0O2v4/aY2u7j9/2/6fP4/f7s+/32/f71/f7t/P34/v76/v77/v76/f38/v7q7Oz9/v75/vvf8eX1/vjq/fDP+9zr/fDq/e+/9Mrq/e7E+Mxm3HN24YSC3YwTwSMUtSIXuycavikfxi4izDIhyTAhyTE8ykoauiclxjEowDUsxDYPthgsxTUDyQgg2iQ08jk43z3Q9tHP9dAA0gAA0QAA0AAAzwAAwQAAvAAAuwEAtAEAswAArAAB0AEBxQIBrAEC1AICtwMDvQUF1AUJ2QkL3wwL2gsKygwKwgsMxQwO3w4T6BMZ6xko7ChH3kdDyUN623qE64R8znx1wnX+/v79/f38/Pz7+/v6+vr5+fn4+Pj39/f29vby8vLx8fHq6urp6eno6Ojl5eXj4+Pg4ODf39/W1tbMzMzGxsbFxcXDw8PCwsKvr6+urq6srKypqamoqKiUlJSSkpKQkJCKioqIiIiHh4eGhoZ+fn5xcXFwcHBUP7YxAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH1wgUDigoTpImZAAAARtJREFUGNMBEAHv/gABAQEBlZeanJ2dm5iVAQEBAAGYAZVyknGMho+RpJ+YlQEAAQGVc3CNi4WBdXSIqKGalQABlXOOh4R+dnV3d3pTrKKZAJVyb39fY2ZlZG54eVc5q6AAlpODWUtHR0pPVoJ7WC8HqACZkG2VPSclJjeVaH1VLAyvAJuJbFREQj4TLZVqfVouFLIAnIqAaV1bTDU2lWt8WDgStgCclGJhYFxRMzFJXmdSPxa3AJpQTU9PRkMVDUFITkUkCLMAmKM8NDowESMYIjI7HAW7sACVn0AqISkgKCEoFwoLCLWpAAGapSsdDxsaGQ4QBAi5rqYAAZWep64fHgIDBgm6ta2nngABAZeepqqxtLi4s7Cppp6XR0lhOIfKM38AAAAASUVORK5CYII=">':"")+
        ' <a href="http://www.stumbleupon.com/submit?url='+url+'&amp;title='+title+'" class="spacedLink">StumbleUpon</a></li>'+

        '<li>'+(dataUriSupported?'<img height="16" width="16" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAsklEQVQ4EWNgoBAwgvQnVq75f+vBG5KMUlMQYZjfHsLIBNJFqmZkPSzEWKsqL8zQXebJICLIDVZuEzUTrg3sAjgPBwNZM7oSolyAzWaYQUS5AKYYG43XBUeWpaPogfGRwwCvAW/efwUbAPMCjI9sKl4DArKXgNXCbIbxkQ2gOAwoNgDsBS5ONgYNJTFkl2FlG2nLwMVv3HsFZlPHBTLifAznrj6Bm47OQI42mBwoM1EFAAAnVCliRFKHdQAAAABJRU5ErkJggg==">':"")+
        ' <a href="http://www.facebook.com/sharer.php?u='+url+'&amp;t='+title+'"'+
        'onclick="if (window.isFile || window.isXul) return true; '+
        'window.open(&quot;http://www.facebook.com/sharer.php?u='+url+'&amp;t='+title+
        '&quot;,&quot;sharer&quot;,&quot;toolbar=0,status=0,width=626,height=436&quot;);return false;" class="spacedLink">Facebook</a></li>'+

        '<li>'+(dataUriSupported?'<img height="16" width="16" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB/ElEQVQ4EYVTO24UQRB9/dmZkdfCIK0QBhMACQdwgDgMN4AEiYALcAFy7kNABkYkGzhAWMa2DHg9n+7iVfXMaAmAknp7tuvVq1dV3Q6j9SlJlzLEOXgIPPcmRjf5/7ZHdWQRaVPCOjucDYJlcHi8AFLOErz/J4kRQASXGfjYDmhIeDwAKx9xBzz8jxUCgjqSfE8CPWi5EpeTjOu+F36CVcGxrEBBMVDiaDOB5vqVBQu6WAU+dQmnwZuGwkACstxlRDckqWIhMQLPOtfXvfw0AmfA95thqwBNWGg04PktLbTYrEAlXxJTEciemtd+KdvZf7ESTjipEyaazAgyu/2lTTjP2ZpICZZQYSp7gg8kelh5PFj4Kd56ZvhE2IUSMOMVm/niZoPDOqJl0FSAYlYhoNoabSmBiI5pVNouv39w32G3l05wIwaqKRq00XErWGWYFvXz3uAbA4+51lyf+wy9h0JVRqAgfmehc8vmJt7n/CrKP6J81fzqfIPTVOOAo+S9soko+GkzhxgNocUkDfLmosPrsyvwtpTDP5KRWBz2Of4PB3vYr8o9mNuZncfLvRrPdmveJJVNDn0G8yKUMV/pO+p16MVmAn00yvnu9g7erpZ4xAbUrFtXMy42AE9YwmHNxo42lzAd6AtMQ48NgjVVOz+BVNQ9Zql4UI9P/TehBOJIi+EJIAAAAABJRU5ErkJggg==">':"")+
        ' <a href="https://twitter.com/intent/tweet?related=choiceofgames&amp;text=Awesome+game%3A+'+title+'&amp;url='+url+'&amp;via=choiceofgames" class="spacedLink">Twitter</a></li>';

  var nowMsg = "";
  if (now) nowMsg = "<p>Please support our work by sharing this game with friends!  The more people play, the more resources we'll have to work on the next game.</p>";
  msgDiv.innerHTML = nowMsg + "<ul id='sharelist'>\n"+
    mobileMesg+
    shareLinkText+
    "</ul><br>\n"; // just one line break; <ul> provides its own
  target.appendChild(msgDiv);
}

function isShareConfigured() {
  return !!document.getElementById("share");
}

function shareAction(e) {
  clearScreen(function() {
    var target = document.getElementById('text');
    printShareLinks(target, "now");
    printButton("Next", target, false, function () {
      clearScreen(loadAndRestoreGame);
    });
  });
}

function isReviewSupported() {
  return !!(window.isIosApp || window.isAndroidApp);
}

function isFollowEnabled() {
  if (!window.isWeb) return false;
  // iOS add to homescreen seems not to like these iframes
  if (window.navigator.standalone) return false;
  if ("localhost" != window.location.hostname && !/\.?choiceofgames\.com$/.test(window.location.hostname)) return false;
  return true;
}

function printFollowButtons() {
  if (!isFollowEnabled()) return;
  // Just FB Like, for now
  var target = document.getElementById('text');
  var iframe = document.createElement('iframe');
  var width = 300;
  var height = 66;
  iframe.setAttribute("src", "//www.facebook.com/plugins/like.php?href=https%3A%2F%2Fwww.facebook.com%2Fchoiceofgames"+
    "&amp;send=false&amp;layout=standard&amp;width="+width+"&amp;show_faces=true&amp;font&amp;colorscheme=light&amp;"+
    "action=like&amp;height="+height+"&amp;appId=190439350983878");
  iframe.setAttribute("scrolling", "no");
  iframe.setAttribute("frameborder", "0");
  iframe.setAttribute("style", "border:none; overflow:hidden; width:"+width+"px; height:"+height+"px;");
  iframe.setAttribute("allowTransparency", "true");
  target.appendChild(iframe);
}

function subscribeLink(e) {
  clearScreen(function() {
    subscribe(document.getElementById('text'), {now:1}, function() {
      clearScreen(loadAndRestoreGame);
    });
  });
}

function subscribeByMail(target, options, callback, code) {
  if (options.now) {
    code();
    if (options.allowContinue) safeTimeout(function() {callback("now");}, 0);
  } else {
    println("Click here to subscribe to our mailing list; " + options.message);
    println("");
    printButton("Subscribe", target, false, function() {
        code();
      });
    if (options.allowContinue) {
      printButton("No, Thanks", target, false, function() {
        safeTimeout(function() {callback();}, 0);
      });
    }
    // why is this timeout necessary?
    safeTimeout(function() {printFooter();}, 0);
  }
}

function subscribe(target, options, callback) {
  if (!options.message) options.message = "we'll notify you when our next game is ready!";
  if (typeof options.allowContinue === "undefined") options.allowContinue = 1;
  if (!target) target = document.getElementById('text');
  if (window.isIosApp) {
    subscribeByMail(target, options, callback, function() {
      callIos("subscribe");
    });
    return;
  }
  var mailToSupported = isMobile && !window.isMacApp;
  if (window.isAndroidApp) mailToSupported = urlSupport.isSupported("mailto:support@choiceofgames.com");
  if (mailToSupported) {
    subscribeByMail(target, options, callback, function() {
      window.location.href = "mailto:subscribe-"+window.storeName+"-"+platformCode() + "@choiceofgames.com?subject=Sign me up&body=Please notify me when the next game is ready.";
    });
    return;
  }
  println("Type your email address below; " + options.message);
  println("");
  fetchEmail(function(defaultEmail) {
    promptEmailAddress(target, defaultEmail, options.allowContinue, function(cancel, email) {
      if (cancel) {
        return safeCall(null, callback);
      }
      var head= document.getElementsByTagName('head')[0];
      var script = document.createElement('script');
      script.type = 'text/javascript';
      var timestamp = new Date().getTime();
      var timeout = setTimeout(function() {
        window["jsonp"+timestamp]({
          result:"error", msg:"Couldn't connect. Please try again later."
        });
      }, 10000);
      window["jsonp"+timestamp] = function(response) {
        clearTimeout(timeout);
        if (response.result == "error") {
          document.getElementById("errorMessage").innerHTML = response.msg;
        } else {
          clearScreen(function() {
            target = document.getElementById('text');
            println(response.msg, target);
            println("", target);
            if (options.allowContinue) {
              printButton("Next", target, false, function() {
                safeCall(null, callback);
              });
            }
          });
        }
      };
      var mailParams = "u=eba910fddc9629b2810db6182&id=e9cdee1aaa&SIGNUP="+window.storeName+"-"+platformCode()+"&EMAIL="+encodeURIComponent(email);
      if (window.isChromeApp) {
        chrome.permissions.contains({origins: ["http://choiceofgames.us4.list-manage.com/"]},function(isXhrAllowed) {
          if (isXhrAllowed) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", 'http://choiceofgames.us4.list-manage.com/subscribe/post-json?'+mailParams, true);
            xhr.onreadystatechange = function() {
              if (xhr.readyState != 4) return;
              if (xhr.status == 200) {
                var response = JSON.parse(xhr.responseText);
                window["jsonp"+timestamp](response);
              } else if (xhr.status === 0) {
                window["jsonp"+timestamp]({result:"error", msg:"There was a network error submitting your registration. Please try again later, or email subscribe@choiceofgames.com instead."});
              } else {
                window["jsonp"+timestamp]({result:"error", msg:"Sorry, our mail server had an error. It's our fault. Please try again later, or email subscribe@choiceofgames.com instead."});
              }
            };
            xhr.send();
          } else {
            window.addEventListener('message', function(event) {
              if (window["jsonp"+timestamp]) {
                var jsonpt = window["jsonp"+timestamp];
                window["jsonp"+timestamp] = null;
                if (jsonpt) jsonpt(event.data);
              }
            });
            var iframe = document.createElement("IFRAME");
            iframe.setAttribute("src", "sandbox.html");
            iframe.setAttribute("name", "sandbox");
            iframe.onload = function() {
              iframe.contentWindow.postMessage({email:email, game:window.storeName, platform:platformCode()}, "*");
            };
            document.documentElement.appendChild(iframe);
            return;
          }
        });
      } else {
        if (isWinStoreApp || window.location.protocol == "https:") {
          var xhr = findXhr();
          xhr.open("GET", 'https://www.choiceofgames.com/mailchimp_proxy.php/subscribe/post-json?'+mailParams, true);
          var done = false;
          xhr.onreadystatechange = function() {
            if (done) return;
            if (xhr.readyState != 4) return;
            done = true;
            if (xhr.status == 200) {
              var response = JSON.parse(xhr.responseText);
              window["jsonp"+timestamp](response);
            } else if (xhr.status === 0) {
                window["jsonp"+timestamp]({result:"error", msg:"There was a network error submitting your registration. Please try again later, or email subscribe@choiceofgames.com instead."});
            } else {
              window["jsonp"+timestamp]({result:"error", msg:"Sorry, our mail server had an error. It's our fault. Please try again later, or email subscribe@choiceofgames.com instead."});
            }
          };
          xhr.send();
        } else {
          script.src = 'http://choiceofgames.us4.list-manage.com/subscribe/post-json?'+mailParams+'&c=jsonp' + timestamp;
          head.appendChild(script);
        }
      }
    });
  });
}

function downloadLink(e) {
  if (e && e.preventDefault) e.preventDefault();
  if (window.releaseDate && new Date() < window.releaseDate) {
    return asyncAlert("You'll need to wait until after the game is released on " + window.releaseDate);
  }
  clearScreen(function() {
    var text = document.getElementById("text");
    if (window.knownPurchases && window.knownPurchases.adfree) {
      println("You can download the game using the links below.");
      println("");
      var files = {
        Windows: window.downloadName + " Setup " + window.downloadVersion + "-ia32.exe",
        Mac: window.downloadName + "-" + window.downloadVersion + ".dmg",
        Linux: window.downloadPackage + "-" + window.downloadVersion + "-ia32.deb"
      }
      var detectedOs;
      if (/Windows/.test(navigator.userAgent)) {
        detectedOs = "Windows";
      } else if (/Mac OS X/.test(navigator.userAgent)) {
        detectedOs = "Mac";
      } else if (/Linux/.test(navigator.userAgent)) {
        detectedOs = "Linux";
      }
      if (detectedOs) {
        printDownloadLink(detectedOs);
      }
      for (var os in files) {
        if (detectedOs != os) printDownloadLink(os);
      }
      function printDownloadLink(os) {
        var link = document.createElement("a");
        if (detectedOs == os) {
          setClass(link, "next linkButton");
        } else {
          link.style.display = "block";
        }
        link.innerHTML = "Download for " + os;
        link.href = "scenes/"+files[os];
        text.appendChild(link);
      }
      println("");
      printButton("Next", text, false, function() {
        safeCall(null, function() { clearScreen(loadAndRestoreGame); });
      });
    } else {
      println("To download this game for Windows, Mac, or Linux, you'll need to purchase it first.");
      println("");
      printOptions([""], [{name:"Purchase it now.", purchase:1}, {name:"No, thanks.", cancel:1}], function(option) {
        if (option.purchase) {
          purchase("adfree", downloadLink);
        } else {
          safeCall(null, function() { clearScreen(loadAndRestoreGame); });
        }
      });
    }
  });
}

function cacheKnownPurchases(knownPurchases) {
  if (!knownPurchases) return;
  var output = {billingSupported:true};
  for (i = 0; i < knownPurchases.length; i++) {
    var parts = knownPurchases[i].split(/\./);
    if (parts[0] != window.storeName) continue;
    output[parts[1]] = true;
  }
  window.knownPurchases = output;
  fetchEmail(function(email) {
    if (email) window.store.set("knownPurchases"+email.replace(/[^A-z0-9]/g, "_"), JSON.stringify(window.knownPurchases));
  })
  if (window.isIosApp) {
    callIos("updateadfree", output.adfree);
  } else if (window.isAndroidApp) {
    androidBilling.updateAdfree(!!output.adfree);
  }
}

// Callback expects a map from product ids to booleans
function checkPurchase(products, callback) {
  function publishPurchaseEvents(purchases) {
    if (window.purchaseSubscriptions) {
      for (var key in purchaseSubscriptions) {
        if (purchases[key]) purchaseSubscriptions[key].call();
      }
    }
  }

  function checkWebPurchases(callback) {
    isRegistered(function (registered) {
      if (!registered) return callback("ok", {billingSupported: true});
      if (window.knownPurchases) {
        safeTimeout(function() {
          callback("ok", window.knownPurchases);
          publishPurchaseEvents(knownPurchases);
        }, 0);
      } else {
        startLoading();
        xhrAuthRequest("GET", "get-purchases", function(ok, response) {
          doneLoading();
          if (ok) {
            cacheKnownPurchases(response);
            callback(ok, window.knownPurchases);
          } else {
            fetchEmail(function(email) {
              if (!email) return callback(ok, window.knownPurchases);
              window.store.get("knownPurchases"+email.replace(/[^A-z0-9]/g, "_"), function(ok, value) {
                if (ok) {
                  window.knownPurchases = JSON.parse(value);
                }
                callback(ok, window.knownPurchases);
                publishPurchaseEvents(window.knownPurchases);
              })
            });
          }
        });
      }
    });
  }

  function mergeKnownPurchases(purchases) {
    checkWebPurchases(function(ok, knownPurchases) {
      if (knownPurchases) {
        var productList = products.split(/ /);
        for (i = 0; i < productList.length; i++) {
          if (knownPurchases[productList[i]]) purchases[productList[i]] = knownPurchases[productList[i]];
        }
      }
      callback("ok", purchases);
      publishPurchaseEvents(purchases);
    });
  }

  var i;
  if (window.isIosApp) {
    window.checkPurchaseCallback = mergeKnownPurchases;
    callIos("checkpurchase", products);
  } else if (window.isAndroidApp && !window.isNookAndroidApp) {
    window.checkPurchaseCallback = mergeKnownPurchases;
    androidBilling.checkPurchase(products);
  } else if (window.isWinOldApp) {
    safeTimeout(function() {
      var purchases = eval(window.external.CheckPurchase(products));
      callback("ok",purchases);
      publishPurchaseEvents(purchases);
    }, 0);
  } else if (window.isMacApp && window.macPurchase) {
    safeTimeout(function() {
      var purchases = JSON.parse(macPurchase.checkPurchases_(products));
      callback("ok",purchases);
      publishPurchaseEvents(purchases);
    }, 0);
  } else if (window.isCef) {
    cefQuery({
      request:"CheckPurchases " + products,
      onSuccess: function(response) {
        console.log("cp response " + response);
        var purchases = JSON.parse(response);
        callback("ok",purchases);
        publishPurchaseEvents(purchases);
      },
      onFailure: function(error_code, error_message) {
        console.error("CheckPurchases error: " + error_message);
        callback(!"ok");
      }
    });
  } else if (window.isGreenworks) {
    var greenworks = require('greenworks');
    var greenworksApps = require('../package.json').products;
    var purchases = {};
    var productList = products.split(/ /);
    for (i = 0; i < productList.length; i++) {
      var appId = greenworksApps[productList[i]];
      var purchased = false;
      try {
        purchased = greenworks.isSubscribedApp(appId);
      } catch (e) {
        return safeTimeout(function() {callback(!"ok");}, 0);
      }
      purchases[productList[i]] = purchased;
    }
    purchases.billingSupported = true;
    publishPurchaseEvents(purchases);
    safeTimeout(function() {callback("ok", purchases);}, 0);
  } else if (isWebPurchaseSupported()) {
    checkWebPurchases(function(ok, knownPurchases) {
      callback(ok, knownPurchases);
      publishPurchaseEvents(window.knownPurchases);
    });
  } else {
    var productList = products.split(/ /);
    var purchases = {};
    for (i = 0; i < productList.length; i++) {
      purchases[productList[i]] = !!window.isChromeApp;
    }
    purchases.billingSupported = false;
    publishPurchaseEvents(purchases);
    safeTimeout(function() {callback("ok", purchases);}, 0);
  }
}

function isWebPurchaseSupported() {
  return window.isSecureWeb && isWebSavePossible() && window.stripeKey;
}

function isRestorePurchasesSupported() {
  return !!window.isIosApp || !!window.isAndroidApp || isWebPurchaseSupported();
}

function restorePurchases(product, callback) {
  function webRestoreCallback() {
    var purchased = window.knownPurchases && window.knownPurchases[product];
    if (!purchased) {
      if (window.isAndroidApp) {
        asyncAlert("Restore completed. This product is not yet purchased. Sometimes purchases can fail to restore for reasons outside our control. If you have already purchased this product, try uninstalling and reinstalling the app. If that doesn't work, please email a copy of your receipt to " + getSupportEmail() + " and we'll find a way to help you.");
      } else {
        asyncAlert("Restore completed. This product is not yet purchased.");
      }
    }
    callback(purchased);
  }
  function secondaryRestore(error) {
    window.restoreCallback = null;
    if (product) {
      checkPurchase(product, function(ok, purchases) {
        if (purchases[product]) {
          callback("purchased");
        } else {
          clearScreen(function() {
            var target = document.getElementById('text');
            if (error) {
              target.innerHTML="<p>Restore failed. Please try again later, or sign in to Choiceofgames.com to restore purchases.</p>";
            } else {
              target.innerHTML="<p>Restore completed. This product is not yet purchased. You may also sign in to Choiceofgames.com to restore purchases.</p>";
            }
            loginForm(document.getElementById('text'), /*optionality*/1, /*err*/null, webRestoreCallback);
          });
        }
      });
    } else {
      callback();
    }
  }
  if (window.isIosApp) {
    window.restoreCallback = secondaryRestore;
    callIos("restorepurchases");
  } else if (window.isAndroidApp) {
    window.restoreCallback = secondaryRestore;
    androidBilling.forceRestoreTransactions();
  } else if (isWebPurchaseSupported()) {
    isRegistered(function(registered) {
      if (registered) {
        startLoading();
        xhrAuthRequest("GET", "get-purchases", function(ok, response) {
          doneLoading();
          if (ok) {
            cacheKnownPurchases(response);
          } else {
            if (response.error != "not registered") {
              alertify.error("There was an error downloading your purchases from Choiceofgames.com. "+
                "Please refresh this page to try again, or contact " + getSupportEmail() + " for assistance.", 15000);
            }
          }
          webRestoreCallback();
        });
      } else {
        clearScreen(function() {
          var target = document.getElementById('text');
          target.innerHTML="<p>Please sign in to Choiceofgames.com to restore purchases.</p>";
          loginForm(document.getElementById('text'), /*optional*/1, /*err*/null, webRestoreCallback);
        });
      }
    });
  } else {
    safeTimeout(callback, 0);
  }
}
// Callback expects a localized string, or "", or "free", or "guess"
function getPrice(product, callback) {
  if (window.isIosApp) {
    window.priceCallback = callback;
    callIos("price", product);
  } else if (window.isAndroidApp) {
    window.priceCallback = callback;
    androidBilling.getPrice(product);
  } else if (window.isWeb) {
    if (window.productData && window.productData[product] && window.productData[product].amount) {
      safeTimeout(function () {
        callback.call(this, "$"+(productData[product].amount/100));
      }, 0);
    } else {
      safeTimeout(function() {
        if (window.productData && window.productData[product] && window.productData[product].amount) {
          callback.call(this, "$"+(productData[product].amount/100));
        } else {
          callback.call(this, "guess");
        }
      }, 500);
    }
  } else if (window.isGreenworks) {
    if (window.productData && window.productData[product]) {
      safeTimeout(function () {
        callback.call(this, productData[product]);
      }, 0);
    } else {
      window.awaitSteamProductData = function() {
        doneLoading();
        window.awaitSteamProductData = null;
        if (window.productData && window.productData[product]) {
          callback.call(this, productData[product]);
        } else {
          callback.call(this, "hide");
        }
      };
      startLoading();
      safeTimeout(function() {if (window.awaitSteamProductData) awaitSteamProductData();}, 5000);
    }
  } else {
    safeTimeout(function () {
      callback.call(this, "hide");
    }, 0);
  }
}
// Callback expects no args, but should only be called on success
function purchase(product, callback) {
  var purchaseCallback = function() {
    window.purchaseCallback = null;
    safeCall(null, callback);
    if (window.purchaseSubscriptions && purchaseSubscriptions[product]) {
      purchaseSubscriptions[product].call();
    }
  };
  if (window.isIosApp) {
    window.purchaseCallback = purchaseCallback;
    callIos("purchase", product);
  } else if (window.isAndroidApp) {
    window.purchaseCallback = purchaseCallback;
    var androidStackTrace = androidBilling.purchase(product);
    if (androidStackTrace) throw new Error(androidStackTrace);
  } else if (window.isWinOldApp) {
    window.external.Purchase(product);
  } else if (window.isMacApp && window.macPurchase) {
    macPurchase.purchase_(product);
  } else if (window.isGreenworks) {
    var greenworksApps = require('../package.json').products;
    if (greenworksApps[product]) require("electron").shell.openExternal("steam://advertise/"+greenworksApps[product]);
  } else if (window.isCef) {
    cefQuerySimple("Purchase " + product);
    // no callback; we'll refresh on purchase
  } else if (window.isWeb && product == window.appPurchase) {
    var webStoreFallback = function() {
      window.appPurchase = null;
      purchase(product, callback);
    };
    var clickLink = function(id) {
      var link = document.getElementById(id);
      if (!link) return webStoreFallback();
      var href = link.getAttribute("href");
      if (!href) return webStoreFallback();
      window.location.href = href;
    };
    
    // instead of IAP, send the user to a store
    if (/(iPhone OS|iPad)/.test(navigator.userAgent)) {
      if (/iPhone OS [456]_/.test(navigator.userAgent)) {
        // ancient versions of iOS can't use our app
        webStoreFallback();
      } else {
        clickLink("iphoneLink");
      }
    } else if (/Silk/.test(navigator.userAgent)) {
      clickLink("kindleLink");
    } else if (/Android/.test(navigator.userAgent)) {
      clickLink("androidLink");
    } else if (window.steamClobber && document.getElementById("steamLink")) {
      clickLink("steamLink");
    } else {
      webStoreFallback();
    }
  } else if (isWebPurchaseSupported()) {
    if (!window.StripeCheckout) return asyncAlert("Sorry, we weren't able to initiate payment. (Your "+
      "network connection may be down.) Please refresh the page and try again, or contact "+
      "support@choiceofgames.com for assistance.");
    var fullProductName = window.storeName + "." + product;
    function stripe() {
      if (window.productData && window.productData[product]) {
        var data = productData[product];
        return StripeCheckout.open({
          key:         window.stripeKey,
          address:     false,
          amount:      data.amount,
          name:        data.display_name,
          email:       window.recordedEmail,
          panelLabel:  'Buy',
          token:       function(response) {
            clearScreen(function() {
              startLoading();
              xhrAuthRequest("POST", "purchase", function(ok, response) {
                doneLoading();
                if (ok) {
                  cacheKnownPurchases(response);
                  return purchaseCallback();
                } else if (/^card error: /.test(response.error)) {
                  var cardError = response.error.substring("card error: ".length);
                  asyncAlert(cardError);
                  clearScreen(loadAndRestoreGame);
                } else if ("purchase already in flight" == response.error) {
                  asyncAlert("Sorry, there was an error handling your purchase. Please wait five minutes and try again, or contact support@choiceofgames.com for assistance.");
                  clearScreen(loadAndRestoreGame);
                } else {
                  asyncAlert("Sorry, there was an error processing your card. (Your "+
                    "network connection may be down.) Please refresh the page and try again, or contact "+
                    "support@choiceofgames.com for assistance.");
                  clearScreen(loadAndRestoreGame);
                }
              }, "stripeToken", response.id, "product", fullProductName, "key", window.stripeKey);
            });
          }
        });
      } else {
        return asyncAlert("Sorry, we weren't able to initiate payment. (Your "+
          "network connection may be down.) Please refresh the page and try again, or contact "+
          "support@choiceofgames.com for assistance.");
      }
    }
    if (window.registered && window.recordedEmail) {
      stripe();
    }
    clearScreen(function() {
      var target = document.getElementById('text');
      target.innerHTML="<p>Please sign in to Choiceofgames.com to purchase.</p>";
      loginForm(document.getElementById('text'), /*optional*/1, /*err*/null, function(registered){
        if (registered) {
          if (window.knownPurchases && window.knownPurchases[product]) {
            purchaseCallback();
          } else {
            clearScreen(loadAndRestoreGame);
            return stripe();
          }
        } else {
          clearScreen(loadAndRestoreGame);
        }
      });
    });
  } else {
    safeTimeout(purchaseCallback, 0);
  }
}

function printDiscount(product, fullYear, oneBasedMonthNumber, dayOfMonth, line, options) {
  if (window.updatedDiscountDates && updatedDiscountDates[product]) {
    var udd = updatedDiscountDates[product];
    fullYear = udd.fullYear;
    oneBasedMonthNumber = udd.oneBasedMonthNumber;
    dayOfMonth = udd.dayOfMonth;
  }
  var shortMonthString = shortMonthStrings[oneBasedMonthNumber];
  var discountTimestamp = new Date(shortMonthString + " " + dayOfMonth + ", " + fullYear).getTime();
  var discountEligible = new Date().getTime() < discountTimestamp;
  var span;
  span = document.createElement("span");
  span.setAttribute("id", "discount_" + product);
  printx(line, span);
  span.innerHTML = span.innerHTML.replace("${choice_discount_ends}", "<span id=discountdate_"+product+">"+shortMonthString + " " + parseInt(dayOfMonth, 10) + "</span>") + " ";

  if (!discountEligible) {
    span.style.display = "none";
  }

  text.appendChild(span);
}

function rewriteDiscount(product, fullYear, oneBasedMonthNumber, dayOfMonth) {
  if (!window.updatedDiscountDates) window.updatedDiscountDates = {};
  window.updatedDiscountDates[product] = {fullYear:fullYear, oneBasedMonthNumber:oneBasedMonthNumber, dayOfMonth:dayOfMonth};
  var span = document.getElementById("discount_"+product);
  if (!span) return;
  var shortMonthString = shortMonthStrings[oneBasedMonthNumber];
  var discountTimestamp = new Date(shortMonthString + " " + dayOfMonth + ", " + fullYear).getTime();
  var discountEligible = new Date().getTime() < discountTimestamp;
  if (discountEligible) {
    var dateSpan = document.getElementById("discountdate_"+product);
    if (!dateSpan) return;
    span.style.display = "";
    dateSpan.innerHTML = shortMonthString + " " + parseInt(dayOfMonth, 10);
  } else {
    span.style.display = "none";
  }
}

function handleDiscountResponse(ok, response) {
  if (!ok || !response || !window.storeName || !response[storeName]) return;
  if (!window.updatedDiscountDates) window.updatedDiscountDates = {};
  var udds = response[storeName];
  for (var product in udds) {
    if (!udds.hasOwnProperty(product)) continue;
    var udd = udds[product];
    var result = udd.split("-");
    rewriteDiscount(product, result[0], parseInt(result[1],10), parseInt(result[2], 10));
  }
}

function registerNativeAchievement(name) {
  if (window.blockNativeAchievements) return;
  if (window.isIosApp) {
    callIos("achieve", name+"/");
  } else if (window.isMacApp && window.macAchievements) {
    macAchievements.achieve_(name);
  } else if (window.isWinOldApp) {
    window.external.Achieve(name);
  } else if (window.isCef) {
    cefQuerySimple("Achieve " + name);
  } else if (window.isGreenworks) {
    require('greenworks').activateAchievement(name, function() {
      console.log("registered achievement " + name);
    })
  }
}

function achieve(name, title, description) {
  if (initStore()) window.store.set("achieved", toJson(nav.achieved));
  registerNativeAchievement(name);
  // iOS shows a prominent banner; no need to show our own
  if (window.isIosApp) return;
  var escapedTitle = title+"".replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
  var escapedDescription = description+"".replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/\[b\]/g, '<b>')
    .replace(/\[\/b\]/g, '</b>')
    .replace(/\[i\]/g, '<i>')
    .replace(/\[\/i\]/g, '</i>');
  var html = "<b>Achievement: "+escapedTitle+"</b><br>" + escapedDescription;
  alertify.log(html);
}

function checkAchievements(callback) {
  safeTimeout(function() {
    if (!initStore()) return callback();
    window.store.get("achieved", function(ok, value){
      function mergeNativeAchievements(achieved) {
        window.checkAchievementCallback = null;
        var nativeRegistered = {};
        for (var i = 0; i < achieved.length; i++) {
          nav.achieved[achieved[i]] = true;
          nativeRegistered[achieved[i]] = true;
        }
        for (var achievement in nav.achieved) {
          if (nav.achieved[achievement] && !nativeRegistered[achievement]) {
            registerNativeAchievement(achievement);
          }
        }
        callback();
      }
      var alreadyLoadingAchievements = false;
      if (ok && value) {
        var achievementRecord = jsonParse(value);
        for (var achieved in achievementRecord) {
          if (achievementRecord[achieved]) nav.achieved[achieved] = true;
        }
      }
      if (window.isIosApp) {
        alreadyLoadingAchievements = !!window.checkAchievementCallback;
        window.checkAchievementCallback = mergeNativeAchievements;
        if (!alreadyLoadingAchievements) callIos("checkachievements");
      } else if (window.isGreenworks) {
        if (!window.greenworksAchivementCallbackCount) {
          var greenworks = require('greenworks');
          var nativeAchievementNames = greenworks.getAchievementNames();
          window.greenworksAchivementCallbackCount = nativeAchievementNames.length;
          if (!window.greenworksAchivementCallbackCount) {
            return callback();
          }
          var nativeAchievements = [];
          for (var i = 0; i < nativeAchievementNames.length; i++) {
            (function(i) {
              greenworks.getAchievement(nativeAchievementNames[i], function(bAchieved) {
                greenworksAchivementCallbackCount--;
                if (bAchieved) {
                  nativeAchievements.push(nativeAchievementNames[i]);
                }
                if (!greenworksAchivementCallbackCount) {
                  mergeNativeAchievements(nativeAchievements);
                }
              }, function(err) {
                greenworksAchivementCallbackCount--;
              });
            })(i);
          }
        }
      } else if (window.isMacApp && window.macAchievements) {
        alreadyLoadingAchievements = !!window.checkAchievementCallback;
        window.checkAchievementCallback = mergeNativeAchievements;
        if (!alreadyLoadingAchievements) macAchievements.checkAchievements();
      } else if (window.isWinOldApp) {
        var checkWinAchievements = function () {
          var achieved = eval(window.external.GetAchieved());
          if (achieved) {
            mergeNativeAchievements(achieved);
          } else {
            safeTimeout(checkWinAchievements, 100);
          }
        };
        checkWinAchievements();
      } else if (window.isCef) {
        var checkCefAchievements = function() {
          cefQuery({
            request:"GetAchieved ",
            onSuccess: function(response) {
              //console.log("GetAchieved " + response);
              var achieved = eval(response);
              mergeNativeAchievements(achieved);
            },
            onFailure: function(error_code, error_message) {
              //console.error("GetAchieved error " + error_message);
              if (error_code == 1) {
                safeTimeout(checkCefAchievements, 100);
              } else {
                callback();
              }
            }
          });
        };
        checkCefAchievements();
      } else {
        callback();
      }
    });
  },0);
}

function isAdvertisingSupported() {
  return typeof window != "undefined" && (window.isIosApp || window.isAndroidApp);
}

function isFullScreenAdvertisingSupported() {
  return window.isIosApp || window.isAndroidApp;
}

function showFullScreenAdvertisement(callback) {
  if (window.isIosApp) {
    callIos("advertisement");
    safeTimeout(callback, 0);
  } else if (window.isAndroidApp && window.adBridge) {
    adBridge.displayFullScreenAdvertisement();
    safeTimeout(callback, 0);
  } else {
    safeTimeout(callback, 0);
  }
}

function showTicker(target, endTimeInSeconds, finishedCallback) {
  if (!target) target = document.getElementById('text');
  var div = document.createElement("span");
  div.setAttribute("id", "delayTicker");
  target.appendChild(div);
  var timerDisplay = document.createElement("span");
  div.appendChild(timerDisplay);
  var timer;

  var statsButton = document.getElementById("statsButton");
  if (statsButton) {
    var defaultStatsButtonDisplay = statsButton.style.display;
    statsButton.style.display = "none";
  }

  if (endTimeInSeconds > Math.floor(new Date().getTime() / 1000)) {
    if (window.isAndroidApp) {
      notificationBridge.scheduleNotification(endTimeInSeconds);
    } else if (window.isIosApp) {
      callIos("schedulenotification", endTimeInSeconds);
    }
  }

  function cleanUpTicker() {
    window.blockRestart = false;
    if (window.isAndroidApp) {
      notificationBridge.cancelNotification();
    } else if (window.isIosApp) {
      callIos("cancelnotifications");
    }
    clearInterval(timer);
    if (statsButton) statsButton.style.display = defaultStatsButtonDisplay;
  }

  function formatSecondsRemaining(secondsRemaining, forceMinutes) {
    if (!forceMinutes && secondsRemaining < 60) {
      return ""+secondsRemaining+"s";
    } else {
      var minutesRemaining = Math.floor(secondsRemaining / 60);
      var remainderSeconds;
      if (minutesRemaining < 60) {
        remainderSeconds = secondsRemaining - minutesRemaining * 60;
        return ""+minutesRemaining+"m " + formatSecondsRemaining(remainderSeconds);
      } else if (minutesRemaining < 6000) {
        var hoursRemaining = Math.floor(secondsRemaining / 3600);
        remainderSeconds = secondsRemaining - hoursRemaining * 3600;
        return ""+hoursRemaining+"h " + formatSecondsRemaining(remainderSeconds, true);
      } else {
        var daysRemaining = Math.floor(secondsRemaining / 86400);
        remainderSeconds = secondsRemaining - daysRemaining * 86400;
        return ""+daysRemaining+" days " + formatSecondsRemaining(remainderSeconds, true);
      }
    }
  }

  function tick() {
    var tickerElement = document.getElementById("delayTicker");
    var tickerStillVisible = tickerElement && tickerElement.parentNode && tickerElement.parentNode.parentNode;
    if (!tickerStillVisible) {
      cleanUpTicker();
      return;
    }
    var nowInSeconds = Math.floor(new Date().getTime() / 1000);
    var secondsRemaining = endTimeInSeconds - nowInSeconds;
    if (secondsRemaining >= 0) {
      timerDisplay.innerHTML = "" + formatSecondsRemaining(secondsRemaining) + " seconds remaining";
    } else {
      cleanUpTicker();
      tickerElement.innerHTML = "0s remaining";
      if (finishedCallback) safeCall(null, finishedCallback);
    }
  }

  timer = setInterval(tick, 1000);
  tick();
}

function printButton(name, parent, isSubmit, code) {
  var button;
  if (isSubmit) {
    button = document.createElement("input");
    button.type = "submit";
    button.value = name;
    button.name = name;
  } else {
    button = document.createElement("button");
    button.setAttribute("type", "button");
    printx(name, button);
  }
  setClass(button, "next");
  button.setAttribute("accesskey", "n");
  if (code) button.onclick = function(event) {
    if (window.isIosApp) {
      window.freezeCallback = function() {
        window.freezeCallback = null;
        code(event);
      };
      callIos("freeze");
    } else {
      safeCall(null, function() {code(event);});
    }
  };
  if (!isMobile) try { button.focus(); } catch (e) {}
  parent.appendChild(button);
  return button;
}

function printLink(target, href, anchorText, onclick) {
  if (!target) target = document.getElementById('text');
  var link = document.createElement("a");
  link.setAttribute("href", href);
  link.appendChild(document.createTextNode(anchorText));
  if (onclick) {
    if (link.addEventListener) {
      link.addEventListener("click", onclick, true);
    } else {
      link.onclick = onclick;
    }
  }
  target.appendChild(link);
  target.appendChild(document.createTextNode(" "));
}

function kindleButton(target, query, buttonName) {
  printButton(buttonName, main, false,
    function() {
      try {
        window.location.href="http://www.amazon.com/s?rh=n%3A133140011%2Ck%3A" + encodeURIComponent(query);
      } catch (e) {} // xulrunner will intercept this link and throw an exception, opening it in the external browser
    }
  );
}

function printInput(target, inputType, callback, minimum, maximum, step) {
    if (!target) target = document.getElementById('text');
    var form = document.createElement("form");
    target.appendChild(form);
    var self = this;
    form.action="#";


    if (inputType == "textarea") {
      var input = document.createElement("textarea");
      input.setAttribute("rows", 4);
    } else {
      var input = document.createElement("input");
      input.setAttribute("type", inputType);
      if (inputType == "number") {
        input.setAttribute("min", minimum);
        input.setAttribute("max", maximum);
        step = step || "any";
        input.setAttribute("step", step);
      }
    }

    input.name="text";
    input.setAttribute("style", "font-size: 25px; width: 90%;");
    form.appendChild(input);

    form.onsubmit = function(e) {
        preventDefault(e);
        if (!input.value) {
            // TODO optional value?
            // TODO configurable error message?
            asyncAlert("Don't just leave it blank!  Type something!");
            return;
        }
        if (window.isIosApp) {
          window.freezeCallback = function() {
            window.freezeCallback = null;
            safeCall(null, function() {callback(input.value);});
          };
          callIos("freeze");
        } else {
          safeCall(null, function() {callback(input.value);});
        }
        return false;
    };

    form.appendChild(document.createElement("br"));
    form.appendChild(document.createElement("br"));
    printButton("Next", form, true);

}

function promptEmailAddress(target, defaultEmail, allowContinue, callback) {
  if (!target) target = document.getElementById('text');
  var form = document.createElement("form");
  var self = this;
  form.action="#";

  var message = document.createElement("div");
  message.style.color = "red";
  message.style.fontWeight = "bold";
  message.setAttribute("id", "errorMessage");
  form.appendChild(message);

  var input = document.createElement("input");
  // This can fail on IE
  try { input.type="email"; } catch (e) {}
  input.name="email";
  input.value=defaultEmail;
  input.setAttribute("style", "font-size: 25px; width: 90%;");
  form.appendChild(input);
  target.appendChild(form);
  println("", form);
  println("", form);
  printButton("Next", form, true);

  if (allowContinue) {
    printButton("No, Thanks", target, false, function() {
      callback(true);
    });
  }

  form.onsubmit = function(e) {
    preventDefault(e);
    safeCall(this, function() {
      var email = trim(input.value);
      if (!/^\S+@\S+\.\S+$/.test(email)) {
        var messageText = document.createTextNode("Sorry, \""+email+"\" is not an email address.  Please type your email address again.");
        message.innerHTML = "";
        message.appendChild(messageText);
      } else {
        recordEmail(email, function() {
          callback(false, email);
        });
      }
    });
  };

  curl();
}

function loginForm(target, optional, errorMessage, callback) {
  if (!isRegisterAllowed() || !initStore()) return safeTimeout(function() {
    callback(!"ok");
  }, 0);
  var optional_start = 1;
  var optional_returning_subscribe = 2;
  var optional_returning_no_subscribe = 3;
  var optional_new_subscribe = 4;
  var optional_new_no_subscribe = 5;
  startLoading();
  fetchEmail(function(defaultEmail) {
    isRegistered(function(registered) {
      if (registered) {
        if (defaultEmail) {
          doneLoading();
          loginDiv(registered, defaultEmail);
          return safeTimeout(callback, 0);
        }
        // Cookie says I'm logged in, but we have no local record of the email address
        return getRemoteEmail(function(ok, response) {
          doneLoading();
          if (ok) {
            if (response.email) {
              loginDiv(registered, response.email);
              return recordEmail(response.email, callback);
            } else {
              // not really logged in after all
              logout();
              loginDiv();
              return loginForm(target, optional, errorMessage, callback);
            }
          } else {
            // missed an opportunity to record email locally. meh.
            return safeCall(null, callback);
          }
        });
      }
      doneLoading();
      var form = document.createElement("form");

    if (!errorMessage) errorMessage = "";

      var escapedEmail = defaultEmail.replace(/'/g, "&apos;");
      var passwordButton;
      if (optional == optional_start) {
        form.innerHTML = "<div id=message style='color:red; font-weight:bold'>"+errorMessage+
          "</div><div class='choice'>"+
          "<label for=yes class=firstChild><input type=radio name=choice value=yes id=yes checked> My email address is: "+
          "<input type=email name=email id=email value='"+escapedEmail+"' style='font-size: 25px; width: 11em'></label>"+
          ((isWeb && window.facebookAppId)?"<label for=facebook><input type=radio name=choice value=facebook id=facebook > Sign in with Facebook.</label>":"")+
          ((isWeb && window.googleAppId)?"<label for=google><input type=radio name=choice value=google id=google > Sign in with Google.</label>":"")+
          "<label for=no class=lastChild><input type=radio name=choice value=no id=no > No, thanks.</label>"+
          "<p><label class=noBorder for=subscribe><input type=checkbox name=subscribe id=subscribe checked> "+
          "Email me when new games are available.</label></p>";

        form.email.onclick = function() {
          setTimeout(function() {form.email.focus();}, 0);
        };
        setTimeout(function() {form.email.focus();}, 0);
      } else {
        form.innerHTML = "<div id=message style='color:red; font-weight:bold'>"+errorMessage+
          "</div><span><span>My email address is: </span><input type=email name=email id=email value='"+
          escapedEmail+"' style='font-size: 25px; width: 12em'></span><p><label class=noBorder id=subscribeLabel for=subscribe>"+
          "<input type=checkbox name=subscribe id=subscribe checked> "+
          "Email me when new games are available.</label></p><p>Do you have a Choiceofgames.com password?</p>"+
          "<div class='choice'>"+
          "<label for=new class=firstChild><input type=radio name=choice value=new id=new checked> No, I'm new.</label>"+
          "<label for=passwordButton><input type=radio name=choice value=passwordButton id=passwordButton> "+
          "Yes, I have a password: <input id=password type=password name=password disabled class=needsclick style='font-size: 25px; width: 11em'></label>"+
          "<label for=forgot><input type=radio name=choice value=forgot id=forgot> I forgot my password.</label>"+
          ((isWeb && window.facebookAppId)?"<label for=facebook><input type=radio name=choice value=facebook id=facebook> Sign in with Facebook.</label>":"")+
          ((isWeb && window.googleAppId)?"<label for=google><input type=radio name=choice value=google id=google> Sign in with Google.</label>":"")+
          (optional ? "<label for=no><input type=radio name=choice value=no id=no> Cancel.</label>" : "") +
          "</div><br>";

        var labels = form.getElementsByTagName("label");
        setClass(labels[labels.length-1], "lastChild");

        var password = form.password;
        passwordButton = form.passwordButton;

        passwordButton.parentNode.onclick = function() {
          passwordButton.checked = true;
          passwordButton.onchange();
        };

        var radioButtons = form.choice;
        var onchange = function() {
          var enabled = passwordButton.checked;
          password.disabled = !enabled;
          if (enabled) {
            password.focus();
            setTimeout(function() {password.parentNode.scrollIntoView();}, 0);
          }
        };
        for (var i = radioButtons.length - 1; i >= 0; i--) {
          radioButtons[i].onchange = onchange;
        }
        if (optional) {
          form.subscribe.checked = (optional == optional_returning_subscribe || optional == optional_new_subscribe);
          passwordButton.checked = (optional == optional_returning_subscribe || optional == optional_returning_no_subscribe);
        }
      }

      function showMessage(msg) {
        var message = document.getElementById('message');
        var messageText = document.createTextNode(msg);
        message.innerHTML = "";
        message.appendChild(messageText);
      }

      form.onsubmit = function(event) {
        preventDefault(event);
        var email = trim(form.email.value);
        var subscribe = form.subscribe.checked;
        var choice = getFormValue("choice");
        if ("facebook" == choice) {
          if (!window.FB) return asyncAlert("Sorry, we weren't able to sign you in with Facebook. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
          var loginParams = {scope:'email',return_scopes:true};
          if (window.facebookReRequest) loginParams.auth_type = "rerequest";
          return FB.login(function(response){
            if ("connected" == response.status) {
              var grantedScopes = [];
              try { grantedScopes = response.authResponse.grantedScopes.split(","); } catch (e) {}
              var grantedEmail = false;
              for (var i = 0; i < grantedScopes.length; i++) {
                if ("email" == grantedScopes[i]) {
                  grantedEmail = true;
                  break;
                }
              }
              if (grantedEmail) {
                xhrAuthRequest("POST", "facebook-login", function(ok, response){
                  if (ok) {
                    loginDiv(ok, response.email);
                    recordLogin(ok, response.email);
                    cacheKnownPurchases(response.purchases);
                    safeCall(null, function() {callback("ok");});
                  } else {
                    asyncAlert("Sorry, we weren't able to sign you in with Facebook. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
                  }
                }, "app_id", facebookAppId);
              } else {
                showMessage("Sorry, we require an email address to sign you in. Please grant access to your email address, or type your email address below.");
                window.facebookReRequest = true;
              }
            }
          },loginParams);
        }
        if ("google" == choice) {
          if (!window.gapi) return asyncAlert("Sorry, we weren't able to sign you in with Google. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
          var done = false;
          return gapi.auth.signIn({callback: function (authResult) {
            if (done) return;
            done = true;
            if (authResult['status']['signed_in']) {
              isRegistered(function(registered) {
                if (!registered) xhrAuthRequest("POST", "google-login", function(ok, response){
                  loginDiv(ok, response.email);
                  recordLogin(ok, response.email);
                  cacheKnownPurchases(response.purchases);
                  if (ok) {
                    callback("ok");
                  } else {
                    asyncAlert("Sorry, we weren't able to sign you in with Google. Please try again later, or contact support@choiceofgames.com for assistance.");
                  }
                }, "code", authResult['code'], "client_id", googleAppId);
              });
            } else {
              asyncAlert("Sorry, we weren't able to sign you in with Google. Please try again later, or contact support@choiceofgames.com for assistance.");
            }
          }});
        }
        if (!/^\S+@\S+\.\S+$/.test(email) && "no" != choice) {
          showMessage('Sorry, "'+email+'" is not an email address.  Please type your email address again.');
        } else {
          recordEmail(email, function() {
            if ("yes" == choice) {
              clearScreen(function() {
                if (defaultEmail) {
                  optional = subscribe ? optional_returning_subscribe : optional_returning_no_subscribe;
                } else {
                  optional = subscribe ? optional_new_subscribe : optional_new_no_subscribe;
                }
                loginForm(document.getElementById("text"), optional, null, callback);
              });
            } else if ("no" == choice) {
              safeCall(null, function() {callback(false);});
            } else if ("new" == choice) {
              target.innerHTML = "";
              window.scrollTo(0,0);
              form = document.createElement("form");
              var escapedEmail = email.replace(/'/g, "&apos;");
              form.innerHTML = "<div id=message style='color:red; font-weight:bold'></div>"+
                "<div>My email address is: </div><div><input type=email name=email id=email value='"+
                escapedEmail+"' style='font-size: 25px; width: 12em'></div>"+
                "<div>Type it again: </div><div><input type=email name=email2 id=email2 autocomplete='off' style='font-size: 25px; width: 12em'></div>"+
                "<div>Enter a new password:&nbsp;</div><div>"+
                "<input type=password name=password id=password style='font-size: 25px; width: 12em'></div>";
              form.onsubmit = function(event) {
                preventDefault(event);
                var email = trim(form.email.value);
                var email2 = trim(form.email2.value);
                if (!/^\S+@\S+\.\S+$/.test(email)) {
                  showMessage('Sorry, "'+email+'" is not an email address.  Please type your email address again.');
                  return;
                } else if (email != email2) {
                  showMessage('Those email addresses don\'t match.  Please type your email address again.');
                  return;
                }
                startLoading();
                form.style.display = "none";
                window.scrollTo(0,0);
                login(email, form.password.value, /*register*/true, subscribe, function(ok, response) {
                  doneLoading();
                  if (ok) {
                    target.innerHTML = "";
                    loginDiv(ok, email);
                    recordLogin(ok, email);
                    cacheKnownPurchases(response.purchases);
                    // we need another click event so we can launch Stripe in a pop-up
                    asyncAlert("You have registered successfully.", function() {
                      safeCall(null, function() {callback("ok");});
                    })
                  } else if ("incorrect password" == response.error) {
                    target.innerHTML = "";
                    loginForm(target, optional, 'Sorry, the email address "'+email+'" is already in use. Please type your password below, or use a different email address.', callback);
                  } else {
                    form.style.display = "";
                    showMessage("Sorry, we weren't able to sign you in. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
                  }
                });
              };
              target.appendChild(form);
              println("", form);
              printButton("Next", form, true);
              if (optional) {
                printButton("Cancel", form, false, function() {
                  safeCall(null, function() {callback(false);});
                });
              }
            } else if ("passwordButton" == choice) {
              startLoading();
              form.style.display = "none";
              window.scrollTo(0,0);
              login(email, form.password.value, /*register*/false, form.subscribe.checked, function(ok, response) {
                doneLoading();
                form.style.display = "";
                if (ok) {
                  target.innerHTML = "";
                  loginDiv(ok, email);
                  recordLogin(ok, email);
                  cacheKnownPurchases(response.purchases);
                  // we need another click event so we can launch Stripe in a pop-up
                  asyncAlert("You have registered successfully.", function() {
                    safeCall(null, function() {callback("ok");});
                  })
                } else if ("unknown email" == response.error) {
                  showMessage('Sorry, we can\'t find a record for the email address "'+email+'". Please try a different email address, or create a new account.');
                } else if ("incorrect password" == response.error) {
                  showMessage('Sorry, that password is incorrect. Please try again, or select "I forgot my password" to reset your password.');
                } else {
                  showMessage("Sorry, we weren't able to sign you in. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
                }
              });
            } else if ("forgot" == choice) {
              startLoading();
              form.style.display = "none";
              window.scrollTo(0,0);
              forgotPassword(email, function(ok, response) {
                doneLoading();
                form.style.display = "";
                if (ok) {
                  showMessage("We've emailed you a link to reset your password. Please check your email and click on the link, then return here to sign in.");
                  document.getElementById('passwordButton').checked = true;
                  document.getElementById('passwordButton').onchange();
                } else if ("unknown email" == response.error) {
                  showMessage('Sorry, we can\'t find a record for the email address "'+email+'". Please try a different email address, or create a new account.');
                } else {
                  showMessage("Sorry, we weren't able to sign you in. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
                }
              });
            }
          });
        }
      };

      target.appendChild(form);
      if (passwordButton && passwordButton.checked) passwordButton.onchange();
      if (optional && optional > 1) document.getElementById("subscribeLabel").style.display = "none";
      printButton("Next", form, true);
      printFooter();
    });
  });
}

function loginDiv(registered, email) {
  var domain = "https://www.choiceofgames.com/";
  var identity = document.getElementById("identity");
  if (!identity) return;
  if (registered) {
    var emailLink = document.getElementById("email");
    emailLink.setAttribute("href", domain + "profile" + "/");
    emailLink.innerHTML = "";
    emailLink.appendChild(document.createTextNode(email));
    identity.style.display = "block";
    var logoutLink = document.getElementById("logout");
    logoutLink.onclick = function(event) {
      preventDefault(event);
      logout();
      loginDiv();
    };
  } else {
    identity.style.display = "none";
  }
}

function isRegistered(callback) {
  if (window.isWeb) {
    return safeTimeout(function() {
      if (!window.registered) window.registered = !!getCookieByName("login");
      callback(window.registered);
    }, 0);
  } else if (initStore()) {
    return window.store.get("login", function(ok, value) {
      safeTimeout(function() {
        window.registered = ok && value && "false" != value;
        callback(window.registered);
      }, 0);
    });
  } else {
    safeCall(null, function() {
      window.registered = false;
      callback(false);
    });
  }
}

function isRegisterAllowed() {
  return window.isWeb || window.isIosApp || window.isAndroidApp;
}

function preventDefault(event) {
  if (!event) event = window.event;
  if (!event) return;
  if (event.preventDefault) {
    event.preventDefault();
  } else {
    event.returnValue = false;
  }
}

function getPassword(target, code) {
  if (!target) target = document.getElementById('text');
  var textArea = document.createElement("textarea");
  textArea.cols = 41;
  textArea.rows = 30;
  setClass(textArea, "savePassword");
  target.appendChild(textArea);
  println("", target);
  printButton("Next", target, false, function() {
    code(false, textArea.value);
  });

  printButton("Cancel", target, false, function() {
    code(true);
  });
}

function showPassword(target, password) {
  if (!target) target = document.getElementById('text');

  var textBuffer = [];
  var colWidth = 40;
  for (var i = 0; i < password.length; i++) {
    textBuffer.push(password.charAt(i));
    if ((i + 1) % colWidth === 0) {
      textBuffer.push('\n');
    }
  }
  password = "----- BEGIN PASSWORD -----\n" + textBuffer.join('') + "\n----- END PASSWORD -----";

  var shouldButton = isMobile;
  if (shouldButton) {
    var button = printButton("Email My Password to Me", target, false,
      function() {
        safeCall(self, function() {
            if (isWeb) {
              // TODO more reliable system
            }
            window.location.href = "mailto:?subject=Save%20this%20password&body=" + encodeURIComponent(password);
        });
      }
    );
    setClass(button, "");
  }

  var shouldTextArea = !isMobile;
  if (shouldTextArea) {
    var textArea = document.createElement("textarea");
    textArea.cols = colWidth + 1;
    textArea.rows = 30;
    setClass(textArea, "savePassword");

    textArea.setAttribute("readonly", true);
    textArea.onclick = function() {textArea.select();};
    textArea.value = (password);
    target.appendChild(textArea);
  }
}

function changeTitle(title) {
  document.title = title;
  var h1 = document.getElementsByTagName("h1");
  if (h1) h1 = h1[0];
  h1.innerHTML = "";
  h1.appendChild(document.createTextNode(title));
  if (window.isWinOldApp) {
    window.external.SetTitle(title);
  }
}

function changeAuthor(author) {
  var authorTag = document.getElementById("author");
  authorTag.innerHTML = "";
  authorTag.appendChild(document.createTextNode("by " + author));
}


function reportBug() {
  var prompt = "Please explain the problem. Be sure to describe what you expect, as well as what actually happened.";
  alertify.prompt(prompt, function(ok, body) {
    var statMsg = "(unknown)";
    try {
        statMsg = toJson(window.stats, '\n');
    } catch (ex) {}
    body += "\n\nGame: " + window.storeName;
    if (window.stats && window.stats.scene) {
      body += "\nScene: " + window.stats.scene.name;
      body += "\nLine: " + (window.stats.scene.lineNum+1);
    }
    body += "\nUser Agent: " + navigator.userAgent;
    body += "\nLoad time: " + window.loadTime;
    if (window.Persist) body += "\nPersist: " + window.Persist.type;
    body += "\nversion=" + window.version;
    body += "\n\n" + statMsg;
    if (window.nav && window.nav.bugLog) body += "\n\n" + window.nav.bugLog.join("\n");
    console.log(body);
    if (ok) alertify.prompt("Please type your email address.", function(ok, email) {
      if (ok) xhrAuthRequest("POST", "support-mail", function(ok, response) {
        if (ok) {
          alertify.log("Thank you for reporting a bug!");
        } else {
          alertify.alert("Bug reporting failed. Please email your bug report to support@choiceofgames.com (and be sure to mention that the bug reporter failed!)");
        }
      }, "email", encodeURIComponent(email),
        "subject", encodeURIComponent("bug report " + window.storeName),
        "text", encodeURIComponent(body));
    });
  });
}

window.registered = false;

function getSupportEmail() {
  if (window.storeName) {
    return "support-" + storeName + "-" + platformCode() + "@choiceofgames.com";
  }
  try {
    return document.getElementById("supportEmail").getAttribute("href").substring(7);
  } catch (e) {
    return "support-external@choiceofgames.com";
  }
}

function absolutizeAboutLink() {
  var aboutAnchor = document.getElementById("aboutLink");
  if (aboutLink) {
    var aboutHref = aboutLink.getAttribute("href");
    if (/^https?:/.test(aboutHref)) return;

    var linkTags = document.getElementsByTagName("link");
    var canonical;
    for (var i = 0; i < linkTags.length; i++) {
      if (linkTags[i].getAttribute("rel") == "canonical") {
        canonical = linkTags[i].getAttribute("href");
        break;
      }
    }

    if (!canonical) return;

    var absoluteCanonical;
    if (/^https?:/.test(canonical)) {
      absoluteCanonical = canonical;
    } else if (/^\//.test(canonical)) {
      absoluteCanonical = "https://www.choiceofgames.com" + canonical;
    } else {
      absoluteCanonical = "https://www.choiceofgames.com/" + canonical;
    }
    if (!/\/$/.test(canonical)) {
      absoluteCanonical += "/";
    }

    aboutLink.setAttribute("href", absoluteCanonical + aboutHref);
  }
}

function aboutClick() {
    window.location.href = document.getElementById("aboutLink").href;
}

window.onerror=function(msg, file, line, stack) {
    if (window.console) {
      window.console.error(msg);
      if (file) window.console.error("file: " + file);
      if (line) window.console.error("line: " + line);
    }
    if (window.Event && msg instanceof window.Event && /WebKit/.test(navigator.userAgent)) {
      return; // ignore "adsense offline" error
    } else if (/(Error loading script|Script error)/.test(msg) && /(show_ads|google-analytics|version\.js)/.test(file)) {
      return; // ignore "adsense offline" error
    }
    alert(msg);
    if (!window.storeName) return;
    var ok = confirm("Sorry, an error occured.  Click OK to email error data to support.");
    if (ok) {
        var statMsg = "(unknown)";
        try {
            statMsg = toJson(window.stats, '\n');
        } catch (ex) {}
        var body = "What were you doing when the error occured?\n\nError: " + msg;
        if (window.stats && window.stats.scene && window.stats.scene.name) body += "\nScene: " + window.stats.scene.name;
        if (file) body += "\nFile: " + file;
        if (line) body += "\nLine: " + line;
        if (stack) body += "\nStack: " + stack;
        body += "\nUser Agent: " + navigator.userAgent;
        body += "\nLoad time: " + window.loadTime;
        if (window.Persist) body += "\nPersist: " + window.Persist.type;
        body += "\n\n" + statMsg + "\n\nversion=" + window.version;
        if (window.currentVersion) {
          body += "\ncurrentVersion=" + window.currentVersion;
        }
        var supportEmailHref = "mailto:support-external@choiceofgames.com";
        try {
          supportEmailHref="mailto:"+getSupportEmail();
          supportEmailHref=supportEmailHref.replace(/\+/g,"%2B");
        } catch (e) {}
        window.location.href=(supportEmailHref + "?subject=Error Report&body=" + encodeURIComponent(body));
    }
};

window.onload=function() {
    if (window.alreadyLoaded) return;
    window.alreadyLoaded = true;
    window.main = document.getElementById("main");
    var head = document.getElementsByTagName("head")[0];
    window.nav.setStartingStatsClone(window.stats);
    if (initStore()) {
      store.get("preferredZoom", function(ok, preferredZoom) {
        if (ok && !isNaN(parseFloat(preferredZoom))) {
          setZoomFactor(parseFloat(preferredZoom));
        }
      });
      store.get("preferredBackground", function(ok, preferredBackground) {
        if (!/^(sepia|black|white)$/.test(preferredBackground)) {
          preferredBackground = "sepia";
        }
        if (preferredBackground === "black") {
          document.body.classList.add("nightmode");
        } else if (preferredBackground === "white") {
          document.body.classList.add("whitemode");
        }
      });
    }
    if (window.achievements && window.achievements.length) {
      nav.loadAchievements(window.achievements);
      checkAchievements(function() {});
      setButtonTitles();
    }
    nav.loadProducts(window.knownProducts, window.purchases);
    stats.sceneName = window.nav.getStartupScene();
    var map = parseQueryString(window.location.search);
    if (!map) {
      if (window.androidQueryString) {
        map = parseQueryString(window.androidQueryString);
      } else if (window.forcedScreenshots) {
        map = {forcedScene:"screenshots"};
      }
    }

    if (map) {
      window.forcedScene = map.forcedScene;
      window.slot = map.slot;
      window.debug = map.debug;
      if (map.restart) {
        restartGame();
      } else if (map.achievements) {
        doneLoading();
        showAchievements("hideNextButton");
      } else if (map.forcedScene) {
        safeCall(null, function() {loadAndRestoreGame(window.slot, window.forcedScene);});
      } else if (map.persistence) {
        var persistenceParts = map.persistence.split("|");
        if (persistenceParts.length == 2) {
          window.storeName = persistenceParts[0];
          window.remoteStoreName = persistenceParts[1];
        } else {
          window.storeName = map.persistence;
        }
        var startupScene = new Scene("startup", window.stats, window.nav, {secondaryMode:"startup", saveSlot:"startup"});
        startupScene.startupCallback = function() {
          safeCall(null, loadAndRestoreGame);
        }
        startupScene.execute();
      } else if (map.textOptionsMenu) {
        textOptionsMenu();
      } else {
        safeCall(null, loadAndRestoreGame);
      }
    } else {
      safeCall(null, loadAndRestoreGame);
    }
    if (window.Touch && window.isWeb) {
      // INSERT ADMOB AD
    }
    isRegistered(function(registered){
      if (registered) {
        fetchEmail(function(email) {
          loginDiv(registered, email);
        });
      } else {
        loginDiv();
      }
    });
    if (window.isWinStoreApp || window.isWinOldApp) {
        var subscribeAnchor = document.getElementById("subscribeLink");
        if (subscribeAnchor) {
            subscribeAnchor.onclick = function() {
              safeCall(null, subscribeLink);
              return false;
            };
        }
    }
    if (window.isCef || window.isNode || window.isMacApp) {
      var buttons = document.getElementById("buttons");
      buttons.appendChild(document.createTextNode(" "));
      var menuButton = document.createElement("button");
      menuButton.id = "menuButton";
      setClass(menuButton, "spacedLink");
      menuButton.onclick = showMenu;
      menuButton.innerHTML = "Menu";
      buttons.appendChild(menuButton);
    } else if (window.isWeb) {
      var buttons = document.getElementById("buttons");
      buttons.appendChild(document.createTextNode(" "));
      var menuButton = document.createElement("button");
      menuButton.id = "menuButton";
      setClass(menuButton, "spacedLink");
      menuButton.onclick = textOptionsMenu;
      menuButton.innerHTML = "Settings";
      buttons.appendChild(menuButton);
    }
    if (window.isWinOldApp) {
        absolutizeAboutLink();
        var h1s = document.getElementsByTagName("h1");
        if (h1s.length) window.external.SetTitle(document.getElementsByTagName("h1")[0].innerText);
    }
    if (isFollowEnabled()) {
      var shareElement = document.getElementById("share");
      if (shareElement) shareElement.innerHTML = '<iframe src="//www.facebook.com/plugins/like.php?href=https%3A%2F%2Fwww.facebook.com%2Fchoiceofgames&amp;send=false'+
      '&amp;layout=button_count&amp;width=90&amp;show_faces=true&amp;font&amp;colorscheme=light&amp;action=like&amp;height=20&amp;appId=190439350983878"'+
      ' scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:90px; height:20px;" allowTransparency="true"></iframe>'+
      '<iframe allowtransparency="true" frameborder="0" scrolling="no" '+
      'src="//platform.twitter.com/widgets/follow_button.html?screen_name=choiceofgames&amp;show_screen_name=false"'+
      ' style="width:160px; height:20px;"></iframe>';
    }
    var supportEmailLink = document.getElementById("supportEmail");
    if (window.storeName && supportEmailLink) {
      supportEmailLink.href = "mailto:" + getSupportEmail();
    }

    submitAnyDirtySaves();

    if (window.purchaseSubscriptions) {
      var productList = "";
      for (var key in purchaseSubscriptions) {
        productList += (productList ? " " : "") + key;
      }
      if (productList) checkPurchase(productList, function() {});
    }
    if (window.isWeb) {
      (function() {
        if (window.releaseDate && new Date() < window.releaseDate) {
          var appLinks = document.getElementById('mobileLinks');
          if (appLinks) appLinks.style.display = 'none';
        }
        var productMap = {};
        if (typeof purchases === "object") {
          for (var scene in purchases) {
            productMap[purchases[scene]] = 1;
          }
        }
        if (!window.knownProducts) window.knownProducts = [];
        for (var product in productMap) {
          window.knownProducts.push(product);
        }

        var fullProducts = [];
        for (var i = 0; i < window.knownProducts.length; i++) {
          fullProducts[i] = window.storeName + "." + window.knownProducts[i];
        }
        xhrAuthRequest("GET", "product-data", function(ok, data) {
          if (!window.productData) window.productData = {};
          for (var i = 0; i < window.knownProducts.length; i++) {
            window.productData[window.knownProducts[i]] = data[window.storeName + "." + window.knownProducts[i]];
          }
        }, "products", fullProducts.join(","));
      })();
    }

};

if ( document.addEventListener ) {
  document.addEventListener( "DOMContentLoaded", window.onload, false );
}

try {
  var style = document.createElement('style');
  style.type = 'text/css';
  try {style.innerHTML = 'noscript {display: none;}'; } catch (e) {}
  document.getElementsByTagName('head')[0].appendChild(style);
} catch (e) {}

if (window.isWeb) {
  document.getElementById("dynamic").innerHTML = ".webOnly { display: block; }";
  var checkoutScript = document.createElement("script");
  checkoutScript.async = 1;
  checkoutScript.src="https://checkout.stripe.com/v2/checkout.js";
  document.getElementsByTagName("head")[0].appendChild(checkoutScript);

  var metas = document.getElementsByTagName("meta");
  var facebookAppId, googleAppId;
  var googleLoginCallbackCallback;
  for (var i = 0; i < metas.length; i++) {
    var meta = metas[i];
    if ("fb:app_id" == meta.getAttribute("property")) {
      facebookAppId = meta.getAttribute("content");
    } else if ("google-signin-clientid" == meta.getAttribute("name")) {
      googleAppId = meta.getAttribute("content");
    }
  }

  if (facebookAppId) {
    window.fbAsyncInit = function() {
      FB.init({
        appId      : facebookAppId,
        cookie     : true,  // enable cookies to allow the server to access 
                            // the session
        xfbml      : true,  // parse social plugins on this page
        version    : 'v2.0' // use version 2.0
      });
    };

    (function(d, s, id){
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src ="//connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document,'script','facebook-jssdk'));
  }

  if (googleAppId) (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/client:plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
  
} else if (window.isIosApp) {
  document.getElementById("dynamic").innerHTML =
  "#header { display: none; }"+
  ""+
  "body { transition-duration: 0; }"+
  ""+
  "#emailUs { display: none; }"+
  ""+
  "#main { padding-top: 1em; }";
  // Use UIWebView width, not screen width, on iPad
  document.querySelector("meta[name=viewport]").setAttribute("content", "width="+window.innerWidth);
  window.addEventListener("resize", function() {
      document.querySelector("meta[name=viewport]").setAttribute("content", "width="+window.innerWidth);
      // this dummy element seems to be required to get the viewport to stick
      var dummy = document.createElement("p");
      dummy.innerHTML = "&nbsp;";
      document.body.appendChild(dummy);
      window.setTimeout(function() {document.body.removeChild(dummy);}, 10);
    }, false);
  callIos("checkdiscounts");
  // in a timeout because iOS may try to add to the head before mygame.js has run
  (function(){
    var requester = function() {
      if (window.stats) {
        callIos("requestscenes");
      } else {
        safeTimeout(requester, 1);
      }
    }
    safeTimeout(requester, 0);
  })();
} else if (window.isAndroidApp) {
  document.getElementById("dynamic").innerHTML =
  "#header { display: none; }"+
  ""+
  "#emailUs { display: none; }"+
  ""+
  "#main { padding-top: 1em; }";
} else if (window.isMacApp || window.isWinOldApp || window.isCef || window.isNode) {
  document.getElementById("dynamic").innerHTML =
    "#headerLinks { display: none; }"+
    ""+
    "#emailUs { display: none; }";
}
// on touch devices, this hover state never goes away
if (!('ontouchstart' in window)) {
  document.getElementById("dynamic").innerHTML += ".choice label:hover {background-color: #E4DED8;}\n" +
    "body.nightmode .choice label:hover {background-color: #555;}\n"+
    "body.whitemode .choice label:hover {background-color: #ddd;}\n";
}
if (window.isChromeApp) {
  var base = document.createElement('base');
  base.setAttribute("target", "_blank");
  document.head.appendChild(base);

  document.addEventListener( "DOMContentLoaded", function() {
    var aboutLink = document.getElementById("aboutLink");
    aboutLink.addEventListener("click", function() {
      if (chrome.app.window) {
        event.preventDefault();
        chrome.app.window.create("credits.html", {}, function(w) {
          w.contentWindow.addEventListener( "DOMContentLoaded", function() {
            var win = this;
            var back = win.document.getElementById("back");
            back.addEventListener("click", function(event) {
              event.preventDefault();
              win.close();
            }, false);
            var base = win.document.createElement('base');
            base.setAttribute("target", "_blank");
            win.document.head.appendChild(base);
            win.document.documentElement.style.overflowY = "scroll";
          }, false);
        });
      }
    }, false);

    var statsButton = document.getElementById("statsButton");
    if (statsButton) {
      statsButton.onclick = undefined;
      statsButton.addEventListener("click", function() {
        showStats();
      }, false);
    }

    var achievementsButton = document.getElementById("achievementsButton");
    if (achievementsButton) {
      achievementsButton.onclick = undefined;
      achievementsButton.addEventListener("click", function() {
        showAchievements();
      }, false);
    }

    var restartButton = document.getElementById("restartButton");
    restartButton.onclick = undefined;
    restartButton.addEventListener("click", function() {
      restartGame("prompt");
    }, false);

    var subscribeAnchor = document.getElementById("subscribeLink");
    subscribeAnchor.onclick = undefined;
    subscribeAnchor.addEventListener("click", function() {
      subscribeLink();
    }, false);

    var supportAnchor = document.getElementById("supportEmail");
    supportAnchor.addEventListener("click", function(event) {
      event.preventDefault();
    }, false);

  }, false );
}
if (window.isCef) {
  var pollPurchases = function() {
    cefQuery({
      request:"PollPurchases",
      onSuccess:function(response){
        //console.log("PollPurchases: '"+response+"'");
        if (response) {
          clearScreen(loadAndRestoreGame);
        }
        safeTimeout(pollPurchases, 100);
      },
      onFailure:function(error_code, error_message) {
        console.error("PollPurchases error: " + error_message);
      }
    });
  };
  pollPurchases();
} else if (window.isGreenworks) {
	(function() {
		var greenworksApps = require('../package.json').products;
		if (typeof greenworksApps === "undefined") throw new Error("package.json missing products");
		var greenworksAppId = window.isTrial ? greenworksApps.steam_demo : greenworksApps.adfree;
		if (greenworks.restartAppIfNecessary(greenworksAppId)) return require('electron').remote.app.quit();
		if (!greenworks.initAPI()) {
			var errorCode = greenworks.isSteamRunning() ? 77778 : 77777;
			alert("There was an error connecting to Steam. Steam must be running" +
				" to play this game. If you launched this game using Steam, try restarting Steam" +
				" or rebooting your computer. If that doesn't work, try completely uninstalling" +
				" Steam and downloading a fresh copy from steampowered.com.\n\nIf none of that works, please contact" +
				" support@choiceofgames.com and we'll try to help. (Mention error code "+errorCode+".)")
			require('electron').remote.app.quit();
    }
		if (window.isTrial && greenworks.isSubscribedApp(greenworksApps.adfree)) {
			alert("This is the demo version of the game, " +
				"but you now own the full version. The demo will now exit. Your progress has been saved." +
				" Please launch the full version of the game using Steam.");
			require('electron').remote.app.quit();
		}
		var pollPurchases = function(oldCount) {
			var count = 0;
			for (var product in greenworksApps) {
				if (greenworks.isSubscribedApp(greenworksApps[product])) {
					count++;
				}
			}
			if (count != oldCount && typeof oldCount !== "undefined") clearScreen(loadAndRestoreGame);
			safeTimeout(function() {pollPurchases(count)}, 100);
		};
		pollPurchases();

    var appIds = [];
    for (var product in greenworksApps) {
      appIds.push(greenworksApps[product]);
    }

    xhrAuthRequest("GET", "steam-price", function(ok, data) {
      if (!window.productData) window.productData = {};
      for (var product in greenworksApps) {
        window.productData[product] = data[greenworksApps[product]];
      }
      if (window.awaitSteamProductData) window.awaitSteamProductData();
    }, "user_id", greenworks.getSteamId().steamId, "app_ids", appIds.join(","));
	})();
}

function winStoreShareLinkHandler(e) {
    var request = e.request;
    var canonical = document.querySelector("link[rel=canonical]");
    var canonicalHref = canonical && canonical.getAttribute("href");
    if (!/^https?:/.test(canonicalHref)) {
        canonicalHref = "https://www.choiceofgames.com" + canonicalHref;
    }
    if (!/\/$/.test(canonicalHref)) {
        canonicalHref += "/";
    }
    canonicalHref += "redirect.php?src=winshare";
    request.data.properties.title = document.title;
    request.data.properties.description = document.querySelector("meta[name=description]").getAttribute("content");
    request.data.setUri(new Windows.Foundation.Uri(canonicalHref));
}

if (window.isWinStoreApp) {
    var dataTransferManager = Windows.ApplicationModel.DataTransfer.DataTransferManager.getForCurrentView();
    dataTransferManager.addEventListener("datarequested", winStoreShareLinkHandler);

    baseScript = document.createElement("script");
    baseScript.src = "//Microsoft.WinJS.1.0/js/base.js";
    baseScript.onload = function () {
        WinJS.Application.onsettings = function (e) {
            var privacyCmd = new Windows.UI.ApplicationSettings.SettingsCommand("privacy", "Privacy Policy", function () {
                window.open("https://www.choiceofgames.com/privacy-policy");
            });
            e.detail.e.request.applicationCommands.append(privacyCmd);
        };
        WinJS.Application.start();
    };
    document.head.appendChild(baseScript);

    uiScript = document.createElement("script");
    uiScript.src = "//Microsoft.WinJS.1.0/js/ui.js";
    document.head.appendChild(uiScript);
} else if (window.isWinOldApp) {
    console = {
        log: function (message) { window.external.ConsoleLog(message); },
        error: function (message) { window.external.ConsoleError(message); }
    };
    document.oncontextmenu = function() {return false;};
}

function platformCode() {
  if (window.isIosApp) return "ios";
  if (window.isAndroidApp) return "android";
  if (window.isMacApp) return "mac";
  if (window.isWinStoreApp) return "windows";
  if (window.isWinOldApp) return "csharp";
  if (window.isChromeApp) return "chrome";
  if (window.isWebOS) return "palm";
  if (window.isSteamApp) return "steam";
  if (window.isCef) return "cef";
  if (window.isNode) return "dl";
  if (window.isWeb) return "web";
  return "unknown";
}

function reinjectNavigator() {
  if (window.stats && window.stats.scene && window.stats.scene.nav) {
    var scene = window.stats.scene;
    scene.nav = window.nav;
    nav.repairStats(scene.stats);
  }
}
/*
 * Copyright 2010 by Dan Fabulich.
 *
 * Dan Fabulich licenses this file to you under the
 * ChoiceScript License, Version 1.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *  http://www.choiceofgames.com/LICENSE-1.0.txt
 *
 * See the License for the specific language governing
 * permissions and limitations under the License.
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied.
 */
function Scene(name, stats, nav, options) {
    if (!name) name = "";
    if (!stats) stats = {};
    // the name of the scene
    this.name = name;

    // the permanent statistics and the temporary values
    this.stats = stats;
    this.temps = {choice_reuse:"allow", choice_user_restored:false};

    // the navigator determines which scene comes next
    this.nav = nav;

    options = options || {};

    // should we print debugging information?
    this.debugMode = options.debugMode || false;

    // used for stats screen, and maybe other secondary views someday
    this.secondaryMode = options.secondaryMode;

    this.saveSlot = options.saveSlot || "";

    // the array of lines in the scene file
    this.lines = [];

    // the current line number (WARNING 0-based!)
    this.lineNum = 0;
    this.rollbackLineCoverage();

    // when this is true, the main printLoop will halt
    this.finished = false;

    // map of label names to line numbers
    this.labels = {};

    // the current amount of indentation
    this.indent = 0;

    // Did the previous line contain text?
    this.prevLine = "empty";

    // Have we ever printed any text?
    this.screenEmpty = true;

    // Have we run any commands (except for create and scene_list) yet?
    this.initialCommands = true;

    this.stats.sceneName = name;

    // for easy reachability from the window
    this.stats.scene = this;

    // where should we print text?
    this.target = null;
}

Scene.prototype.reexecute = function reexecute() {
  this.lineNum = this.stats.testEntryPoint || 0;
  this.finished = 0;
  this.indent = this.getIndent(this.lines[this.lineNum]);
  this.prevLine = "empty";
  this.screenEmpty = true;
  this.execute();
};

// the main loop of the scene
Scene.prototype.printLoop = function printLoop() {
    var line;
    for (;!this.finished && this.lineNum < this.lines.length; this.lineNum++) {
        line = this.lines[this.lineNum];
        if (!trim(line)) {
            this.paragraph();
            continue;
        }
        var indent = this.getIndent(line);
        if (indent > this.indent) {
            // ignore indentation level of *comments
            if (/\s*\*comment\b/.test(line)) continue;
            throw new Error(this.lineMsg() + "increasing indent not allowed, expected " + this.indent + " was " + indent);
        } else if (indent < this.indent) {
            this.dedent(indent);
        }
        if (this.temps.fakeChoiceLines && this.temps.fakeChoiceLines[this.lineNum]) {
          this.rollbackLineCoverage();
          this.lineNum = this.temps.fakeChoiceEnd;
          this.rollbackLineCoverage();
          delete this.temps.fakeChoiceEnd;
          delete this.temps.fakeChoiceLines;
          continue;
        }
        this.indent = indent;
        if (!this.runCommand(line)) {
            if (/^\s*#/.test(line)) {
                if (this.temps.fakeChoiceEnd) {
                    this.rollbackLineCoverage();
                    this.lineNum = this.temps.fakeChoiceEnd;
                    this.rollbackLineCoverage();
                    delete this.temps.fakeChoiceEnd;
                    delete this.temps.fakeChoiceLines;
                    continue;
                } else {
                    throw new Error(this.lineMsg() + "It is illegal to fall out of a *choice statement; you must *goto or *finish before the end of the indented block.");
                }
            }
            this.prevLine = "text";
            this.screenEmpty = false;
            this.printLine(line);
        }
    }
    this.rollbackLineCoverage();
    if (!this.finished) {
        this.autofinish();
    }
    this.save("temp");
    if (this.skipFooter) {
        this.skipFooter = false;
    } else {
        printFooter();
    }
};

Scene.prototype.dedent = function dedent(newDent) {};

Scene.prototype.printLine = function printLine(line, parent) {
    if (!line) return null;
    line = this.replaceVariables(line.replace(/^ */, ""));
    if (!parent) parent = this.target;
    printx(line, parent);
    // insert extra space unless the line ends with hyphen or dash
    if (!/[-\u2011-\u2014]$/.test(line)) printx(' ', parent);
};

Scene.prototype.replaceVariables = function (line) {
  line = String(line);
  var replacer = /([$@](\!?\!?)\{)/;
  var index = 0;
  var output = [];
  for (var result = replacer.exec(line); result; result = replacer.exec(line.substring(index))) {
    output.push(line.substring(index, index + result.index));
    var curlies = 0;
    var closingCurly = -1;
    var exprStart = index + result.index + result[1].length;
    for (var i = exprStart; i < line.length; i++) {
      var c = line.charAt(i);
      if (c === "{") {
        curlies++;
      } else if (c === "}") {
        if (curlies) {
          curlies--;
        } else {
          closingCurly = i;
          break;
        }
      }
    }
    if (closingCurly == -1) {
      throw new Error(this.lineMsg() + "invalid "+result[0]+"} variable substitution at letter " + (index + result.index + 1));
    }
    var body = line.substring(exprStart, closingCurly);
    var stack, value;
    if (result[0].charAt(0) === "$") {
      stack = this.tokenizeExpr(body);
      value = this.evaluateExpr(stack);
    } else {
      var expr;
      var options;
      if (/^\s*\(/.test(body)) {
        var parens = 0;
        var closingParen = -1;
        for (var i = 1; i < body.length; i++) {
          var c = body.charAt(i);
          if (c === "(") {
            parens++;
          } else if (c === ")") {
            if (parens) {
              parens--;
            } else {
              closingParen = i;
              break;
            }
          }
        }
        if (closingParen == -1) {
          throw new Error(this.lineMsg() + "invalid "+result[0]+"} at letter " + (index + result.index + 1) + "; missing closing parenthesis )");
        }
        if (body.charAt(closingParen+1) != " ") {
          throw new Error(this.lineMsg() + "invalid "+result[0]+"} at letter " + (index + result.index + 1) + "; there should be a space after the closing parenthesis )");
        }
        expr = body.substring(1, closingParen);
        options = body.substring(closingParen+2).split("|");
      } else {
        if (!/^\S+ /.test(body)) {
          throw new Error(this.lineMsg() + "invalid "+result[0]+"} at letter " + (index + result.index + 1) + "; there should be a space after the first word");
        }
        var spaceIndex = body.indexOf(' ');
        expr = body.substring(0, spaceIndex);
        options = body.substring(spaceIndex+1).split("|");
      }
      if (options.length < 2) {
        throw new Error(this.lineMsg() + "invalid "+result[0]+"} at letter " + (index + result.index + 1) + "; there should be at least one pipe | to separate options");
      }
      stack = this.tokenizeExpr(expr);
      value = this.evaluateExpr(stack);
      if (typeof value === "boolean" || /^(true|false)$/i.test(value)) {
        value = bool(value) ? 1 : 2;
      }
      value = num(value, this.lineNum+1);
      if ((value | 0) !== value) {
        throw new Error(this.lineMsg() + "invalid "+result[0]+"} at letter " + (index + result.index + 1) + "; '"+expr+"' is equal to " + value + " which is not a whole integer number");
      } else if (value < 1) {
        throw new Error(this.lineMsg() + "invalid "+result[0]+"} at letter " + (index + result.index + 1) + "; '"+expr+"' is equal to " + value + " which is not a positive number");
      } else if (value > options.length) {
        throw new Error(this.lineMsg() + "invalid "+result[0]+"} at letter " + (index + result.index + 1) + "; '"+expr+"' is equal to " + value + " but there are only " + options.length + " options");
      }
      value = options[value-1];
      value = this.replaceVariables(value);
    }
    var capitalize = result[2];
    if (capitalize) value = String(value);
    if (capitalize == "!") {
      value = value.charAt(0).toUpperCase() + value.slice(1);
    } else if (capitalize == "!!") {
      value = value.toUpperCase();
    }
    if (typeof highlightGenderPronouns != "undefined" && highlightGenderPronouns && /\b(he|him|his|she|her|hers)\b/gi.test(value)) {
      // this zero-width space will give us a hint for highlighting
      output.push("\u200b");
    }
    output.push(value);
    index = closingCurly+1;
  }
  if (index === 0) return line;
  output.push(line.substring(index));
  return output.join("");
};

Scene.prototype.paragraph = function paragraph() {
    if (this.prevLine == "text") {
        println("", this.target);
        println("", this.target);
    } else if (this.prevLine == "block") {
      println("", this.target);
    }
    this.prevLine = "empty";
};

Scene.prototype.loadSceneFast = function loadSceneFast(url) {
    if (this.loading) return;
    this.loading = true;
    var result;
    if (window.cachedResults && window.cachedResults[this.name]) {
      result = window.cachedResults[this.name];
      return this.loadLinesFast(result.crc, result.lines, result.labels);
    } else if (typeof allScenes != "undefined") {
      result = allScenes[this.name];
      if (!result) throw new Error("Couldn't load scene '" + this.name + "'\nThe file doesn't exist.");
      return this.loadLinesFast(result.crc, result.lines, result.labels);
    } else if (typeof isIosApp != "undefined") {
      startLoading();
      var self = this;
      var startedWaiting = new Date().getTime();

      function retryScenes(command) {
        if (!command) command = "retryscenes";
        clearScreen(function() {
          startLoading();
          if (command == "retryscenes") curl();
          window.downloadState = null;
          callIos(command);
          startedWaiting = new Date().getTime();
          awaitAllScenes();
        });
      }

      function awaitAllScenes() {
        if (typeof allScenes != "undefined") {
          result = allScenes[self.name];
          if (!result) throw new Error("Couldn't load scene '" + self.name + "'\nThe file doesn't exist.");
          self.loadLinesFast(result.crc, result.lines, result.labels);
        } else if (window.downloadState == "failed" || (new Date().getTime() - startedWaiting) > 5000) {
          doneLoading();
          if (window.downloadRequired) {
            println("We weren't able to download the latest version of the game.");
            println("");
            printButton("Try Again", main, false, retryScenes);
          } else {
            println("We weren't able to download the latest version of the game. Please try downloading again. The latest version may contain important fixes.");
            println("");
            var retry = {name: "Try downloading again."};
            var ignore = {name: "Continue playing without the latest version."}
            printOptions([""], [retry, ignore], function(option) {
              if (option == retry) {
                retryScenes();
              } else {
                retryScenes("requestscenesforce");
              }
            });
          }
        } else {
          setTimeout(awaitAllScenes, 0);
        }
      }
      return awaitAllScenes();
    }
    startLoading();
    if (!url) {
        url = Scene.baseUrl + "/" + this.name.replace(/ /g, "_") + ".txt.json";
    }
    var xhr = findXhr();
    xhr.open("GET", url, true);
    var self = this;
    var done = false;
    xhr.onreadystatechange = function() {
        if (done) return;
        if (xhr.readyState != 4) return;
        if (xhr.status == 403) {
          try {
            var err = JSON.parse(xhr.responseText);
            if (err.error == "not registered") {
              return isRegistered(function(registered) {
                if (registered) {
                  logout();
                  loginDiv();
                }
                return clearScreen(function() {
                  loginForm(main, 0/*optional*/,
                    "Please sign in to access this part of the game.", function() {
                      clearScreen(loadAndRestoreGame);
                    });
                });
              });
            }
          } catch (e) {} // JSON parse failure? must not be a login prompt
        }
        done = true;

        var result;
        try {
          result = jsonParse(xhr.responseText);
        } catch (e) {
          if (window.console) console.error(e, e.stack);
        }
        if (window.isWeb && (xhr.status != 200 || !result)) {
          var status = xhr.status;
          if (status == 200 || !status) status = "network";
          main.innerHTML = "<p>Our apologies; there was a " + status + " error while loading game data."+
          "  Please refresh your browser now; if that doesn't work, please click the Restart button and email "+getSupportEmail()+" with details.</p>"+
          " <p><button onclick='window.location.reload();'>Refresh Now</button></p>";
          return;
        } else if (xhr.responseText === "") {
          throw new Error("Couldn't load " + url + "\nThe file is probably missing or empty.");
        }

        if (!window.cachedResults) window.cachedResults = {};
        cachedResults[self.name] = result;
        self.loadLinesFast(result.crc, result.lines, result.labels);
    };
    if (isIE) {
      // IE8 swallows errors in onreadystatechange if xhr.send is in a try block
      xhr.send(null);
    } else {
      try {
        xhr.send(null);
      } catch (e) {
        if (window.location.protocol == "file:" && !window.isMobile) {
          if (/Chrome/.test(navigator.userAgent)) {
            window.onerror("We're sorry, Google Chrome has blocked ChoiceScript from functioning.  (\"file:\" URLs cannot "+
            "load files in Chrome.)  ChoiceScript works just fine in Chrome, but only on a published website like "+
            "choiceofgames.com.  For the time being, please try another browser like Mozilla Firefox.");
            return;
          }
        }
        window.onerror("Couldn't load URL: " + url + "\n" + e);
      }
    }
};

Scene.prototype.loadLinesFast = function loadLinesFast(crc, lines, labels) {
  this.checkSum(crc);
  this.lines = lines;
  this.labels = labels;
  this.loading = false;
  this.loaded = true;
  var self = this;
  if (this.executing) {
    safeCall(this, function() {
      doneLoading();
      self.execute();
    });
  }
};

// load the scene file from the specified URL (or from default URL by name)
Scene.prototype.loadScene = function loadScene(url) {
    if (this.loading) return;
    this.loading = true;
    startLoading();
    if (!url) {
        url = Scene.baseUrl + "/" + this.name + ".txt";
    }
    var xhr = findXhr();
    xhr.open("GET", url, true);
    var self = this;
    var done = false;
    xhr.onreadystatechange = function() {
        if (done) return;
        if (xhr.readyState != 4) return;
        done = true;
        if (xhr.status == 403) {
          try {
            var err = JSON.parse(xhr.responseText);
            if (err.error == "not registered") {
              return isRegistered(function(registered) {
                if (registered) {
                  logout();
                  loginDiv();
                }
                return clearScreen(function() {
                  loginForm(main, 0/*optional*/,
                    "Please sign in to access this part of the game.", function() {
                      clearScreen(loadAndRestoreGame);
                    });
                });
              });
            }
          } catch (e) {} // JSON parse failure? must not be a login prompt
        }
        if (window.isWeb && xhr.status != 200) {
            var status = xhr.status || "network";
            main.innerHTML = "<p>Our apologies; there was a " + status + " error while loading game data."+
            "  Please refresh your browser now; if that doesn't work, please email "+getSupportEmail()+" with details.</p>"+
            " <p><button onclick='window.location.reload();'>Refresh Now</button></p>";
            return;
        } else if (xhr.responseText === "") {
          if (window.location.protocol == "file:" && !window.isMobile && /Chrome/.test(navigator.userAgent)) {
            window.onerror("We're sorry, Google Chrome has blocked ChoiceScript from functioning.  (\"file:\" URLs cannot "+
            "load files in Chrome.)  ChoiceScript works just fine in Chrome, but only on a published website like "+
            "choiceofgames.com.  For the time being, please try another browser like Mozilla Firefox.");
            return;
          } else {
            window.onerror("Couldn't load " + url + "\nThe file is probably missing or empty.");
            return;
          }
        }
        var result = xhr.responseText;
        scene = result;
        scene = scene.replace(/\r/g, "");
        this.loading = false;
        self.loadLines(scene);
        if (self.executing) {
            safeCall(self, function () {
              doneLoading();
              self.execute();
            });
        }
    };
    if (isIE) {
      // IE8 swallows errors in onreadystatechange if xhr.send is in a try block
      xhr.send(null);
    } else {
      try {
        xhr.send(null);
      } catch (e) {
        if (window.location.protocol == "file:" && !window.isMobile) {
          if (/Chrome/.test(navigator.userAgent)) {
            window.onerror("We're sorry, Google Chrome has blocked ChoiceScript from functioning.  (\"file:\" URLs cannot "+
            "load files in Chrome.)  ChoiceScript works just fine in Chrome, but only on a published website like "+
            "choiceofgames.com.  For the time being, please try another browser like Mozilla Firefox.");
            return;
          } else if (e.code === 1012 /*NS_ERROR_DOM_BAD_URI*/) {
            window.onerror("Couldn't load scene file: " + url + "\nThe file is probably missing.");
            return;
          }
        }
        window.onerror("Couldn't load URL: " + url + "\n" + e);
      }
    }
};

Scene.prototype.checkSum = function checkSum(crc) {
  if (this.temps.choice_crc) {
    if (this.temps.choice_crc != crc) {
      // The scene has changed; restart the scene
      var userRestored = this.temps.choice_user_restored || false;
      this.temps = {choice_reuse:"allow", choice_user_restored:userRestored, choice_crc: crc};
      this.lineNum = 0;
      this.indent = 0;
    }
  } else {
    this.temps.choice_crc = crc;
  }
};

Scene.prototype.loadLines = function loadLines(str) {
    var crc = crc32(str);
    this.checkSum(crc);
    this.lines = str.split('\n');
    this.parseLabels();
    this.loaded = true;
};

// launch the vignette as soon as it's available
Scene.prototype.execute = function execute() {
    if (!this.loaded) {
        this.executing = true;
        if (Scene.generatedFast || (typeof generatedFast != "undefined" && generatedFast) || typeof allScenes != 'undefined') {
          this.loadSceneFast();
        } else {
          this.loadScene();
        }
        return;
    }
    if (this.nav) this.nav.repairStats(stats);
    doneLoading();
    if (typeof this.targetLabel != "undefined") {
      var label = this.targetLabel.label.toLowerCase();
      if (typeof(this.labels[label]) != "undefined") {
          this.lineNum = this.labels[label];
          this.indent = this.getIndent(this.lines[this.lineNum]);
          delete this.targetLabel;
      } else {
          throw new Error(this.targetLabel.origin + " line " + (this.targetLabel.originLine+1) + ": "+this.name+" doesn't contain label " + label);
      }
    }
    this.printLoop();
};

// loop through the file looking for *label commands
Scene.prototype.parseLabels = function parseLabels() {
    var lineLength = this.lines.length;
    var oldLineNum = this.lineNum;
    var screenshots = ("choicescript_screenshots" == this.name);
    var seenChoiceWithoutSet = 0;
    for (this.lineNum = 0; this.lineNum < lineLength; this.lineNum++) {
        this.rollbackLineCoverage();
        var line = this.lines[this.lineNum];
        // strip byte order mark
        if (this.lineNum == 0 && line.charCodeAt(0) == 65279) lines[0] = line.substring(1);
        var invalidCharacter = line.match(/^(.*)\ufffd/);
        if (invalidCharacter) throw new Error(this.lineMsg() + "invalid character. (ChoiceScript text should be saved in the UTF-8 encoding.) " + invalidCharacter[0]);
        var result = /^(\s*)\*(\w+)(.*)/.exec(line);
        if (!result) continue;
        var indentation = result[1];
        var indent = indentation.length;
        var command = result[2].toLowerCase();
        var data = trim(result[3]);
        if ("label" == command) {
            data = data.toLowerCase();
            if (/\s/.test(data)) throw new Error(this.lineMsg() + "label '"+data+"' is not allowed to contain spaces");
            if (this.labels.hasOwnProperty(data)) {
              throw new Error(this.lineMsg() + "label '"+data+"' already defined on line " + (this.labels[data]*1+1));
            }
            this.labels[data] = this.lineNum;
        } else if (screenshots) {
          if ("fake_choice" == command) {
            if (seenChoiceWithoutSet) throw new Error(this.lineMsg() +
              "In choicescript_screenshots, you need to *set at least one variable between *fake_choice commands, so the stat screen looks interesting. " +
              "There was no *set since the last *fake_choice on line " + seenChoiceWithoutSet + ".");
            seenChoiceWithoutSet = this.lineNum+1;
          } else if ("set" == command) {
            seenChoiceWithoutSet = 0;
          }
        }
    }
    this.rollbackLineCoverage();
    this.lineNum = oldLineNum;
};

// if this is a command line, run it
Scene.prototype.runCommand = function runCommand(line) {
    var result = /^\s*\*(\w+)(.*)/.exec(line);
    if (!result) {
      if (this.secondaryMode == "startup" && this.startupCallback) {
        this.finished = true;
        this.skipFooter = true;
        this.startupCallback();
        return true;
      }
      return false;
    }
    var command = result[1].toLowerCase();
    var data = trim(result[2]);
    // Treat *sm_init as a no-op so compiled scenes with that plugin command don't error
    if (command === "sm_init") return true;
    if (Scene.validCommands[command]) {
        if ("comment" == command) return true;
        if (Scene.initialCommands[command]) {
          if ("startup" != String(this.name).toLowerCase() || !this.initialCommands) {
            throw new Error(this.lineMsg() + "Invalid "+command+" instruction, only allowed at the top of startup.txt");
          }
        } else {
          if (this.secondaryMode == "startup" && this.startupCallback) {
            this.finished = true;
            this.skipFooter = true;
            this.startupCallback();
            return true;
          }
          this.initialCommands = false;
        }
        if (command == "choice" && String(this.name).toLowerCase() == "choicescript_screenshots") {
          throw new Error(this.lineMsg() + "choicescript_screenshots files should only contain *fake_choice commands, not real *choice commands");
        }
        this[command](data);
    } else {
        throw new Error(this.lineMsg() + "Non-existent command '"+command+"'");
    }
    return true;
};

// *choice [group1] [group2] ...
// prompt the user with a multiple choice question.
// nested lines are options to be presented to the user
//
// Examples:
// *choice
//    good
//      Good choice
//      *finish
//    bad
//      Bad choice
//      *finish
//
// *choice toy
//    spaceship
//      Nice spaceship
//      *finish
//    train
//      Nice train
//      *finish
//    doll
//      Nice doll
//      *finish
//
// *choice color toy
//    red
//      spaceship
//        Nice red spaceship
//        *finish
//      train
//        Nice red train
//        *finish
//    blue
//       spaceship
//         Nice blue spaceship
//        *finish
//       train
//         Nice red train
//        *finish

// If a group is specified, generate a prompt message, e.g. "*choice toy" -> "Select a toy:"
// If no group is specified, don't generate a prompt message
// if multiple groups are specified, allow the user to make multiple choices simultaneously
//   all multi-dimensional choices must be valid (otherwise throw a parse error)
Scene.prototype.choice = function choice(data) {
    var startLineNum = this.lineNum;
    var groups = data.split(/ /);
    for (var i = 0; i < groups.length; i++) {
      if (!/^\w*$/.test(groups[i])) {
        throw new Error(this.lineMsg() + "invalid choice group name: " + groups[i]);
      }
    }
    var options = this.parseOptions(this.indent, groups);
    var self = this;
    this.renderOptions(groups, options, function(option) {
      self.standardResolution(option);
    });
    this.finished = true;
    if (this.fakeChoice) {
      this.temps.fakeChoiceEnd = this.lineNum;
      var fakeChoiceLines = {};
      for (i = 0; i < options.length; i++) {
        fakeChoiceLines[options[i].line-1] = 1;
      }
      this.temps.fakeChoiceLines = fakeChoiceLines;
    }
    this.lineNum = startLineNum;
};

Scene.prototype.fake_choice = function fake_choice(data) {
    this.fakeChoice = true;
    this.choice(data, true);
    delete this.fakeChoice;
};

Scene.prototype.standardResolution = function(option) {
  var self = this;
  self.lineNum = option.line;
  self.indent = self.getIndent(self.nextNonBlankLine(true/*includingThisOne*/));
  if (option.reuse && option.reuse != "allow") self.temps.choice_used[option.line-1] = 1;
  if (this.nav) this.nav.bugLog.push("#"+(option.line+1) + " " + option.name);

  self.finished = false;
  self.resetPage();
};

Scene.prototype.nextNonBlankLine = function nextNonBlankLine(includingThisOne) {
    var line;
    var i = this.lineNum;
    if (!includingThisOne) i++;
    while(isDefined(line = this.lines[i]) && !trim(line)) {
      i++;
    }
    return line;
};

Scene.prototype.resetCheckedPurchases = function resetCheckedPurchases() {
  for (var temp in this.temps) {
    if (/^choice_purchased/.test(temp)) {
      delete this.temps[temp];
    }
  }
};

// reset the page and invoke code after clearing the screen
Scene.prototype.resetPage = function resetPage() {
    var self = this;
    this.resetCheckedPurchases();
    clearScreen(function() {
      // save in the background, eventually
      self.save("");
      self.prevLine = "empty";
      self.screenEmpty = true;
      self.execute();
    });
};

/* The function needs some explaining.
We want the game to be "refreshable," e.g. on the web.
So we only make a "real" autosave as you click "Next"
But if we do it that way, when we visit the stat screen, it's out of date
So we make a "temp" autosave slot, right as the page finishes redrawing,
and the stat screen uses the "temp" autosave to display your current data.
When you refresh the page, the "temp" autosave is rewritten.

If you save stats on the stat screen, they're written into tempStatWrites;
when the stat screen saves, we transfer tempStatWrites back to the main
game (if the main game is running in a separate iframe, e.g. iOS).

If the main game is about to write the main "" slot, we merge the temp
stat writes into the main stats (and clear the stat writes) before
saving.

Thus, stat changes on the stat screen will only be permanently saved when
the player clicks "Next" in the main game, ensuring that the game is still
refreshable.
*/
Scene.prototype.save = function save(slot) {
    if (this.saveSlot) {
      transferTempStatWrites();
    } else {
      if (!slot) {
        slot = "";
        for (var key in tempStatWrites) {
          if (tempStatWrites.hasOwnProperty(key)) {
            this.stats[key] = tempStatWrites[key];
          }
        }
        tempStatWrites = {};
      }

      saveCookie(function() {}, slot, this.stats, this.temps, this.lineNum, this.indent, this.debugMode, this.nav);
    }
};

// *goto labelName
// Go to the line labeled with the label command *label labelName
//
// goto by reference
//   *create foo "labelName"
//   *goto {foo}
Scene.prototype["goto"] = function scene_goto(line) {
    var label;
    if (/[\[\{]/.test(line)) {
      label = this.evaluateReference(this.tokenizeExpr(line));
    } else {
      label = String(line).toLowerCase();
    }
    if (typeof(this.labels[label]) != "undefined") {
        this.lineNum = this.labels[label];
        this.indent = this.getIndent(this.lines[this.lineNum]);
    } else {
        throw new Error(this.lineMsg() + "bad label " + label);
    }
};

Scene.prototype.gosub = function scene_gosub(label) {
    if (!this.temps.choice_substack) {
      this.temps.choice_substack = [];
    }
    this.temps.choice_substack.push({lineNum: this.lineNum, indent: this.indent});
    this["goto"](label);
};

Scene.prototype.gosub_scene = function scene_gosub_scene(data) {
    if (!this.stats.choice_subscene_stack) {
      this.stats.choice_subscene_stack = [];
    }
    this.stats.choice_subscene_stack.push({name:this.name, lineNum: this.lineNum + 1, indent: this.indent, temps: this.temps});
    this.goto_scene(data);
};

Scene.prototype["return"] = function scene_return() {
    var stackFrame;
    if (this.temps.choice_substack && this.temps.choice_substack.length) {
      stackFrame = this.temps.choice_substack.pop();
      this.lineNum = stackFrame.lineNum;
      this.indent = stackFrame.indent;
    } else if (this.stats.choice_subscene_stack && this.stats.choice_subscene_stack.length) {
      stackFrame = this.stats.choice_subscene_stack.pop();
      this.finished = true;
      this.skipFooter = true;
      var scene = new Scene(stackFrame.name, this.stats, this.nav, {debugMode:this.debugMode, secondaryMode:this.secondaryMode, saveSlot:this.saveSlot});
      scene.temps = stackFrame.temps;
      scene.screenEmpty = this.screenEmpty;
      scene.prevLine = this.prevLine;
      scene.lineNum = stackFrame.lineNum;
      scene.indent = stackFrame.indent;
      scene.execute();
    } else if (!this.temps.choice_substack && !this.stats.choice_subscene_stack) {
      throw new Error(this.lineMsg() + "invalid return; gosub has not yet been called");
    } else {
      throw new Error(this.lineMsg() + "invalid return; we've already returned from the last gosub");
    }

};

// *gotoref expression
// Go to the label identified by the expression
//
// *temp foo
// *set foo "bar"
// *gotoref foo
// Skipped!
// *label bar
Scene.prototype["gotoref"] = function scene_gotoref(expression) {
    var stack = this.tokenizeExpr(expression);
    var value = this.evaluateExpr(stack);
    this["goto"](value);
};


// *finish
// halt the scene
Scene.prototype.finish = function finish(buttonName) {
    this.paragraph();
    this.finished = true;
    var self = this;
    if (this.secondaryMode == "stats") {
      if (typeof window == "undefined") return;
      if (window.forcedScene == "choicescript_stats") return;
      if (window.isAndroidApp && window.statsMode.get()) return;
      printButton(buttonName || "Next", main, false,
        function() {
          clearScreen(loadAndRestoreGame);
        }
      );
      return;
    }
    var nextSceneName = this.nav && nav.nextSceneName(this.name);
    // if there are no more scenes, then just halt
    if (!nextSceneName) {
        if (!this.secondaryMode) this.ending();
        return;
    }
    if (this.screenEmpty) {
      this.goto_scene(nextSceneName);
      return;
    }
    if (!buttonName) buttonName = "Next Chapter";
    buttonName = this.replaceVariables(buttonName);


    printButton(buttonName, main, false,
      function() {
        safeCall(self, function() {
            var scene = new Scene(nextSceneName, self.stats, self.nav, {debugMode:self.debugMode, secondaryMode:self.secondaryMode});
            scene.resetPage();
        });
      }
    );
    if (this.debugMode) println(toJson(this.stats));
};

Scene.prototype.autofinish = function autofinish(buttonName) {
  this.finish(buttonName);
};

// *reset
// clear all stats
Scene.prototype.reset = function reset() {
    this.nav.resetStats(this.stats);
    this.stats.scene = this;
};

Scene.prototype.parseGotoScene = function parseGotoScene(data) {
  var sceneName, label;
  if (/[\[\{]/.test(data)) {
    var stack = this.tokenizeExpr(data);
    sceneName = this.evaluateReference(stack, {toLowerCase: false});
    if (stack.length) {
      label = this.evaluateReference(stack);
    }
    if (stack.length) {
      throw new Error(this.lineMsg() + "Invalid *goto_scene command; nothing should appear after the label " + label);
    }
  } else {
    var words = data.split(/ /);
    sceneName = words[0];
    if (words.length > 2) {
      throw new Error(this.lineMsg() + "Invalid *goto_scene command; nothing should appear after the label " + words[1]);
    } else if (words.length == 2) {
      label = words[1];
    }
  }
  return {sceneName:sceneName, label:label};
};

// *goto_scene foo
//
Scene.prototype.goto_scene = function gotoScene(data) {
    var result = this.parseGotoScene(data);

    this.finished = true;
    this.skipFooter = true;
    var scene = new Scene(result.sceneName, this.stats, this.nav, {debugMode:this.debugMode, secondaryMode:this.secondaryMode, saveSlot:this.saveSlot});
    scene.screenEmpty = this.screenEmpty;
    scene.prevLine = this.prevLine;
    if (typeof result.label != "undefined") scene.targetLabel = {label:result.label, origin:this.name, originLine:this.lineNum};
    scene.execute();
};

// *redirect_scene foo
Scene.prototype.redirect_scene = function redirectScene(data) {
  if (this.secondaryMode != "stats") throw new Error(this.lineMsg() + "The *redirect_scene command can only be used from the stats screen.");
  var args = trim(data).split(/ /);
  var sceneName, label;
  if (args.length == 1) {
    sceneName = data;
  } else {
    sceneName = args[0];
    label = args[1];
  }
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  redirectFromStats(sceneName, label, this.lineNum, function() {
    delete self.secondaryMode;
    self.goto_scene(data);
  });
};

Scene.prototype.product = function product(productId) {
  if (!/^[a-z]+$/.test(productId)) throw new Error(this.lineMsg()+"Invalid product id: " +productId);
  if (this.nav) this.nav.products[productId] = {};
}

Scene.prototype.restore_purchases = function scene_restorePurchases(data) {
  var self = this;
  var target = this.target;
  if (!target) target = document.getElementById('text');
  var button = printButton("Restore Purchases", target, false,
    function() {
      safeCall(self, function() {
          restorePurchases(null, function() {
            self["goto"](data);
            self.finished = false;
            self.resetPage();
          });
      });
    }
  );

  setClass(button, "");
  this.prevLine = "block";
};

Scene.prototype.check_purchase = function scene_checkPurchase(data) {
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  var productList = data.split(/ /);
  for (var i = 0; i < productList.length; i++) {
    var product = productList[i];
    if (!this.nav.products[product] && product != "adfree") {
      throw new Error(this.lineMsg() + "The product " + product + " wasn't declared in a *product command");
    }
  }
  checkPurchase(data, function(ok, result) {
    self.finished = false;
    self.skipFooter = false;
    if (!ok) {
      result = {billingSupported:true};
      self.temps.choice_purchase_error = true;
    }
    result = result || {};
    var products = data.split(/ /);
    var everything = true;
    for (var i = 0; i < products.length; i++) {
      var purchasedProduct = result[products[i]] || false;
      self.temps["choice_purchased_"+products[i]] = purchasedProduct;
      if (!purchasedProduct) everything = false;
    }
    self.temps.choice_purchased_everything = everything;
    self.temps.choice_purchase_supported = !!result.billingSupported;
    self.execute();
  });
};

Scene.prototype.purchase = function purchase_button(data) {
  var result = /^(\w+)\s+(\S+)\s+(.*)/.exec(data);
  if (!result) throw new Error(this.lineMsg() + "invalid line; can't parse purchaseable product: " + data);
  var product = result[1];
  var priceGuess = trim(result[2]);
  var label = trim(result[3]);
  if (!this.nav.products[product] && product != "adfree") {
    throw new Error(this.lineMsg() + "The product " + product + " wasn't declared in a *product command");
  }
  if (typeof this.temps["choice_purchased_"+product] === "undefined") throw new Error(this.lineMsg() + "Didn't check_purchases on this page");
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  getPrice(product, function (price) {
    if (!price || "free" == price) {
      self["goto"](label);
      self.finished = false;
      self.resetPage();
    } else {
      if (price == "guess") price = priceGuess;
      var prerelease = (typeof window !== "undefined" && window.releaseDate && window.isWeb && window.releaseDate > new Date());
      var buttonText;
      if (prerelease) {
        buttonText = "Pre-Order It";
      } else {
        buttonText = "Buy It Now";
      }
      if (price != "hide") {
        buttonText += " for " + price;
      }
      var target = self.target;
      if (!target) target = document.getElementById('text');
      self.paragraph();
      var button = printButton(buttonText, target, false,
        function() {
          safeCall(self, function() {
              purchase(product, function() {
                safeCall(self, function() {
                  self["goto"](label);
                  self.finished = false;
                  self.resetPage();
                });
              });
          });
        }
      );
      self.prevLine = "block";
      if (isRestorePurchasesSupported()) {
        self.prevLine = "text";
        printx("If you've already purchased, click here to ", target);
        printLink(target, "#", "restore purchases",
          function() {
            safeCall(self, function() {
                restorePurchases(product, function(purchased) {
                  if (purchased) {
                    self["goto"](label);
                    self.finished = false;
                    self.resetPage();
                  } else {
                    // refresh, in case we're on web showing a full-screen login. Not necessary on mobile? But, meh.
                    if (!self.secondaryMode) clearScreen(loadAndRestoreGame);
                  }
                });
            });
          }
        );
      }

      self.skipFooter = false;
      self.finished = false;
      self.execute();
    }
  });
};

Scene.prototype.purchase_discount = function purchase_discount(line) {
  var args = trim(String(line)).split(" ");
  if (args.length != 5) throw new Error(this.lineMsg() + "expected five arguments, saw "+args.length+": " + line);
  var product = args[0];
  var expectedEndDateString = args[1];
  var expectedEndDate = parseDateStringInCurrentTimezone(expectedEndDateString, this.lineNum+1);
  var fullPriceGuess = this.replaceVariables(args[2]);
  var discountedPriceGuess = this.replaceVariables(args[3]);
  var label = args[4];
  var startsWithDollar = /^\$/;
  if (!startsWithDollar.test(fullPriceGuess)) {
    throw new Error(this.lineMsg() + "full price guess "+fullPriceGuess+"doesn't start with dollar: " + line);
  }
  if (!startsWithDollar.test(discountedPriceGuess)) {
    throw new Error(this.lineMsg() + "discounted price guess "+discountedPriceGuess+"doesn't start with dollar: " + line);
  }
  var prerelease = (typeof window !== "undefined" && window.releaseDate && window.isWeb && window.releaseDate > new Date());
  var discountText;
  if (prerelease) {
    discountText = "[b]Buy now before the price increases![/b]";
  } else {
    discountText = "[b]On sale until "+shortMonthStrings[expectedEndDate.getMonth()+1]+" "+expectedEndDate.getDate()+"! Buy now before the price increases![/b]"
  }
  if (typeof printDiscount != "undefined") {
    printDiscount(product, expectedEndDate.getYear()+1900, expectedEndDate.getMonth()+1, expectedEndDate.getDate(), discountText);
  }
  var priceGuess;
  if (new Date().getTime() < expectedEndDate.getTime()) {
    priceGuess = discountedPriceGuess;
  } else {
    priceGuess = fullPriceGuess;
  }
  this.purchase([product, priceGuess, label].join(" "));
}

Scene.prototype.print_discount = function print_Discount(line) {
  var result = /(\w+) (\d{4})-(\d{2})-(\d{2}) (.*$)/.exec(line);
  if (!result) throw new Error("invalid discount: " + line);
  var product = result[1];
  var fullYear = result[2];
  var oneBasedMonthNumber = parseInt(result[3],10);
  var dayOfMonth = parseInt(result[4],10);
  var discountText = result[5];
  this.temps.choice_discount_ends = "POISONTOKEN";
  discountText = this.replaceVariables(discountText).replace("POISONTOKEN", "${choice_discount_ends}");
  delete this.temps.choice_discount_ends;
  if (typeof printDiscount != "undefined") printDiscount(product, fullYear, oneBasedMonthNumber, dayOfMonth, discountText);
};

// *abort
// halt the scene without showing a button
Scene.prototype.abort = function() {
  this.paragraph();
  this.finished = true;
};

// *create
// create a new permanent stat
Scene.prototype.create = function create(line) {
    var result = /^(\w*)(.*)/.exec(line);
    if (!result) throw new Error(this.lineMsg()+"Invalid create instruction, no variable specified: " + line);
    var variable = result[1];
    this.validateVariable(variable);
    variable = variable.toLowerCase();
    var expr = result[2];
    var stack = this.tokenizeExpr(expr);
    if (stack.length === 0) throw new Error(this.lineMsg()+"Invalid create instruction, no value specified: " + line);
    var self = this;
    function complexError() {
      throw new Error(self.lineMsg()+"Invalid create instruction, value must be a a number, true/false, or a quoted string: " + line);
    }
    if (stack.length > 1) complexError();
    var token = stack[0];
    if (!/STRING|NUMBER|VAR/.test(token.name)) complexError();
    if ("VAR" == token.name && !/^true|false$/i.test(token.value)) complexError();
    if ("STRING" == token.name && /\$!?!?{/.test(token.value)) throw new Error(this.lineMsg() + "Invalid create instruction, value must be a simple string without ${}: " + line);
    var value = this.evaluateExpr(stack);
    this.stats[variable] = value;
    if (this.nav) this.nav.startingStats[variable] = value;
};

// *temp
// create a temporary stat for the current scene
Scene.prototype.temp = function temp(line) {
    var result = /^(\w*)(.*)/.exec(line);
    if (!result) throw new Error(this.lineMsg()+"Invalid temp instruction, no variable specified: " + line);
    var variable = result[1];
    this.validateVariable(variable);
    var expr = result[2];
    var stack = this.tokenizeExpr(expr);
    if (stack.length === 0) {
      this.temps[variable.toLowerCase()] = null;
      return;
    }
    var value = this.evaluateExpr(stack);
    this.temps[variable.toLowerCase()] = value;
};

// retrieve the value of the variable, preferring temp scope
Scene.prototype.getVar = function getVar(variable) {
    var value;
    variable = String(variable).toLowerCase();
    if (variable && !isNaN(1*variable) && String(1*variable) === variable) return 1*variable;
    if (variable == "true") return true;
    if (variable == "false") return false;
    if (variable == "choice_subscribe_allowed") return true;
    if (variable == "choice_register_allowed") return isRegisterAllowed();
    if (variable == "choice_registered") return typeof window != "undefined" && !!window.registered;
    if (variable == "choice_is_web") return typeof window != "undefined" && !!window.isWeb;
    if (variable == "choice_is_steam") return typeof window != "undefined" && !!window.isSteamApp;
    if (variable == "choice_is_ios_app") return typeof window != "undefined" && !!window.isIosApp;
    if (variable == "choice_is_advertising_supported") return typeof isAdvertisingSupported != "undefined" && !!isAdvertisingSupported();
    if (variable == "choice_is_trial") return !!(typeof isTrial != "undefined" && isTrial);
    if (variable == "choice_release_date") {
      if (typeof window != "undefined" && window.releaseDate) {
        return simpleDateTimeFormat(window.releaseDate);
      }
      return "release day";
    }
    if (variable == "choice_prerelease") {
      if (typeof window != "undefined" && window.releaseDate) {
        return new Date() < window.releaseDate.getTime();
      } else {
        return false;
      }
    }
    if (variable == "choice_kindle") return false;
    if (variable == "choice_randomtest") return !!this.randomtest;
    if (variable == "choice_quicktest") return false; // quicktest will explore "false" paths
    if (variable == "choice_restore_purchases_allowed") return isRestorePurchasesSupported();
    if (variable == "choice_save_allowed") return areSaveSlotsSupported();
    if (variable == "choice_time_stamp") return Math.floor(new Date()/1000);
    if ("undefined" === typeof this.temps[variable]) {
        if ("undefined" === typeof this.stats[variable]) {
            throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
        }
        value = this.stats[variable];
        if (value === null || value === undefined) {
            throw new Error(this.lineMsg() + "Variable '"+variable+"' exists but has no value");
        }
        if (this.debugMode) println("stats["+ variable + "]==" + value);
        return value;
    }
    value = this.temps[variable];
    if (value === null || value === undefined) {
        throw new Error(this.lineMsg() + "Variable '"+variable+"' exists but has no value");
    }
    if (this.debugMode) println("temps["+ variable + "]==" + value);
    return value;
};

// set the value of the variable, preferring temp scope
Scene.prototype.setVar = function setVar(variable, value) {
    variable = variable.toLowerCase();
    if (this.debugMode) println(variable +"="+ value);
    if ("undefined" === typeof this.temps[variable]) {
        if ("undefined" === typeof this.stats[variable]) {
            throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
        }
        this.stats[variable] = value;
        if (this.saveSlot == "temp") tempStatWrites[variable] = value;
    } else {
        this.temps[variable] = value;
    }
};

// *delete variable
// deletes the named variable
Scene.prototype["delete"] = function scene_delete(variable) {
    variable = variable.toLowerCase();
    if ("undefined" === typeof this.temps[variable]) {
        if ("undefined" === typeof this.stats[variable]) {
            throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
        }
        delete this.stats[variable];
    } else {
        delete this.temps[variable];
    }
};

// during a choice, recursively parse the options
Scene.prototype.parseOptions = function parseOptions(startIndent, choicesRemaining, expectedSubOptions) {
    // nextIndent: the level of indentation after the current line
    // For example, in the color/toy sample above, we start at 0
    // then the nextIndent is 2 for "red"
    // then the nextIndent is 4 for "spaceship"
    var nextIndent = null;
    var options = [];
    var line;
    var currentChoice = choicesRemaining[0];
    if (!currentChoice) currentChoice = "choice";
    var suboptionsEncountered = false;
    var bodyExpected = false;
    var previousSubOptions;
    var namesEncountered = {};
    var atLeastOneSelectableOption = false;
    var prevOption, ifResult;
    var startingLine = this.lineNum;
    function removeModifierCommand() {
      line = trim(line.replace(/^\s*\*(\w+)(.*)/, "$2"));
      parsed = /^\s*\*(\w+)(.*)/.exec(line);
      if (parsed) {
        command = parsed[1].toLowerCase();
        data = trim(parsed[2]);
      } else {
        command = "";
      }
    }
    while(isDefined(line = this.lines[++this.lineNum])) {
        if (!trim(line)) {
            this.rollbackLineCoverage();
            continue;
        }
        var indent = this.getIndent(line);
        if (nextIndent === null || nextIndent === undefined) {
            // initialize nextIndent with whatever indentation the line turns out to be
            // ...unless it's not indented at all
            if (indent <= startIndent) {
                throw new Error(this.lineMsg() + "invalid indent, expected at least one '" + currentChoice + "'");
            }
            this.indent = nextIndent = indent;
        }
        if (indent <= startIndent) {
            // it's over!
            // TODO is this error test valid?
            if (choicesRemaining.length>1 && !suboptionsEncountered) {
                throw new Error(this.lineMsg() + "invalid indent, there were subchoices remaining: [" + choicesRemaining.join(",") + "]");
            }
            if (bodyExpected && !this.fakeChoice) {
                throw new Error(this.lineMsg() + "Expected choice body");
            }
            if (!atLeastOneSelectableOption) this.conflictingOptions("line " + (startingLine+1) + ": No selectable options");
            if (expectedSubOptions) {
                this.verifyOptionsMatch(expectedSubOptions, options);
            }
            this.rollbackLineCoverage();
            prevOption = options[options.length-1];
            if (!prevOption.endLine) prevOption.endLine = this.lineNum;
            this.lineNum--;
            this.rollbackLineCoverage();
            return options;
        }
        if (indent < this.indent) {
            // TODO drift detection
            if (false) /*(indent != nextIndent)*/ {
                // error: indentation has decreased, but not all the way back
                // Example:
                // *choice
                //     red
                //   blue
                throw new Error(this.lineMsg() + "invalid indent, expected "+this.indent+", was " + indent);
            }

            // we must be falling out of a sub-block
            this.dedent(indent);
            this.indent = indent;
        }
        if (indent > this.indent) {
            // body of the choice
            // ...unless we haven't identified our choices yet
            // TODO is this error test valid?
            if (choicesRemaining.length>1) throw new Error(this.lineMsg() + "invalid indent, there were subchoices remaining: [" + choicesRemaining.join(",") + "]");
            this.rollbackLineCoverage();
            bodyExpected = false;
            continue;
        }

        // here's the end of the previous option
        if (options.length) {
          prevOption = options[options.length-1];
          if (!prevOption.endLine) prevOption.endLine = this.lineNum;
        }

        // Execute *if commands (etc.) during option loop
        // sub-commands may modify this.indent
        var parsed = /^\s*\*(\w+)(.*)/.exec(line);
        var unselectable = false;
        var inlineIf = null;
        var selectableIf = null;
        var self = this;

        var overrideDefaultReuseSetting = false;
        var reuse = this.temps.choice_reuse;
        if (parsed) {
            var command = parsed[1].toLowerCase();
            var data = trim(parsed[2]);
            // TODO whitelist commands
            if ("hide_reuse" == command) {
              reuse = "hide";
              overrideDefaultReuseSetting = true;
              removeModifierCommand();
            }
            if ("disable_reuse" == command) {
              reuse = "disable";
              overrideDefaultReuseSetting = true;
              removeModifierCommand();
            }
            if ("allow_reuse" == command) {
              reuse = "allow";
              overrideDefaultReuseSetting = true;
              removeModifierCommand();
            }

            if ("print" == command) {
                line = this.evaluateExpr(this.tokenizeExpr(data));
            } else if ("if" == command) {
              ifResult = this.parseOptionIf(data, command);
              if (ifResult) {
                inlineIf = ifResult.condition;
                if (ifResult.result) {
                  line = ifResult.line;
                } else {
                  continue;
                }
              } else {
                this["if"](data, true /*inChoice*/);
                continue;
              }
            } else if (/^(else|elseif|elsif)$/.test(command)) {
              this[command](data, true /*inChoice*/);
              continue;
            } else if ("selectable_if" == command) {
              ifResult = this.parseOptionIf(data, command);
              if (!ifResult) throw new Error(this.lineMsg() + "Couldn't parse the line after *selectable_if: " + data);
              line = ifResult.line;
              selectableIf = ifResult.condition;
              unselectable = unselectable || !ifResult.result;
            } else if ("comment" == command) {
                continue;
            } else if (!command) {
              // command was rewritten by earlier modifier
            } else {
                if (Scene.validCommands[command]) {
                  throw new Error(this.lineMsg() + "Invalid indent? Expected an #option here, not *"+command);
                }  else {
                    throw new Error(this.lineMsg() + "Non-existent command '"+command+"'");
                }
            }
        }

        if ("allow" != reuse) {
          if (!this.temps.choice_used) this.temps.choice_used = {};
          if (this.temps.choice_used[this.lineNum]) {
            if ("hide" == reuse) continue;
            unselectable = true;
          }
        }

        // this line should be a valid option
        if (!/^\s*\#\s*\S/.test(line)) {
            throw new Error(this.lineMsg() + "Expected option starting with #");
        }
        // replace variables here and discard the result, so error messages display the correct line
        this.replaceVariables(line);
        line = trim(trim(line).substring(1));
        var option = {name:line, group:currentChoice};
        if (reuse != "allow") option.reuse = reuse;
        if (this.displayOptionConditions) {
          option.displayIf = [];
          for (var i = 0; i < this.displayOptionConditions.length; i++) {
            option.displayIf[i] = this.displayOptionConditions[i];
          }
          if (inlineIf) option.displayIf.push(inlineIf);
        } else if (inlineIf) {
          option.displayIf = [inlineIf];
        }
        if (selectableIf) {
          option.selectableIf = selectableIf;
        }
        option.line = this.lineNum + 1;
        if (unselectable) {
          option.unselectable = true;
        }
        if (namesEncountered[line]) {
            this.conflictingOptions(this.lineMsg() + "Invalid option; conflicts with option '"+option.name+"' on line " + namesEncountered[line]);
        } else {
            namesEncountered[line] = option.line;
        }
        options.push(option);
        if (choicesRemaining.length>1) {
            // recursive call will modify this.indent
            option.suboptions = this.parseOptions(this.indent, choicesRemaining.slice(1), previousSubOptions);
            // now restore it
            this.indent = nextIndent;
            if (!previousSubOptions) previousSubOptions = option.suboptions;
            suboptionsEncountered = true;
        } else {
            bodyExpected = true;
        }
        if (!unselectable) atLeastOneSelectableOption = true;
    }
    if (bodyExpected && !this.fakeChoice) {
        throw new Error(this.lineMsg() + "Expected choice body");
    }
    prevOption = options[options.length-1];
    if (!prevOption.endLine) prevOption.endLine = this.lineNum;
    if (!atLeastOneSelectableOption) this.conflictingOptions("line " + (startingLine+1) + ": No selectable options");
    return options;
};

// compute *if statement during options
Scene.prototype.parseOptionIf = function parseOptionIf(data) {
  var parsed = /^\s*\((.*)\)\s+(#.*)/.exec(data);
  if (!parsed) {
    return;
  }
  var condition = parsed[1];
  var stack = this.tokenizeExpr(condition);
  var result = this.evaluateExpr(stack);
  if (this.debugMode) println(condition + " :: " + result);
  result = bool(result, this.lineNum+1);
  // In the autotester, all conditionals are enabled
  result = result || this.testPath;
  return {result:result, line:parsed[2], condition:null};
};

// Add this as a separate method so we can override it elsewhere
// We want this error during randomtest but not during autotest
// Because autotest makes impossible situations happen
Scene.prototype.conflictingOptions = function conflictingOptions(str) {
  throw new Error(str);
};

// verify that the current option set corresponds to the previous option set
// (for multichoices)
Scene.prototype.verifyOptionsMatch = function verifyOptionsMatch(prev, current) {
    // find matching option by name
    function findMatch(name, options) {
        for (var i = 0; i < options.length; i++) {
            var option = options[i];
            if (option && name == option.name) {
                return option;
            }
        }
        return null;
    }

    var prevOpt, curOpt;
    for (var i = 0; i < prev.length; i++) {
        prevOpt = prev[i];
        curOpt = findMatch(prevOpt.name, current);
        if (!curOpt) throw new Error(this.lineMsg()+"Missing expected suboption '"+prevOpt.name+"'; all suboptions must have same option list");
    }

    if (prev.length == current.length) return;

    for (i = 0; i < current.length; i++) {
        curOpt = current[i];
        prevOpt = findMatch(curOpt.name, prev);
        if (!prevOpt) throw new Error(this.lineMsg()+"Added unexpected suboption '"+curOpt.name+"'; all suboptions must have same option list");
    }

    throw new Error(this.lineMsg()+"Bug? previous options and current options mismatch, but no particular missing element");
};

// render the prompt and the radio buttons
Scene.prototype.renderOptions = function renderOptions(groups, options, callback) {
    for (var i = 0; i < options.length; i++) {
      var option = options[i];
      option.name = this.replaceVariables(option.name);
    }
    this.paragraph();
    printOptions(groups, options, callback);

    if (this.debugMode) println(toJson(this.stats));

    if (this.finished) printFooter();
};

// *page_break
// pause and prompt the user to press "Next"
Scene.prototype.page_break = function page_break(buttonName) {
    if (this.screenEmpty) return;
    if (!buttonName) buttonName = "Next";
    buttonName = this.replaceVariables(buttonName);
    this.paragraph();
    this.finished = true;

    var self = this;
    printButton(buttonName, main, false,
      function() {
        self.finished = false;
        self.resetPage();
      }
    );
    if (this.debugMode) println(toJson(this.stats));
};

// *line_break
// single line break in the middle of a paragraph
Scene.prototype.line_break = function line_break() {
    println("", this.target);
};

// *image
// display named image //CJW edited to compensate for data uri images
Scene.prototype.image = function image(data, invert) {
    data = data || "";
    data = this.replaceVariables(data);
    var args = data.split(" ");
    var source, alignment;
    var alt = null;
    if (args.length > 2) {
      var source = args[0];
      var alignment = args[1];
      var alt = trim(args[2]);
    }
    else if (args.length > 1) {
      var source = args[0];
      var alignment = args[1];
    }
    else {
      var source = data;
    }
    alignment = alignment || "center";
    if (!/(right|left|center|none)/.test(alignment)) throw new Error(this.lineMsg()+"Invalid alignment, expected right, left, center, or none: " + data);
    printImage(source, alignment, alt, invert);
    if (this.verifyImage) this.verifyImage(source);
    if (alignment == "none") this.prevLine = "text";
    this.screenEmpty = false;
};

Scene.prototype.text_image = function textImage(data) {
  this.image(data, "invert");
}

// *sound
// play named sound file
Scene.prototype.sound = function sound(source) {
    if (typeof playSound == "function") playSound(source);
    if (this.verifyImage) this.verifyImage(source);
};

Scene.prototype.youtube = function youtube(slug) {
  if (typeof printYoutubeFrame !== "undefined") {
    printYoutubeFrame(slug);
    this.prevLine = "block";
    this.screenEmpty = false;
  }
}

// *link
// Display URL with anchor text
Scene.prototype.link = function link(data) {
    var result = /^(\S+)\s*(.*)/.exec(data);
    if (!result) throw new Error(this.lineMsg() + "invalid line; this line should have an URL: " + data);
    var href = result[1];
    var anchorText = trim(result[2]) || href;
    printLink(this.target, href, anchorText);
    this.prevLine = "text";
    this.screenEmpty = false;
};

// *link_button
// Display button that takes you to an URL
Scene.prototype.link_button = function linkButton(data) {
    if (typeof window == "undefined") return;
    var result = /^(\S+)\s*(.*)/.exec(data);
    if (!result) throw new Error(this.lineMsg() + "invalid line; this line should have an URL: " + data);
    var href = result[1];
    var anchorText = trim(result[2]) || href;
    var target = this.target;
    if (!target) target = document.getElementById('text');
    printButton(anchorText, target, false, function() {
      window.location.href = href;
    });
    this.prevLine = "empty";
    this.screenEmpty = false;
};

// how many spaces is this line indented?
Scene.prototype.getIndent = function getIndent(line) {
    if (line === null || line === undefined) return 0;
    var spaces = line.match(/^([ \t]*)/);
    if (spaces === null || spaces === undefined) return 0;
    var whitespace = spaces[0];
    var len = whitespace.length;
    if (0 === len) return 0;
    var tab = /\t/.test(whitespace);
    var space = / /.test(whitespace);
    if (tab && space) {
        throw new Error(this.lineMsg()+"Tabs and spaces appear on the same line");
    }
    if (tab) {
        this.firstTab = this.lineNum+1;
        if (this.firstSpace) {
            throw new Error(this.lineMsg()+"Illegal mixing of spaces and tabs; this line has a tab, but there were spaces on line " + this.firstSpace);
        }
    } else {
        this.firstSpace = this.lineNum + 1;
        if (this.firstTab) {
            throw new Error(this.lineMsg()+"Illegal mixing of spaces and tabs; this line has a space, but there were tabs on line " + this.firstTab);
        }
    }
    return len;
};

// *comment ignorable text
Scene.prototype.comment = function comment(line) {
    if (this.debugMode) println("*comment " + line);
};

Scene.prototype.advertisement = function advertisement() {
  if (typeof isFullScreenAdvertisingSupported != "undefined" && isFullScreenAdvertisingSupported()) {
    this.finished = true;
    this.skipFooter = true;

    var self = this;
    showFullScreenAdvertisement(function() {
      self.finished = false;
      self.skipFooter = false;
      self.resetPage();
    });
  }

};

// *looplimit 5
// The number of times a given line is allowed to be accessed
Scene.prototype.looplimit = function looplimit() {}; // TODO looplimit

Scene.prototype.hide_reuse = function hide_reuse() {
  this.temps.choice_reuse = "hide";
};

Scene.prototype.disable_reuse = function disable_reuse() {
  this.temps.choice_reuse = "disable";
};

Scene.prototype.allow_reuse = function allow_reuse() {
  this.temps.choice_reuse = "allow";
};

// *label labelName
// Labels a line for use later in *goto
// Do nothing here; these labels are parsed in this.parseLabel
Scene.prototype.label = function label() {};

// *print expr
// print the value of the specified expression
Scene.prototype.print = function scene_print(expr) {
    var value = this.evaluateExpr(this.tokenizeExpr(expr));
    this.prevLine = "text";
    this.screenEmpty = false;
    this.printLine(value);
};

// *input_text var
// record text typed by the user and store it in the specified variable
Scene.prototype.input_text = function input_text(line) {
    var stack = this.tokenizeExpr(line);
    var variable = this.evaluateReference(stack);
    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }

    var inputType = "text";
    if (stack.length == 1 && stack[0].name == "VAR" && stack[0].value == "long") {
      inputType = "textarea";
    }
    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }
    this.finished = true;
    this.paragraph();
    var self = this;
    printInput(this.target, inputType, function(value) {
      safeCall(self, function() {
        value = trim(String(value));
        value = value.replace(/\n/g, "[n/]");
        if (self.nav) self.nav.bugLog.push("*input_text " + variable + " " + value);
        self.finished = false;
        self.setVar(variable, value);
        self.resetPage();
      });
    });
    if (this.debugMode) println(toJson(this.stats));
};

// *input_number var min max
// record number typed by the user and store it in the specified variable
Scene.prototype.input_number = function input_number(data) {
    var stack = this.tokenizeExpr(data);
    if (!stack.length) throw new Error(this.lineMsg() + "Invalid input_number statement, expected three args: varname min max");
    var variable = this.evaluateReference(stack);
    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }

    var simpleConstants;
    if (stack.length == 2 && stack[0].name == "NUMBER" && stack[1].name == "NUMBER") {
      simpleConstants = true;
    } else {
      simpleConstants = false;
    }

    if (!stack.length) throw new Error(this.lineMsg() + "Invalid input_number statement, expected three args: varname min max");
    var minimum = this.evaluateValueToken(stack.shift(), stack);
    if (isNaN(minimum*1)) throw new Error(this.lineMsg() + "Invalid minimum, not numeric: " + minimum);
    if (!stack.length) throw new Error(this.lineMsg() + "Invalid input_number statement, expected three args: varname min max");

    var maximum = this.evaluateValueToken(stack.shift(), stack);
    if (stack.length) throw new Error(this.lineMsg() + "Invalid input_number statement, expected three args: varname min max");
    if (isNaN(maximum*1)) throw new Error(this.lineMsg() + "Invalid maximum, not numeric: " + maximum);

    // in quicktest, min and max can get mixed up as the interpreter "cheats" on if statements
    // so quicktest will ignore min/max errors unless they're simple constants e.g. *input_number x 6 4
    var checkMinMax = !this.quicktest || simpleConstants;
    if (checkMinMax && parseFloat(minimum) > parseFloat(maximum)) {
      throw new Error(this.lineMsg() + "Minimum " + minimum+ " should not be greater than maximum " + maximum);
    }

    function isInt(x) {
       var y=parseInt(x,10);
       if (isNaN(y)) return false;
       return x==y && x.toString()==y.toString();
    }
    var intRequired;
    if (isInt(minimum) && isInt(maximum)) {
      intRequired = 1;
    }
    this.finished = true;
    this.paragraph();
    var self = this;
    printInput(this.target, "number", function(value) {
      safeCall(self, function() {
        var numValue = parseFloat(""+value);
        if (isNaN(numValue)) {
          asyncAlert("Please type in a number.");
          return;
        }
        if (intRequired && !isInt(value)) {
          asyncAlert("Please type in an integer number.");
          return;
        }
        if (numValue < minimum * 1) {
          asyncAlert("Please use a number greater than or equal to " + minimum);
          return;
        }
        if (numValue > maximum * 1 && !this.quicktest) {
          asyncAlert("Please use a number less than or equal to " + maximum);
          return;
        }
        if (self.nav) self.nav.bugLog.push("*input_number " + variable + " " + value);
        self.finished = false;
        self.setVar(variable, numValue);
        self.resetPage();
      });
    }, minimum, maximum, intRequired);
    if (this.debugMode) println(toJson(this.stats));
};

// *script code
// evaluate the specified ECMAScript
Scene.prototype.script = function script(code) {
    var stats = this.stats;
    var temps = this.temps;
    try {
      if (typeof window == "undefined") {
        (function() {
          var window = _global;
          eval(code);
        }).call(this);
      } else {
        eval(code);
      }
    } catch (e) {
      throw new Error(this.lineMsg() + "error executing *script: " + e + (e.stack ? "\n" + e.stack : ""));
    }
};

// is this a valid variable name?
Scene.prototype.validateVariable = function validateVariable(variable) {
    if (!variable || !/^[a-zA-Z]/.test(variable)) {
        throw new Error(this.lineMsg()+"Invalid variable name, must start with a letter: " + variable);
    }
    if (!/^\w+$/.test(variable)) {
        throw new Error(this.lineMsg()+"Invalid variable name: '" + variable + "'");
    }
    if (/^(and|or|true|false)$/.test(variable)) throw new Error(this.lineMsg()+"Invalid variable name, '" + variable + "' is a reserved word");
    if (/^choice_/.test(variable)) throw new Error(this.lineMsg()+"Invalid variable name, variables may not start with 'choice_'; this is a reserved prefix");
};

// *rand varname min max
// Set varname to a random number from min to max
//
// Example:
// *rand foo 1 6
//   roll a cube die
// *rand foo 1.0 6.0
//   compute a decimal from [1.0,6.0)
Scene.prototype.rand = function rand(data) {
    var stack = this.tokenizeExpr(data);
    if (!stack.length) throw new Error(this.lineMsg() + "Invalid rand statement, expected three args: varname min max");
    var variable = this.evaluateReference(stack);
    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }

    if (!stack.length) throw new Error(this.lineMsg() + "Invalid rand statement, expected three args: varname min max");
    var minimum = this.evaluateValueToken(stack.shift(), stack);
    if (!stack.length) throw new Error(this.lineMsg() + "Invalid rand statement, expected three args: varname min max");
    var maximum = this.evaluateValueToken(stack.shift(), stack);
    if (stack.length) throw new Error(this.lineMsg() + "Invalid rand statement, expected three args: varname min max");
    var diff;

    diff = maximum - minimum;
    if (isNaN(diff)) {
        throw new Error(this.lineMsg() + "Invalid rand statement, min and max must be numbers");
    }
    if (diff < 0) {
        throw new Error(this.lineMsg() + "Invalid rand statement, min must be less than max: " + minimum + " > " + maximum);
    }
    if (diff === 0) {
      this.setVar(variable, minimum);
      return;
    }
    function isInt(x) {
       var y=parseInt(x,10);
       if (isNaN(y)) return false;
       return x==y && x.toString()==y.toString();
    }
    var result;
    var random = Math.random();
    if (isInt(minimum) && isInt(maximum)) {
        // int random
        result = 1*minimum + Math.floor(random*(diff+1));
    } else {
        result = 1*minimum + random*diff;
    }
    this.setVar(variable, result);
    if (this.randomLog) {
      this.randomLog("*rand " + variable + " " + result);
    }
    if (this.nav) this.nav.bugLog.push("*rand " + variable + " " + result);
};

// *set varname expr
// sets the specified varname to the value of the expr
//
// Examples:
//
// literal
//     literal int: 2
//     literal decimal: 2.3
//     boolean value: true
//     quoted string: "fie"
//         with backslash escaping "she said it was \"ironic\"!"  "c:\\foo"
//     variable name: foo
//
// math
//     +: 2+2
//     -: foo-3
//     *: 2*3
//     /: 8/2
//     if one operand is a string, we'll try to parse it as a number, fail if that doesn't work
//
// fairmath
//     %+: foo%+30
//     %-: foo%-20
//
// concatenate
//     &: "foo"&bar
//
// may omit leading operand
//     *set foo +2
//     *set foo %+30
//     *set foo &"blah blah"
//
// spaces optional
//     *set foo+2
//     *set foo bar + 2
//     *set bar% +30
//
// multiple operators in one line, parentheses mandatory
//     *set foo (foo+2)/4
//     *set foo 2+(foo/2)
//     *set foo (foo/2)+(bar/3)
//     *set foo +(bar/3)
//
// set variable by reference
//
//     *set foo bar
//     *set {foo} 3
//     *comment now bar=3
Scene.prototype.set = function set(line) {
    var stack = this.tokenizeExpr(line);
    var variable = this.evaluateReference(stack);
    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }
    if (stack.length === 0) throw new Error(this.lineMsg()+"Invalid set instruction, no expression specified: " + line);
    // if the first token is an operator, then it's implicitly based on the variable
    if (/OPERATOR|FAIRMATH/.test(stack[0].name)) stack.unshift({name:"VAR", value:variable, pos:"(implicit)"});
    var value = this.evaluateExpr(stack);
    this.setVar(variable, value);
};

// *setref variableExpr expr
// just like *set, but variableExpr is a string expression naming a variable reference
//
// Example:
// *set foo "bar"
// *setref foo 3
// *comment now bar=3
Scene.prototype.setref = function setref(line) {
    var stack = this.tokenizeExpr(line);
    var variable = this.evaluateValueToken(stack.shift(), stack);
    variable = String(variable).toLowerCase();

    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }

    // if the first token is an operator, then it's implicitly based on the variable
    if (/OPERATOR|FAIRMATH/.test(stack[0].name)) stack.unshift({name:"VAR", value:variable, pos:"(implicit)"});
    var value = this.evaluateExpr(stack);
    this.setVar(variable, value);
};

Scene.prototype.share_this_game = function share_links(now) {
  now = !!trim(now);
  this.paragraph();
  printShareLinks(this.target, now);
  this.prevLine = "empty"; // printShareLinks provides its own paragraph break
};

Scene.prototype.more_games = function more_games(now) {
  if (typeof window == "undefined" || typeof moreGames == "undefined") return;
  if (!!trim(now)) {
    moreGames();
    return;
  }
  var self = this;
  var target = this.target;
  if (!target) target = document.getElementById('text');
  var button = printButton("Play More Games Like This", target, false,
    function() {
      safeCall(self, moreGames);
    }
  );

  setClass(button, "");
  this.prevLine = "block";
};

Scene.prototype.ending = function ending() {
    if (typeof window == "undefined") return;
    this.paragraph();
    var groups = [""];
    options = [];
    options.push({name:"Play again.", group:"choice", restart:true});
    options.push({name:"Play more games like this.", group:"choice", moreGames:true});
    options.push({name:"Share this game with friends.", group:"choice", share:true});
    options.push({name:"Email me when new games are available.", group:"choice", subscribe:true});

    var self = this;
    function endingMenu() {
      printFollowButtons();
      self.renderOptions([""], options, function(option) {
        if (option.restart) {
          self.restart();
          return;
        } else if (option.moreGames) {
          self.more_games("now");
          if (typeof curl != "undefined") curl();
        } else if (option.share) {
          clearScreen(function() {
            self.share_this_game("now");
            endingMenu();
          });
        } else if (option.subscribe) {
          subscribeLink();
        }
      });
    }
    endingMenu();
    this.finished = true;
};

Scene.prototype.restart = function restart() {
  if (this.secondaryMode) throw new Error(this.lineMsg() + "Cannot *restart in " + this.secondaryMode + " mode");
  this.finished = true;
  delayBreakEnd();
  var self = this;
  self.reset();
  var startupScene = self.nav.getStartupScene();
  var scene = new Scene(startupScene, self.stats, self.nav, {debugMode:self.debugMode, secondaryMode:false});
  scene.resetPage();

};

/* Subscribe options, in JSON format.
"now" on mobile means we should immediately mailto: the subscribe address
otherwise, we should display a Subscribe button which launches the mailto:
On non-mailte: platforms, we ignore "now"

"allowContinue" is the default; setting it to false blocks the "No, Thanks"
button and the "Next" button after successfully subscribing
Only Coming Soon pages use "allowContinue"

"message" is the message we'll show to justify subscribing
the default message is: "we'll notify you when our next game is ready!" */
Scene.prototype.subscribe = function scene_subscribe(data) {
  var options = {};
  if (data) {
    try {
      options = JSON.parse(data);
    } catch (e) {
      throw new Error(this.lineMsg() + "Couldn't parse subscribe arguments: " + data);
    }
  }
  this.prevLine = "block";
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  subscribe(this.target, options, function(now) {
    self.finished = false;
    // if "now" actually worked, then continue the scene
    // otherwise, reset the page before continuing
    if (now) {
      self.skipFooter = false;
      self.execute();
    } else {
      self.resetPage();
    }
  });
};

Scene.prototype.restore_game = function restore_game(data) {
  var cancelLabel;
  if (data) {
    var result = /^cancel=(\S+)$/.exec(data);
    if (!result) throw new Error(this.lineMsg() + "invalid restore_game line: " + data);
    cancelLabel = result[1];
  }
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  var unrestorableScenes = this.parseRestoreGame(false/*alreadyFinished*/);
  function renderRestoreMenu(saveList, dirtySaveList) {
    self.paragraph();
    var options = [];
    for (var i = 0; i < saveList.length; i++) {
      var save = saveList[i];
      var date = new Date(save.timestamp*1);
      if (!save) continue;
      var name = "";
      if (save.temps && save.temps.choice_restore_name) name = save.temps.choice_restore_name;
      options.push({name:name + " ("+simpleDateTimeFormat(date)+")", group:"choice", state:save});
    }
    if (false) options.push({name:"Restore using a password.", group:"choice", password:true});
    options.push({name:"Retrieve saved games online from choiceofgames.com.", group:"choice", fetch:true});
    if (dirtySaveList.length) options.push({name:"Upload saved games to choiceofgames.com.", group:"choice", upload:true});
    options.push({name:"Cancel.", group:"choice", cancel:true});
    var groups = [""];
    self.renderOptions(groups, options, function(option) {
      if (option.upload) {
        clearScreen(function() {
          fetchEmail(function(defaultEmail){
            self.printLine("Please type your email address to identify yourself.");
            promptEmailAddress(this.target, defaultEmail, "allowContinue", function(cancel, email) {
              if (cancel) {
                self.finished = false;
                if (typeof cancelLabel !== "undefined") {
                  self["goto"](cancelLabel);
                }
                self.resetPage();
                return;
              }
              clearScreen(function() {
                startLoading();
                submitDirtySaves(dirtySaveList, email, function(ok) {
                  doneLoading();
                  self.prevLine = "text"; // Put some space between the message and the option list
                  if (!ok) {
                    self.printLine("Error uploading saves. Please try again later.");
                    renderRestoreMenu(saveList, dirtySaveList);
                  } else {
                    var count = dirtySaveList.length + (dirtySaveList.length == 1 ? " save" : " saves");
                    self.printLine("Uploaded " + count + ".");
                    renderRestoreMenu(saveList, []);
                  }
                });
              });
            });
          });
        });
      } else if (option.fetch) {
        clearScreen(function() {
          fetchEmail(function(defaultEmail){
            self.printLine("Please type your email address to identify yourself.");
            promptEmailAddress(this.target, defaultEmail, "allowContinue", function(cancel, email) {
              if (cancel) {
                self.finished = false;
                if (typeof cancelLabel !== "undefined") {
                  self["goto"](cancelLabel);
                }
                self.resetPage();
                return;
              }
              clearScreen(function() {
                startLoading();
                getRemoteSaves(email, function (remoteSaveList) {
                  doneLoading();
                  self.prevLine = "text";
                  if (!remoteSaveList) {
                    self.printLine("Error downloading saves. Please try again later.");
                    renderRestoreMenu(saveList, dirtySaveList);
                  } else {
                    mergeRemoteSaves(remoteSaveList, "recordDirty", function(saveList, newRemoteSaves, dirtySaveList) {
                      if (!remoteSaveList.length) {
                        self.printLine("No saves downloaded for email address \""+email+"\". (Is that the correct email address?) If you're having trouble, please contact support at "+getSupportEmail()+".");
                        renderRestoreMenu(saveList, dirtySaveList);
                      } else {
                        var downloadCount = remoteSaveList.length + " saved " + (remoteSaveList.length == 1 ? "game" : "games");
                        var newCount = newRemoteSaves + " new saved " + (newRemoteSaves == 1 ? "game" : "games");
                        self.printLine("Synchronized " + downloadCount + ". Downloaded " + newCount + ".");
                        renderRestoreMenu(saveList, dirtySaveList);
                      }
                    });
                  }
                });
              });
            });
          });
        });
      } else if (option.password) {
        clearScreen(function() {
          self.restore_password();
        });
      } else {
        if (option.cancel) {
          self.finished = false;
          if (typeof cancelLabel !== "undefined") {
            self["goto"](cancelLabel);
          }
          self.resetPage();
        } else {
          var state = option.state;
          var sceneName = null;
          if (state.stats && state.stats.sceneName) sceneName = (""+state.stats.sceneName).toLowerCase();
          var unrestorable = unrestorableScenes[sceneName];

          if (unrestorable) {
            asyncAlert(unrestorable);
            self.finished = false;
            self.resetPage();
            return;
          }

          saveCookie(function() {
            clearScreen(function() {
              restoreGame(state, null, /*userRestored*/true);
            });
          }, "", state.stats, state.temps, state.lineNum, state.indent, this.debugMode, this.nav);
        }
      }
    });
  }
  getDirtySaveList(function(dirtySaveList) {
    getSaves(function(saveList) {
      renderRestoreMenu(saveList, dirtySaveList);
    });
  });
};

Scene.prototype.restore_password = function restore_password() {
  var alreadyFinished = this.finished;
  this.finished = true;
  this.paragraph();
  this.printLine('Please paste your password here, then press "Next" below to continue.');
  this.prevLine = "text";
  this.paragraph();
  var self = this;
  var unrestorableScenes = this.parseRestoreGame(alreadyFinished);
  getPassword(this.target, function (cancel, password) {
    if (cancel) {
      self.finished = false;
      self.resetPage();
      return;
    }
    password = password.replace(/\s/g, "");
    password = password.replace(/^.*BEGINPASSWORD-----/, "");
    var token = self.deobfuscatePassword(password);
    token = token.replace(/^[^\{]*/, "");
    token = token.replace(/[^\}]*$/, "");
    var state;
    try {
      state = jsonParse(token);
    } catch (e) {
      asyncAlert("Sorry, that password was invalid. Please contact " + getSupportEmail() + " for assistance. Be sure to include your password in the email.");
      return;
    }

    var sceneName = null;
    if (state.stats && state.stats.sceneName) sceneName = (""+state.stats.sceneName).toLowerCase();

    var unrestorable = unrestorableScenes[sceneName];
    if (unrestorable) {
      asyncAlert(unrestorable);
      self.finished = false;
      self.resetPage();
      return;
    }

    saveCookie(function() {
      clearScreen(function() {
        // we're going to pretend not to be user restored, so we get reprompted to save
        restoreGame(state, null, /*userRestored*/false);
      });
    }, "", state.stats, state.temps, state.lineNum, state.indent, this.debugMode, this.nav);
  });
  if (alreadyFinished) printFooter();
};

Scene.prototype.parseRestoreGame = function parseRestoreGame(alreadyFinished) {
    if (alreadyFinished) {
      // if we're already finished, the printLoop bumped us an extra line ahead
      this.lineNum--;
      this.rollbackLineCoverage();
    }
    // nextIndent: the level of indentation after the current line
    var nextIndent = null;
    var unrestorableScenes = {};
    var line;
    var startIndent = this.indent;
    while(isDefined(line = this.lines[++this.lineNum])) {
        if (!trim(line)) {
            this.rollbackLineCoverage();
            continue;
        }
        var indent = this.getIndent(line);
        if (nextIndent === null || nextIndent === undefined) {
            // initialize nextIndent with whatever indentation the line turns out to be
            // ...unless it's not indented at all
            if (indent > startIndent) {
                this.indent = nextIndent = indent;
            }
        }
        if (indent <= startIndent) {
            // it's over!
            if (!alreadyFinished) {
              this.lineNum--;
              this.rollbackLineCoverage();
            }
            return unrestorableScenes;
        }
        if (indent != this.indent) {
            // all chart rows are supposed to be at the same indentation level
            // anything at the wrong indentation level might be a mis-indented title/definition
            // or just a typo
            throw new Error(this.lineMsg() + "invalid indent, expected "+this.indent+", was " + indent);
        }

        //
        // *restore_game
        //   ending You can't restore to the ending.

        line = trim(line);
        var result = /^(\w+)\s+(.*)/.exec(line);
        if (!result) throw new Error(this.lineMsg() + "invalid line; this line should have a scene name followed by an error message: " + line);
        var sceneName = result[1].toLowerCase();
        var error = trim(result[2]);
        unrestorableScenes[sceneName] = error;
    }
    if (!alreadyFinished) {
      this.lineNum--;
      this.rollbackLineCoverage();
    }
    return unrestorableScenes;
};

Scene.prototype.check_registration = function scene_checkRegistration() {
  if (typeof window == "undefined" || typeof isRegistered == "undefined") return;
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  isRegistered(function() {
    self.finished = false;
    self.skipFooter = false;
    self.execute();
  });
};

Scene.prototype.login = function scene_login(optional) {
  if (typeof window == "undefined" || typeof loginForm == "undefined") return;
  optional = trim(optional);
  if (optional) {
    if (optional != "optional") throw new Error(this.lineMsg() + "invalid *login option: " + optional);
    optional = 1;
  }
  var self = this;
  this.finished = true;
  this.skipFooter = true;
  this.paragraph();
  var target = this.target;
  if (!target) target = document.getElementById('text');
  loginForm(target, optional, null, function() {
    clearScreen(function() {
      self.finished = false;
      self.prevLine = "empty";
      self.screenEmpty = true;
      self.execute();
    });
  });
};

Scene.prototype.save_game = function save_game(destinationSceneName) {
  if (!destinationSceneName) throw new Error(this.lineMsg()+"*save_game requires a destination file name, e.g. *save_game Episode2");
  if (this.temps.choice_user_restored) return;
  var self = this;
  this.finished = true;
  this.skipFooter = true;
  fetchEmail(function(defaultEmail){
    self.paragraph();
    var form = document.createElement("form");
    setClass(form, "saveGame");

    form.action="#";

    var message = document.createElement("div");
    message.style.color = "red";
    message.style.fontWeight = "bold";
    form.appendChild(message);

    var saveName = document.createElement("input");
    saveName.type="text";
    saveName.name="saveName";
    saveName.setAttribute("placeholder", "Type a name for your saved game");
    saveName.setAttribute("style", "font-size: 25px; width: 90%;");
    form.appendChild(saveName);

    var hideEmailForm = false;
    // hideEmailForm = _global.automaticCloudStorage;
    if (hideEmailForm) {
      println("", form);
    } else {
      println("", form);
      println("", form);
      println("Please login to the choiceofgames.com save system with your email address below.", form);

      var emailInput = document.createElement("input");
      // This can fail on IE
      try { emailInput.type="email"; } catch (e) {}
      emailInput.name="email";
      emailInput.value=defaultEmail;
      emailInput.setAttribute("placeholder", "you@example.com");
      emailInput.setAttribute("style", "font-size: 25px; width: 90%;");
      form.appendChild(emailInput);

      println("", form);
      println("", form);

      var subscribeLabel = document.createElement("label");
      subscribeLabel.setAttribute("for", "subscribeBox");
      var subscribeBox = document.createElement("input");
      subscribeBox.type = "checkbox";
      subscribeBox.name = "subscribe";
      subscribeBox.setAttribute("id", "subscribeBox");
      subscribeBox.setAttribute("checked", true);
      subscribeLabel.appendChild(subscribeBox);
      subscribeLabel.appendChild(document.createTextNode("Email me when new games are available."));
      form.appendChild(subscribeLabel);
    }

    println("", form);
    var target = this.target;
    if (!target) target = document.getElementById('text');
    target.appendChild(form);
    printButton("Next", form, true);

    printButton("Cancel", target, false, function() {
      clearScreen(function() {
        self.finished = false;
        self.prevLine = "empty";
        self.screenEmpty = true;
        self.execute();
      });
    });

    form.onsubmit = function(e) {
      preventDefault(e);
      safeCall(this, function() {
        var messageText;
        if (!trim(saveName.value)) {
          messageText = document.createTextNode("Please type a name for your saved game.");
          message.innerHTML = "";
          message.appendChild(messageText);
          return;
        }

        var slot = "save" + new Date().getTime();
        // create a clone stats object whose scene name is the destination scene
        var saveStats = {};
        for (var stat in self.stats) {
          if ("scene" == stat) continue;
          saveStats[stat] = self.stats[stat];
        }
        saveStats.scene = {name:destinationSceneName};

        if (hideEmailForm) {
          clearScreen(function() {
            saveCookie(function() {
              recordSave(slot, function() {
                self.finished = false;
                self.prevLine = "empty";
                self.screenEmpty = true;
                self.execute();
              });
            }, slot, saveStats, {choice_reuse:"allow", choice_user_restored:true, choice_restore_name:saveName.value}, 0, 0, false, self.nav);
          });
          return;
        }

        var shouldSubscribe = subscribeBox.checked;
        var email = trim(emailInput.value);
        if (!/^\S+@\S+\.\S+$/.test(email)) {
          messageText = document.createTextNode("Sorry, \""+email+"\" is not an email address.  Please type your email address again.");
          message.innerHTML = "";
          message.appendChild(messageText);
          return;
        }

        recordEmail(email, function() {
          clearScreen(function() {
            saveCookie(function() {
              recordSave(slot, function() {
                startLoading();
                submitRemoteSave(slot, email, shouldSubscribe, function(ok) {
                  doneLoading();
                  if (!ok) {
                    asyncAlert("Couldn't upload your saved game to choiceofgames.com. You can try again later from the Restore menu.", function() {
                      self.finished = false;
                      self.prevLine = "empty";
                      self.screenEmpty = true;
                      self.execute();
                    });
                  } else {
                    self.finished = false;
                    self.prevLine = "empty";
                    self.screenEmpty = true;
                    self.execute();
                  }
                });
              });
            }, slot, saveStats, {choice_reuse:"allow", choice_user_restored:true, choice_restore_name:saveName.value}, 0, 0, false, self.nav);
          });
        });
      });
    };

    printFooter();
  });
};

Scene.prototype.show_password = function show_password() {
  if (this.temps.choice_user_restored) return;
  this.paragraph();
  if (typeof(window) != "undefined" && !window.isMobile) {
    this.printLine('Please copy and paste the password in a safe place, then press "Next" below to continue.');
    println("", this.target);
    println("", this.target);
  }
  var password = computeCookie(this.stats, this.temps, this.lineNum, this.indent);
  password = this.obfuscate(password);
  showPassword(this.target, password);
  this.prevLine = "block";
};

Scene.prototype.obfuscate = function obfuscate(password) {
  var self = this;
  return password.replace(/./g,
    function(x) {
      var y = self.obfuscator[x];
      return y;
    }
  );
};

// The obfuscator must take US-ASCII and obfuscate it
// for use in a password.  This password will be sent via
// HTML email and its whitespace handling will be unpredictable,
// So we can't output any of these characters: [ <>&]
// Since we're losing four characters of output, we JSON-escape
// four characters of input [^`|~].
Scene.prototype.obfuscator = {
  " ": "k",
  "!": "E",
  "\"": "`",
  "#": "\\",
  "$": "r",
  "%": "J",
  "&": "o",
  "'": "0",
  "(": "Z",
  ")": "M",
  "*": "G",
  "+": "t",
  ",": "Y",
  "-": "f",
  ".": "2",
  "/": "!",
  "0": "i",
  "1": "*",
  "2": "1",
  "3": "3",
  "4": "[",
  "5": "6",
  "6": "v",
  "7": "\"",
  "8": "F",
  "9": "9",
  ":": "{",
  ";": "Q",
  "<": "?",
  "=": "5",
  ">": "#",
  "?": "K",
  "@": "/",
  "A": "=",
  "B": "N",
  "C": "z",
  "D": "$",
  "E": "W",
  "F": "(",
  "G": ")",
  "H": "q",
  "I": "C",
  "J": "+",
  "K": "U",
  "L": ".",
  "M": "H",
  "N": "B",
  "O": "S",
  "P": "X",
  "Q": "I",
  "R": "-",
  "S": "m",
  "T": "D",
  "U": "^",
  "V": "A",
  "W": "a",
  "X": "y",
  "Y": ",",
  "Z": "d",
  "[": "O",
  "\\": "s",
  "]": "8",
  "^": "sVii6h",
  "_": "]",
  "`": "sViivi",
  "a": "4",
  "b": "g",
  "c": "%",
  "d": "w",
  "e": "h",
  "f": "n",
  "g": "b",
  "h": "7",
  "i": "x",
  "j": "~",
  "k": "_",
  "l": "l",
  "m": ":",
  "n": "c",
  "o": "L",
  "p": "j",
  "q": "u",
  "r": "R",
  "s": "}",
  "t": "p",
  "u": "V",
  "v": "P",
  "w": "'",
  "x": "T",
  "y": "|",
  "z": "@",
  "{": "e",
  "|": "sVii\"%",
  "}": ";",
  "~": "sVii\"h"
};
Scene.prototype.deobfuscator = {
  "k": " ",
  "E": "!",
  "`": "\"",
  "\\": "#",
  "r": "$",
  "J": "%",
  "o": "&",
  "0": "'",
  "Z": "(",
  "M": ")",
  "G": "*",
  "t": "+",
  "Y": ",",
  "f": "-",
  "2": ".",
  "!": "/",
  "i": "0",
  "*": "1",
  "1": "2",
  "3": "3",
  "[": "4",
  "6": "5",
  "v": "6",
  "\"": "7",
  "F": "8",
  "9": "9",
  "{": ":",
  "Q": ";",
  "?": "<",
  "5": "=",
  "#": ">",
  "K": "?",
  "/": "@",
  "=": "A",
  "N": "B",
  "z": "C",
  "$": "D",
  "W": "E",
  "(": "F",
  ")": "G",
  "q": "H",
  "C": "I",
  "+": "J",
  "U": "K",
  ".": "L",
  "H": "M",
  "B": "N",
  "S": "O",
  "X": "P",
  "I": "Q",
  "-": "R",
  "m": "S",
  "D": "T",
  "^": "U",
  "A": "V",
  "a": "W",
  "y": "X",
  ",": "Y",
  "d": "Z",
  "O": "[",
  "s": "\\",
  "8": "]",
  "]": "_",
  "4": "a",
  "g": "b",
  "%": "c",
  "w": "d",
  "h": "e",
  "n": "f",
  "b": "g",
  "7": "h",
  "x": "i",
  "~": "j",
  "_": "k",
  "l": "l",
  ":": "m",
  "c": "n",
  "L": "o",
  "j": "p",
  "u": "q",
  "R": "r",
  "}": "s",
  "p": "t",
  "V": "u",
  "P": "v",
  "'": "w",
  "T": "x",
  "|": "y",
  "@": "z",
  "e": "{",
  ";": "}"
};

Scene.prototype.deobfuscatePassword = function deobfuscatePassword(password) {
  var self = this;
  password = password.replace(/./g,
    function(x) {
      var y = self.deobfuscator[x];
      return y;
    }
  );
  return password;
};

Scene.prototype.stat_chart = function stat_chart() {
  var rows = this.parseStatChart();
  var target = this.target;
  if (!target) target = document.getElementById('text');

  if (this.prevLine == "text") println("", target);

  var barWidth = 0;
  var standardFontSize = 0;

  function fixFontSize(span1, span2) {
    if (!standardFontSize) {
      if (window.getComputedStyle) {
        standardFontSize = parseInt(getComputedStyle(document.body).fontSize, 10);
      } else if (document.body.currentStyle) {
        standardFontSize = parseInt(document.body.currentStyle.fontSize, 10);
      } else {
        standardFontSize = 16;
      }
    }
    if (!barWidth) barWidth = span1.parentNode.offsetWidth;
    var spanMaxWidth, biggestSpanWidth;
    if (span2) {
      spanMaxWidth = barWidth / 2 - 1; /* minus one as a fudge factor; why is this needed? */
      biggestSpanWidth = Math.max(span1.offsetWidth, span2.offsetWidth);
    } else {
      spanMaxWidth = barWidth;
      biggestSpanWidth = span1.offsetWidth;
    }

    if (biggestSpanWidth > spanMaxWidth) {
      var newSize = Math.floor(standardFontSize * spanMaxWidth / biggestSpanWidth);
      span1.parentNode.style.fontSize = newSize + "px";
      if (window.getComputedStyle) {
        // on Android, if the user is using non-standand styles, browser may try to ignore our font setting
        var actual = parseInt(getComputedStyle(span1).fontSize, 10);
        if (actual > newSize) {
          newSize *= newSize / actual;
          span1.parentNode.style.fontSize = newSize + "px";
        }
      }
    }

  }

  for (i = 0; i < rows.length; i++) {
    var row = rows[i];
    var type = row.type;
    var variable = row.variable;
    var value = this.evaluateExpr(this.tokenizeExpr(variable));
    var label = this.replaceVariables(row.label);
    var definition = this.replaceVariables(row.definition || "");

    var statWidth, div, span, statValue;
    if (type == "text") {
      div = document.createElement("div");
      setClass(div, "statText");
      span = document.createElement("span");
      if (trim(label) || trim(value)) {
        printx(label + ": " + value, span);
      } else {
        // unofficial line_break
        printx(" ", span);
      }
      div.appendChild(span);
      target.appendChild(div);
    } else if (type == "percent") {
      div = document.createElement("div");
      setClass(div, "statBar statLine");
      span = document.createElement("span");
      printx("\u00a0\u00a0"+label+": "+value+"%", span);
      div.appendChild(span);
      statValue = document.createElement("div");
      setClass(statValue, "statValue");
      statValue.style.width = value+"%";
      statValue.innerHTML = "&nbsp;";
      div.appendChild(statValue);
      target.appendChild(div);
      fixFontSize(span);
    } else if (type == "opposed_pair") {
      div = document.createElement("div");
      setClass(div, "statBar statLine opposed");
      span0 = document.createElement("span");
      printx("\u00a0\u00a0"+label+": "+value+"% ", span0);
      div.appendChild(span0);
      span = document.createElement("span");
      span.setAttribute("style", "float: right");
      printx(row.opposed_label+": "+(100-value)+"%\u00a0\u00a0", span);
      div.appendChild(span);
      statValue = document.createElement("div");
      setClass(statValue, "statValue");
      statValue.style.width = value+"%";
      statValue.innerHTML = "&nbsp;";
      div.appendChild(statValue);
      target.appendChild(div);
      fixFontSize(span0, span);
    } else {
      throw new Error("Bug! Parser accepted an unknown row type: " + type);
    }
  }
  this.prevLine = "block";
  this.screenEmpty = false;
};

Scene.prototype.parseStatChart = function parseStatChart() {
    // nextIndent: the level of indentation after the current line
    var nextIndent = null;
    var rows = [];
    var line, line1, line2, line2indent;
    var startIndent = this.indent;
    while(isDefined(line = this.lines[++this.lineNum])) {
        if (!trim(line)) {
            this.rollbackLineCoverage();
            continue;
        }
        var indent = this.getIndent(line);
        if (nextIndent === null || nextIndent === undefined) {
            // initialize nextIndent with whatever indentation the line turns out to be
            // ...unless it's not indented at all
            if (indent <= startIndent) {
                throw new Error(this.lineMsg() + "invalid indent, expected at least one row");
            }
            this.indent = nextIndent = indent;
        }
        if (indent <= startIndent) {
            // it's over!
            this.rollbackLineCoverage();
            this.lineNum--;
            this.rollbackLineCoverage();
            return rows;
        }
        if (indent != this.indent) {
            // all chart rows are supposed to be at the same indentation level
            // anything at the wrong indentation level might be a mis-indented title/definition
            // or just a typo
            throw new Error(this.lineMsg() + "invalid indent, expected "+this.indent+", was " + indent);
        }

        //
        // *stat_chart
        //   text wounds Wounds
        //     Definition
        //   percent Infamy Infamy
        //     Definition
        //   opposed_pair brutality
        //     Brutality
        //       Strength and cruelty
        //     Finesse
        //       Precision and aerial maneuverability
        //

        // TODO opposed_pair
        // TODO definitions
        // TODO variable substitutions
        // TODO *if/*else
        // TODO *line_break
        line = trim(line);
        var result = /^(text|percent|opposed_pair)\s+(.*)/.exec(line);
        if (!result) throw new Error(this.lineMsg() + "invalid line; this line should start with 'percent', 'text', or 'opposed_pair'");
        var type = result[1].toLowerCase();
        var data = trim(result[2]);
        if ("opposed_pair" == type) {
          this.getVar(data);
          line1 = this.lines[++this.lineNum];
          this.replaceVariables(line1);
          line1indent = this.getIndent(line1);
          if (line1indent <= this.indent) throw new Error(this.lineMsg() + "invalid indent; expected at least one indented line to indicate opposed pair name. indent: " + line1indent + ", expected greater than " + this.indent);
          line2 = this.lines[this.lineNum + 1];
          line2indent = this.getIndent(line2);
          if (line2indent <= this.indent) {
            // line1 was the only line
            rows.push({type: type, variable: data, label: data, opposed_label: trim(line1)});
          } else {
            this.lineNum++;
            this.replaceVariables(line2);
            if (line2indent == line1indent) {
              // two lines: first label, second label
              rows.push({type: type, variable: data, label: trim(line1), opposed_label: trim(line2)});
            } else if (line2indent > line1indent) {
              // line 2 is a definition; therefore the opposed_label and its definition must be on lines 3 and 4
              var line1definition = line2;
              var line3 = this.lines[++this.lineNum];
              this.replaceVariables(line3);
              var line3indent = this.getIndent(line3);
              if (line3indent != line1indent) throw new Error(this.lineMsg() + "invalid indent; this line should be the opposing label name. expected " + line1indent + " was " + line3indent);
              var line4 = this.lines[++this.lineNum];
              this.replaceVariables(line4);
              var line4indent = this.getIndent(line4);
              if (line4indent != line2indent) throw new Error(this.lineMsg() + "invalid indent; this line should be the opposing label definition. expected " + line2indent + " was " + line4indent);
              rows.push({type: type, variable: data, label: trim(line1), definition:trim(line2), opposed_label: trim(line3), opposed_definition: trim(line4)});
            } else {
              throw new Error(this.lineMsg() + "invalid indent; expected a second line with indent " + line1indent + " to match line " + this.lineNum + ", or else no more opposed_pair lines");
            }
          }
        } else {
          var variable, label;
          if (!/ /.test(data)) {
            variable = data;
            label = data;
          } else if (/^\(/.test(data)) {
            var parens = 0;
            var closingParen = -1;
            for (var i = 1; i < data.length; i++) {
              var c = data.charAt(i);
              if (c === "(") {
                parens++;
              } else if (c === ")") {
                if (parens) {
                  parens--;
                } else {
                  closingParen = i;
                  break;
                }
              }
            }
            if (closingParen == -1) {
              throw new Error(this.lineMsg() + "missing closing parenthesis");
            }
            variable = data.substring(1, closingParen);
            label = trim(data.substring(closingParen+1))
            if (label === "") {
              label = variable;
            }
          } else {
            result = /^(\S+) (.*)/.exec(data);
            if (!result) throw new Error(this.lineMsg() + "Bug! can't find a space when a space was found");
            variable = result[1];
            label = result[2];
          }
          this.evaluateExpr(this.tokenizeExpr(variable));
          this.replaceVariables(label);
          line2 = this.lines[this.lineNum + 1];
          line2indent = this.getIndent(line2);
          if (line2indent <= this.indent) {
            // No definition line
            rows.push({type: type, variable: variable, label: label});
          } else {
            this.lineNum++;
            this.replaceVariables(line2);
            rows.push({type: type, variable: variable, label: label, definition: trim(line2)});
          }
        }
    }
    return rows;
};

// *timer Dec 25, 2016 9:30:00 PDT
Scene.prototype.timer = function(dateString) {
  var end;
  if (dateString == "release") {
    if (typeof window === "undefined" || !window.releaseDate) return;
    end = window.releaseDate/1000;
  } else {
    end = Date.parse(dateString)/1000;
  }
  var now = new Date()/1000;
  if (now < end) {
    var target = this.target;
    if (!target) {
      target = document.createElement("p");
      document.getElementById('text').appendChild(target);
    }
    var self = this;
    showTicker(target, end, function() {
      clearScreen(loadAndRestoreGame());
    });
  }
}

// *delay_break 1200
Scene.prototype.delay_break = function(durationInSeconds) {
  if (isNaN(durationInSeconds * 1)) throw new Error(this.lineMsg() + "invalid duration");
  this.finished = true;
  this.skipFooter = true;
  var target = this.target;
  if (!target) {
    target = document.createElement("p");
    document.getElementById('text').appendChild(target);
  }
  var self = this;
  delayBreakStart(function(delayStart) {
    window.blockRestart = true;
    var endTimeInSeconds = durationInSeconds * 1 + delayStart * 1;
    showTicker(target, endTimeInSeconds, function() {
      printButton("Next", target, false, function() {
        delayBreakEnd();
        self.finished = false;
        self.resetPage();
      });
    });
    printFooter();
  });
};

// *delay_ending 1200 $2.99 $0.99
Scene.prototype.delay_ending = function(data) {
  var args = data.split(/ /);
  var durationInSeconds = args[0];
  var fullPriceGuess = args[1];
  var singleUsePriceGuess = args[2];
  if (isNaN(durationInSeconds * 1)) throw new Error(this.lineMsg() + "invalid duration");
  if (!/^\$/.test(fullPriceGuess)) throw new Error(this.lineMsg() + "invalid fullPriceGuess: \""+fullPriceGuess+"\"");
  if (singleUsePriceGuess && !/^\$/.test(singleUsePriceGuess)) throw new Error(this.lineMsg() + "invalid singleUsePriceGuess: \""+singleUsePriceGuess+"\"");
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  checkPurchase("adfree", function(ok, result) {
    if (result.adfree || !result.billingSupported) {
      self.ending();
      return;
    }
    getPrice("adfree", function (fullPrice) {
      if (fullPrice == "guess") fullPrice = fullPriceGuess;
      getPrice("skiponce", function (singleUsePrice) {
        if (singleUsePrice == "guess") singleUsePrice = singleUsePriceGuess;

        options = [];
        var finishedWaiting = {name: "Play again after a short wait. ", unselectable: true};
        options.push(finishedWaiting);
        var upgradeSkip = {name: "Upgrade to the unlimited version for " + fullPrice + " to skip the wait forever."};
        options.push(upgradeSkip);
        var skipOnce = {name: "Skip the wait one time for " + singleUsePrice + "."};
        if (singleUsePriceGuess) options.push(skipOnce);
        var restorePurchasesOption = {name: "Restore purchases from another device."};
        if (isRestorePurchasesSupported()) options.push(restorePurchasesOption);
        var playMoreGames = {name: "Play more games like this."};
        options.push(playMoreGames);
        var emailMe = {name: "Email me when new games are available."};
        options.push(emailMe);

        self.paragraph();
        printOptions([""], options, function(option) {
          if (option == playMoreGames) {
            self.more_games("now");
            if (typeof curl != "undefined") curl();
          } else if (option == emailMe) {
            subscribeLink();
          } else if (option == upgradeSkip) {
            purchase("adfree", function() {
              safeCall(self, function() {
                self.restart();
              });
            });
          } else if (option == skipOnce) {
            purchase("skiponce", function() {
              safeCall(self, function() {
                self.restart();
              });
            });
          } else if (option == restorePurchasesOption) {
            restorePurchases("adfree", function() {
              clearScreen(loadAndRestoreGame);
            });
          } else {
            self.restart();
          }
        });

        var target = document.getElementById("0").parentElement;

        delayBreakStart(function(delayStart) {
          window.blockRestart = true;
          var endTimeInSeconds = durationInSeconds * 1 + delayStart * 1;
          showTicker(target, endTimeInSeconds, function() {
            clearScreen(function() {
              self.ending();
            });
          });
          printFooter();
        });
      });
    });
  });

};

// *if booleanExpr
// execute different code depending on whether the booleanExpr is true or false
//
// Examples:
// *if bool-expression
//     blah
//     blah
// *elseif bool-expression
//     blah
//     blah
// *else
//     blah
//     blah
// bool-expression
//     by reference
//         *set foo true
//         *if foo ...
//     equality
//         foo=2
//         foo="blah"
//         2="2"
//             true
//     inequality
//         foo>2
//         foo<2
//         foo<=2
//         foo>=2
//     and/or logic, parentheses mandatory
//         (foo=2) or (foo=3)
//         ((foo>4) and (foo<8)) or (bar=0)
//
// NOTE: *if commands may be used inside *choices, to make some choices conditionally available
Scene.prototype["if"] = function scene_if(line) {
    var stack = this.tokenizeExpr(line);
    var result = this.evaluateExpr(stack);
    if (this.debugMode) println(line + " :: " + result);
    result = bool(result, this.lineNum+1);
    if (result) {
        // "true" branch, just go on to the next line
        this.indent = this.getIndent(this.nextNonBlankLine());
    } else {
        // "false" branch; skip over the true branch
        this.skipTrueBranch(false);
    }
};

// TODO Rename this function to just skipBranch
Scene.prototype.skipTrueBranch = function skipTrueBranch(inElse) {
  var self = this;
  function prevNonBlankLine() {
    var line;
    var i = self.lineNum - 1;
    while(isDefined(line = self.lines[i]) && !trim(line)) {
      i--;
    }
    return i;
  }
  var startIndent = this.indent;
  var nextIndent = null;
  while (isDefined(line = this.lines[++this.lineNum])) {
      this.rollbackLineCoverage();
      if (!trim(line)) continue;
      var indent = this.getIndent(line);
      if (nextIndent === null || nextIndent === undefined) {
          if (indent <= startIndent) throw new Error(this.lineMsg() + "invalid indent, expected at least one line in 'if' true block");
          nextIndent = indent;
      }
      if (indent <= startIndent) {
          // true block is over
          var parsed;
          // check to see if this is an *else or *elseif
          if (indent == startIndent) parsed = /^\s*\*(\w+)(.*)/.exec(line);
          if (!parsed || inElse) {
              this.lineNum = prevNonBlankLine();
              this.rollbackLineCoverage();
              this.indent = indent;
              return;
          }
          var command = parsed[1].toLowerCase();
          var data = trim(parsed[2]);
          if ("else" == command) {
              if (data) {
                if (/^if\b/.test(data)) {
                  throw new Error(this.lineMsg() + "'else if' is invalid, use 'elseif'");
                }
                throw new Error(this.lineMsg() + "nothing should appear on a line after 'else': " + data);
              }
              this.lineNum = this.lineNum; // code coverage
              // go on to the next line
              this.indent = this.getIndent(this.nextNonBlankLine());
          } else if (/^else?if$/.test(command)) {
              this.lineNum = this.lineNum; // code coverage
              this["if"](data);
          } else {
              this.lineNum = prevNonBlankLine();
              this.rollbackLineCoverage();
              this.indent = this.getIndent(this.nextNonBlankLine());
          }
          return;
      }
      if (indent < nextIndent) {
          // *if foo
          //      foo
          //    bar
          throw new Error(this.lineMsg() + "invalid indent, expected "+nextIndent+", was " + indent);
      }
  }
};

Scene.prototype["else"] = Scene.prototype.elsif = Scene.prototype.elseif = function scene_else(data, inChoice) {
    if (inChoice) {
      this.skipTrueBranch(true);
      return;
    }
    throw new Error(this.lineMsg() + "It is illegal to fall in to an *else statement; you must *goto or *finish before the end of the indented block.");
};

// break the string up into a stack of tokens, defined in Scene.tokens below
Scene.prototype.tokenizeExpr = function tokenizeExpr(str) {
    var stack = [];
    var tokenTypes = Scene.tokens;
    var tokenTypesLength = tokenTypes.length;
    var pos = 0;
    while (str) {
        var matched = false;
        for (var i = 0; i < tokenTypesLength; i++) {
            var tokenType = tokenTypes[i];
            var token = tokenType.test(str, this.lineNum+1);
            if (token) {
                matched = true;
                str = str.substr(token.length);
                pos += token.length;
                if ("WHITESPACE" == tokenType.name) {
                    break;
                } else if ("CURLY_QUOTE" == tokenType.name) {
                  throw new Error(this.lineMsg()+"Invalid use of curly smart quote: " + token + "\nUse straight quotes \" instead")
                }
                stack.push({name:tokenType.name, value:token, pos:pos});
                break;
            }
        }
        if (!matched) throw new Error(this.lineMsg()+"Invalid expression, couldn't extract another token: " + str);
    }
    return stack;
};

// evaluate the stack of tokens
// parenthetical == true if we're evaluating a parenthetical expression
// all expressions consist of either a "singleton" value (2) or two values and one operator (2+2)
Scene.prototype.evaluateExpr = function evaluateExpr(stack, parenthetical) {
    if (!stack.length) {
        throw new Error(this.lineMsg() + "no expression specified");
    }
    var self = this;
    function getToken() {
        var token = stack.shift();
        if (!token) throw new Error(self.lineMsg() + "null token");
        return token;
    }

    var token, value1, value2, operator, result;

    value1 = this.evaluateValueToken(getToken(), stack);

    if (!stack.length) {
        if (parenthetical) {
            throw new Error(this.lineMsg() + "Invalid expression, expected final closing parenthesis");
        }
        return value1;
    }

    token = getToken();

    if (parenthetical && parenthetical == token.name) {
        return value1;
    }

    // Since this isn't a singleton, it must be an operator
    operator = Scene.operators[token.value];
    if (!operator) throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected OPERATOR, was: " + token.name + " [" + token.value + "]");

    if (token.value === '%') {
      this.warning("this is a bare % sign, which should be replaced with %+, %-, or modulo if you're really advanced.");
      this.warning("For more details on modulo, see: https://forum.choiceofgames.com/t/21176");
    }

    value2 = this.evaluateValueToken(getToken(), stack);

    // and do the operator
    result = operator(value1, value2, this.lineNum+1, this);

    if (parenthetical) {
        // expect close parenthesis
        if (stack.length) {
            token = getToken();
            if (parenthetical == token.name) {
                return result;
            } else {
                throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected closing parenthesis, was: " + token.name + " [" + token.value + "]");
            }
        } else {
            throw new Error(this.lineMsg() + "Invalid expression, expected final closing parenthesis");
        }
    } else {
        // if not parenthetical, expect no more tokens
        if (stack.length) {
            token = getToken();
            throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected no more tokens, found: " + token.name + " [" + token.value + "]");
        } else {
            return result;
        }
    }
    throw new Error(this.lineMsg() + "bug, how did I get here?");
};

// turn a number, string, or var token into its value
// or, if this is an open parenthesis, evaluate the parenthetical expression
Scene.prototype.evaluateValueToken = function evaluateValueToken(token, stack) {
    var name = token.name;
    var value;
    if ("OPEN_PARENTHESIS" == name) {
        return this.evaluateExpr(stack, "CLOSE_PARENTHESIS");
    } else if ("OPEN_CURLY" == name) {
        value = this.evaluateExpr(stack, "CLOSE_CURLY");
        return this.getVar(value);
    } else if ("FUNCTION" == name) {
        var functionName = /^\w+/.exec(token.value)[0];
        if (!this.functions[functionName]) throw new Error(this.lineMsg + "Unknown function " + functionName);
        value = this.evaluateExpr(stack, "CLOSE_PARENTHESIS");
        return this.functions[functionName].call(this, value);
    } else if ("NUMBER" == name) {
        return token.value;
    } else if ("STRING" == name) {
        // strip off the quotes and unescape backslashes
        return this.replaceVariables(token.value.slice(1,-1).replace(/\\(.)/g, "$1"));
    } else if ("VAR" == name) {
        var variable = String(token.value);
        while (stack.length && stack[0].name == "OPEN_SQUARE") {
          stack.shift();
          variable += "_" + this.evaluateExpr(stack, "CLOSE_SQUARE");
        }
        return this.getVar(variable);
    } else {
        throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected NUMBER, STRING, VAR or PARENTHETICAL, was: " + name + " [" + token.value + "]");
    }
};

// turn a var token into its name, remove it from the stack
// or if it's a curly parenthesis, evaluate that
// or if it's an array expression, convert it into its raw underscore name
Scene.prototype.evaluateReference = function evaluateReference(stack, options) {
  var toLowerCase = true;
  if (options && options.hasOwnProperty("toLowerCase")) toLowerCase = !!options.toLowerCase;
  function findClosingBracket(stack, type, offset) {
    if (!offset) offset = 0;
    var opens = 0;
    var openType = "OPEN_"+type;
    var closeType = "CLOSE_"+type;
    for (var i = offset; i < stack.length; i++) {
      if (stack[i].name == openType) {
        opens++;
      } else if (stack[i].name == closeType) {
        if (opens) {
          opens--;
        } else {
          return i;
        }
      }
    }
    return -1;
  }
  function normalizeCase(name) {
    if (toLowerCase) {
      return String(name).toLowerCase();
    } else {
      return name;
    }
  }
  if (!stack.length) throw new Error(this.lineMsg()+"Invalid expression, expected a name");
  var name;
  if (stack[0].name === "OPEN_CURLY") {
    stack.shift();
    var closingCurly = findClosingBracket(stack, "CURLY");
    if (closingCurly == -1) throw new Error(this.lineMsg()+"Invalid expression, no closing curly bracket: " + data);
    name = this.evaluateExpr(stack.slice(0, closingCurly));
    stack.splice(0, closingCurly+1);
    return normalizeCase(name);
  } else if (stack[0].name === "NUMBER") {
    // you could have a label that's just a number
    name = stack[0].value;
    stack.shift();
    return name;
  } else {
    if (stack[0].name !== "VAR") throw new Error(this.lineMsg() + "Invalid expression; expected name, found " + stack[0].name + " at char " + stack[0].pos);
    name = String(stack[0].value);
    stack.shift();
    while(stack.length && stack[0].name == "OPEN_SQUARE") {
      var closingBracket = findClosingBracket(stack, "SQUARE", 1);
      if (closingBracket == -1) throw new Error(this.lineMsg()+"Invalid expression, no closing array bracket at char " + stack[1].pos);
      var index = this.evaluateExpr(stack.slice(1, closingBracket));
      name += "_" + index;
      stack.splice(0, closingBracket+1);
    }
    return normalizeCase(name);
  }
};

Scene.prototype.functions = {
  not: function(value) {
    return !bool(value, this.lineNum+1);
  },
  round: function(value) {
    if (isNaN(value*1)) throw new Error(this.lineMsg()+"round() value is not a number: " + value);
    return Math.round(value);
  },
  timestamp: function(value) {
    return Date.parse(value)/1000;
  },
  log: function(value) {
    if (isNaN(value*1)) throw new Error(this.lineMsg()+"log() value is not a number: " + value);
    return Math.log(value)/Math.log(10);
  },
  length: function(value) {
    return String(value).length;
  }
};

Scene.prototype.evaluateValueExpr = function evaluateValueExpr(expr) {
    var stack = this.tokenizeExpr(expr);
    var token = stack.shift();
    if (!token) throw new Error(this.lineMsg() + "null token");
    var value = this.evaluateValueToken(token, stack);
    if (stack.length) {
        token = stack.shift();
        if (!token) throw new Error(this.lineMsg() + "null token");
        throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected no more tokens, found: " + token.name + " [" + token.value + "]");
    }
    return value;
};

Scene.prototype.goto_random_scene = function gotoRandomScene(data) {
  var parsed = this.parseGotoRandomScene(data);
  var allowReuseGlobally = /\ballow_reuse\b/.test(data);
  var allowNoSelection = /\ballow_no_selection\b/.test(data);
  var option = this.computeRandomSelection(Math.random(), parsed, allowReuseGlobally);

  if (option) {
    this.goto_scene(option.name);
  } else {
    if (allowNoSelection) {
      return;
    } else {
      throw new Error(this.lineMsg() + "No selectable scenes");
    }
  }

};

Scene.prototype.parseGotoRandomScene = function parseGotoRandomScene(data) {
    data = data || "";
    var directives = data.split(" ");
    var allowReuseGlobally = false;
    var allowNoSelection = false;
    for (var i = 0; i < directives; i++) {
      var directive = trim(directives[i]);
      if (!directive) continue;
      if (directive == "allow_reuse") {
        allowReuseGlobally = true;
      } else if (directive == "allow_no_selection") {
        allowNoSelection = true;
      } else {
        throw new Error(this.lineMsg() + "invalid command: '" + directive + "'");
      }
    }

    // nextIndent: the level of indentation after the current line
    var nextIndent = null;
    var options = [];
    var line;
    var startIndent = this.indent;
    while(isDefined(line = this.lines[++this.lineNum])) {
        if (!trim(line)) {
            this.rollbackLineCoverage();
            continue;
        }
        var indent = this.getIndent(line);
        if (nextIndent === null || nextIndent === undefined) {
            // initialize nextIndent with whatever indentation the line turns out to be
            // ...unless it's not indented at all
            if (indent <= startIndent) {
                throw new Error(this.lineMsg() + "invalid indent, expected at least one line in *goto_random_scene");
            }
            this.indent = nextIndent = indent;
        }
        if (indent <= startIndent) {
            // it's over!
            this.rollbackLineCoverage();
            this.lineNum--;
            this.rollbackLineCoverage();
            break;
        }
        if (indent != this.indent) {
            // all chart rows are supposed to be at the same indentation level
            // anything at the wrong indentation level might be a mis-indented title/definition
            // or just a typo
            throw new Error(this.lineMsg() + "invalid indent, expected "+this.indent+", was " + indent);
        }
        line = trim(line);

        var option = {allowReuse:allowReuseGlobally};
        var command;
        while(!!(command = /^\*(\S+)/.exec(line))) {
          command = command[1];
          if ("allow_reuse" == command) {
            option.allowReuse = true;
            line = trim(line.substring("*allow_reuse".length));
            command = /^\*(\S+)/.exec(line);
            continue;
          } else if ("if" == command) {
            var conditional = /^\*if\s+\((.+)\)\s+([^\)]+)/.exec(line);
            if (!conditional) throw new Error(this.lineMsg() + " invalid *if, expected () followed by scene name: " + line);
            line = conditional[2];
            var stack = this.tokenizeExpr(conditional[1]);
            this.evaluateExpr(stack);
            option.conditional = conditional[1];
          } else {
            throw new Error(this.lineMsg() + " invalid command: " + line);
          }
        }
        // TODO weights
        option.name = trim(line);
        options.push(option);
    }
    return options;
};

Scene.prototype.computeRandomSelection = function computeRandomSelection(randomFloat, options, allowReuseGlobally) {
  var filtered = [];
  var finished = {};
  if (!allowReuseGlobally) {
    if (!this.stats.choice_grs) this.stats.choice_grs = [];
  }
  var grs = this.stats.choice_grs;
  for (var i = 0; i < grs.length; i++) {
    finished[grs[i]] = 1;
  }
  var option;
  for (i = 0; i < options.length; i++) {
    option = options[i];
    if (!option.allowReuse) {
      if (finished[option.name]) continue;
    }
    if (option.conditional) {
      var stack = this.tokenizeExpr(option.conditional);
      var pass = this.evaluateExpr(stack);
      if (!pass) continue;
    }
    filtered.push(option);
  }
  if (!filtered.length) return null;
  // TODO weights
  var randomSelection = Math.floor(randomFloat*filtered.length);
  option = filtered[randomSelection];
  if (!option.allowReuse) {
    this.stats.choice_grs.push(option.name);
  }
  return option;
};

Scene.prototype.end_trial = function endTrial() {
  this.paragraph();
  printLink(this.target, "#", "Start Over from the Beginning", function(e) {
    preventDefault(e);
    return restartGame("prompt");
  });
  this.prevLine = "block";
  this.screenEmpty = false;
  this.finished = true;
};

Scene.prototype.achieve = function scene_achieve(name) {
  name = name.toLowerCase();
  if (!this.nav.achievements.hasOwnProperty(name)) {
    throw new Error(this.lineMsg() + "the achievement name "+name+" was not declared as an *achievement in startup");
  }
  var achievement = this.nav.achievements[name];
  this.nav.achieved[name] = true;
  if (typeof window != "undefined" && typeof achieve != "undefined") {
    achieve(name, achievement.title, achievement.earnedDescription);
  }
};

Scene.prototype.check_achievements = function scene_checkAchievements() {
  var self = this;
  function callback(immediately) {
    for (var achievement in nav.achievements) {

      self.temps["choice_achieved_"+achievement] = nav.achieved.hasOwnProperty(achievement);
    }
    if (!immediately) {
      self.finished = false;
      self.skipFooter = false;
      self.execute();
    }
  }
  if (typeof checkAchievements == "undefined") {
    callback("immediately");
  } else {
    this.finished = true;
    this.skipFooter = true;
    checkAchievements(callback);
  }
};

Scene.prototype.scene_list = function scene_list() {
  var scenes = this.parseSceneList();
  this.nav.setSceneList(scenes);
};

Scene.prototype.parseSceneList = function parseSceneList() {
  var nextIndent = null;
  var scenes = [];
  var line;
  var startIndent = this.indent;
  while(isDefined(line = this.lines[++this.lineNum])) {
      if (!trim(line)) {
          this.rollbackLineCoverage();
          continue;
      }
      var indent = this.getIndent(line);
      if (nextIndent === null || nextIndent === undefined) {
          // initialize nextIndent with whatever indentation the line turns out to be
          // ...unless it's not indented at all
          if (indent <= startIndent) {
              throw new Error(this.lineMsg() + "invalid indent, expected at least one row");
          }
          this.indent = nextIndent = indent;
      }
      if (indent <= startIndent) {
          // it's over!
          this.rollbackLineCoverage();
          this.lineNum--;
          this.rollbackLineCoverage();
          return scenes;
      }
      if (indent != this.indent) {
          // all scenes are supposed to be at the same indentation level
          throw new Error(this.lineMsg() + "invalid indent, expected "+this.indent+", was " + indent);
      }

      line = trim(line);
      var purchaseMatch = /^\$(\w*)\s+(.*)/.exec(line);
      if (purchaseMatch) {
        line = purchaseMatch[2];
      }
      if (!scenes.length && "startup" != String(line).toLowerCase()) scenes.push("startup");
      scenes.push(line);
  }
  return scenes;
};

Scene.prototype.title = function scene_title(title) {
  if (typeof changeTitle != "undefined") {
    changeTitle(title);
  }
};

Scene.prototype.author = function scene_author(author) {
  if (typeof changeAuthor != "undefined") {
    changeAuthor(author);
  }
};

// *achievement name hidden|visible 100 Achievement Title
//     Earned description
//     Pre-earned description
Scene.prototype.achievement = function scene_achievement(data) {
  var parsed = /(\S+)\s+(\S+)\s+(\S+)\s+(.*)/.exec(data);
  if (!parsed) throw new Error(this.lineMsg() + "Invalid *achievement, requires short name, visibility, points, and display title: " + data);
  var achievementName = parsed[1];
  if (!/^[a-z][a-z0-9_]+$/.test(achievementName)) throw new Error(this.lineMsg()+"Invalid achievement name: " +achievementName);


  if (this.nav.achievements.hasOwnProperty(achievementName)) {
    // this achievement already exists...
    if (!this.nav.achievements[achievementName].lineNumber) {
      // blow away pre-existing mygame.js achievements
      this.nav.achievements = {};
      this.nav.achievementList = [];
    } else if (this.nav.achievements[achievementName].lineNumber != (this.lineNum+1)) {
      // don't allow redefining achievements
      // restarting/randomtest will naturally re-run *achievements; ignore those
      throw new Error(this.lineMsg()+"Achievement "+achievementName+" already defined on line " + this.nav.achievements[achievementName].lineNumber);
    }
  }

  var lineNumber = this.lineNum+1;
  var visibility = parsed[2];
  if (visibility != "hidden" && visibility != "visible") {
    throw new Error(this.lineMsg()+"Invalid *achievement, the second word should be either 'hidden' or 'visible': " +visibility);
  }
  var visible = (visibility != "hidden");
  var pointString = parsed[3];
  if (!/[1-9][0-9]*/.test(pointString)) {
    throw new Error(this.lineMsg()+"Invalid *achievement, the third word should be an integer number of points: " + pointString);
  }
  var points = parseInt(pointString, 10);
  if (points > 100) throw new Error(this.lineMsg()+"Invalid *achievement, no achievement may be worth more than 100 points: " + points);
  if (points < 1) throw new Error(this.lineMsg()+"Invalid *achievement, no achievement may be worth less than 1 point: " + points);
  if (!this.achievementTotal) this.achievementTotal = 0;
  this.achievementTotal += points;
  if (this.achievementTotal > 1000) {
    throw new Error(this.lineMsg()+"Invalid achievements. Adding " + points + " would add up to more than 1,000 points: " + this.achievementTotal);
  }
  var title = parsed[4];
  if (/(\$\{)/.test(title)) throw new Error(this.lineMsg()+"Invalid *achievement. ${} not permitted in achievement title: " + title);
  if (/(\[)/.test(title)) throw new Error(this.lineMsg()+"Invalid *achievement. [] not permitted in achievement title: " + title);
  if (title.length > 50) throw new Error(this.lineMsg()+"Invalid *achievement. Title must be 50 characters or fewer: " + title);

  // Get the description from the next indented line
  var line = this.lines[++this.lineNum];
  var indent = this.getIndent(line);
  if (!indent) {
    throw new Error(this.lineMsg()+"Invalid *achievement. An indented description is required.");
  }
  var preEarnedDescription = trim(line);
  if (/(\$\{)/.test(preEarnedDescription)) throw new Error(this.lineMsg()+"Invalid *achievement. ${} not permitted in achievement description: " + preEarnedDescription);
  if (/(\[)/.test(preEarnedDescription)) throw new Error(this.lineMsg()+"Invalid *achievement. [] not permitted in achievement description: " + preEarnedDescription);
  if (preEarnedDescription.length > 200) throw new Error(this.lineMsg()+"Invalid *achievement. Pre-earned description must be 200 characters or fewer: " + preEarnedDescription);

  if (!visible) {
    if (preEarnedDescription.toLowerCase() != "hidden") throw new Error(this.lineMsg()+"Invalid *achievement. Hidden achievements must set their pre-earned description to 'hidden'.");
  }

  // Optionally get a post-earned description from the next line
  var postEarnedDescription = null;
  while(isDefined(line = this.lines[++this.lineNum])) {
    if (trim(line)) break;
    this.rollbackLineCoverage();
  }
  indent = this.getIndent(line);
  if (indent) {
    postEarnedDescription = trim(line);
    if (/(\$\{)/.test(postEarnedDescription)) throw new Error(this.lineMsg()+"Invalid *achievement. ${} not permitted in achievement description: " + postEarnedDescription);
    if (/(\[)/.test(postEarnedDescription)) throw new Error(this.lineMsg()+"Invalid *achievement. [] not permitted in achievement description: " + postEarnedDescription);
    if (postEarnedDescription.length > 200) throw new Error(this.lineMsg()+"Invalid *achievement. Post-earned description must be 200 characters or fewer: " + postEarnedDescription);
  } else {
    // No indent means the next line is not a post-earned description
    this.rollbackLineCoverage();
    this.lineNum--;
    this.rollbackLineCoverage();
  }

  if (!postEarnedDescription) {
    if (!visible) throw new Error(this.lineMsg()+"Invalid *achievement. Hidden achievements must set a post-earned description.");
    postEarnedDescription = preEarnedDescription;
  }

  if (!this.nav.achievements.hasOwnProperty(achievementName)) {
    this.nav.achievementList.push(achievementName);
    if (this.nav.achievementList.length > 100) {
      throw new Error(this.lineMsg()+"Too many *achievements. Each game can have up to 100 achievements.");
    }
  }

  if (!this.seenAchievementTitles) this.seenAchievementTitles = {};

  if (this.seenAchievementTitles[title]) {
    throw new Error(this.lineMsg()+"An achievement with display title \"" + title + "\" was already defined at line " + this.seenAchievementTitles[title]);
  }

  this.seenAchievementTitles[title] = this.lineNum+1;

  this.nav.achievements[achievementName] = {
    visible: visible,
    points: points,
    title: title,
    earnedDescription: postEarnedDescription,
    preEarnedDescription: preEarnedDescription,
    lineNumber: lineNumber
  };

  if (typeof setButtonTitles != "undefined") setButtonTitles();
};


Scene.prototype.bug = function scene_bug(message) {
  if (message) {
    message = "Bug: " + this.replaceVariables(message);
  } else {
    message = "Bug";
  }
  throw new Error(this.lineMsg() + message);
};

Scene.prototype.warning = function scene_warning(message) {
  // quicktest implements this
}

Scene.prototype.feedback = function scene_feedback() {
  if (typeof window == "undefined" || this.randomtest) return;
  this.paragraph();
  this.printLine("On a scale from 1 to 10, how likely are you to recommend this game to a friend?[n/][n/]");
  this.paragraph();
  var options = [{name:"10 (Most likely)"}];
  for (var i = 9; i > 1; i--) {
    options.push({name:i});
  }
  options.push({name:"1 (Least likely)"});
  options.push({name:"No response."});
  var self = this;
  this.renderOptions([""], options, function(option) {
    var value = "null";
    var numberMatch = /^(\d+)/.exec(option.name);
    if (numberMatch) value = numberMatch[1]*1;
    if (window.storeName) xhrAuthRequest("POST", "feedback", function(ok, response) {
      if (window.console) console.log("ok", ok, response);
    }, "game", window.storeName, "platform", platformCode(), "rating", value);
    self.finished = false;
    self.resetPage();
  });
  this.finished = true;
};

Scene.prototype.parseTrackEvent = function(data) {
  var event = {};
  var stack = this.tokenizeExpr(data);
  if (!stack.length) throw new Error(this.lineMsg() + "Invalid track_event statement, expected at least two args: category and action");
  event.category = this.evaluateValueToken(stack.shift(), stack);
  if (!stack.length) throw new Error(this.lineMsg() + "Invalid track_event statement, expected at least two args: category and action");
  event.action = this.evaluateValueToken(stack.shift(), stack);
  if (stack.length) {
    event.label = this.evaluateValueToken(stack.shift(), stack);
    if (stack.length) {
      event.value = this.evaluateValueToken(stack.shift(), stack);
      if (stack.length) {
        throw new Error(this.lineMsg() + "Invalid track_event statement, expected at most four args: category, action, label, value");
      }
      var intValue = parseInt(event.value, 10);
      if (isNaN(intValue) || event.value != intValue || event.value.toString() != intValue.toString()) {
        throw new Error(this.lineMsg() + "Invalid track_event statement, value must be an integer: " + event.value);
      }
    }
  }
  return event;
}

Scene.prototype.track_event = function track_event(data) {
  var event = this.parseTrackEvent(data);
  if (typeof ga !== "undefined") {
    ga('send', 'event', event.category, event.action, event.label, event.value);
  }
}

Scene.prototype.lineMsg = function lineMsg() {
    return this.name + " line " + (this.lineNum+1) + ": ";
};

Scene.prototype.rollbackLineCoverage = function() {};

Scene.baseUrl = "scenes";
Scene.regexpMatch = function regexpMatch(str, re) {
    var result = re.exec(str);
    if (!result) return null;
    return result[0];
};
// Each token has a name and a test, which returns the matching string
Scene.tokens = [
    {name:"OPEN_PARENTHESIS", test:function(str){ return Scene.regexpMatch(str,/^\(/); } },
    {name:"CLOSE_PARENTHESIS", test:function(str){ return Scene.regexpMatch(str,/^\)/); } },
    {name:"OPEN_CURLY", test:function(str){ return Scene.regexpMatch(str,/^\{/); } },
    {name:"CLOSE_CURLY", test:function(str){ return Scene.regexpMatch(str,/^\}/); } },
    {name:"OPEN_SQUARE", test:function(str){ return Scene.regexpMatch(str,/^\[/); } },
    {name:"CLOSE_SQUARE", test:function(str){ return Scene.regexpMatch(str,/^\]/); } },
    {name:"FUNCTION", test:function(str){ return Scene.regexpMatch(str,/^(not|round|timestamp|log|length)\s*\(/); } },
    {name:"NUMBER", test:function(str){ return Scene.regexpMatch(str,/^\d+(\.\d+)?\b/); } },
    {name:"STRING", test:function(str, line) {
            var i;
            if (!/^\"/.test(str)) return null;
            for (i = 1; i < str.length; i++) {
                var x = str.charAt(i);
                if ("\\" == x) {
                    i++;
                } else if ('"' == x) {
                    return str.substring(0,i+1);
                }
            }
            throw new Error("line "+line+": Invalid string, open quote with no close quote: " + str);
        }
    },
    {name:"CURLY_QUOTE", test:function(str){ return Scene.regexpMatch(str,/^[\u201c|\u201d]/); } },
    {name:"WHITESPACE", test:function(str){ return Scene.regexpMatch(str,/^\s+/); } },
    {name:"NAMED_OPERATOR", test:function(str){ return Scene.regexpMatch(str,/^(and|or|modulo)\b/); } },
    {name:"VAR", test:function(str){ return Scene.regexpMatch(str,/^\w*/); } },
    {name:"FAIRMATH", test:function(str){ return Scene.regexpMatch(str,/^%[\+\-]/); } },
    {name:"OPERATOR", test:function(str){ return Scene.regexpMatch(str,/^[\+\-\*\/\&\%\^\#]/); } },
    {name:"INEQUALITY", test:function(str){ return Scene.regexpMatch(str,/^[\!<>]\=?/); } },
    {name:"EQUALITY", test:function(str){ return Scene.regexpMatch(str,/^=/); } }
    //
];
Scene.operators = {
    "+": function add(v1,v2,line) { return num(v1,line) + num(v2,line); },
    "-": function subtract(v1,v2,line) { return num(v1,line) - num(v2,line); },
    "*": function multiply(v1,v2,line) { return num(v1,line) * num(v2,line); },
    "/": function divide(v1,v2,line) { return num(v1,line) / num(v2,line); },
    "%": function modulo(v1,v2,line) { return num(v1,line) % num(v2,line); },
    "^": function exponent(v1,v2,line) { return Math.pow(num(v1,line), num(v2,line)); },
    "&": function concatenate(v1,v2) { return [v1,v2].join(""); },
    "#": function charAt(v1,v2,line) {
      var i = num(v2,line);
      if (i < 1) {
        throw new Error("line "+line+": There is no character at position " + i + "; the position must be greater than or equal to 1.");
      }
      if (i > String(v1).length) {
        throw new Error("line "+line+": There is no character at position " + i + ". \""+v1+"\" is only " + String(v1).length + " characters long.");
      }
      return String(v1).charAt(i-1);
    },
    "%+": function fairAdd(v1, v2, line) {
        v1 = num(v1,line);
        v2 = num(v2,line);
        var validValue = (v1 >= 0 && v1 <= 100);
        if (!validValue) {
            throw new Error("line "+line+": Can't fairAdd to non-percentile value: " + v1);
        }
        if (v2 > 0) {
          var multiplier = (100 - v1) / 100;
          var actualModifier = v2 * multiplier;
          var value = 1 * v1 + actualModifier;
          value = Math.floor(value);
          if (value > 99) value = 99;
          return value;
        } else {
          var multiplier = v1 / 100;
          var actualModifier = (0-v2) * multiplier;
          var value = v1 - actualModifier;
          value = Math.ceil(value);
          if (value < 1) value = 1;
          return value;
        }
    },
    "%-": function fairSubtract(v1, v2, line) {
        v2 = num(v2,line);
        return Scene.operators["%+"](v1,0-v2,line);
    },
    "=": function equals(v1,v2) { return v1 == v2 || String(v1) == String(v2); },
    "<": function lessThan(v1,v2,line) {
        return num(v1,line) < num(v2,line); },
    ">": function greaterThan(v1,v2,line) { return num(v1,line) > num(v2,line); },
    "<=": function lessThanOrEquals(v1,v2,line) { return num(v1,line) <= num(v2,line); },
    ">=": function greaterThanOrEquals(v1,v2,line) { return num(v1,line) >= num(v2,line); },
    "!=": function notEquals(v1,v2) { return v1 != v2; },
    "and": function and(v1, v2, line) {
        return bool(v1,line) && bool(v2,line);
    },
    "or": function or(v1, v2, line) {
        return bool(v1,line) || bool(v2,line);
    },
    "modulo": function modulo(v1,v2,line) { return num(v1,line) % num(v2,line); },
};

Scene.initialCommands = {"create":1,"scene_list":1,"title":1,"author":1,"comment":1,"achievement":1,"product":1};

Scene.validCommands = {"comment":1, "goto":1, "gotoref":1, "label":1, "looplimit":1, "finish":1, "abort":1,
    "choice":1, "create":1, "temp":1, "delete":1, "set":1, "setref":1, "print":1, "if":1, "rand":1,
    "page_break":1, "line_break":1, "script":1, "else":1, "elseif":1, "elsif":1, "reset":1,
    "goto_scene":1, "fake_choice":1, "input_text":1, "ending":1, "share_this_game":1, "stat_chart":1,
    "subscribe":1, "show_password":1, "gosub":1, "return":1, "hide_reuse":1, "disable_reuse":1, "allow_reuse":1,
    "check_purchase":1,"restore_purchases":1,"purchase":1,"restore_game":1,"advertisement":1,
    "feedback":1,
    "save_game":1,"delay_break":1,"image":1,"link":1,"input_number":1,"goto_random_scene":1,
    "restart":1,"more_games":1,"delay_ending":1,"end_trial":1,"login":1,"achieve":1,"scene_list":1,"title":1,
    "bug":1,"link_button":1,"check_registration":1,"sound":1,"author":1,"gosub_scene":1,"achievement":1,
    "check_achievements":1,"redirect_scene":1,"print_discount":1,"purchase_discount":1,"track_event":1,
    "timer":1,"youtube":1,"product":1,"text_image":1
    };
/*
 * Copyright 2010 by Dan Fabulich.
 * 
 * Dan Fabulich licenses this file to you under the
 * ChoiceScript License, Version 1.0 (the "License"); you may
 * not use this file except in compliance with the License. 
 * You may obtain a copy of the License at
 * 
 *  http://www.choiceofgames.com/LICENSE-1.0.txt
 * 
 * See the License for the specific language governing
 * permissions and limitations under the License.
 * 
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied.
 */
function SceneNavigator(sceneList) {
    this.setSceneList(sceneList);
    this.startingStats = {};
}

SceneNavigator.prototype.setSceneList = function setSceneList(sceneList) {
    this._sceneList = sceneList;
    this._sceneMap = {};
    for (var i = 0; i < sceneList.length-1; i++) {
        var scene1 = sceneList[i];
        var scene2 = sceneList[i+1];
        this._sceneMap[scene1] = scene2;
    }
    this._startupScene = sceneList[0];
};

SceneNavigator.prototype.nextSceneName = function nextSceneName(currentSceneName) {
    var nextScene = this._sceneMap[currentSceneName];
    //if (!nextScene) throw new Error("No scene follows " + currentSceneName);
    return nextScene;
};

SceneNavigator.prototype.getStartupScene = function getStartupScene() {
    return this._startupScene;
};

SceneNavigator.prototype.setStartingStatsClone = function setStartingStatsClone(stats) {
  this.startingStats = {};
  for (var i in stats) {
    this.startingStats[i] = stats[i];
  }
};

SceneNavigator.prototype.resetStats = function resetStats(stats) {
  for (var i in stats) {
    delete stats[i];
  }
  for (i in this.startingStats) {
    stats[i] = this.startingStats[i];
  }
  this.bugLog = [];
};

SceneNavigator.prototype.repairStats = function repairStats(stats) {
  for (var i in this.startingStats) {
    var startingStat = this.startingStats[i];
    if (startingStat === null || startingStat === undefined) continue;
    if (typeof(stats[i]) === "undefined" || stats[i] === null) {
      stats[i] = this.startingStats[i];
    }
  }
};

SceneNavigator.prototype.bugLog = [];
SceneNavigator.prototype.achievements = {};
SceneNavigator.prototype.achievementList = [];
SceneNavigator.prototype.achieved = {};
SceneNavigator.prototype.products = {};

SceneNavigator.prototype.loadAchievements = function(achievementArray) {
  if (!achievementArray) return;
  this.achievements = {};
  this.achievementList = [];
  for (var i = 0; i < achievementArray.length; i++) {
    var achievement = achievementArray[i];
    var achievementName = achievement[0];
    var visible = achievement[1];
    var points = achievement[2];
    var title = achievement[3];
    var earnedDescription = achievement[4];
    var preEarnedDescription = achievement[5];
    this.achievements[achievementName] = {
      visible: visible,
      points: points,
      title: title,
      earnedDescription: earnedDescription,
      preEarnedDescription: preEarnedDescription
    };
    this.achievementList.push(achievementName);
  }
};
SceneNavigator.prototype.loadProducts = function(productArray, purchaseMap) {
  if (!productArray && !purchaseMap) return;
  this.products = {};
  for (var i = 0; i < productArray; i++) {
    this.products[productArray[i]] = {};
  }
  for (var scene in purchaseMap) {
    var product = purchaseMap[scene];
    this.products[product] = {};
  }
}
nav = new SceneNavigator(["startup"]);
stats = {};

</script><style>body {
  max-width: 680px;
  _width:expression(this.scrollWidth > 680 ? "680px" : "auto");
  font-size: 100%;  /* reset for CWS */
  font: -apple-system-body; /* we'll override the font, but keep the size from iOS dynamic text sizing */
  font-family: Georgia,"Times New Roman",serif;
  background-color: #F7F4F1;
  color: rgba(0, 0, 0, 0.85);
  margin: 8px auto; 
  padding: 0 8px;
  -webkit-user-select: text; /* selectable text for Chrome app support */
  transition-property: background-color, color;
  transition-duration: 2s;
}

a {
  /* colored underlined links for XULRunner support */
  color: blue;
  text-decoration: underline;
  cursor: pointer;
}

#main {
	line-height: 1.5;
}

#text img {
  max-width: 100%;
}

.statBar {
  background-color: #949291;
  height: 2em;
  line-height: 2em;
  margin: 4px 0;
  width: 300px;
  max-width: 100%;
  color: #f7f4f1;
  position: relative; /* to allow absolute positioned value */
  z-index: 0;
}
.opposed {
  background-color: #6D6DFC;
}

table {
  margin-bottom: 1.5em;
}

.statText {
  margin-left: 2ex;
  text-indent: -1ex;
}

.statBar > span, .statLine > span {
  position: relative;
  z-index: 1; /* visible over stat value */
  white-space: nowrap; /* remain on single line so we can resize font based on width */
}
.statValue {
  background-color: #ff5955;
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  z-index: -1;
  /* width will be determined at runtime, 0-100% */
}

.choice label{
    padding: 11px 8px 12px;
    display:block;
    border-color:#a9acaf;
    border-style:solid;
    border-width: 1px 1px 0px 1px
}

.choice .firstChild{
    border-top-width:1px;
    -webkit-border-top-right-radius:8px;
    -webkit-border-top-left-radius:8px;
    border-top-right-radius:8px;
    border-top-left-radius:8px;
}
/* IE doesn't support label:last-child */
.choice .lastChild{
    border-bottom-width:1px;
    -webkit-border-bottom-right-radius:8px;
    -webkit-border-bottom-left-radius:8px;
    -moz-border-radius:0px 0px 8px 8px;
    border-bottom-right-radius:8px;
    border-bottom-left-radius:8px;
}
.choice .onlyChild{
    border-width:1px;
    -webkit-border-radius:8px;
    -moz-border-radius:8px;
    border-radius:8px;
}

.choice .noBorder {
  border-width: 0;
}

input[type="radio"], input[type="checkbox"] {
  margin-right: 8px;
}

.saveGame>label {
  display:block;
}

.choice .disabled {
  color: gray;
}

input[type=password]:disabled {
  background-color: lightgray;
}

/* Reset for Firefox vs. Chrome */
input[type=email],input[type=password] {
  padding: 1px;
  margin: 2px 0;
}

.next {
    clear: both;
    display:block;
    width:100%;
    font-size:1.5em;
    font-weight:bolder;
    font-family: -apple-system, sans-serif; /* reset, for Android */
    margin-bottom: 1em; /* reset button margin */
    -webkit-appearance: none; /* Safari, don't override my CSS styles */
    color: #f7f4f1; /* Match background color */ 
    background-color: #626160;
    border: none;
    -webkit-border-radius: 0.5em;
    -moz-border-radius: 0.5em;
    border-radius: 0.5em;
    padding: 6px;
}

.linkButton {
  text-align: center;
  text-decoration: none;
}

.next:hover {
  color: #E4DED8;
}

h1 {
  font-size: 1.5em;
  font-weight: normal;
}

h2 {
  font-size: 1.125em;
  font-weight: normal;
}

#identity {
  float: right;
  display: none;
}

#identity > a {
  display: block;
  text-align: end;
}

#footer {
  margin:10px 0px 75px 0px;
}

#mobileLinks a img {
  border: 0;
}

.mobileBadges {
  margin: 0;
}

.spacedLink {
  margin-right:0.5em;
}

.spacedLink:last-child {
  margin-right:0;
}

#sharelist {
  margin: 0; /* Eliminate leading space before share links */
}

#sharelist li {
  line-height: 1cm; /* Don't let the links bunch up */
}

.alertify-cover {
  background-color: black;
  filter:alpha(opacity=50);
  opacity: 0.5;
}

#greybackground {
    position: fixed;
    width:100%;
    height:100%;
    background-color: black;
    filter:alpha(opacity=50);
    opacity: 0.5;
    top:0;
    left:0;
}

.savePassword {
  font-family: monospace;
  display: block;
}

.webOnly { /* We'll override this in JavaScript */
  display: none;
}

.alignleft {
  display: inline;
  float: left;
  margin-right: 1.625em;
  margin-bottom: 1.5em;
}
.alignright {
  display: inline;
  float: right;
  margin-left: 1.625em;
  margin-bottom: 1.5em;
}
.aligncenter {
  clear: both;
  display: block;
  margin-left: auto;
  margin-right: auto;
  margin-bottom: 1.5em;
}

#main form {
  clear: both;
}

.paidOnly {
  display: none;
}

.videoWrapper {
  position: relative;
  padding-bottom: 56.25%; /* 16:9 */
  height: 0;
}

.videoWrapper iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

body.nightmode {
  background-color: #242424;
  color: rgba(255,255,255,0.85);
}

body.nightmode a {
  color: #7bc8fa;
}

body.nightmode .next {
  color: #242424; /* Match background color */
  background-color: #D9D9D9;
}

body.nightmode .next:hover {
  color: #555;
}

body.nightmode .alertify {
  color: black;
}

body.nightmode a.alertify-button {
  color: white;
}

body.nightmode img.invert {
  -webkit-filter: invert(100%);
  filter: invert(100%);
}

body.whitemode {
  background-color: white;
}

body.whitemode .next {
  color: white; /* Match background color */
}

body.whitemode .next:hover {
  color: #ddd;
}

@media only screen and (max-width: 480px) {
  .definition{
    display: none;
  }
  
  #headerLinks {
    line-height: 2; /* For tapability */
  }

  .gameTitle {
    display: none;
  }

  #advertisement {
    margin: -8px;
  }
  
  .mobileBadges {
    float: none;
  }
  
  #header {
    margin-top: 30px;
  }

  /** Floating images should leave enough room for text */
  #text .alignleft, #text .alignright {
    max-width: 45%;
  }
  
}
.alertify-show,
.alertify-log {
	-webkit-transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1); /* older webkit */
	-webkit-transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1.275);
	   -moz-transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1.275);
	    -ms-transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1.275);
	     -o-transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1.275);
	        transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1.275); /* easeOutBack */
}
.alertify-hide {
	-webkit-transition: all 250ms cubic-bezier(0.600, 0, 0.735, 0.045); /* older webkit */
	-webkit-transition: all 250ms cubic-bezier(0.600, -0.280, 0.735, 0.045);
	   -moz-transition: all 250ms cubic-bezier(0.600, -0.280, 0.735, 0.045);
	    -ms-transition: all 250ms cubic-bezier(0.600, -0.280, 0.735, 0.045);
	     -o-transition: all 250ms cubic-bezier(0.600, -0.280, 0.735, 0.045);
	        transition: all 250ms cubic-bezier(0.600, -0.280, 0.735, 0.045); /* easeInBack */
}
.alertify-cover {
	position: fixed; z-index: 99999;
	top: 0; right: 0; bottom: 0; left: 0;
}
.alertify {
	position: fixed; z-index: 99999;
	top: 50px; left: 50%;
	width: 550px;
	margin-left: -275px;
}
	.alertify-hidden {
		top: -50px;
		visibility: hidden;
	}
.alertify-logs {
	position: fixed;
	z-index: 5000;
	bottom: 10px;
	right: 10px;
	width: 300px;
}
	.alertify-log {
		display: block;
		margin-top: 10px;
		position: relative;
		right: -300px;
	}
	.alertify-log-show {
		right: 0;
	}
	.alertify-dialog {
		padding: 25px;
	}
		.alertify-resetFocus {
			border: 0;
			clip: rect(0 0 0 0);
			height: 1px;
			margin: -1px;
			overflow: hidden;
			padding: 0;
			position: absolute;
			width: 1px;
		}
		.alertify-inner {
			text-align: center;
		}
		.alertify-text {
			margin-bottom: 15px;
			width: 100%;
			-webkit-box-sizing: border-box;
			   -moz-box-sizing: border-box;
			        box-sizing: border-box;
			font-size: 100%;
		}
		.alertify-buttons {
		}
			.alertify-button {
				/* line-height and font-size for input button */
				line-height: 1.5;
				font-size: 100%;
				display: inline-block;
				cursor: pointer;
				margin-left: 5px;
			}

@media only screen and (max-width: 680px) {
	.alertify,
	.alertify-logs {
		width: 90%;
		-webkit-box-sizing: border-box;
		   -moz-box-sizing: border-box;
		        box-sizing: border-box;
	}
	.alertify {
		left: 5%;
		margin: 0;
	}
}
/**
 * Default Look and Feel
 */
.alertify,
.alertify-log {
	font-family: sans-serif;
}
.alertify {
	background: #FFF;
	border: 10px solid #333; /* browsers that don't support rgba */
	border: 10px solid rgba(0,0,0,.7);
	border-radius: 8px;
	box-shadow: 0 3px 3px rgba(0,0,0,.3);
	-webkit-background-clip: padding;     /* Safari 4? Chrome 6? */
	   -moz-background-clip: padding;     /* Firefox 3.6 */
	        background-clip: padding-box; /* Firefox 4, Safari 5, Opera 10, IE 9 */
}
	.alertify-text {
		border: 1px solid #CCC;
		padding: 10px;
		border-radius: 4px;
	}
	.alertify-button {
		border-radius: 4px;
		color: #FFF;
		font-weight: bold;
		padding: 6px 15px;
		text-decoration: none;
		text-shadow: 1px 1px 0 rgba(0,0,0,.5);
		box-shadow: inset 0 1px 0 0 rgba(255,255,255,.5);
		background-image: -webkit-linear-gradient(top, rgba(255,255,255,.3), rgba(255,255,255,0));
		background-image:    -moz-linear-gradient(top, rgba(255,255,255,.3), rgba(255,255,255,0));
		background-image:     -ms-linear-gradient(top, rgba(255,255,255,.3), rgba(255,255,255,0));
		background-image:      -o-linear-gradient(top, rgba(255,255,255,.3), rgba(255,255,255,0));
		background-image:         linear-gradient(top, rgba(255,255,255,.3), rgba(255,255,255,0));
	}
	.alertify-button:hover,
	.alertify-button:focus {
		outline: none;
		box-shadow: 0 0 15px #2B72D5;
		background-image: -webkit-linear-gradient(top, rgba(0,0,0,.1), rgba(0,0,0,0));
		background-image:    -moz-linear-gradient(top, rgba(0,0,0,.1), rgba(0,0,0,0));
		background-image:     -ms-linear-gradient(top, rgba(0,0,0,.1), rgba(0,0,0,0));
		background-image:      -o-linear-gradient(top, rgba(0,0,0,.1), rgba(0,0,0,0));
		background-image:         linear-gradient(top, rgba(0,0,0,.1), rgba(0,0,0,0));
	}
	.alertify-button:active {
		position: relative;
		top: 1px;
	}
		.alertify-button-cancel {
			background-color: #FE1A00;
			border: 1px solid #D83526;
		}
		.alertify-button-ok {
			background-color: #5CB811;
			border: 1px solid #3B7808;
		}
		
.alertify-log {
	background: #1F1F1F;
	background: rgba(0,0,0,.9);
	padding: 15px;
	border-radius: 4px;
	color: #FFF;
	text-shadow: -1px -1px 0 rgba(0,0,0,.5);
}
	.alertify-log-error {
		background: #FE1A00;
		background: rgba(254,26,0,.9);
	}
	.alertify-log-success {
		background: #5CB811;
		background: rgba(92,184,17,.9);
	}</style><script>allScenes = {"chapter1_start":{"crc":893538626,"labels":{"chapter1_start":0,"gender_select":5,"origin_select":59,"appearance_select":88,"eyes_select":119,"waiting_room":142,"audition_start":192,"name_input":195,"name_confirmed":208,"rooftop_scene":256,"minjae_warning":279,"minjae_choice_label":295,"commute_scene":326,"origin_local":337,"origin_global":345,"origin_mixed":351,"contract_scene":359,"contract_family":366,"contract_alone":392,"end_chapter":424},"lines":["*label chapter1_start","*image header_chapter1.png center","The heavy doors close behind you. The sound of the waiting room cuts off instantly.","It is dead silent inside.","","*label gender_select","You stand in the restroom of the Titan skyscraper a few minutes before your name is called.","You splash freezing cold water on your face and look in the mirror.","","Who is staring back?","*choice","    # I am a young woman.","        (She/Her)","        *set gender \"female\"","        *set he_she \"she\"","        *set him_her \"her\"","        *set his_her \"her\"","        *set boy_girl \"girl\"","        *set man_woman \"woman\"","        *set son_daughter \"daughter\"","        *set honorific_older_male \"Oppa\"","        You adjust your hair.","        You know what this industry does to girls. They want dolls. They want perfection.","        *set stress %+12","        *goto origin_select","","    # I am a young man.","        (He/Him)","        *set gender \"male\"","        *set he_she \"he\"","        *set him_her \"him\"","        *set his_her \"his\"","        *set boy_girl \"boy\"","        *set man_woman \"man\"","        *set son_daughter \"son\"","        *set honorific_older_male \"Hyung\"","        You square your shoulders.","        You know the competition for boy groups is brutal. They want soldiers.","        *goto origin_select","","    # I am non-binary / gender-fluid.","        (They/Them)","        *set gender \"nb\"","        *set scandal_mult 2","        *set he_she \"they\"","        *set him_her \"them\"","        *set his_her \"their\"","        *set boy_girl \"kid\"","        *set man_woman \"person\"","        *set son_daughter \"child\"","        *set honorific_older_male \"Sunbae\"","        You look at your reflection.","        This industry relies on strict boxes. You don't fit in either.","        It will be harder for you, but you will force them to make a new category just for you.","        *set rebellion +10","        *set scandal_risk %+ (5 * scandal_mult)","        *set charisma %+5","        *goto origin_select","","*label origin_select","Who are you, really?","*choice","    # I am a local Korean. Born and raised here.","        *set origin \"Local\"","        *set skin_tone \"pale\"","        *set visual %+5","        You know the culture, the language, and the pressure perfectly.","        *goto appearance_select","","    # I am a 'Gyopo' (Global). Korean blood, but born overseas.","        *set origin \"Global\"","        *set skin_tone \"tan\"","        *set charisma %+5","        You speak Korean with a slight accent.","        You left your whole life behind to come here.","        *goto appearance_select","","    # I am Mixed Race / Non-Korean.","        I look different.","        *set origin \"Mixed\"","        *set skin_tone \"dark\"","        *set scandal_risk %+ (10 * scandal_mult)","        *set charisma %+10","        *set rebellion +5","        You stand out immediately.","        The conservative public might not accept you easily, but your look is unforgettable.","        *goto appearance_select","","*label appearance_select","And how have you styled yourself for this life-changing day?","*choice","    # Natural, silky black hair. Kept neat.","        *set hair_color \"black\"","        *set hair_style \"natural\"","        *set rebellion -5","        *set rel_manager %+5","        Safe.","        Professional. Obedient.","        *goto eyes_select","        ","    # I bleached it platinum blonde myself in the sink.","        *set hair_color \"blonde\"","        *set hair_style \"dyed\"","        *set rebellion +10","        *set scandal_risk %+ (5 * scandal_mult)","        *set rel_manager %-7","        It looks a bit damaged, but it screams \"Look at me.\"","        *goto eyes_select","","    # I dyed it unnatural color. A scream for attention.","        *set hair_color \"colored\"","        *set hair_style \"punk\"","        *set rebellion +20","        *set scandal_risk %+ (10 * scandal_mult)","        *set rel_manager %-15","        It's messy.","        It's punk. It's dangerous.","        *goto eyes_select","","*label eyes_select","And your eyes?","","*choice","    # Dark brown, warm and full of dreams.","        *set eye_color \"dark brown\"","        *goto waiting_room","    # Onyx black, sharp and unreadable.","        *set eye_color \"black\"","        *set the_mask %+5","        *goto waiting_room","    # Light amber, almost like honey.","        *set eye_color \"amber\"","        *set visual %+5","        *goto waiting_room","    # Heterochromia (One brown, one blue/green).","        *set eye_color \"heterochromia\"","        *set heterochromia true","        *set visual %+10","        *set scandal_risk %+ (5 * scandal_mult)","        *set charisma %+5","        *goto waiting_room","","*label waiting_room","The Holding Area","","You sit on the floor.","It is packed. The air smells of cheap hairspray and fear.","Across the room, you see Number 001 (Coco).","*if (gender = \"female\")","    She looks perfect. Her hair is sleek, her skin glowing.","    She knows she is the main character.","*if (gender = \"male\")","    He looks perfect.","    His posture is relaxed, his jawline sharp. He knows he is the main character.","*if (gender = \"nb\")","    They look perfect. Their style is distinct, breaking every rule.","    They know they are the main character.","*if (per_bold >= 55)","    You scan the room.","    Most of these kids look like they are about to throw up. You straighten your back. You aren't like them.","    You belong here.","*if (per_gentle >= 55)","    You see a girl crying in the corner while her mother yells at her.","    You wish you could go over and comfort her, but you are frozen in your spot.","    How do you spend the agonizing wait?","","*choice","    # I study Coco.","        I need to know my competition.","        *set self_belief %-5","        *set visual %+5","        *set per_bold +5","        You realize: That is the standard I have to beat.","        :/","        *goto audition_start","","    # I put in my headphones and analyze the vocal technique of the song.","        *set vocals %+5","        *set stress %-5","        *set self_belief %+5","        *set per_gentle +5","        You close your eyes.","        You strip away the beat and listen only to the breathing and the pitch.","        You care about the music, not the drama.","        *goto audition_start","","    # I eavesdrop on the other kids to gather intel.","        *set the_mask %+5","        *set per_bold -5","        Knowledge is power.","        *goto audition_start","","*label audition_start","Finally, they call your number.","You walk in. Director Park is waiting.","*label name_input","\"Surname first,\" he mutters, his fingers hovering over the keyboard. \"Then your given name.\"","*input_text surname","*input_text name","","\"So,\" he looks up, reading the screen. \"${surname} ${name}?\"","*set full_name (\"\"&surname) & (\" \"&name)","*choice","    # \"Yes, that's me.\"","        *goto name_confirmed","    # \"No, let me correct that.\"","        *goto name_input","","*label name_confirmed","*set stats_unlocked true","Director Park hits 'Enter'.","He finally looks at you, scanning your appearance.","","*if (heterochromia)","    He pauses. \"The eyes... distinct. But risky.\"","*if (hair_style = \"punk\")","    He frowns. \"You'll dye that hair back to black if you pass.\"","*if (origin = \"Mixed\")","    \"Unique look. It will either be your weapon or your downfall.\"","\"Show me your kki (Talent),\" Park says.","","*choice","    # I sing with deep emotion (Han).","        *if (vocals >= 22)","            \"Your support is decent,\" he nods.","            *set rel_manager %+5","            *set self_belief %+5","            *goto rooftop_scene","        *else","            \"You're flat. Stop.\"","            *set self_belief %-10","            *goto rooftop_scene","","    # I dance with military precision.","        *if (dance >= 22)","            \"Clean lines. Good stamina.\"","            *set rel_manager %+5","            *set self_belief %+5","            *goto rooftop_scene","        *else","            \"You're rushing the beat. Next.\"","            *set self_belief %-10","            *goto rooftop_scene","        ","    # I stare him down and perform with pure Charisma.","        *if (charisma >= 22) or (visual >= 22)","            A slow smirk spreads across his face.","            \"You have guts.\"","            *set rel_manager %+10","            *set self_belief %+10","            *goto rooftop_scene","        *else","            \"Is that it? You're just standing there? Next.\"","            *set self_belief %-10","            *goto rooftop_scene","","*label rooftop_scene","You exit to the rooftop to get some much needed air.","A light skinned teen with wolf cut black hair is there you realize he's a famous actor.","\"You're not supposed to be up here,\" he says while holding his vape pen.","*if (per_bold >= 55)","    You don't shrink away. You stand tall and meet his gaze.","*if (per_gentle >= 55)","    His voice breaks your heart a little.","    Under the arrogance, he sounds so incredibly depleted.","","*choice","    # \"I know. But I couldn't breathe downstairs.\"","        *set rel_minjae %+5","        *set per_gentle +5","        \"Yeah. The air in this building is poisoned.\"","        *goto minjae_warning","","    # \"You're Han Min-jae ${honorific_older_male}!\"","        *set rel_minjae %-5","        He flinches.","        \"Don't call me ${honorific_older_male}. That guy on TV is just a product.\"","        *goto minjae_warning","","*label minjae_warning","He takes a hit from the vape. \"You passed, didn't you? I can see the hope in your face. It is disgusting.\"","He steps closer. \"This place will take everything. Your name. Your face. Even the friends you will meet here. The system is designed to make you eat each other.\"","\"Run away,\" he warns. \"Before you turn into me.\"","","*if (per_gentle >= 55)","    You feel a pang of sadness for him.","    He looks so lonely.","    \"Are you okay, Sunbae?\" you ask softly.","    Even though you only get a tired look in return, you still want to hug him.","    *goto minjae_choice_label","*else ","    You scoff internally. Another rich kid complaining about being famous.","    You keep your face blank, but your eyes are cold.","    *goto minjae_choice_label","","*label minjae_choice_label","*if (per_bold >= 55)","    You stand there with your feet planted and arms crossed, a defiant look in your eyes.","    Sunbae almost seems impressed.","","*if (per_gentle >= 55)","    You stand there, one of your arms hugging the other as a form of comfort and protection, but you don't run.","    You stay. Minjae almost looks like he regrets the harsh truths he just threw at you.","    \"Why don't you, run I mean?\"","","*choice","    # \"Music is the only thing that makes me feel alive.\"","        *set motivation \"Passion\"","        *set rel_minjae %+10","        \"Passion. That is the first thing they kill. But I suppose it is a good enough fuel for now.\"","        *goto commute_scene","","    # \"I'm going to be the biggest star Korea has ever seen.\"","        *set motivation \"Ambition\"","        *set rel_minjae %+15","        \"You're funny. Delusional, but entertaining. I'll give you that. Let's see if that ego survives the first month.\"","        *goto commute_scene","","    # \"I just want to survive.\"","        *set rel_minjae %+20","        *set motivation \"Survival\"","        *set self_belief %+10","        \"Survival. At least you're honest about it. That is rare here. Most kids lie to themselves until they forget who they were.\"","        *goto commute_scene","","","*label commute_scene","You leave the building and take the subway.","You look at the reflection in the window.","You just stepped out of Olympus back to Earth.","*if (origin = \"Local\")","    *goto origin_local","*if (origin = \"Global\")","    *goto origin_global","*if (origin = \"Mixed\")","    *goto origin_mixed","","*label origin_local","Grandma's House","She gives you an extra spoon of rice.","\"Eat,\" she says. \"They won't feed you properly there.\"","You eat.","It tastes like warmth and nostalgia, you think to yourself that you should remember grandma's smile for some reason.","*goto contract_scene","","*label origin_global","The Guesthouse","You check your phone. It's 3 AM back home. Everyone you love is asleep.","You are alone in a foreign country, chasing a dream.","*goto contract_scene","","*label origin_mixed","The Family Home","Your Grandfather yells at your father.","\"A clown? You let the child become a clown?\"","He points at you.","\"Korea will never accept you with that face.\"","*goto contract_scene","","*label contract_scene","","*if (origin = \"Global\")","    *goto contract_alone","*else","    *goto contract_family","","*label contract_family","The contract is on the kitchen table.","The house is quiet, but the air is heavy with your parents' expectations.","*choice","    # I sign with a shaking hand. I'm terrified.","        *set self_belief %-5","        *set rebellion -5","        *set per_gentle +5","        *set trauma_points + 1","        Mom nods.","        \"Make us proud.\"","        *goto end_chapter","","    *selectable_if (rel_father <= 40) #I sign aggressively to prove Dad wrong.","        *set rebellion +10","        *set rel_father %-5","        You press the pen down hard, the nib almost tearing the expensive paper.","        Your father looks away, unable to meet your eyes.","        *goto end_chapter","    # I sign calmly.","        I am a professional.","        *set the_mask %+10","        *set rebellion -10","        The Trainee is born.","        *goto end_chapter","","*label contract_alone","The contract lies on the cheap linoleum floor of your guesthouse room.","It is just you.","No parents to read the fine print. No family to cheer for you or warn you.","You are thousands of miles from home, holding a pen that will decide your next seven years.","*choice","    # I sign with a shaking hand. I wish I could call my mom.","        *set self_belief %-5","        *set rebellion -5","        *set per_gentle +5","        *set trauma_points + 1","        The silence in the room is deafening, but you sign anyway.","        You are on your own now.","        *goto end_chapter","","    # I sign aggressively.","        I crossed an ocean to get here.","        I crossed an ocean for this. I won't turn back.","        *set rebellion +10","        *set per_bold +10","        You didn't leave everything behind to be scared.","        You sign your name in bold ink.","        *goto end_chapter","","    # I sign calmly.","        I am my own guardian now.","        *set the_mask %+10","        *set rebellion -10","        You are an adult now.","        You pack the contract away. The Trainee is born.","        *goto end_chapter","","*label end_chapter","*goto_scene chapter2_trainee"]},"chapter2_trainee":{"crc":307494588,"labels":{"chapter2_trainee":0,"medical_check":4,"medical_next":36,"coco_logic":114,"meet_jun":136,"month_3_start":204,"eval_room_entry":408,"post_personality_check":433,"eval_1":436,"eval_1_result":496,"month_6_rain":552,"meet_the_others":660,"group_description_done":720,"jiwon_yuri_advice":760,"ruthless_reaction":805,"meet_the_others_casual":811,"month_12_start":891,"cafeteria_scene":899,"month_12_choices":952,"rooftop_haneul":970,"convenience_store_coco":1030,"meeting_eden":1074,"mirror_practice":1095,"month_12_grind":1130,"reflection_complete":1169,"night_before_year1":1204,"eval_year1":1362,"eval_year1_result":1399,"month_18_birthday":1405,"month_24_start":1441,"jun_secret_scene":1458,"coco_secret_scene":1475,"viral_logic_check":1491,"crisis_moment":1497,"viral_moment":1537,"final_prep_choice":1623,"stress_check_finale":1678,"check_stress_vitals":1702,"eval_2":1722,"eval_2_result":1820,"post_eval_check":1827,"check_stress_post_eval":1850,"the_announcement":1873,"outcome_accepted":1954,"outcome_not_allrounder":1958,"outcome_manager_cut":1967,"outcome_rejected":1976,"rescue_check":1990,"end_chapter_2_medical_rescue":1998,"end_chapter_2_villain":2049,"end_chapter_2_rebel":2072,"end_chapter_2_safe":2130,"end_chapter_2_final":2135,"gates_open":2172},"lines":["*label chapter2_trainee","*set chapter 2","*image header_chapter2.png center","","*label medical_check","The medical room is cold and smells of antiseptic.","The agency nurse is moving efficiently, checking a long line of trainees.","\"Stand straight,\" the nurse commands, adjusting the digital sensor. \"Weight on both feet.\"","","You look at the digital readout.","You are...","*choice","    #Really short. I'm tiny compared to the other trainees.","        *set p_height \"Really Short\"","        *set visual %+3","        *goto medical_next","    #On the shorter side.","        A bit smaller than average.","        *set p_height \"Short\"","        *set visual %+1","        *goto medical_next","    #Exactly average.","        I fit the standard idol profile.","        *set p_height \"Average\"","        *goto medical_next","    #Tall.","        I stand out in a crowd.","        *set p_height \"Tall\"","        *set charisma %+1","        *goto medical_next","    #Really tall.","        I tower over almost everyone in the company.","        *set p_height \"Really Tall\"","        *set charisma %+3","        *goto medical_next","","*label medical_next","She scribbles numbers onto your file with robotic precision.","To Titan Entertainment, your body is just data. A set of measurements to be optimized.","","*if (gender = \"male\")","    *set biology \"male\"","    *set dorm_ward \"boys\"","    *set lower_anatomy \"penis\"","    *set has_chest false","    *set j_he \"he\"","    *set j_him \"him\"","    *set j_his \"his\"","    *set j_boy \"boy\"","    ","    The nurse stamps your file: MALE / 4TH FLOOR.","    Here is your keycard, she says, handing you a plastic ID.","    You are rooming with a trainee named Jun.","    *goto coco_logic","","*if (gender = \"female\")","    *set biology \"female\"","    *set dorm_ward \"girls\"","    *set lower_anatomy \"vagina\"","    *set has_chest true","    *set j_he \"she\"","    *set j_him \"her\"","    *set j_his \"her\"","    *set j_boy \"girl\"","","    The nurse stamps your file: FEMALE / 5TH FLOOR.","    Here is your keycard, she says, handing you a plastic ID.","    You are rooming with a trainee named Jun.","    *goto coco_logic","","*comment --- Fallback for Non-Binary or Unassigned ---","The nurse pauses at the housing section of your file.","Her finger hovers over the keyboard.","","System error, she mutters. The dorm software is old.","It only accepts binary input for the keycard access levels.","She looks at you, not unkindly, but with the exhaustion of an overworked employee.","I can't print the ID without selecting a ward, she says.","We have the 4th Floor (Boys) or the 5th Floor (Girls).","I just need to know which keycard to code so the elevator works for you.","","*fake_choice","    # Code the keycard for the 4th Floor. (Boys Wing)","        *set biology \"male\"","        *set dorm_ward \"boys\"","        *set lower_anatomy \"penis\"","        *set has_chest false","        *set j_he \"he\"","        *set j_him \"him\"","        *set j_his \"his\"","        *set j_boy \"boy\"","","        She types a command and the machine whirrs.","        Done, she says. 4th Floor.","        You're rooming with a trainee named Jun.","","    # Code the keycard for the 5th Floor. (Girls Wing)","        *set biology \"female\"","        *set dorm_ward \"girls\"","        *set lower_anatomy \"vagina\"","        *set has_chest true","        *set j_he \"she\"","        *set j_him \"her\"","        *set j_his \"her\"","        *set j_boy \"girl\"","","        She types a command and the machine whirrs.","        Done, she says. 5th Floor.","        You're rooming with a trainee named Jun.","","You take the plastic ID card. It feels heavy in your hand.","It's just a room number, you tell yourself. It doesn't define who you are. It's just a place to sleep.","*goto coco_logic","","*label coco_logic","*if (gender = \"male\")","    *set rival_name \"Coco\"","    *set r_he \"he\"","    *set r_him \"him\"","    *set r_his \"his\"","","*if (gender = \"female\")","    *set rival_name \"Coco\"","    *set r_he \"she\"","    *set r_him \"her\"","    *set r_his \"her\"","","*if (gender = \"nb\")","    *set rival_name \"Coco\"","    *set r_he \"they\"","    *set r_him \"them\"","    *set r_his \"their\"","","You head toward the elevator to meet your new roommate.","*goto meet_jun","","*label meet_jun","The elevator opens on the ${dorm_ward} floor. The hallway is pristine polished white floors and endless doors marked with numbers.","It smells of industrial cleaner and expensive perfume.","","You find Room 404. You tap your ID card against the reader, and the heavy door clicks open.","The room is small but efficient. It looks like an IKEA showroom designed by a drill sergeant.","There are two sturdy, modern bunk beds with white sheets tucked in with military precision.","A small desk is pushed against the wall, but there are no posters, no clutter, no personality.","","But as you step inside, the sterile illusion is broken.","The room smells powerfully of spicy beef broth and MSG.","A ${j_boy} is sitting on the floor behind the bottom bunk, hunched over something like a goblin.","${j_he} freezes when you enter, cheeks bulging like a chipmunk, a pair of wooden chopsticks hanging from ${j_his} mouth.","","Mmph!","${j_he} squeaks, frantically trying to swallow the noodles. ${j_he} scrambles to hide a steaming cup of instant ramen behind ${j_his} back.","I... I thought you were the manager! ${j_he} gasps, wiping broth from ${j_his} chin. Please don't report me.","I was starving.","","Jun looks soft, too soft for this rigid place.","${j_he} is wearing an oversized hoodie and looks at you with wide, terrified eyes.","","*fake_choice","    # \"I understand the need for junk, but doing this on Day 1? It's basically a death wish.\"","        *set charisma %+5","        *set rel_jun %+10","        Jun laughs nervously, nearly choking on a noodle.","        I know! I'm living on the edge. I'm Jun, by the way.","","    # I sniff the air loudly. \"Spicy flavor? Bold choice.\"","        *set the_mask %+5","        *set rel_jun %+5","        Jun blinks, then giggles nervously.","        It's the only flavor that matters.","","    # \"You're lucky I'm not a snitch. That smell is going to get us killed.\"","        *set per_bold +5","        *set rel_jun %+5","        Jun winces.","        I know. I have the window open! I'm trying to fan it out!","        Jun looks at the cup in ${j_his} hand, then back at you.","        Um, Jun whispers, Do... do you want some?","        I have a second pair of chopsticks. It's still hot.","        *fake_choice","            # \"No thanks. You look like you need it more.\"","                *set per_gentle +5","                *set rel_jun %+10","                Are you sure?","                Jun asks. ${j_he} takes another slurping bite, looking guilty but happy.","","            # \"Hell yes.\" I sit on the floor. Forbidden noodles taste the best.","                *set rel_jun %+15","                *set physical %-5","                You sit cross-legged on the pristine tile.","                You take turns slurping the spicy, salty noodles. Compared to the cafeteria salad, it tastes like heaven.","                Jun smiles, watching you eat. It's a flash of human warmth in the cold room.","","            # \"I don't eat sodium bombs. It bloats your face for weigh-ins.\"","                *set ruthless +5","                *set rel_jun %-5","                Jun flinches and quickly puts the lid back on the cup.","                Right. Sorry. I should... I should throw this out.","","I'm glad you're my roommate, Jun says quietly, wiping the cup clean.","This place feels so lonely. And hungry.","*goto month_3_start","","","*label month_3_start","*set stress +10","[i](System: Another month passes. The competition grows thinner. Stress +10)[/i]","","Age 15. Month 3. The First Evaluation.","It is the morning of the Culling.","","You wake up in the Trainee Dorms. It isn't a bedroom; it is a storage unit for human capital.","The room is windowless and painfully white.","Four bunk beds are stacked with mathematical precision into a space meant for two.","Every surface is cluttered, not with personal items, but with company-mandated efficiency: assigned diet supplements, schedule tablets, and identical grey practice uniforms drying on the rails.","There is no privacy here. Just the sound of twelve other teenagers breathing in their sleep and the low, electric hum of the air purifier.","","You step out into the hallway. The Titan Entertainment building is a labyrinth of concrete and glass.","The corridors are endless, white, and sterile, lit by harsh fluorescent lights that buzz softly.","It doesn't feel like a school. It feels like a high-tech factory.","Through the glass walls of the practice rooms, you see silhouettes of other trainees already working.","They are just blurs of movement, repeating the same dance steps over and over in front of floor-to-ceiling mirrors.","","You look over at Jun. ${j_he} is sitting on the edge of ${j_his} bed, staring at the floor.","${j_he} looks pale under the artificial lights, looking smaller than usual in the clinical room.","\"I don't know if I can do this,\" ${j_he} whispers, ${j_his} hands trembling.","","\"Hey,\" you say, walking over to ${j_him}.","The floor is freezing cold under your bare feet.","You put a hand on ${j_his} shoulder.","","*fake_choice","    # \"Don't worry, Junie. I've got you.\"","        *set jun_nickname \"Junie\"","        *set rel_jun %+5","        *set per_gentle +5","        Jun takes a deep breath, giving you a small smile.","        \"Thanks. You always treat me like a kid, but I like it.\"","","    # \"Look at me, Jun-ah. You're ready.\"","        *set jun_nickname \"Jun-ah\"","        *set rel_jun %+5","        *set charisma %+5","        Jun nods, the familiar honorific grounding ${j_him}.","        \"Right. Jun-ah is ready. We can do this.\"","","    # \"Aww, is Uri Jun (Our Jun) scared?\"","        *set jun_nickname \"Uri Jun\"","        *set per_bold +5","        Jun blushes and shoves your arm playfully.","        \"Stop calling me that! I'm not a baby.\" But ${j_he} stops shaking.","","    # \"Stop crying, Crybaby. Tears ruin the makeup.\"","        *set jun_nickname \"Crybaby\"","        *set per_bold +5","        *set ruthless +5","        Jun laughs nervously, wiping ${j_his} eyes.","        \"You're brutal. But you're right.\"","","In the main hall, the atmosphere is suffocating.","Dozens of trainees are stretching on the cold wooden floor, checking their reflections in the mirrors one last time.","You have one hour before you are called. How do you spend it?","","*choice","    # I practice \"smizing\" in the mirror. First impressions are everything.","        *set visual %+7","        *set stress %+5","        *set physical %-5","        You stare at yourself until your eyes water.","        You force a smile until your cheeks cramp.","        You look like a doll. Perfect.","        *gosub_scene mechanics check_stress_threshold","        *goto eval_room_entry","","    # I lock myself in a closet and work on my dance routine.","        *set dance %+11","        *set physical %-10","        *set stress %+15","        You run the choreography at 2x speed in the stifling heat of the closet.","        Your muscles burn, panic rising in your chest with every mistake.","        *gosub_scene mechanics check_stress_threshold","        *goto eval_room_entry","","    # I do vocal riffs in the stairwell.","        *set vocals %+7","        *set stress %+15","        *set physical %-5","        You push your range higher and higher, terrified of cracking.","        You need to hit that high note today.","        *gosub_scene mechanics check_stress_threshold","        *goto eval_room_entry","","    # I hang out with Jun and Hana. We need to calm each other down.","        *set rel_jun %+5","        *set per_gentle +5","        *set stress %-10","        *set physical %+5","        You find Hana sitting on the floor, shaking.","        \"I can't do it,\" Hana whispers.","        \"You're going to be fine\" you and Jun say together.","        *goto eval_room_entry","","    # I go to the rooftop to escape the noise.","        *set stress %-10","        *set rel_minjae %+5","        ","        The door to the roof is heavy. You push it open, expecting silence.","        Instead, you hear shouting.","        ","        \"I will protect you! Even if the whole world turns against us!\"","        ","        It is Han Min-jae.","        He is standing near the railing, reading from a script.","        He says the line with perfect diction, perfect projection... and zero soul.","        ","        He groans, throwing his head back.","        \"Garbage. Absolute garbage. I've said this line in three different dramas this year.\"","        He kicks the ventilation shaft.","        \"Why do they always cast me as the 'Prince'? I want to play a villain. A psycho. A horse with alcoholism.\"","","        He turns around and sees you.","        For a second, the 'National Heartthrob' mask slips. He looks annoyed to be caught venting.","        \"You again?\" he snaps, quickly rolling up the script. \"Don't you have a mirror to stare at?\"","","        *fake_choice","            # \"I prefer watching you have an artistic crisis. It's more entertaining.\"","                *set charisma %+5","                *set rel_minjae %+5","                Minjae snorts, a small smirk breaking through his annoyance.","                \"Glad I can entertain the rookies. Tickets are usually expensive.\"","                He taps the script against his leg.","                \"My agent says this role is a 'guaranteed hit'. Another romance. Another fake smile.\"","                He looks at you, eyes narrowing thoughtfully.","                \"You... you're raw. You haven't learned to fake it yet. Read the female lead lines. I need to feel something other than boredom.\"","","            # \"You sounded professional, Sunbae. But maybe too... perfect?\"","                *set per_gentle +5","                *set rel_minjae %+5","                Minjae pauses, surprised by your honesty.","                \"Too perfect,\" he repeats, bitter but intrigued. \"That's exactly the problem. I'm a machine.\"","                He runs a hand through his hair, looking tired.","                \"I need to break the image. I need to be messy.\"","                He holds out the script. \"Help me. Don't act like an idol. Act like a person who actually has feelings. Can you do that?\"","","            # \"Sorry to interrupt, Sunbae-nim. I'll leave.\"","                *set the_mask %+5","                \"Stop,\" Minjae commands, his voice dropping into his 'actor tone'.","                \"Leaving is boring. Stay.\"","                He sighs. \"Since you're already here, make yourself useful. Read the other part. I need a warm body to rehearse with.\"","","        You take the script. It's a scene about a forbidden confession. Standard K-Drama stuff.","        You read the line: [i]\"But Oppa, you belong to the stars, and I'm just...\"[/i](lol xp)","        ","        Minjae steps closer. The shift is terrifyingly instant.","        One second he is the jaded Minjae, the next he is the desperate lover.","        He reaches out, capturing a lock of your hair.","        ","        His eyes, those famous striking green eyes that are on billboards all over Seoul, lock onto yours.","        ","        \"Screw the stars,\" he whispers. The intensity in his voice makes your heart hammer.","        \"I'm tired of shining for everyone else. I just want...\"","        ","        He leans in. He isn't acting anymore. Or is he?","        With Minjae, the line is always blurred.","        He stares at your lips, and for a silent moment, the rooftop feels like a movie set.","        ","        *fake_choice","            # I don't pull away. Instead, I lean in slightly, daring him to finish the scene.","                *set romance_minjae true","                *set charisma %+5","                *set rel_minjae %+5","                Minjae freezes. He realizes you aren't pulling back.","                He inhales sharply, his gaze dropping to your lips one last time, lingering there dangerously.","                For a second, you think he might actually close the distance.","                ","            # I step back sharply. \"Acting. Remember?\"","                *set the_mask %+10","                *set rel_minjae %+3","                You break the spell.","                Minjae blinks, snapping out of his trance immediately.","                \"Right. Acting,\" he mutters, though he looks a bit flushed.","                \"Good focus. Most rookies would have melted.\"","","            # I laugh nervously. \"Wow. You really are a pro, Sunbae.\"","                *set per_bold %+5","                *set rel_minjae %+2","                Minjae pulls back, rolling his eyes but looking pleased to have his ego stroked.","                \"Obviously. Did you think I was serious? Please.\"","","        He clears his throat, turning back to the city lights to hide his face.","        \"Okay. Cut. That... that was better.\"","        ","        He walks past you toward the door.","        ","        *if (romance_minjae)","            He pauses at the door, his hand resting on the handle.","            He touches his own lips absentmindedly, then looks back at you with a dark, unreadable expression.","            \"You're dangerous, Rookie,\" he murmurs, half to himself.","            \"Be careful with eyes like that. You might burn someone.\"","","        *if (romance_minjae = false)","            He pauses at the door, regaining his composure.","            \"You're not useless, Rookie. Keep practicing.\"","            \"See you around, ${name}.\"","","        *set rel_minjae %+5","        *goto eval_room_entry","","*label eval_room_entry","","The manager calls your group.","You walk into the waiting area outside the evaluation room.","","The door opens and ${rival_name} walks out.","You recognize ${r_him} instantly. It is the trainee you met at the auditions, the one with the expensive clothes and the perfect posture.","Back then, ${r_he} was just another hopeful. Now, three months later, ${r_he} is the Ace.","${r_He} wipes sweat from ${r_his} forehead and smirks when ${r_he} sees you.","","\"Still here?\"","${r_he} asks, popping a piece of gum. \"I thought you would have quit by now.\"","${r_He} walks past you without waiting for an answer, confident that ${r_he} has already secured the top spot.","","*if (per_gentle >= 50)","    Your heart does a pitter-patter in your chest, beating against your ribs like a trapped bird.","    You wipe your sweaty palms on your pants. \"Just breathe,\" you tell yourself. \"Just breathe.\"","    *goto post_personality_check","","*if (per_bold >= 50)","    You stare at the closed door. You are ready for Judgment Day.","    You feel like a mannequin in a shop window, and the executives inside are just calculators, figuring out how much profit they can squeeze out of your youth per quarter.","    It is what it is, right?","    *goto post_personality_check","","*label post_personality_check","\"Next!\" the director barks.","","*label eval_1","*page_break The Performance.","You step onto the \"X\" tape mark.","Five judges. One camera.","The music starts. It's your moment.","How do you perform?","","*choice","    # I focus purely on my visuals. I catch the light and charm the camera.","        *if (visual >= 20) or (charisma >= 30)","            You don't just dance; you pose. Every movement is a photoshoot. The judges stop writing and just watch you. You are magnetic.","            *set visual %+10","            *goto eval_1_result","        *else","            You try to look charming, but you just look stiff.","            \"Stop posing and dance,\" a judge mutters.","            *set self_belief %-5","            *goto eval_1_result","","    # I pour my heart out into the singing.","        *if (vocals >= 25)","            *set visual %-5","            *set vocals %+10","            You close your eyes.","            You scrunch up your face. You look ugly, but the sound coming out of you is raw and powerful.","            The head vocal trainer nods. Finally. Some emotion.","            *goto eval_1_result","        *else","            Your voice cracks on the high note.","            It's painful to hear.","            *set self_belief %-10","            *goto eval_1_result","    ","    # I don't give a f***. I put in half the effort to look effortless.","        *if (dance >= 34) or (vocals >= 35)","            You dance like you're bored, but you hit every beat perfectly.","            It's the Genius vibe.","            The judges look confused, but impressed. \"So much talent,\" they whisper.","            *set charisma %+15","            *goto eval_1_result ","        *else","            You mark the moves lazily.","            The music stops.","            \"Get out,\" the Director says. \"If you don't want to be here, leave.\"","            *set scandal_risk %+ (10 * scandal_mult)","            *set stress %+10","            *goto eval_1_result","","    # I sabotage the trainee next to me.","        *set ruthless +10","        *set rel_jun %-10","        *set rel_manager %+7","        During the group formation, you step slightly in front of your partner, blocking their light.","        You sing louder over their lines.","        They stumble, flustered. You shine.","        The judges see it. They know what you did.","        And they like the hunger.","        Jun looks at you with shock. Why did you do that?","        *goto eval_1_result","","*label eval_1_result","The music fades. You bow, panting. ","\"Thank you. Next.\"","","The next morning, Hana's locker is empty. She is gone. ","But there is no time to mourn.","\"Line up!\" the Manager barks. \"Weekly Body Check.\"","","It is the Weigh-In. The most dreaded day of the week. ","You stand in a line in your underwear while the staff measures you with cold tape. ","The Manager reads the digital scale out loud for everyone to hear.","","\"${surname} ${name}...\" he looks at the number. ","\"You gained 0.4kg since last week.\"","The room is silent. The other trainees look away, terrified it will happen to them next.","\"Do you want to be a pig or an idol?\" he asks casually, writing something red in your file.","","How do you react to the humiliation?","","*fake_choice","    # I decide to starve myself. I will do whatever it takes to be an idol.[b]TRAIT GAINED: EATING DISORDER[/b]","        *set trauma_points + 2","        *set physical -15","        *set ruthless +10","        *set eating_disorder_flag true","","        The word \"pig\" feels like a hot, itchy weight on your chest. ","","        At first, its just the rumbles. Your stomach is shouting at you, a big, angry, hollow sound that makes your legs feel like jelly during dance practice. You think about bread, about the way it smells, about how much you just want to be a normal kid who eats without thinking. ","","        But then you look at the posters on the practice room wall. You see Jungkooks abs, the way every muscle looks like it was carved from stone. You see Lalisas waist, so small and perfect it doesn't even look real. They don't have \"0.4kg extra.\" They are icons. And if you want to stand on the same stage as them, you have to be perfect too.","","        You decide to turn the rumbles into a secret mission. A game. You start to count, not the steps of the dance, but the numbers. A single grape is 2. A bite of chicken is a mistake you have to fix with an extra hour of cardio. If you can just control the numbers, you can carve yourself into a masterpiece. You aren't \"hungry\" anymore. You're just winning. You're becoming a product that doesn't break ","","        [b]TRAIT GAINED: EATING DISORDER[/b]","        [i](System: You have developed an unhealthy relationship with food. This will restrict certain choices and drain your Physical stats significantly.)[/i]","","        \"Understood, sir,\" you say, your voice small but steady. \"It won't happen again. I'll be better.\"","","    # I dissociate. I stare at the wall and pretend I'm not here.","        *set trauma_points + 1","        *set the_mask %+15","        It's just numbers. It's just flesh. You float above your body, watching the scene like a movie.","        You don't feel the shame. You don't feel anything.","        ","","    # I clench my fists. This system is sick, not me.","        *set rebellion %+10","        *set self_belief +5","        You know that 0.4kg is just water weight.","        His words burn, but you refuse to let them destroy you.","        You eat dinner that night out of spite.","       ","","*goto month_6_rain","","*label month_6_rain","*page_break Time Jump: Month 6","","Age 15. Month 6.","","*set stress +10","[i](System: the cold is starting to affect you . Stress +10)[/i]","","The rainy season has hit Seoul.","The sky is a bruise of dark grey clouds. The rain falls in thick, heavy sheets, turning the grey concrete of the city into a blurred watercolor painting.","You are standing at the glass doors of the Titan building, stuck. You didn't bring an umbrella.","You are shivering in your thin practice clothes, hugging your arms as you stare at the downpour.","","Suddenly, a sleek, black luxury sedan pulls up to the curb.","A chauffeur in a suit steps out and opens the back door. A trainee steps out. It is Haneul.","Everyone knows Haneul. They call Haneul the Royal.","Haneul has never raised a voice. Haneul always bows 90 degrees.","","You look at Haneul.","Haneul is...","","*fake_choice","    # A handsome young man.","        *set haneul_gender \"male\"","        *set h_he \"he\"","        *set h_him \"him\"","        *set h_his \"his\"","    # A beautiful young woman.","        *set haneul_gender \"female\"","        *set h_he \"she\"","        *set h_him \"her\"","        *set h_his \"her\"","    # A striking person with an androgynous look.","        *set haneul_gender \"nb\"","        *set h_he \"they\"","        *set h_him \"them\"","        *set h_his \"their\"","","Haneul is wearing full stage makeup and an outfit that costs more than your parents' house.","Haneul spots you shivering by the door. Instead of rushing inside, ${h_he} stops, waving the driver away.","\"You're soaked,\" a soft voice says.","","You stare at the clothes.","\"Where were you? Trainees aren't allowed to leave the building.\"","\"Internal profile shoot,\" Haneul whispers, looking a bit guilty about the special treatment.","\"The executives wanted to test my visuals for the investor portfolio. It's... it's nothing, really. Just standing around.\"","","*if (ruthless >= 15)","    You feel a hot, ugly knot of jealousy tighten in your chest.","    While you were sweating in the basement practicing basic steps, Haneul was getting pampered in a black car.","    It's not fair. Why is Haneul the chosen one?","","*fake_choice","    # Look up, surprised. \"I'm fine. Just waiting for the rain to stop.\"","        *set per_bold +5","        Haneul smiles gently.","        \"It's not going to stop for hours. You'll catch a cold.\"","    # Shiver visibly. \"I forgot my umbrella. Today is just not my day.\"","        *set per_gentle +5","        Haneul's expression softens with sympathy.","        \"Oh no. We can't have our best vocalist getting sick, can we?\"","    # Glare at the car. \"Must be nice to be the favorite.\"","        *set rebellion %+5","        *set rel_haneul %-5","        Haneul flinches, the smile faltering.","        \"I didn't ask for it,\" ${h_he} says quietly.","","Haneul opens a large, clear umbrella. \"Here,\" ${h_he} says. \"We can share.\"","Haneul holds it over your head, tilting it so you are fully covered, leaving the expensive jacket slightly exposed to the freezing rain.","\"Shall we?\" Haneul asks, offering a warm, perfect smile.","","*fake_choice","    # I blush and step close. It feels like a scene from a drama.","        *set rel_haneul %+10","        *set romance_haneul true","        *set stress %-5","        The world goes quiet under the plastic canopy.","        It's intimate.","        You're really kind, Haneul, you whisper.","        And you're really talented, Haneul replies effortlessly.","        I watch you in dance class sometimes. You have something I don't.","        I hope we both debut, Haneul says softly, closing the umbrella as you reach the lobby.","        Water drips from ${h_his} wet shoulder, but there is no complaint.","        I think... I think I'd like standing on stage next to you.","        ${h_He} bows politely and heads to the elevator, leaving you standing there, a little less cold than before.","","    # \"I can walk myself.\" But I accept the shelter anyway.","        *set the_mask %+5","        Haneul chuckles softly.","        I know you can.","        But it's nicer to walk together, isn't it?","        I hope we both debut, Haneul says softly, closing the umbrella as you reach the lobby.","        Water drips from ${h_his} wet shoulder, but there is no complaint.","        I think... I think I'd like standing on stage next to you.","        ${h_He} bows politely and heads to the elevator, leaving you standing there, a little less cold than before.","","    # \"Thanks. I owe you one.\"","        *set rel_haneul %+5","        No debts between teammates, Haneul says simply.","        You walk the short distance to the dorms together, shoulder to shoulder.","        For a moment, the brutal competition of Titan Entertainment fades away. Haneul has a calming aura, like a human sedative.","        I hope we both debut, Haneul says softly, closing the umbrella as you reach the lobby.","        Water drips from ${h_his} wet shoulder, but there is no complaint.","        I think... I think I'd like standing on stage next to you.","        ${h_He} bows politely and heads to the elevator, leaving you standing there, a little less cold than before.","","*goto meet_the_others","","*label meet_the_others","*page_break teamwork makes dreamwork","","Age 15. Month 9.","","Titan decides to test your \"Chemistry.\"","You are assigned to a temporary team for a showcase evaluation.","","*if (gender = \"male\")","    *set kang_he \"he\"","    *set kang_him \"him\"","    *set kang_his \"his\"","    *set rio_he \"he\"","    *set rio_him \"him\"","    *set rio_his \"his\"","    *set jiwon_he \"he\"","    *set jiwon_him \"him\"","    *set jiwon_his \"his\"","    *set yuri_he \"he\"","    *set yuri_him \"him\"","    *set yuri_his \"his\"","","*if (gender = \"female\")","    *set kang_he \"she\"","    *set kang_him \"her\"","    *set kang_his \"her\"","    *set rio_he \"she\"","    *set rio_him \"her\"","    *set rio_his \"her\"","    *set jiwon_he \"she\"","    *set jiwon_him \"her\"","    *set jiwon_his \"her\"","    *set yuri_he \"she\"","    *set yuri_him \"her\"","    *set yuri_his \"her\"","","*if (gender = \"nb\")","    *set kang_he \"he\"","    *set kang_him \"him\"","    *set kang_his \"his\"","    *set rio_he \"he\"","    *set rio_him \"him\"","    *set rio_his \"his\"","    *set jiwon_he \"she\"","    *set jiwon_him \"her\"","    *set jiwon_his \"her\"","    *set yuri_he \"she\"","    *set yuri_him \"her\"","    *set yuri_his \"her\"","","You walk into Practice Room 3. Four other trainees are waiting.","","*if (gender = \"nb\")","    Titan is trying something experimental: A Co-ed Group.","    You see two boys and two girls waiting for you. This project will either revolutionize the industry or fail spectacularly.","    *goto group_description_done","*else","    These aren't just random faces. These are the top trainees in your wing.","    *goto group_description_done","","*label group_description_done","","There is Kang, the oldest. ${kang_he} is stretching with intense focus.","Kang is known as the \"Dancing Machine\".","There is Rio, sitting on the speaker, rapping to ${rio_him}self.","${rio_he} has a playful, chaotic energy and hair dyed a bright, unnatural red.","There are Jiwon and Yuri, whispering in the corner. They are the vocal powerhouses, but they look terrified.","Kang claps ${kang_his} hands. \"Alright, listen up. We have 48 hours to perfect this choreo. No sleeping.\"","Rio groans, throwing ${rio_his} head back. \"Easy for you to say, Cyborg. Some of us need beauty sleep.\"","How do you position yourself in this group?","","*fake_choice","    # I align myself with Kang. We need discipline to win.","        *set rel_kang %+10","        *set dance %+5","        *set ruthless +5","        Kang nods at you approvingly.","        \"Finally. Someone who takes this seriously.\"","        You and Kang lead the practice, drilling the steps until everyone hates you, but the synchronization is perfect.","","    # I joke around with Rio to lighten the mood.","        *set rel_rio %+10","        *set charisma %+5","        *set per_bold +5","        Rio grins and high-fives you.","        \"Exactly! If we're gonna suffer, let's have fun.\"","        The practice is chaotic, but the energy is electric.","        Even Kang cracks a smile eventually.","","    # I help Jiwon and Yuri with the vocals. They look nervous.","        *set rel_jiwon %+10","        *set rel_yuri %+10","        *set per_gentle +5","        *set vocals %+5","        \"Thank you,\" Jiwon whispers.","        \"Kang moves too fast for us.\"","        You spend the extra hours teaching them the harmonies.","        You become the glue holding the team together.","*goto jiwon_yuri_advice","","*label jiwon_yuri_advice","The evaluation goes well, but it was exhausting.","Later that night, while you are refilling your water bottle, Jiwon approaches you timidly. Yuri is standing right behind ${jiwon_him}.","\"Hey, ${name},\" Jiwon starts, fidgeting with the hem of ${jiwon_his} shirt.","\"You... you always look so composed. The diet, the training... how do you do it? We feel like we're drowning.\"","They are looking at you with wide, desperate eyes.","","*choice","    *selectable_if (eating_disorder_flag = false) # \"It's about balance. Eat healthy, sleep when you can. Don't starve yourselves.\"","        *set per_gentle +5","        *set rel_jiwon %+5","        *set rel_yuri %+5","        Jiwon sighs, relieved.","        \"The trainers say we need to lose weight, but... okay. We'll try to stay healthy.\"","        Yuri smiles at you. \"You're like a real leader.\"","        *goto meet_the_others_casual","","    *selectable_if (eating_disorder_flag = false) # \"Just fake it until you make it. That's what I do.\"","        *set the_mask %+5","        *set charisma %+5","        *set rel_rio %+5","        Rio, who was eavesdropping, laughs from the doorway.","        \"Best advice ever.\"","        Jiwon and Yuri look confused, but they giggle. \"Okay. Fake it. We can do that.\"","        *goto meet_the_others_casual","","    # \"You have to be hungry. Literally. If you aren't suffering, you aren't working hard enough.\"","        *set ruthless +10","        *set physical %-5","        *set rel_jiwon %-5","        *set rel_yuri %-5","        ","        *if (eating_disorder_flag)","            [i](Your Condition forces this choice)[/i]","            You stare at them. You want to tell them to be healthy.","            But the voice in your head screams louder.","            \"Do you want to debut?\" you snap, your voice harsh from hunger.","            \"Then stop complaining about food. We don't get to eat and dream at the same time.\"","            *goto ruthless_reaction","        *else","            You look at them coldly. This is a competition, not a summer camp.","            \"Do you want to debut?\" you ask simply.","            \"Then stop complaining. Hunger is just proof that you want it enough.\"","            *goto ruthless_reaction","","*label ruthless_reaction","Jiwon flinches. \"Oh. I see.\"","They exchange a worried look but nod. \"Right. Suffering is part of the job. Thanks, ${name}.\"","They walk away looking even more stressed than before.","*goto meet_the_others_casual","","*label meet_the_others_casual","3 hours later (in the spongebob voice)","","Age 15. Month 9.","","It is 11:00 PM. Lights out.","You and Jun are lying in your bunks, staring at the glow in the dark stars Jun stuck to the ceiling.","Suddenly, there is a sharp tap on your door. Not the heavy pound of a manager, but a rhythmic, secret code.","Tap tap tap tap... tap tap.","","Jun freezes. \"Did we get caught?\"","","Before you can answer, the door clicks open.","A head with bright red hair pops in. It's Rio from three doors down.","","\"We are going to the cafeteria,\" Rio whispers, a mischievous glint in ${rio_his} eyes.","\"Are you insane?\" Jun whispers back. \"The Night Manager patrols that hallway every twenty minutes.\"","","\"Exactly,\" Rio grins.","\"That is what makes it fun. Kang, Jiwon, and Yuri are already waiting by the service elevator. You in?\"","You and Jun slip into your slippers and follow Rio into the hallway.","Your eyes are struggling to see anything because it is pitch black except for the stick lights Rio somehow smuggled in.","Rio says proudly \"My cousin smuggled them in\" while cleaning invisible lint from ${rio_his} shoulder.","You reach the cafeteria.","It is a vast, empty space of stainless steel and polished stone.","The rows of tables look something out of a sci-fi movie.","Kang is sitting at the furthest corner table, checking ${kang_his} watch.","Jiwon and Yuri are huddled together, jumping at every hum of the industrial refrigerators.","\"You actually came,\" Kang says, looking both relieved and annoyed. \"Sit. Quickly.\"","Rio produces a plastic bag filled with contraband: spicy ramen cups and chocolate bars.","\"The vending machine in the staff lounge was unlocked,\" Rio brags, passing out the food.","\"A gift from the gods of Titan.\"","","As you all sit around the cold metal table, the atmosphere shifts.","For a moment, you are not trainees in a cookie cutter.","You cant wait to have a secret feast, you're starving.","","Yuri looks at the group, her voice small.","\"I was thinking... if we all debut together, we should come back here. On our first anniversary. We can buy the whole vending machine next time.\"","The idea of a future together hangs in the air, fragile and hopeful just like Yuri.","What do you do now?","","*fake_choice","    # I grab a bag of chips and bond with Rio over how crazy the managers are.","        *set rel_rio %+10","        *set charisma %+5","        *set rebellion %+5","        \"Pass the chips,\" you say.","        \"Did you see Director Park today? He looked like a statue that was about to crack.\"","        Rio laughs \"you said crack\", and for a second, the sterile cafeteria feels warm.","        You spend the night whispering jokes about the staff.","","    # I talk strategy with Kang. We need to plan for the next evaluation.","        *set rel_kang %+10","        *set ruthless +5","        *set self_belief %+5","        \"The team battle is coming,\" you whisper, leaning over the table.","        Kang nods, appreciating your focus even in the middle of a heist.","        You two bond over your shared ambition and the drive to win.","","    # I sit with Jiwon and Yuri and try to calm their nerves.","        *set rel_jiwon %+10","        *set rel_yuri %+10","        *set per_gentle +5","        \"We are going to make it,\" you say softly, looking at them.","        \"All of us. Titan picked us for a reason.\"","        Jiwon sighs, the tension in ${jiwon_his} shoulders dropping just a little.","","Suddenly, a flashlight beam sweeps across the far entrance. ","\"Manager!\" Kang hisses.","You all dive under the industrial tables, hearts hammering against the cold floor.","You hold your breath as the footsteps echo: slow, rhythmic, and terrifying. ","","The light passes. The heavy doors click shut.","Rio lets out a shaky laugh. \"Okay. Maybe room 404 is safer next time. Let's get out of here.\"","You sneak back to your dorms, feeling a little less worried about the next evaluation.","You are exhausted, but you feel like a team.","*gosub_scene mechanics check_stress_threshold","*goto month_12_start","","*label month_12_start","*page_break Time Jump: Month 12","","Age 15. Month 12.","","You have survived a year.","The fear has turned into a dull, aching exhaustion. You are stronger, but you are hollow.","","*label cafeteria_scene","12:30 PM.","The Cafeteria.","","It is lunch time, or as the trainees call it, The Starvation Station.","The room is a United Nations of tired teenagers. Everyone is picking at the same sad meal: boiled chicken breast, unsalted broccoli, and a single cherry tomato.","You look across the room.","Haneul is sitting in the center, posture perfect, eating with the grace of royalty.","Even in a sweat-stained practice tee, Haneul looks like a Prince/Princess from a K-Drama.","","And then, there is ${rival_name}.","Coco is sitting on top of the table not the bench, the table! wearing headphones around ${r_his} neck.","${r_He} looks different. Maybe its the bleach blonde streaks in ${r_his} hair, or the way ${r_he} wears ${r_his} uniform loosely, but ${r_he} screams Main Character Energy.","Like a rebellious pop-punk star dropped into a convent.","","You walk past ${rival_name}'s table to dump your tray.","Coco is scrolling through a phone hidden under ${r_his} leg.","On the screen, you catch a glimpse of a photo: A group of American teenagers at a high school Prom, holding red solo cups and laughing.","Aish... so boring, Coco mutters in broken Korean, swiping the photo away aggressively. Why is everyone here so... stiff?","Coco looks up, catching you staring. ${r_He} doesn't flinch. ${r_He} just smirks, popping a bubble of gum.","You.","What are you looking at? Never seen a foreigner before?","","*fake_choice","    # \"I heard you snapped at the dance teacher. You have a death wish?\"","        *set rebellion %+8","        *set rel_rival %+10","        Coco grins, revealing a sharp canine tooth.","        He was being a Kkondae. Yelling just to hear his own voice.","        I just told him to 'Chill out' in English. He didn't understand, but he got the vibe.","","    # \"That photo... was that Prom?\"","        *set per_gentle +5","        *set rel_rival %+5","        Coco stiffens, then sighs, looking at the black screen.","        Yeah. My friends back in LA. They're worrying about corsages and limos.","        ${r_He} laughs bitterly.","        I flew 6,000 miles to be a star, and now I'm jealous of a school dance. Pathetic, right?","","    # \"You're sitting on the table. If Park sees you, you're dead.\"","        *set scandal_risk %-5","        Coco laughs, a deep, charismatic sound. Let him see.","        In America, we sit where we want. This whole 'bow 90 degrees' thing is killing my back.","        ${r_He} hops off the table, but with style. You're strict. Like a little grandpa.","        Being a trainee is weird, Coco sighs, switching to English.","        Everyone wants to be famous, but nobody wants to be \"real\". It's all... ${r_He} waves a hand. Fake smiles. Plastic.","        ${r_He} glances at Haneul. That one. The 'Royal'. Too perfect. It creeps me out.","        Nobody is that nice without a reason.","","The whistle blows. Lunch is over.","Coco stands up, the mask of the Wild Ace sliding back into place.","I'm sneaking out tonight, ${r_he} whispers, winking at you. Don't snitch.","","*label month_12_choices","You have one night off.","You need to escape the pressure.","","*choice","    # Coco invited me to sneak out. I want some trouble.","        *goto convenience_store_coco","","    # I saw Haneul heading to the roof with a ring light. I'm curious.","        *goto rooftop_haneul","","    # I've heard rumors of a secret studio in the basement. I want to investigate.","        *goto meeting_eden","","    # I stay in the practice room and work on my acting.","        *goto mirror_practice","","","*label rooftop_haneul","*set rel_haneul %+10","*set stress %-5","","You walk up the fire escape to the roof.","The city lights of Seoul glow in the distance.","You find Haneul leaning against the railing.","${h_He} is holding a brand new, expensive-looking designer bag. ${h_He} has a ring light clipped to ${h_his} phone.","","Hi guys!","Haneul says to the phone, voice bubbly and bright. Look what LuxeMode sent me! It's so cute, right? #OOTD #TitanTrainee.","Haneul smiles, a perfect, dazzling smile. Click. Click. Click.","","Then, Haneul lowers the phone. The smile vanishes instantly. ${h_He} looks exhausted.","${h_He} carefully puts the expensive bag back into its box, treating it like a museum artifact.","","${name}?","Haneul turns around, startled. Oh. I... I didn't see you.","","*fake_choice","    # \"Nice bag. Is that yours?\"","        Haneul laughs nervously. This? No. I can't afford this. It's a sponsorship.","        I have to post a photo, then send it back.","","    # \"You have a lot of followers, don't you?\"","        *set charisma %+5","        Haneul nods. 50,000. People like the 'Prince/Princess' aesthetic.","        Haneul sits on the concrete floor, pulling ${h_his} knees to ${h_his} chest.","        Everyone thinks I'm rich, Haneul whispers.","        Because I post photos in nice clothes and my aunt picks me up in a sedan once a month.","        But I live in Dorm 502 with three other people. My parents... they don't have money.","        My dad is sick and my mom can only do so much.","        Haneul looks at the phone.","        This is how I pay for his meds and my siblings school supplies .","        I smile, I promote vitamins and bags I'll never own, and I send the money to Busan.","        *fake_choice","            # \"You're a good son/daughter/person, Haneul. That's honorable.\"","                *set rel_haneul %+7","                *set per_gentle +5","                Haneul looks at you with soft eyes.","                You think so? Sometimes I feel like a liar. But... hearing you say that makes it feel better.","                *goto month_12_grind","                ","            # \"It's smart. Use the system before it uses you.\"","                *set ruthless +5","                *set rel_haneul %-2","                Haneul nods firmly.","                Umm i guess. atleast Titan don't own my Instagram account. Yet.","                *goto month_12_grind","","            # \"Can you teach me? I need cash too.\"","                *set rel_haneul %+10","                Haneul giggles, the sound genuine this time.","                Sure.","                Step one: Find your 'good side'. Step two: Lie about how much you love matcha.","                You sit on the roof for an hour, watching the city. Haneul isn't the Royal up here.","                ${h_He} is just a kid trying to support a family.","                *goto month_12_grind","","","*label convenience_store_coco","*set rel_rival %+15","*set stress %-15","*set physical %+10","*set rebellion %+22","","You and Jun are sneaking out to the convenience store.","Just as you reach the side door, a shadow detaches itself from the wall.","","\"Going somewhere?\" Coco asks, smirking.","${r_He} pulls down ${r_his} black face mask. \"Without me?\"","","\"We... we were just getting water,\" Jun stammers, terrified of the Ace.","\"Relax,\" Coco laughs, throwing an arm around Jun's shoulders. \"I'm starving. Let's go.\"","","At the Store:","You are eating spicy ramen.","Jun is nervous. Coco is buying three bags of gummy bears and a soda.","${r_He} look at you, eyes scanning your face.","","\"You look tired, ${name},\" Coco says, voice surprisingly soft.","\"You working too hard?\"","","*fake_choice","    # \"I have to. I'm not a natural genius like you.\"","        *set rel_rival %+5","        ${r_He} snorts.","        \"Genius? Please. I practice until my feet bleed. I just make it look easy.\"","        *goto month_12_grind","    # \"I'm fine. Just thinking about the evaluation.\"","        *set rel_rival %+2","        ${r_He} rolls his eyes. \"Stop thinking. Eat the gummy bears.\"","        *goto month_12_grind","    # \"I was hoping to run into you, actually.\"","        *set romance_coco true","        *set rel_rival %+7","        Coco pauses, a gummy bear halfway to ${r_his} mouth.","        ${r_He} blushes, looking away quickly.","        \"Smooth,\" ${r_he} mutters, trying to hide a smile. \"Don't get used to it.\"","        Coco dumps the snacks on the counter. \"My treat. Consider it an investment in my future backup dancer.\"","        \"I'm not your backup dancer,\" you argue with a pang of annoyance.","        \"We'll see,\" Coco winks.","        *goto month_12_grind","","*label meeting_eden","*set vocals %+5","*set rel_eden %+10","","You find Studio B in the basement. It smells like coffee and heated electronics.","Inside, a man is slumped over a mixing desk, hair messy. It is the legendary producer, Eden.","","He isn't alone.","Coco is there too, nodding to a beat before leaving. \"Later, old man,\" Coco calls out, brushing past you.","Eden spins around and sees you. \"Great. Shift change. You want to learn?\"","","*fake_choice","    # \"Yes. Teach me how to make a hit.\"","        *set ruthless +5","        Eden smirks. \"Ambitious. Sit down.\"","        *goto month_12_grind","    # \"I just want to escape the dorms.\"","        Eden nods. \"Valid. Put these headphones on.\"","        You spend the night learning about mixing. It's the only place in the building where you feel in control.","        *goto month_12_grind","","*label mirror_practice","*set charisma %+10","*set the_mask %+10","*set stress %+10","*set physical %-5","","It is 2 AM.","You are alone in the practice room.","You are trying to practice your Ending Fairy face.","You look like a dying fish, a voice says.","You spin around. Coco is leaning against the doorway.","You're trying too hard, ${r_he} says. It's about confidence.","Coco walks over, standing incredibly close to you to fix your posture.","You can smell ${r_his} expensive cologne/perfume.","","*fake_choice","    # Stand your ground. \"Then show me.\"","        *set rel_rival %+5","        *set romance_coco true","        *set ruthless +5","        Coco smirks, staring right into your eyes.","        The air is electric.","        Something about your posture changes, becomes tighter like a prey waiting to be devoured.","        You look deep into Coco's eyes and try not to miss a beat while your cheeks get warmer by the minute, meanwhile Coco seems unfazed.","        Watch closely, ${r_he} whispers while placing one hand on your waist and another on your cheek.","        It's a mask, Coco says, looking at the mirror.","        Put it on, take it off. If you let them see the real you, they'll eat you alive.","        *goto month_12_grind","        ","    # Step back. \"I've got it, thanks.\"","        Coco shrugs, stepping away. Suit yourself.","        It's a mask, Coco says, looking at the mirror.","        Put it on, take it off. If you let them see the real you, they'll eat you alive.","        *goto month_12_grind","","*label month_12_grind","*page_break 1 year into training","","Back to reality. The next evaluation is coming.","It has been twelve months since you first stepped through the doors of the company.","*set stress %+20","[i](System: A year of training takes its toll. Stress increased by 20%)[/i]","","A full year of blood, sweat, and endless repetition in the practice rooms.","You look different than you did on day one. The \"grind\" has carved a new silhouette out of you.","How has the year of training shaped your physique?","","*choice","    # I've become lean and athletic, built for explosive power.","        *set p_body_type \"lean and athletic\"","        *set dance %+5","        *set physical %+5","        *set stress %+5","        *goto reflection_complete","    # I've developed a slender and elegant frame, focused on fluid lines.","        *set p_body_type \"slender and elegant\"","        *set visual %+5","        *set physical %-5","        *set stress %+10","        Maintaining this weight is a constant mental battle.","        *goto reflection_complete","    # I'm soft but toned; I prioritized health over aesthetics.","        *set p_body_type \"soft but toned\"","        *set physical %+15","        *set stress %-5","        *set visual %-5","        The managers hate it, but you feel strong.","        *goto reflection_complete","    # I'm sharp and agile, appearing fast and dangerous.","        *set p_body_type \"sharp and agile\"","        *set charisma %+5","        *set stress %+5","        *goto reflection_complete","","*label reflection_complete","You dance for 2 hours and then you allow yourself to wipe the sweat from your brow.","You are ready for what comes next.","${rival_name} is getting arrogant (side eye >_>).","${r_He} thinks ${r_he} is untouchable because ${r_he} is the CEO's favorite.","","How do you prepare?","*choice","    # I challenge ${rival_name} to a dance-off. I need to assert dominance.","        *set dance %+10","        *set charisma %+5","        *set physical %-5","        *set self_belief %+5","        *set rel_rival %+4","        You keep up with ${r_him}.","        ${r_He} looks shocked. You earned ${r_his} respect.","        *goto night_before_year1","","    # I focus on my weaknesses. I can't have any holes in my armor.","        *set vocals %+10","        *set dance %+10","        *set stress %+5","        *set physical %-5","        You round out your skills.","        *goto night_before_year1","","    # I play politics. I make sure the trainers see me working late.","        *set ruthless +5","        *set the_mask %+10","        *set scandal_risk %-10","        *set rel_manager %+10","        Hard work is good.","        Being SEEN working hard is better.","        *goto night_before_year1","","*label night_before_year1","*page_break One Year Later: The Night Before Evaluation 2","","Age 16. Month 12.","","It has been a year since you joined Titan.","The dorm room is still a pristine, mega super duper shoe box.","The agency forbids \"clutter,\" claiming it distracts from the goal of perfection.","But over the last twelve months, you have carved out a tiny sanctuary on your shelf: a secret reminder of who you were before you became a trainee.","What is the one thing that keeps you sane in this place?","","*fake_choice","    # My sketchbook. I draw the other trainees when they aren't looking.","        *set hobby \"Sketching\"","        *set visual %+7","        *set stress %-8","        It's your escape.","        When the dance routines turn your brain to mush, you draw weird caricatures of the instructors or fashion designs you'll never wear.","        It keeps your eyes sharp.","","    # A cheap ukulele I smuggled in. I play it softly when the cameras are off.","        *set hobby \"Music\"","        *set vocals %+5","        *set stress %-5","        Titan wants you to sound like a pop star.","        But with this, you can just play folk songs and breathe. It reminds you that music used to be fun.","","    # A stack of superhero comics hidden under my mattress.","        *set hobby \"Comics\"","        *set self_belief %+5","        *set stress %-10","        In these pages, people save the world with superpowers.","        It's a nice break from a world where your only power is \"smiling while tired.\"","","    # A retro handheld console. I play RPGs under the blanket.","        *set hobby \"Gaming\"","        *set stress %-15","        *set physical %-5","        You save the princess, slay the dragon, and pause the game.","        It's the only place where you can make mistakes and just hit \"Restart.\"","","    # My secret stash of fashion magazines. I study the trends like a Bible.","        *set hobby \"Fashion\"","        *set visual %+10","        *set ruthless +5","        You don't just look at the clothes; you analyze them.","        You know exactly what image Titan is trying to sell. One day, you'll be on the cover.","","    # A worn out basketball. I sneak out to the courtyard at night to shoot hoops.","        *set hobby \"Basketball\"","        *set physical %+10","        *set stress %-5","        The rhythm of the ball hitting the pavement is your meditation.","        It's the only time you get to sweat on your own terms.","","    # A professional makeup kit. I practice contouring on Jun.","        *set hobby \"Makeup\"","        *set visual %+10","        *set rel_jun %+5","        \"Make me look fierce,\" Jun always says.","        You treat faces like canvases. You know how to hide the dark circles and the stress.","","    # A hard drive full of classic cinema. I analyze the acting.","        *set hobby \"Cinema\"","        *set charisma %+5","        *set the_mask %+5","        You watch the greats, their micro-expressions, their timing.","        You aren't just an idol; you want to become more than just a one trick pony.","","The lights are out.","The blue glow of the humidifier is the only light in the room.","\"Hey, ${name}?\" Jun whispers from the bottom bunk.","","\"Yeah?\"","","Jun is quiet for a moment.","\"I was thinking about the first day we met. Do you remember?\"","*fake_choice","    # \"I remember. We were shaking in our gym clothes.\"","        *set rel_jun %+5","        \"I was shaking so bad,\" Jun whispers.","        \"I thought I was going to throw up on my shoes.\"","","    # \"I remember. You were breaking the rules immediately.\"","        *set rel_jun %+5","        *set per_bold +5","        Jun giggles softly.","        \"I was starving! I couldn't help it.\"","","    # \"That feels like a lifetime ago.\"","        *set stress %+5","        \"It does,\" Jun agrees. \"We were just kids then. Now look at us.\"","","\"I can still smell those spicy noodles,\" Jun says dreamily.","\"You walked in and caught me red-handed, mouth full of ramen. I thought you were going to report me.\"","And instead, you reply...","","*fake_choice","    # \"I realized right then that if you were brave enough to risk expulsion for MSG, you were worth knowing.\"","        *set rel_jun %+15","        *set per_bold +5","        *set charisma %+5","        Jun lets out a quiet, muffled giggle against the pillow.","        \"It wasn't bravery, it was pure desperation. But I'm glad you saw it that way. You made me feel like a rebel instead of just a hungry kid.\"","        ","    # \"Reporting you would have been the Idol thing to do. Sitting down to eat was the human thing to do.\"","        *set rel_jun %+10","        *set the_mask %-10","        *set self_belief %+5","        \"A human being,\" Jun muses, his voice sounding small in the dark room. ","        \"It's easy to forget we're allowed to be that. You've always been good at reminding me that we aren't just products on a shelf.\"","","    # \"I just figured having a roommate who owes me a life-long debt of silence was a smart tactical move.\"","        *set rel_jun %+8","        *set ruthless +5","        *set charisma %+10","        \"Aish, you and your tactics!\" Jun huffs playfully, though you can hear the smile in his voice.","        \"Fine. I'm still paying off that debt, aren't I? I guess I'll have to keep being your best friend until we're both legends.\"","","    # \"Honestly? I was just waiting for you to offer me a bite. I was starving too.\"","        *set rel_jun %+15","        *set per_bold +5","        Jun laughs, a genuine sound that cuts through the tension of the upcoming evaluation.","        \"I knew it! I saw that look in your eyes. It wasn't judgment, it was pure envy. We were just two starving wolves in gym clothes.\"","","Silence settles between the bunks again.","It feels heavier than it did a year ago. The stakes are real now.","\"Hey, ${name}?\" Jun asks.","\"If only one of us makes it past tomorrow... promise me you won't look back. Just reach toward the mic.\"","","*fake_choice","    # \"I promise. I'll become a star for both of us.\"","        *set ruthless +5","        *set rel_jun %-5","        \"Umm okay,\" Jun hesitates. \"That's what I wanted to hear. Don't waste it.\"","","    # \"Don't say that. We go together or we don't go at all.\"","        *set rel_jun %+20","        *set rebellion %+15","        Jun doesn't answer for a long time.","        Then, a soft whisper: \"You're too good for this world, ${name}.\"","","    # \"If I make it, I'm buying you a ramen factory. We'll swim in spicy broth.\"","        *set charisma %+10","        *set rel_jun %+10","        *set stress %-5","        Jun bursts into a wet, sniffling laugh.","        \"Idiot. You better promise.\"","        \"I promise. Unlimited noodles,\" you grin. It's easier to joke than to cry.","","    # \"Go to sleep, Jun. Emotions burn energy we need for tomorrow.\"","        *set the_mask %+10","        *set stress %-5","        \"Okay,\" Jun says, voice devoid of hope.","        \"Goodnight, ${name}.\"","","*goto eval_year1","","*label eval_year1","*page_break The Second Quarterly Evaluation","","Director Park is watching today. The atmosphere is suffocating.","${rival_name} performs first.","It is technically flawless, but ${r_he} is chewing gum.","","Now, it is your turn.","*if (stress >= 93) and (hidden_injury = false)","    You step forward, but your vision blurs.","    You simply faint before the music even starts.","    \"Pathetic,\" Park mutters.","    *set passed_eval false","    *goto eval_year1_result","","*if (hidden_injury)","    You perform with terrifying intensity.","    The painkillers mask the pain, making your movements sharp but slightly manic.","    Park watches you closely.","    \"Your eyes look dangerous,\" he notes.","    *set charisma %+15","    [i](Painkillers Bonus: +15 Charisma)[/i]","","*if ((dance >= 45) or (vocals >= 45)) or ((charisma >= 45) or (visual >= 45))","    You power through.","    Your eyes are fierce. You channel every ounce of frustration into the movement.","    Director Park nods slowly. \"Good energy.\"","    *set passed_eval true","    *goto eval_year1_result","*else","    You perform well, but it feels average.","    You blend into the background.","    Park doesn't even look up from his notes. \"Next.\"","    *set self_belief %-5","    *set rel_manager -10","    *goto eval_year1_result","","*label eval_year1_result","The next day.","One of the trainees, Alex, is gone.","Erased because they were chewing gum during the evaluation.","${rival_name}, however, is still here. Of course.","","*label month_18_birthday","*page_break Time Jump: Month 18","","Age 16. Month 18. Your Birthday.","You are sitting on the cold concrete of the rooftop.","The door creaks open.","It's Jun.","","Jun holds out a generic \"Choco Pie\" wrapper with a single, unlit match in it.","\"Happy Birthday,\" Jun whispers.","\"Make a wish.\"","","*fake_choice","    # I blow it out and start crying. The pressure is too much.","        *set per_gentle +10","        *set rel_jun %+10","        *set stress %-10","        Jun sits beside you and just holds your hand.","        \"We're going to make it,\" Jun promises.","","    # I laugh and pretend to eat the match. \"Thanks, idiot.\"","        *set per_bold +10","        *set rel_jun %+15","        *set stress %-15","        Jun grins.","        \"Hey! That cost me 500 won.\"","        You split the Choco Pie.","        It tastes like cardboard and sugar, but it's the best thing you've ever eaten.","","    # \"I don't have time for this. I need to practice.\"","        *set rel_jun %-10","        *set self_belief %+5","        Jun's smile fades.","        \"Right. Sorry.\"","        Jun leaves the Choco Pie on the floor. You eat it alone, tasting ash.","","*label month_24_start","*page_break Time Jump: Month 24","","Age 16. Month 24.","","Two years.","","Only 30 trainees left.","You are hurt.","Your knees ache. You have forgotten what it feels like to be rested.","*if (rel_jun >= 55)","    *gosub jun_secret_scene","*if (rel_rival >= 35)","    *gosub coco_secret_scene","","*goto viral_logic_check","","*label jun_secret_scene","*page_break","It is late at night.","Jun is sitting on your bed, holding a small plastic package.","\"Here,\" Jun says, shoving it into your hand. \"Eat.\"","It's a red bean bun. From the convenience store.","","\"I saw you didn't eat lunch,\" Jun mutters, refusing to look at you.","\"You look like a skeleton. If you pass out on stage, I'm not carrying you.\"","Jun's hands are shaking slightly.","You realize Jun isn't worried about the stage. Jun is worried about you.","","\"You're my family now, ${name},\" Jun whispers.","\"Don't leave me behind, okay?\"","You eat the bun. You feel lucky to have met Jun.","*return","","*label coco_secret_scene","*page_break","You are tying your shoelaces in the hallway.","\"Nice shoes,\" a voice draws out. \"Cheap, though.\"","It's Coco.","${r_He} kicks your foot gently, but there's no malice in it today.","","Coco squats down next to you.","\"Listen,\" ${r_he} says, voice low. \"The judges are looking for eye contact. When you hit the bridge, don't blink. Intimidate them.\"","You look at ${r_him}, surprised. \"Why are you helping me?\"","","Coco smirks, but it doesn't reach ${r_his} eyes.","\"Because beating you when you're weak isn't fun. And... honestly? You're the only one here who actually challenges me.\"","\"Don't you dare lose to anyone but me,\" Coco says, standing up and walking away.","*return","","*label viral_logic_check","*if (stress < 62)","    *goto viral_moment","*else","    *goto crisis_moment","","*label crisis_moment","*page_break THE BREAKING POINT","","Your vision blurs.","The room spins.","You drop to your knees, gasping for air. Your body has finally hit its limit.","Jun rushes over. \"${name}! Are you okay?\"","","You try to stand, but your legs are trembling uncontrollably.","You know this feeling. It is not just fatigue. It is a shutdown.","If you don't rest, you will collapse on stage tomorrow.","But if you rest now, you will lose the sharpness you worked so hard for.","","What do you do?","*fake_choice","    # I take the strongest painkillers I have. I will force my body to work.","        *set physical 5","        *set stress 99","        *set self_belief %+10","        *set ruthless +10 ","        *set trauma_points + 2","        You swallow the pills dry.","        Within minutes, the pain fades into a dull buzz. Your heart is racing dangerously fast, arms heavy.","        You feel invincible. You feel numb.","        (Warning: Physical Health is critical. You are running on borrowed time.)","","","    # I accept my limits. I drink water and sleep for 12 hours.","        *set stress %-40","        *set physical %+20","        *set dance %-5","        *set vocals %-5","        *set charisma %-5","        ","        You crawl into bed, ignoring the panic in your chest.","        When you wake up, your body feels lighter, but your mind feels dull.","        You lost the \"edge\" you sharpened all night. You feel rusty.","","*goto viral_moment","","*label viral_moment","*page_break The Viral Clip","You are in the locker room, peeling off your sweat-soaked shirt.","The air is thick with the smell of damp towels and exhaustion.","Jun bursts in, clutching his phone like it is a grenade.","\"${name}... do not freak out.\"","\"What did I do now?\" You blink, too tired to focus.","\"You didn't do anything. That is the problem. You are trending on N.\"","","He presses play.","It is a grainy video taken from inside a CU convenience store, looking out onto the rainy street in Gangnam at 2:00 AM.","The neon sign of a karaoke bar reflects in a puddle next to you.","But the focus isn't just on you. It's on the scruffy, one-eared street cat sitting on the curb next to you.","The caption reads: [b]Found this trainee having a serious conversation with a Stray Cat at 2AM. My heart hurts.#TitanTrainee #CatWhisperer #KpopFuture[/b]","","*temp viral_gain 0","","*comment --- SKILL CHECKS & FLAVOUR TEXT ---","","*if (visual >= 50)","    *set viral_gain +5000","    [i](System: High Visuals. Your face card is the main event.)[/i]","    In the video, the streetlamp flickers, illuminating your side profile.","    You look like a painting.","    You gently wipe a raindrop off the cat's head, and the camera zooms in on your expression.","    Jun shakes his head. \"Even with a wet cat, you look like you're filming a CF (Commercial).\"","    The top comment reads: [b]@VisualHunter: \"The way they look at that cat... I wish I was that cat. That nose bridge is art. Total Face Genius.\"[/b]","    *line_break","","*if (vocals >= 50)","    *set viral_gain +5000","    [i](System: High Vocals. You were serenading the cat.)[/i]","    In the video, you are humming a soft, complex melody to the cat while opening a can of tuna.","    The audio is faint, but your pitch is perfect. The cat seems to stop eating just to listen.","    \"You were singing a ballad to a stray?\" Jun asks. \"And hitting those notes casually?\"","    The top comment reads: [b]@BalladLover: \"Wait, turn up the volume. That humming... the tone (Eumsaek) is insane. They are serenading a cat with main vocal skills?\"[/b]","    *line_break","","*if (dance >= 50)","    *set viral_gain +5000","    [i](System: High Dance/Physical. Your body language tells a story.)[/i]","    In the video, you crouch down with a fluid, athletic grace that screams \"dancer.\"","    Even while squatting on the wet pavement, your posture is perfect, your balance absolute. You mimic the cat's movements playfully.","    \"Only a dancer moves like that,\" Jun notes. \"You made feeding a cat look like choreography.\"","    The top comment reads: [b]@StageGenius: \"Look at the flexibility in that crouch. That's not a normal person, that's a main dancer. The body control is crazy.\"[/b]","    *line_break","","*if (charisma >= 50)","    *set viral_gain +6000","    [i](System: High Charisma. You treated the cat like a Senior.)[/i]","    In the video, you don't just feed the cat.","    You stand up, bow a full 90 degrees to it, and speak respectfully.","    [b]\"Please eat well, Sunbae-nim,\"[/b] you say to the cat with a straight face.","    ","    Jun bursts out laughing.","    \"Did you just call a stray cat 'Sunbae-nim'? You're insane.\"","    The internet is losing its mind over your 4D personality.","    The top comment reads: [b]@VarietyGod: \"Did they just bow to a cat?! LOL. Finally an idol who isn't a robot. I'm stanning the Cat Sunbae and their Hubae!\"[/b]","    *line_break","","*comment --- SCANDAL MODIFIER (THE BIG REWARD) ---","","*if (scandal_risk > 25)","    *set viral_gain +15000","    *set followers +viral_gain","    [b]VIEWS: 3.5M (TRENDING #1)[/b]","    [i]( +${viral_gain} Followers)[/i]","    ","    *set rel_manager -25","    The Manager storms in, waving a tablet.","    \"Do you have no Nunchi?! Dispatch is writing articles about your 'Midnight Rebellion'!\"","    \"But...\" He pauses, looking at the numbers.","    \"The public loves a bad boy/girl with a soft heart. You're the #1 search term on Naver right now.\"","    *goto final_prep_choice","*else","    *set viral_gain +5000","    *set followers +viral_gain","    [b]VIEWS: 900K (TRENDING #3)[/b]","    [i]( +${viral_gain} Followers)[/i]","    ","    *set rel_manager -5","    The Manager sighs, rubbing his temples.","    \"Aish... at least the comments are positive. 'The Warm-Hearted Trainee'. It's a good image.\"","    \"But be careful. Dispatch is always watching.\"","    *goto final_prep_choice","","*label final_prep_choice","\"I was just paying my respects to the street boss,\" you whisper.","\"You weren't just feeding a cat,\" Jun corrects you. \"You were being 'Real'. People are starving for that.\"","He points at the screen showing your profile.","[b]CURRENT FOLLOWERS: ${followers}[/b]","*gosub_scene social_logic update_feed","","The public is watching.","And the K-Netz have high expectations now.","","You have one last chance to boost your stats before the Big Announcement.","The air in the practice room is thick with the scent of sweat and desperation.","*choice","    # I push through the pain. No one debuts by being careful.","        *if (physical <= 35) or (stress >= 60)","            *set stress %+20","            *set physical -15","            *set hidden_injury true","            SNAP.","            A blinding white pain shoots through your ankle. You have pushed too far.","            You will have to hide this limp from the cameras if you want to survive.","            *goto stress_check_finale","        *else","            *set dance +10","            *set vocals +10","            *set stress %+10","            *set physical -10","            You unlock a new level of stamina through sheer willpower.","            *goto stress_check_finale","","    # I rest and recover. I need to be at my best for the stage.","        *if (stress >= 90)","            You try to sleep, but the chemicals in your blood are screaming.","            *set stress %-5","            *set physical %+5","            *set self_belief %-10","            You wake up barely rested and feeling paranoid.","            *goto stress_check_finale","        *else","            I need to be at my best for the stage.","            *set stress %-20","            *set physical %+15","            *set visual %+5","            *set rel_manager %-5","            Your skills don't improve, but you feel human again.","            *goto stress_check_finale","","    # I study \"Idol Psychology.\" I'll win with my mind.","        *set charisma %+7","        *set the_mask %+10","        *set stress %+5","        You learn how to manipulate the camera's gaze.","        You aren't stronger, but you are smarter.","        *goto stress_check_finale","","*label stress_check_finale","*page_break Vitals Check","","[i](System: Pre-Evaluation Vitals Scan...)[/i]","","*if (physical < 30)","    Your breath comes in shallow, ragged gasps.","    Your body feels like it's made of cardboard and bad variables.","    *if (physical <= 10)","        *choice","            # \"Is there a 'Load Game' button for my muscles? I think I'm stuck in a low-HP glitch.\"","                *set physical -1","                *set stress %+5","                You look at your hands, half-expecting to see a health bar blinking red in the corner of your vision.","                There isn't one. Just the cold reality of lactic acid.","                *goto check_stress_vitals","            # \"I'll just wait for the next scene. Characters don't die in the middle of a montage, right?\"","                *set the_mask %+10","                *set self_belief %+5","                The fourth wall is the only thing keeping you upright.","                If this is a tragedy, at least you'll get a good edit.","                *goto check_stress_vitals","    *goto check_stress_vitals","","*label check_stress_vitals","*if (stress > 85)","    The buzzing in your ears is louder than the music.","    You feel like your life is just a series of choices made by someone else.","    *if (stress >= 95)","        *choice","            # I look directly at the security camera and wink. \"I hope the audience likes the 'Mental Breakdown' arc.\"","                *set charisma %+10","                *set scandal_risk %+10","                If you're going to lose your mind, you might as well give the producers some good footage for the trailer.","                *goto eval_2","            # I turn to the 'Voice' in my head. \"If you're going to pick a dialogue option, make it a good one.\"","                *set the_mask %+15","                *set stress %-5","                You've officially reached the point where you're talking to the narrator.","                Director Park would call this 'Strong Mental'. You call it a Tuesday.","                *goto eval_2","","*goto eval_2","","*label eval_2","*page_break The Second Quarterly Evaluation","","Director Park is watching today.","The atmosphere is suffocating.","${rival_name} performs first.","It is technically flawless, but ${r_he} is chewing gum.","\"Respect is basic,\" Park mutters, marking ${r_him} down.","","Now, it is your turn.","*temp masked_performance false","*temp total_skill","*set total_skill (vocals + dance)","*set total_skill (total_skill + visual)","*set total_skill (total_skill + charisma)","","","*if (stress >= 93) and (hidden_injury = false)","    *if (the_mask >= 65)","        Your vision goes black.","        The room spins. Your body screams at you to collapse.","        But you don't.","        Your Mask is so hardened it acts like a second skeleton.","        You dissociate completely. You are not ${name} anymore; you are a product.","        Your body moves on autopilot, hitting every angle with terrifying precision while your mind floats in a void.","        Director Park looks at you, slightly unsettled by your empty eyes.","        \"Your Mental is strong,\" he says slowly.","        \"Almost too strong. Good.\"","        *set passed_eval true","        *set masked_performance true","        *set dissociated_pass true","        *set charisma %+20","        *goto eval_2_result","    *else","        You step forward, but your vision blurs.","        You simply faint before the music even starts.","        \"Pathetic,\" Park mutters. \"Weak Mental.\"","        *set passed_eval false","        *goto eval_2_result","","*if (hidden_injury)","    A sharp pain shoots up your leg.","    *if (the_mask >= 40)","        But your face does not twitch.","        Park sees the sweat, but he cannot find the flaw.","        \"Professional,\" he notes. \"You have the right Mental.\"","        *set passed_eval true","        *set masked_performance true","        *set charisma %+10","        *set physical -10","        *goto eval_2_result","    *elseif (stress >= 90)","        The painkillers mask the pain, making your movements sharp but manic.","        \"Your eyes look dangerous,\" he notes. \"Good Kki.\"","        *set passed_eval true","        *set charisma %+15","        *goto eval_2_result","    *else","        You stumble.","        Park sighs. \"Injury? Unprofessional.\"","        *set passed_eval false","        *goto eval_2_result","","","*if ((dance >= 45) or (vocals >= 45)) or ((charisma >= 45) or (visual >= 45))","    You power through.","    Your eyes are fierce. Director Park nods slowly. \"Good energy.\"","    *set passed_eval true","    *goto eval_2_result","","","*elseif (total_skill >= 150)","    You don't have a \"Main\" skill. You don't have a specialty.","    But as you move from dance to vocals to acting, Director Park stops writing.","    ","    He looks at your file. Then he looks at you.","    You didn't go to the convenience store parties. You didn't bond with your roommates.","    You spent every single hour of the last two years in the studio.","    ","    \"You are a machine,\" Park whispers, half-impressed, half-disturbed.","    \"No weakness. No holes. You sacrificed everything to be efficient.\"","    He circles your name in red ink.","    \"We can use a weapon like you. You are the ultimate [b]All-Rounder[/b].\"","    ","    *set passed_eval true","    *set self_belief %+15","    *set ruthless +10","    *goto eval_2_result","","","*else","    You perform well, but it feels average.","    You lack a \"Killing Part\" or the insane dedication of an All-Rounder.","    Park doesn't even look up from his notes.","    *set self_belief %-5","    *set rel_manager -10","    *set passed_eval false","    *goto eval_2_result","*label eval_2_result","The music fades. You bow, panting.","Thank you. Next.","","The next day.","One of the trainees, Alex, is gone.","${rival_name}, however, is still here. Of course.","*label post_eval_check","*page_break The Final Wait","","[i](System: Post-Evaluation Status...)[/i]","","*if (physical < 15)","    You are practically vibrating with exhaustion.","    Your vision is flickering like a bad internet connection.","    *choice","        # \"I bet my 'Visual' stat is carrying me right now. God knows my 'Physical' is at zero.\"","            *set visual %+5","            *set self_belief %-5","            You lean against the wall, wondering if you're just a collection of numbers on a spreadsheet.","            Director Park's spreadsheet, specifically.","            *goto check_stress_post_eval","","        # I ask Jun if he thinks we're in a survival show or a horror movie.","            *set rel_jun %+10","            *set stress %-5","            \"Same thing,\" Jun whispers back, his eyes dead.","            \"At least in horror movies, the ghosts don't make you practice choreography for 18 hours.\"","            *goto check_stress_post_eval","","*label check_stress_post_eval","*if (stress > 90)","    You're replaying every micro-mistake in your head on a loop.","    *choice","        # \"Narrator, if you can hear me... just skip to the part where I'm famous.\"","            *set self_belief %+5","            *set stress %+10","            The silence of the hallway is your only answer.","            The 'Skip' button is broken.","            You have to live through every agonizing second of the 'Wait' mechanic.","            *goto the_announcement","","        # I start practicing my \"Shocked Victory Face\" just in case.","            \"Who, me? I'm so surprised!\"","            *set the_mask %+15","            *set charisma %+5","            You look at your reflection in a locker.","            You look like a professional liar.","            In this building, that's the highest form of praise.","            *goto the_announcement","","*goto the_announcement","","*label the_announcement","The Summoning.","8:00 AM. Main Hall.","","Director Park walks in with a microphone. Behind him, a screen lights up: [b]PROJECT: SUPERNOVA[/b].","\"We have trimmed the fat,\" Park says coldly. \"Now, only the best remain.\"","","Starting next week, your lives will be broadcast 24/7. You will compete for 7 spots in the final group.","He begins to read the names of the survivors.","","\"Coco... Kang... Haneul... Jiwon...\"","He lists 29 names. The room is thinning out.","","Jun is standing next to you. ${j_He} isn't gripping your hand anymore. ${j_He} is standing straight, hands at ${j_his} sides, staring at the floor.","${j_He} is trembling so slightly you almost can't see it.","","Director Park stops reading. He lowers the paper.","\"That is all,\" Park says. \"Those whose names were not called... thank you for your hard work. Please clear your lockers by noon.\"","","The room is deadly silent.","Jun doesn't scream. In a terrifying display of discipline, Jun turns to the Director and bows a full 90 degrees.","\"Thank you for the opportunity,\" Jun whispers.","","It is heartbreakingly polite.","Jun turns around, pale as a ghost, and begins to walk toward the exit with the other rejected trainees.","","\"Wait,\" Park says. \"I missed one.\"","","Jun stops. Hope flashes in ${j_his} eyes.","Park doesn't even look at Jun. He looks at the remaining candidates.","","\"The final spot...\"","","*if (passed_eval = false)","    *goto outcome_rejected","","*if (((vocals <= 15) or (charisma <= 15)) or (dance <= 15))","    *goto outcome_not_allrounder","","*if (rel_manager < 33)","    *goto outcome_manager_cut","","\"${surname} ${name}.\"","","The hope vanishes from Jun's face instantly. The mask comes back up.","${j_He} gives you a small, broken smile and walks toward the door. Alone.","","Director Park waits for you to step forward. \"Join the line, ${name}.\"","","*choice","    # I stand still, watching Jun leave. I worked too hard to throw this away.","        You feel like throwing up.","        But you take a step forward. You bow to the Director.","        \"Thank you, sir,\" you say.","        You don't look back at the door. You can't.","        *goto outcome_accepted","","    # \"No.\" I turn my back on the Director and follow Jun. (Requires Rebellion 65+)","        *if (rebellion < 65)","            You open your mouth to speak. Your heart screams at you to move.","            [i]\"No,\"[/i] you want to say. [i]\"This is wrong.\"[/i]","            ","            But the word dies in your throat.","            Years of conditioning, the fear of Director Park, the desperate need to succeed it all freezes you in place.","            Your legs feel heavy, like they are filled with lead. You watch Jun's hand slip off the door handle.","            ","            You failed ${j_him}. You simply aren't brave enough to throw it all away.","            You look down at your feet, defeated, and step back into line.","            *goto outcome_accepted","        *else","            *set rebellion +20","            *set rel_jun %+50","            You don't step forward. You step back.","            ","            \"Where are you going?\" Park asks, his voice mild. \"If you walk out that door, you are done.\"","            ","            You don't answer. You turn around and walk toward the exit, matching Jun's pace.","            You grab Jun's hand just as ${j_he} reaches the handle.","            \"Let's go, ${jun_nickname},\" you say quietly.","            *goto end_chapter_2_rebel","","*label outcome_accepted","Director Park nods. \"Welcome to Project: Supernova.\"","*goto end_chapter_2_safe","","*label outcome_not_allrounder","\"Rio.\"","Rio gasps, stepping forward.","Your name was not called. The room spins.","\"You are unbalanced,\" Park says, looking at you briefly. \"A true Idol must be an all-rounder.\"","*set passed_eval false","*set cut_reason \"unbalanced\"","*goto rescue_check","","*label outcome_manager_cut","\"Rio.\"","Rio gasps, stepping forward.","Your name was not called. The room spins.","\"Talent is common,\" Park says, looking at you. \"But I cannot debut a trainee who lacks respect for the hierarchy.\"","*set passed_eval false","*set cut_reason \"attitude\"","*goto rescue_check","","*label outcome_rejected","\"Rio.\"","Rio gasps, stepping forward.","Your name was not called. The room spins.","*if (stress >= 93) and (the_mask < 70)","    *set cut_reason \"medical_collapse\"","    *goto rescue_check","*elseif (hidden_injury) and (masked_performance = false)","    *set cut_reason \"medical_injury\"","    *goto rescue_check","*else","    *set cut_reason \"rejected\"","    *goto rescue_check","","*label rescue_check","*if (dissociated_pass)","    *goto end_chapter_2_villain","*elseif (cut_reason = \"medical_collapse\") or (cut_reason = \"medical_injury\")","    *goto end_chapter_2_medical_rescue","*else","    *goto end_chapter_2_villain","","*label end_chapter_2_medical_rescue","*page_break The Back Exit","","You are standing in the alley behind the building.","Shivering. Broken. Alone.","The rain masks your tears. You gave everything, and they tossed you out like garbage.","","Suddenly, a Rolls Royce pulls to the curb. The window rolls down and the most beautiful woman you've ever seen has just handed you a towel.","It is the Show Producer (PD). He looks annoyed.","\"Get in,\" he mutters. \"Before the paparazzi see you.\"","He slides the door open.","","Sitting inside is Noa.","She isn't looking at her phone. She is looking at you.","And she isn't looking at you like a judge. Her eyes are warm, filled with a deep, painful recognition.","\"Here,\" Noa says softly.","She reaches out and hands you another dry towel.","Her hands are warm, contrasting sharply with the cold rain.","","\"Director Park sees a broken puppet, but you remind me of someone,\" Noa says.","\"I was watching the feed. I saw you get up when anyone else would have stayed down.\"","She leans forward, and for a second, the Perfect Idol mask slips. You see the survivor underneath.","\"I know that feeling,\" she whispers. \"It's the same I had when they told me to quit.\"","","The PD sighs.","\"Noa, are you sure? The kid is injured.\"","","\"I'm sure,\" Noa says firmly, not breaking eye contact with you.","\"I'm using my Host Veto. ${name} ${surname} is coming to the Villa.\"","She smiles not her media smile, but a small, sad, genuine one.","\"The system is cold, ${name}. You'll need someone to help you keep the fire burning. Come with me.\"","*set entry_method \"medical_wildcard\"","*set rel_noa +20","*set scandal_risk %+ (10 * scandal_mult)","","*choice","    # I take the towel. I trust her warmth.","        *set self_belief %+10","        *set per_gentle +5","        \"Thank you, Sunbae-nim,\" you whisper.","        Noa moves over to make space for you. As you pass her by you notice the small scar on her right hand.","        \"Call me Unnie/Noona when the cameras are off,\" she says kindly.","        You climb in. You are safe.","        *goto end_chapter_2_final","","    # I get in, but I keep my guard up.","        *set ruthless +5","        You nod, wiping the rain from your face.","        She saved you, but you know this industry. Nothing is free.","        *goto end_chapter_2_final","","*label end_chapter_2_villain","You drag your suitcase into the rainy street outside Titan. It is over.","Suddenly, a black van screeches to a halt, blocking your path.","The window rolls down.","It is the new shows producer. He is holding an Iced Americano and looking at you with delight.","","*if (dissociated_pass)","    \"Stop! Don't move!\" he yells, framing you with his hands like a camera.","    \"That look in your eyes... so empty. So dead. It's giving 'Tim Burton meets K-Pop'. I am obsessed.\"","    He takes a sip of his coffee through a neon straw.","    \"Park hates it. He wants robots. But me? I'm from LA, baby. We love a good breakdown.\"","    \"Get in. You're my new Villain.\"","    *set entry_method \"villain\"","    *goto end_chapter_2_final","*else","    \"Hey! The Angry One!\" he calls out.","    \"I saw you in there. You looked like you wanted to set the building on fire.\"","    He smirks.","    \"Do it. But do it on my show.\"","    \"Korea is too polite. I need someone to flip a table. Get in, darling.\"","    *set entry_method \"villain\"","    *goto end_chapter_2_final","","*label end_chapter_2_rebel","*page_break The Exit","","You and ${jun_nickname} storm out into the rainy street.","The heavy doors of Titan Entertainment slam shut behind you with a final, echoing thud.","The music from inside is cut off instantly.","All that's left is the sound of the rain hitting the asphalt and ${jun_nickname}'s ragged breathing.","","${jun_nickname} stumbles, dropping ${j_his} bag onto the wet pavement.","$!{j_he} leans against the brick wall, sliding down until ${j_he}'s sitting in a puddle.","\"We're dead,\" $!{j_he} gasps, burying ${j_his} face in ${j_his} hands. \"My parents... the contract penalty... we're actually dead.\"","","You stand over ${j_him}, soaking wet, adrenaline still pumping through your veins.","You just threw away your dream. But looking at ${j_him}, you don't feel regret.","In fact, a laugh bubbles up in your chest. It starts low, then builds into something hysterical and liberating.","","${jun_nickname} looks up, terrified. \"Why are you laughing? We just ruined our lives!\"","","\"We didn't ruin them,\" you gasp, wiping rain from your eyes. \"We saved them. Did you see Park's face? He looked like he was about to blow a gasket.\"","","${jun_nickname} blinks, and then, a small, shaky smile breaks through ${j_his} tears.","\"He did turn kinda purple,\" ${j_he} admits.","","\"Exactly.\" You grab ${j_his} shoulders, forcing ${j_him} to look at you in the pouring rain.","\"Listen to me, ${jun_nickname} ah. You smart. You loyal.\"","","${jun_nickname} stares at you, confused.","","\"YOU THE BEST,\" you shout over the thunder, channeling your inner DJ Khaled. \"And I love you! That's why I walked out. We go together, remember?\"","","${jun_nickname} stares at you, ${j_his} eyes wide. $!{j_he} looks like ${j_he} doesn't know whether to hug you or call a doctor.","\"You're... you're quoting memes right now?\" $!{j_he} whispers, voice trembling. \"We just got fired and you're quoting DJ Khaled?\"","","\"Another one,\" you simply say, pulling ${j_him} to ${j_his} feet. \"You're stuck with me now, Crybaby. No refunds.\"","","${jun_nickname} takes a deep breath, steadying ${j_him}self.","$!{j_he} looks at you, and for the first time in months, the fear is gone from ${j_his} eyes.","\"Okay,\" $!{j_he} says, gripping your hand. \"No refunds.\"","","Suddenly, a slow clap echoes from the street.","A black van has pulled up silently when you didn't notice.","The producer is leaning out, still clapping. He has a silk hermes scarf with flamboyant colors.","","\"Bravo! Encore!\" he shouts over the rain.","\"Walking out on Director Park? Screaming in the rain? Honey, I worked in Hollywood for ten years and I haven't seen an exit that dramatic.\"","","He unlocks the doors.","\"I can't let chemistry like that walk away. The ratings would never forgive me.\"","\"Get in, you beautiful disasters. You're messy, and I'm going to make you stars.\"","","${jun_nickname} looks at you, confused. \"Who is that?\"","\"Our new ride,\" you say, grabbing ${j_his} hand. \"Come on.\"","","*set entry_method \"rebel\"","*set rel_jun %+50","*set scandal_risk %+ (20 * scandal_mult)","*goto end_chapter_2_final","","*label end_chapter_2_safe","Pack your bags. You move into the Villa tomorrow.","*set entry_method \"merit\"","*goto end_chapter_2_final","","*label end_chapter_2_final","*page_break Project: Supernova Begins","","The vehicle speeds through the rain, leaving the Titan building behind.","","*if (entry_method = \"medical_wildcard\")","    Noa glances at you from the seat beside you.","    \"Rest now,\" she says softly, checking her phone.","    \"We're almost at the Villa.\"","    \"The cameras start rolling the moment we step off this van. Be ready.\"","    ","    The PD looks at her in the rearview mirror. \"You sure about this, Noa? Bringing a wounded bird into a snake pit?\"","    Noa's eyes harden. \"Just drive.\"","    *goto gates_open","","*elseif (entry_method = \"merit\")","    You sit in the transport bus with the other survivors.","    The mood is tense.","    The screen at the front flickers on.","    The PD appears, wearing a face mask and a silk robe.","    \"Welcome to the show,\" his voice crackles over the speakers.","    \"Noa is waiting for you at the gates. Don't disappoint her.\"","    *goto gates_open","","*elseif (entry_method = \"villain\")","    \"You better be ready. The Host isn't known for playing favorites.\"","    *goto gates_open","","*elseif (entry_method = \"rebel\")","    \"Is Noa ready? Good. I know she can turn these lemons into lemonade...\"","    *goto gates_open","","*else","    The PD drives in silence.","    \"Welcome to the show.\"","    *goto gates_open","","*label gates_open","*page_break The Gates Open","","The gates of a massive, secluded estate swing open.","The Villa.","\"Welcome to Project: Supernova,\" the PD says.","\"Try not to die.\"","*gosub_scene mechanics safe_stat_clamp","*if (entry_method = \"rebel\")","    [b]CHAPTER 3: REBEL PATH - COMING SOON[/b]","    ","    You've chosen the path of the Outcasts. Currently, the Rebel route is being carefully crafted to ensure the bond between you and Jun gets the depth it deserves.","    ","    In the meantime, use the new [b]Save System[/b] to explore the other connection and get traumatized by RO'S /xp ","    *page_break","    *finish","*else","    *goto_scene chapter3_solo"]},"chapter3_solo":{"crc":-92591882,"labels":{"1":1802,"2":2727,"3":1948,"4":2797,"5":2345,"6":1877,"7":2086,"chapter3_solo":0,"intro_medical_ride":14,"intro_villain_ride":34,"intro_merit_ride":42,"viewing_the_villa":49,"exiting_the_vehicle":97,"convergence_start":117,"convergence_meeting":147,"entering_the_villa_interior":189,"mission_medical":213,"mission_merit":218,"interview_booth":223,"question_2":302,"interview_end":400,"check_performance_status":407,"medical_sit_out":413,"performance_stage":428,"post_challenge_social_update":490,"room_selection":501,"night_1_hub":535,"night_1_choices":546,"eden_villa_night":639,"see_eden":651,"eden_greeting_continue":663,"flavor_text_set":679,"eden_reaction":709,"night_1_end":739,"scene_coco_tv":761,"coco_popcorn_moment":837,"coco_popcorn_shared_text":848,"coco_end_scene":922,"scene_haneul_drums_sexy":932,"haneul_reaction_check":1084,"haneul_drum_lesson":1107,"night_1_fin":1198,"scene_minjae_garden":1203,"bedroom_scene":1296,"bedroom_desc_end":1310,"bedroom_talk_end":1346,"day_2_morning_reveal":1351,"pool_party_announcement":1410,"day_2_afternoon":1488,"scene_gym_kang":1506,"kang_conversation_serious":1531,"scene_garden_jiwon":1551,"jiwon_conversation":1570,"scene_gameroom_rio":1586,"rio_game_moment":1603,"day_2_night":1623,"day_3_morning":1641,"day_3_night":1683,"day_4_morning":1702,"party_prep":1715,"party_prep_end":1764,"pool_party_start":1771,"visual_reveal_pool":1853,"jiwon_natural_reveal":1899,"swimming_challenge":1978,"pd_secret_reveal":2035,"coco_la_moment":2064,"chicken_fight_setup":2134,"zen_chicken_observation":2190,"choose_partner_normal":2233,"pd_announcement":2432,"chicken_fight_start":2436,"chicken_fight_mechanics":2458,"victory_dance_end":2503,"synchronization_end":2597,"chicken_fight_outcome":2601,"victory_post_hug":2635,"victory_pd_comment":2656,"defeat_reaction_start":2679,"defeat_common":2689,"pool_party_aftermath":2694,"coco_confrontation":2838,"pool_party_cut":2919,"night_choices":2947,"yuri_resolved":3055,"balcony_scene_start":3064,"scene_noa_romance":3087,"scene_noa_friend":3151,"scene_noa_low":3181,"noa_siblings_talk":3223,"after_entry_comment":3297,"sleep_before_morning":3354,"day_5_start":3360,"benji_secret_scene":3371,"sumin_finale":3409,"noa_pov_end":3543,"exit_pool":3677,"day_6_living_room":3687,"eden_nods_text":3742,"breakdown_description":3784,"eden_session_end":3818,"focus_group_final_fixed":3820,"item_2_focus":3887,"item_3_focus":3925,"post_ro_scenes":4081,"day_8_the_complete_sanctuary":4141,"choose_partner_final":4166,"mirror_phase":4219,"final_romance":4305,"final_gentle":4321,"final_hesitant":4329,"final_professional":4337,"final_rivalry":4345,"exercise_end_final":4354,"minjae_pov_start":4384,"sanctuary_scene":4408,"start_narrative":4440,"minjae_romance_reaction":4454,"minjae_neutral_reaction":4458,"the_switch":4462,"update_1_finale":4475},"lines":["*label chapter3_solo","*image header_villa.png center","*set chapter 3","","[b]CHAPTER 3: THE VILLA[/b]","","","*if (entry_method = \"medical_wildcard\")","    *goto intro_medical_ride","*elseif (entry_method = \"villain\")","    *goto intro_villain_ride","*else","    *goto intro_merit_ride","","*label intro_medical_ride","","","The leather seat of the Rolls Royce is soft, but your body is stiff with pain.","Rain streaks the tinted windows, blurring the world outside.","","Next to you, Noa is checking her reflection in a compact mirror.","Up close, she looks different. The heavy stage makeup hides the fatigue, but you can hear her breathing  it's slightly heavy, a faint wheeze in her throat.","","\"We're here,\" she says, snapping the mirror shut.","She turns to you. The warmth from the alleyway is gone. Her eyes are now sharp, professional.","","\"Listen to me. I brought you in, but I can't carry you up the stairs.\"","She reaches out, smoothing a stray hair from your forehead with a touch that is surprisingly gentle.","\"The moment that door opens, I am the Host. And you are just another contestant. Don't look at me for help.\"","","The car slows to a halt on the gravel.","\"Showtime,\" she whispers.","*goto viewing_the_villa","","*label intro_villain_ride","","The PD grins at you from the front seat.","\"You know why Noa agreed to the Wildcard? She likes broken things.\"","He parks the van aggressively.","\"But be careful. She plays with her toys until she gets bored. Don't be boring.\"","*goto viewing_the_villa","","*label intro_merit_ride","","The bus rumbles over the gravel. The air is thick with tension.","Rio is bouncing his leg nervously. \"I feel like I'm going to throw up,\" he mutters.","\"We're here!\" the PD yells. \"Cameras are rolling!\"","*goto viewing_the_villa","","*label viewing_the_villa","*page_break The Villa","","Through the window, you see it.","[b]THE VILLA.[/b]","","It is a massive, architectural statement rising from the landscape.","The structure is a striking combination of dark industrial steel fused with polished mahogany panels.","Floor to ceiling glass walls stretch across the entire facade, offering an unobstructed view of the pristine marble interior lit by chandeliers.","","To your left, a wide infinity pool glows soft blue with underwater LEDs.","To your right, a curated garden features tall, lush tropical palm trees.","Steam rises faintly from the soil around them  evidence of the industrial heat lamps keeping the tropical plants alive in the Korean climate.","","At the top of the stone stairs awaits the main entrance: colossal double doors made of reinforced glass and intricate gold filigree, twisted into complex geometric patterns.","","It is undeniable in its scale and detail.","How do you feel looking at it?","","*choice","    # It's incredible. This is the life I was born for.","        *set motivation \"Ambition\"","        *set visual %+5","        *set self_belief %+5","        You stare at the gold doors.","        The basement dorms are a distant memory. You belong here, among the expensive things.","        *goto exiting_the_vehicle","","    # It's overwhelming. It feels like a golden cage.","        *set rebellion %+5","        *set ruthless %+5","        The tropical trees, the heat lamps, the gold... it feels like a set designed to trap you.","        It's just a prettier prison than the last one.","        *goto exiting_the_vehicle","","    # I'm indifferent. It's just a location.","        *set the_mask %+5","        You shrug.","        Marble floors or concrete floors  it doesn't matter. You are here to work, not to admire the architecture.","        *goto exiting_the_vehicle","","    # I'm intimidated. I don't belong in a place like this.","        *set per_gentle %+5","        *set stress %+5","        You grip your cheap bag tighter.","        Everything here looks expensive and breakable. You feel small standing next to it.","        *goto exiting_the_vehicle","","*label exiting_the_vehicle","*page_break The Arrival","","*if (entry_method = \"medical_wildcard\")","    The chauffeur opens your door.","    You step out of Noa's car onto the wet gravel.","    ","    The other trainees are already standing there in the rain with their luggage. They stare at you.","    You can practically feel their jealousy burning holes in your back. You aren't just a trainee you're the \"Teacher's Pet\" who arrived in a Rolls Royce.","    ","    Noa steps out from the other side. She fixes her dress, ignoring you completely, and glides up the stairs, disappearing through the golden doors.","    ","    You take your place in the ragged line of trainees, your heart hammering against your ribs.","    *goto convergence_start ","","*else","    You step out into the humid night air from the transport bus.","    You stand in a ragged line with the others, staring up at the entrance.","    *goto convergence_start","","*label convergence_start","*page_break The Doors Open","","Suddenly, the golden doors swing open.","Mist pours out, illuminated by hidden floor lights.","And then, she steps out. [b]NOA.[/b]","","*if (entry_method = \"medical_wildcard\")","    She is wearing a silk robe that flows behind her like liquid gold. ","    To the crowd, she is a goddess. ","    ","    But your eyes, already trained to look past her mask, catch the details she chose for herself. ","    ","    Over the delicate silk of her left sleeve, she has buckled a heavy, vintage gold watch a mans piece, oversized and utilitarian. Its a power move, a reminder that she is the one who keeps the time in this villa. ","    ","    From her right ear hangs a single, mismatched silver earring a sharp, geometric drop that catches the light like a blade. ","    ","    As she descends the stairs, she doesn't just walk she commands. Her deep brown eyes lock onto yours for a split second.","    *goto convergence_meeting","","*else","    She is wearing a silk robe that flows behind her like liquid gold, appearing like a goddess descending from Olympus.","    ","    But as she gets closer, the \"soft\" image sharpens. ","    ","    You notice the expensive vintage watch strapped firmly over her silk cuff, and the singular, heavy silver earring that gives her feminine grace a dangerous, modern edge. ","    ","    She carries herself with an effortless authority that makes the other trainees straighten their posture instinctively. ","    *goto convergence_meeting","","*label convergence_meeting","She descends the stairs, walking straight into the crowd.","Noa stops in front of the group.","She grabs Rio's face with both hands, squishing his cheeks.","\"Look at you,\" she coos, her eyes sparkling with exaggerated warmth. \"So fresh! So edible!\"","","She moves down the line, touching shoulders, fixing hair.","\"I fought for every single one of you,\" she says, her voice dripping with affection. \"You are my chosen ones. I love you already.\"","","She smiles a smile that reaches her eyes and makes you feel like the most important person in the world.","Then, she steps back.","","She doesn't turn cold. She turns [b]Grand[/b].","She spreads her arms wide, framing the massive Villa behind her. The cameras zoom in. The lighting seems to shift, casting her in a heroic glow.","","\"But we are not just here to make friends,\" she projects, her voice booming with professional authority.","\"Welcome to [b]PROJECT: SUPERNOVA[/b].\"","","She points a manicured finger at the sky.","\"30 Trainees enter these gates. But only [b]7[/b] will leave as Icons.\"","","She begins to pace in front of the line, her voice weaving a spell.","\"The final 7 will sign an exclusive global contract with Titan Entertainment. You will record an album produced by the legendary Eden. You will embark on a World Tour before the year ends.\"","","She stops and looks directly into the camera, then back at you.","\"This isn't just a debut. This is a coronation. We are looking for the next Kings and Queens of K-Pop.\"","","She leans in, her expression intense but encouraging.","\"The world is watching. Don't just show them your talent. Show them your Grit.\"","","A beat of silence. The gravity of the moment hangs in the air.","","Then, she tilts her head to the side, breaking the tension with a sharp, cat like grin.","It isn't the smile of a benevolent host. It's the smile of a winner.","","\"But you can't conquer the world on an empty stomach,\" she says, her voice regaining that cool, effortless texture.","","She turns towards the golden doors, glancing back over her shoulder with a look that says [i]Catch me if you can[/i].","","\"Come inside, [i]Jagi-deul[/i],\" she beckons.","\"Let's see if you can handle the real world.\"","","*label entering_the_villa_interior","*gosub_scene social_logic check_rank","*page_break The Grand Hall","","You step through the golden doors. The interior is blinding marble and gold.","Robot cameras move along tracks on the ceiling. Every move is being recorded.","","Noa stands on a grand staircase.","\"Cut!\" the PD yells. \"Okay, settle in. We start the First Mission in 10 minutes.\"","","There is a massive digital leaderboard on the wall.","[b]YOUR RANK: ${rank_title}[/b]","[b]FOLLOWERS: ${followers}[/b]","","Noa claps her hands.","\"The public has a short attention span,\" she announces. \"We need to fix that.\"","","[b]MISSION 1: THE INTRODUCTION[/b]","","*if (entry_method = \"medical_wildcard\")","    *goto mission_medical","*else","    *goto mission_merit","","*label mission_medical","A staff member approaches you.","\"${name}? Noa-ssi said you are exempt from the physical showcase. You only do the Interview segment.\"","*goto interview_booth","","*label mission_merit","The PD nods at you.","\"${name}, since you survived the Titan cull, you get the full slot. First, the Interview. Then, the Freestyle Performance.\"","*goto interview_booth","","*label interview_booth","*page_break The White Room","","You step into the small white booth.","Instead of a camera crew, you find Noa.","She is sitting in the director's chair, perfectly still, simply waiting.","","As you sit down, she offers you a small, graceful smile. It reaches her eyes, warm and inviting.","\"Hello, darling,\" she says softly. \"I wanted to see you myself.\"","","\"Tell me... how would you describe yourself in one word?\"","","*choice","    *selectable_if (eating_disorder_flag = false) # \"Hungry.\" ","        *set charisma %+10","        *set intro_style \"Funny\"","        *set rel_noa %+10","        *set followers +800","        ","        \"Hungry,\" you say with a straight face. \"Actually, starving. Is there catering?\"","","        Noa freezes. She glances quickly at the PD behind the glass, then leans in close, dropping her \"Host\" voice completely.","        ","        [i]\"Right?!\"[/i] she whispers, her eyes widening like a conspirator. [i]\"I have a protein bar hidden in my boot. If this takes ten more minutes, I am eating it.\"[/i]","        ","        She sits back instantly, clearing her throat and fixing her posture. The mask is back on.","        [i]\"Ambition,\"[/i] she says loudly for the cameras. [i]\"A very metaphorical answer. Good.\"[/i]","        *goto question_2","","    # \"I am done with this interview.\"","        *set rebellion %+20","        *set scandal_risk %+10","        *set ruthless %+5","        *set intro_style \"Rebel\"","        *set followers +3500","        *set treasure \"Unknown\"","        *set rel_noa %-10","        ","        You stand up abruptly. \"This is boring,\" you mutter. \"Google me when I am famous.\"","        ","        You turn to leave. Noa doesn't get angry. She just rolls her eyes.","        ","        [i]\"Wow. So edgy,\"[/i] she deadpans, looking at her nails. [i]\"Don't trip on the cable on your way out, Rockstar.\"[/i]","        *goto interview_end","","    # \"Artist.\" ","        *set per_gentle %+5","        *set vocals %+5","        *set intro_style \"Sweet\"","        *set followers +600","        *set rel_noa %+5","        ","        You smile softly. \"I paint with sound. That is all I know.\"","        ","        Noa blinks. She stares at you for a long second, then scrunches her nose slightly.","        ","        [i]\"Okay, Shakespeare,\"[/i] she teases, a playful glint in her eyes. [i]\"That was really cheesy. But...\"[/i]","        She tilts her head, looking at you with genuine warmth.","        [i]\"...you actually made it sound cool. I hate that I liked it.\"[/i]","        *goto question_2","","    # \"Icon.\"","        *set visual %+5","        *set the_mask %+5","        *set intro_style \"Visual\"","        *set followers +1000","        *set rel_noa %+5","        ","        You simply wink. No explanation needed.","        ","        Noa raises an eyebrow. She doesn't say a word.","        Instead, she strikes a pose chin up, heavy eyelids. A silent \"Vogue\" challenge.","        ","        You hold your pose. She holds hers. The visual tension is insane.","        Finally, she breaks into a small, impressed laugh.","        ","        [i]\"Okay, I see you,\"[/i] she admits, checking her reflection in the camera lens. [i]\"But don't steal my light, Agaya. I bite.\"[/i]","        *goto question_2","","*label question_2","\"One last thing. Tell me about your Treasure. The one thing you would save from a fire.\"","","*choice","    # An iPod Classic. My dad won it in a raffle.","        *set treasure \"iPod Classic\"","        *set vocals %+5","        *set rel_father %+10","        *set followers +500","        *set rel_noa %+5","        ","        \"It is old,\" you admit. \"But it reminds me of my dad.\"","        ","        Noa looks at the device. Her smile turns slightly sad.","        [i]\"I always wanted one of those when I was a kid,\"[/i] she says softly.","        [i]\"You won. Treasure that.\"[/i]","        *goto interview_end","","    # My worn-out dance shoes. They have bled with me.","        *set treasure \"Dance Shoes\"","        *set dance %+5","        *set physical %+5","        *set followers +500","        *set rel_noa %+5","        ","        \"They prove I worked harder than anyone else,\" you say.","        ","        Noa sighs. She starts talking, fast.","        [i]\"Hard work is essential, yes, but you need to know when to stop. The body is an instrument, not a machine...\"[/i]","        ","        You try to listen, but her voice fades into a buzz. [i]Bla bla bla... rest...[/i]","        ","        Suddenly, a warm hand covers yours. Noa is staring at you.","        [i]\"Did you hear me?\"[/i] she asks.","        ","        You nod quickly. \"Good\" she says, releasing your hand.","        *goto interview_end","","    # My grandmother's silver locket. It keeps me grounded.","        *set treasure \"Grandma's Locket\"","        *set per_gentle %+10","        *set rel_mother %+5","        *set followers +700","        ","        You touch your neck. \"It is the only piece of home I have left.\"","        ","        Noa tilts her head. She looks genuinely curious. [i]\"Can I see it?\"[/i] she asks.","","        *choice","            # Lean in and show her.","                *set rel_noa %+15","                *set social_special_moment true","                ","                You lean over the table. Noa stands up and walks around the table.","                She reaches out, her fingers brushing against your skin as she holds the pendant.","                ","                [i]\"Pretty,\"[/i] she whispers, looking into your eyes.","                *goto interview_end","","            # Politely decline. It is too personal.","                *set the_mask %+5","                \"I would rather keep it close,\" you say politely.","                Noa shrugs. [i]\"Fair enough. Secrets are valuable too.\"[/i]","                *goto interview_end","","    # A faded family photo. It reminds me who I am fighting for.","        *set treasure \"Family Photo\"","        *set rel_father %+5","        *set rel_mother %+5","        *set followers +600","        ","        \"I am going to change our lives,\" you say. \"They sacrificed everything for me.\"","        ","        Noa's expression tightens. She leans in, speaking suddenly and quickly.","        [i]\"That is a dangerous fuel, darling. When you become the provider, the dynamic shifts. Love becomes transactional. You start resenting the very people you are trying to save...\"[/i]","        ","        You try to listen, but her voice fades into a buzz. [i]Bla bla bla... burden... money...[/i]","        You are just thinking about buying your mom a house. You don't care about the philosophy.","        ","        Suddenly, a sharp tap on your hand. Noa is staring right into your soul.","        [i]\"Are you listening?\"[/i] she demands, her voice low.","        ","        You blink, nodding quickly.","        [i]\"Good,\"[/i] she says, pulling back. [i]\"Don't set yourself on fire just to keep them warm.\"[/i]","        *goto interview_end","","    # My smartphone. An Idol must always be connected.","        *set treasure \"Smartphone\"","        *set ruthless %+5","        *set the_mask %+5","        *set followers +400","        *set rel_noa %-5","        ","        \"My fans are in here.\"","        Noa rolls her eyes with a cynical smile.","        [i]\"You will get tired of it. Trust me. I know I did.\"[/i]","        *goto interview_end","","*label interview_end","\"Thank you, darling,\" Noa says.","The smile is flawless, but the intimacy is gone. She simply looks through you, towards the door.","\"Next,\" she calls out softly.","","*goto check_performance_status","","*label check_performance_status","*if (entry_method = \"medical_wildcard\")","    *goto medical_sit_out","*else","    *goto performance_stage","","*label medical_sit_out","You stumble out of the booth. The medic guides you to a bench.","While the others head to the stage, you just sit there, watching.","","*if (visual >= 50)","    The camera pans to you. You look tragic and beautiful in your pain.","    [i](System: Your Wounded Beauty visual goes viral.)[/i]","    *set followers +1000","    *set performance_type \"Injured_Visual\"","    *goto post_challenge_social_update","*else","    The camera ignores you.","    *set stress %+10","    *set performance_type \"Skipped\"","    *goto post_challenge_social_update","*label performance_stage","*page_break The Freestyle Stage","","You step onto the black marble floor. The other trainees are watching.","What do you show them?","","*choice","    # I Dance. Explosive energy.","        *set physical %-10","        *set performance_type \"Dance\"","        *if (dance >= 40)","            You move like water. Every pop, every lock is precise.","            *set followers +2500","            *set dance %+5","            ","            *if (rel_rival >= 35)","                *set followers +500","                Coco watches from the sidelines, ${r_his} arms crossed. For a split second, the bored mask slips, replaced by a genuine, sharp assessment. \"Not bad, ${name},\" ${r_he} murmurs loud enough for the camera to catch. \"But don't think you've won the center yet.\" ","            ","            *if (rel_kang >= 35)","                *set followers +300","                [b]Kang[/b] gives a single, heavy nod of approval. $!{kang_he} doesn't smile, but you catch ${kang_him} tracking your footwork with the intensity of a scout. \"Solid technique,\" ${kang_he} grunts. \"You didn't waste your energy.\" ","            ","            *goto post_challenge_social_update","        *else","            You try a move but stumble slightly.","            *set followers +500","            *set stress %+5","            *goto post_challenge_social_update","","    # I Sing. An emotional ballad.","        *set physical %-5","        *set performance_type \"Vocal\"","        *if (vocals >= 40)","            You hit the high note with crystal clarity.","            *set followers +2500","            *set vocals %+5","            ","            *if (rel_haneul >= 35)","                *set followers +500","                [b]Haneul[/b] closes ${h_his} eyes for a moment, letting the resonance of your voice hit. When $!{h_he} opens them, there's a look of quiet surprise in ${h_his} gaze. \"The frequency is stable... and the emotion is real,\" $!{h_he} whispers. \"Very impressive, ${name}.\" ","            ","            *if (rel_jiwon >= 35)","                *set followers +300","                [b]Jiwons[/b] mouth falls open slightly. ${jiwon_He} looks at Yuri, then back at you, a mix of awe and motivation in ${jiwon_his} eyes. \"That high note... I felt that in my chest,\" ${jiwon_he} breathes out, offering you a small, supportive thumbs-up. ","            ","            *goto post_challenge_social_update","        *else","            Your voice is thin in this big room.","            *set followers +500","            *goto post_challenge_social_update","","    # I Rest. I save my energy for the long game.","        *set performance_type \"Rest\"","        *set ruthless +5","        You take the mic. \"I will show you my skills when it counts.\"","        *if (charisma >= 45) or (the_mask >= 50)","            *set followers +1200","            *goto post_challenge_social_update","        *else","            *set followers -200","            *goto post_challenge_social_update","*label post_challenge_social_update","*gosub_scene social_logic generate_chapter3_comments","","Noa steps forward.","\"Cut! That's a wrap for Day 1. Go get some rest. Results will be posted tomorrow morning.\"","","*line_break","[b]SYSTEM: YOU HAVE NEW COMMENTS ON NAVER.[/b]","[i](Check the Stats Screen to view your Social Feed)[/i]","","*page_break End of Day 1","*label room_selection","*page_break The Dorms","","The staff leads you to the hallway. There are three doors, each with a handwritten list of names taped to it.","You have to choose where to sleep. This choice will determine who you spend your nights with for the rest of the show.","","*choice","    # The 'Playful' Room (Roommates: Rio & Coco).","        *set room_vibe \"Playful\"","        *set rel_rio %+5","        *set rel_rival %+5","        You hear loud bass thumping from inside before you even open the door.","        Rio is already jumping on the bed, and Coco is trying to set up a mini-basketball hoop on the doorframe.","        \"Party room!\" Rio yells, high-fiving you. \"No sleep allowed!\"","        *goto night_1_hub","","    # The 'Serious' Room (Roommates: Jiwon & Kang).","        *set room_vibe \"Serious\"","        *set rel_jiwon %+5","        *set rel_kang %+5","        You walk into a room the vibe screams focus.","        Kang is already unpacking his vitamins in alphabetical order. Jiwon is reading the rulebook with a highlighter.","        \"We are here to win,\" Kang says, nodding at you. \"Lights out at 10 PM sharp.\"","        *goto night_1_hub","","    # The 'Peaceful' Room (Roommates: Haneul & Yuri).","        *set room_vibe \"Quiet\"","        *set rel_haneul %+5","        *set rel_yuri %+5","        You open the door to pure silence.","        Haneul is meditating in the corner. Yuri is arranging a vase of dried flowers on the nightstand.","        \"Welcome,\" Yuri whispers. \"Please leave your shoes and your stress at the door.\"","        *goto night_1_hub","","*label night_1_hub","*page_break Night 1","","The camera crews have retreated to the perimeter. For the first time, the trainees are alone in the Villa.","And honestly? It's insane.","","It's not a prison. It's a playground.","The kitchen is stocked with food you can't afford, the furniture costs more than your parents' car, and the air conditioning smells like lavender.","","Most trainees are running around touching things, checking if they're real.","","*label night_1_choices","*choice","    *disable_reuse #Kang is by the pool table, lining up a shot alone.","        You walk over to the billiards area. Kang is leaning over the green felt, focused. Click. The cue ball strikes, sinking a striped ball into the corner pocket.","","        $!{kang_he} doesn't look up, but ${kang_he} chalks ${kang_his} cue. \"Penthouse,\" ${kang_he} says suddenly.","        \"Excuse me?\"","        \"That's what I'm buying when I win,\" ${kang_he} straightens up, looking at you. \"Top floor in Gangnam. Floor-to-ceiling windows. What about you? What's the first thing you buy?\"","","        *choice","            #\"A house for my parents. They've sacrificed enough.\"","                *set rel_kang %+ 10","                *set per_gentle %+ 5","                $!{kang_he} nods, a rare look of softness in ${kang_his} eyes. \"Respect. That's... yeah. That's the real goal.\"","                *goto night_1_choices","            #\"A private island. I want to be as far away from people as possible.\"","                *set rel_kang %+ 5","                $!{kang_he} chuckles, lining up the next shot. \"I get that. Invite me when you get sick of the silence.\"","                *goto night_1_choices","            #\"I'm not thinking about the money. I just want the title.\"","                *set rel_kang %- 5","                $!{kang_he} pauses. \"You can't live in a title. Be practical.\"","                *goto night_1_choices","","    *disable_reuse #Jiwon is standing in front of the Smart Fridge, mesmerized.","        Jiwon is waving ${jiwon_his} hand in front of the refrigerator door. The screen lights up, showing the weather and a recipe for avocado toast.","        \"It talks,\" ${jiwon_he} whispers, eyes wide. \"Did you hear that? It greeted me.\"","        ","        $!{jiwon_he} presses a button and ice cubes clatter into a glass. \"Unlimited ice. It's magic.\"","","        *choice","            #\"It's just a fridge, Jiwon.\"","                *set rel_jiwon %+ 5","                \"It's not a fridge. It's a robot butler that feeds us.\"","                *goto night_1_choices","            #\"Ask it if it knows who is going to win the show.\"","                *set rel_jiwon %+ 10","                $!{jiwon_he} giggles. \"Hey Fridge, am I going to debut?\" The fridge beeps. \"It said yes! I think.\"","                *goto night_1_choices","            #\"Grab me a soda while you're worshipping the machine.\"","                *set rel_jiwon %+ 5","                $!{jiwon_he} tosses you a can. \"Sparkling water. Fancy.\"","                *goto night_1_choices","","    *disable_reuse #Rio is behind the DJ booth, pressing every button at once.","        \"Check 1, 2! Check!\" Rio's voice booms through the expensive surround sound system.","        ${rio_he} is wearing huge headphones and messing with the mixer.","        ","        \"This bass goes so low it vibrates my soul,\" ${rio_he} grins at you. \"I think I just accidentally ordered pizza with this button. Or launched a missile. Either way, cool.\"","","        *choice","            #\"Play something wild. Let's work on my twerk.\"","                *set rel_rio %+ 10","                *set dance %+ 5","                Rio drops a heavy beat. You do a quick attempt to wiggle. \"Yesss! That's the energy!\" RIO SHOUTS.","                *goto night_1_choices","            #\"Careful, you'll blow the speakers.\"","                *set rel_rio %- 5","                ${rio_he} rolls ${rio_his} eyes. \"These speakers can handle armageddon. Live a little!\"","                *goto night_1_choices","            #\"Can you remix the doorbell sound?\"","                *set rel_rio %+ 15","                *set charisma %+ 5","                Rio laughs. \"Challenge accepted. Let's make it a trap beat.\"","                *goto night_1_choices","","    *disable_reuse #Yuri is in the lounge, arranging throw pillows for a photo.","        Yuri isn't taking a selfie. ${yuri_he} is staging the room.","        \"If we move this lamp here... and throw this blanket casually there...\"","        ${yuri_he} steps back. \"It looks like a catalogue. Come sit here. We need to look like we're candidly relaxing.\"","        ","        ${yuri_he} laughs. \"I've never been this relaxed in my life. This sofa is swallowing me.\"","","        *choice","            #\"I'm diving in.\" ","                *set rel_yuri %+ 10","                You flop onto the cushions. Yuri snaps a picture instantly. \"Perfect. Natural chaos.\"","                *goto night_1_choices","            #\"Is this velvet? I feel expensive just sitting here.\"","                *set rel_yuri %+ 5","                \"Right? I feel like I should be holding a poodle.\"","                *goto night_1_choices","            #\"You're obsessed.\"","                *set rel_yuri %- 5","                \"I'm thankful. There's a difference.\"","                *goto night_1_choices","","    *disable_reuse #Eden (The Mentor) is nowhere to be seen. I should check the balcony.","        *goto eden_villa_night","","    #The excitement is draining me. I need to end the night.","        *goto night_1_end","","*label eden_villa_night","*comment --- SCENE: EDEN ON THE BALCONY ---","","The glass door slides shut with a heavy click, finally cutting off the thumping bass from the living room. You step out onto the massive balcony, the cool night air hitting your skin.","","*if per_gentle > 50","    You lean against the cold glass, letting out a long breath. The vibe inside is chaotic, too much noise. You just needed a moment of silence before your head exploded.","    *goto see_eden","*else","    You walk to the edge, resting your hands on the railing. This isn't just a house, it's a statement. You look out at the skyline, already imagining the day a view like this belongs to you.","    *goto see_eden","","*label see_eden","But you aren't alone.","","Eden is leaning against the far railing, a silhouette against the city lights. The red edge of his cigarette burns bright in the darkness. He doesn't turn immediately, letting the silence stretch, before finally glancing over his shoulder.","","*if rel_eden > 30","    \"Agaya,\"","    *goto eden_greeting_continue","*else","    \"Hakseng,\"","    *goto eden_greeting_continue","","*label eden_greeting_continue","he greets, his voice smooth, carrying a hint of smoke. \"Good to have you here with us. I've always liked your Je Ne Sais Quoi and those...\"","","*temp flavor_text \"tenacity\"","*if (vocals > dance) and (vocals > charisma)","    *set flavor_text \"vocals. That voice of yours cuts right through the noise\"","    *goto flavor_text_set","*elseif (dance > vocals) and (dance > charisma)","    *set flavor_text \"lines. You don't just move, you command the space\"","    *goto flavor_text_set","*elseif (charisma > vocals) and (charisma > dance)","    *set flavor_text \"vibes. You take up space without even trying\"","    *goto flavor_text_set","*else","    *goto flavor_text_set","","*label flavor_text_set","\"${flavor_text}.\" He turns fully toward you, ash falling from his cigarette. \"Are you ready for the gauntlet?\"","","*choice","    #\"I'm not sure yet, but I'll try my best.\"","        Eden takes a deep, slow inhale. He purses his lips, blowing a perfect ring of smoke that drifts into the night air before dissolving. He stares up at the empty, starless sky.","        ","        \"Aren't we all...\" he murmurs, his voice dripping with a quiet exhaustion.","        *goto eden_reaction","","    #\"Are you Halbae (old man)?\"","        Eden chokes. The smoke catches in his throat, and he coughs, startled out of his pose. He tilts his head, eyes widening, and then bursts into a genuine, sharp laugh.","        ","        \"Well, aren't you a peach?\" He wipes a tear from his eye, a crooked grin staying on his face. \"It's fun. Maybe I'll keep you around.\"","        *set rel_eden %+ 5","        *goto eden_reaction","","    #\"I'm always ready.\"","        Eden stares at you, his expression flattening instantly. He drops the cigarette to the expensive tiles, crushes it under his heel and quietly turns away.","        ","        He walks past you back inside, as if you aren't even worth a response.","        *set rel_eden %- 10","        *goto night_1_choices","","    #\"Depends on who will be cheering for me.\"","        Eden stops. The idol mask slips for a second, and he looks at you, really looks at you with a strange intensity.","        ","        \"Friends come and go,\" he says quietly, starting to chisanbop (count on his fingers). \"But the music you write, produce, and set out to the world? That is forever. Don't you forget that, ${name}.\"","        *goto eden_reaction","","*label eden_reaction","He leans back against the railing, crossing his arms. He doesn't seem in a rush to leave just yet.","","*choice","    #Stare at the stars next to Eden.","        You join him at the railing, looking up.","        ","        \"They're pretty, aren't they?\" Eden asks softly. \"But it's a lie. You're seeing light from three thousand years ago. They're already gone.\"","        ","        You immediately think about Jun.","        (Salt in the wound much?!)","        ","        Before you can answer, he pushes off the railing and walks away, leaving you alone in the dark without a goodbye.","        *goto night_1_choices","","    #Complain about the smell.","        \"Whatever. I was done with it anyway.\"","        ","        He flicks the cigarette butt onto the pristine patio floor with deliberate carelessness. As he walks away, he lazily raises a hand, giving you the middle finger over his shoulder.","        *goto night_1_choices","","    #Try to charm him into giving me a leg up.","        *if rel_eden > 40","            Eden hums, scanning you from head to toe. \"I'll give you a hint: don't skip your skincare that week,\" he says cryptically.","        *goto night_1_choices","        *else","            Eden smirks, shaking his head with a sneer. \"Young ones these days. Don't you have any decency?\"","            He looks one last time upwards and then, as if you didn't just talk for the last few minutes, he simply walks into the villa.  ","        *goto night_1_choices","","*label night_1_end","*page_break Bedtime","","The lights in the main hall dim automatically. The day is finally ending.","You head towards your room, but you stop. The hallway is not empty.","","*choice","    # I hear shouting and weird noises coming from the Media Room.","        ","        *goto scene_coco_tv","","    # [i]Heol.[/i] This hallway is giving me major first victim vibes. It is a total trap. (But let's be real, you are not here to be a survivor. You are here for the Plot. Go on, make a bad decision.)","        ","        *goto scene_haneul_drums_sexy","","    *selectable_if (rel_minjae >= 50) # I saw a shadow sneaking out to the west garden...","        ","        *goto scene_minjae_garden","","    # Just go to my room. I am exhausted.","        *goto bedroom_scene","","*label scene_coco_tv","*temp r_s \"s\"","*temp r_es \"es\"","*temp r_don \"doesn't\"","*if (r_he = \"they\")","    *set r_s \"\"","    *set r_es \"\"","    *set r_don \"don't\"","*disable_reuse","","You follow the flickering blue light into the small media lounge.","Coco is huddled on the floor, wrapped in a blanket like a burrito, inches away from the massive TV screen.","","On the screen, people with questionable spray tans are screaming at each other in a thick, incomprehensible British accent. One of them throws a drink.","It's 'Geordie Shore' you realize. The British version.","","\"Come on, Gary!\" Coco whispers aggressively at the screen. \"Don't text her! She's toxic, mate! Proper mental!\"","","You lean against the doorframe, raising an eyebrow.","\"Geordie Shore? Really?\"","","Coco jumps${r_s} so hard ${r_he} nearly drops${r_s} the remote. ","When ${r_he} sees${r_s} it's you, ${r_he} freezes${r_s}, eyes wide.","You step into the room, pointing at the screen.","\"You're the LA Royalty here. Shouldn't you be watching 'Jersey Shore' instead? You know... supporting the local troops?\"","","Coco blink${r_s} rapidly. The panic on ${r_his} face is genuine for a split second, \"${r_he} realizes ${r_he} slipped into the wrong slang.","","\"I... uh...\" Coco stammer${r_s}, quickly putting on a mask of defensive arrogance.","\"Jersey Shore is for amateurs, darling. Basic.\"","${r_He} waving a hand dismissively, recovering ${r_his} American drawl.","\"True connoisseurs of trash TV know that the British invent the best garbage. It's... anthropological research. Yeah. Research.\"","","${r_He} let${r_s} out a long breath, pulling the blanket tighter.","\"You caught me smuggling contraband culture. If the PD sees this, he'll probably exorcise the TV.\"","","${r_He} gesture${r_s} to the spot next to ${r_him}. \"Sit. I managed to hack the VPN. We have about 20 minutes before the firewall resets.\"","","*choice","    # \"Whatever you say. Please tell me that's Season 12?\"","        *set rel_rival %+ 10","        *set charisma %+ 5","        ","        You decide not to push on the 'LA vs UK' thing. Everyone has secrets.","        ","        Coco's eyes light up, relieved you dropped it. \"A person of culture! Yes! It's the episode where they fight over a kebab.\"","        ","        You sit down. For the next ten minutes, you aren't trainees fighting for your lives. You are just two kids laughing at people making bad decisions.","        \"God, look at them,\" Coco sigh${r_s} happily. \"They are so messy. It's beautiful. No choreography, just chaos.\"","        *goto coco_popcorn_moment","","    # \"Are you okay? You look like you're trying to escape.\"","        *set rel_rival %+ 10","        *set per_gentle %+ 5","        ","        Coco pause${r_s}. The smile on ${r_his} face flicker${r_s}.","        \"Escape? Maybe.\"","        ","        ${r_he} look${r_s} at the screen, where everyone is hugging in a club in Newcastle.","        \"It's just... everyone here speaks so politely. Even when they hate you, they use formal language.\"","        ","        ${r_He} gesture${r_s} at the screaming Brits on TV.","        \"I just needed to hear someone scream 'Wot the f***' without filtering it. It sounds like...\"","        ${r_He} stops ${r_him}self before saying 'home'.","        \"...like freedom.\"","        *goto coco_popcorn_moment","","    # \"You know the staff can track the viewing history, right?\"","        *set rel_rival %- 5","        *set ruthless %+ 5","        ","        Coco roll${r_s} ${r_his} eyes, regaining ${r_his} composure.","        \"Let them watch. Maybe you guys will learn how to have fun.\"","        But ${r_he} nervously glance${r_s} at the door. The mood is broken.","        *goto coco_popcorn_moment","","*label coco_popcorn_moment","Coco reach${r_es} under the blanket and pulls out a plastic bowl.","\"I raided the pantry,\" ${r_he} whisper${r_s}. \"Microwave popcorn. The cheap stuff.\"","","*if (eating_disorder_flag)","    The smell of artificial butter fills the small space. To you, it smells like a shot of nitrous in a leaking tank. A volatile, high-stakes temptation that hits your lungs like the acrid smoke of a dangerous drift. It gives the immediate threat of losing control and spinning out.","    *goto coco_popcorn_shared_text","*else","    The smell of artificial butter fills the small space. It smells comfortable. yum yum.","    *goto coco_popcorn_shared_text","","*label coco_popcorn_shared_text","\"They are fighting over a kebab,\" Coco explain${r_s}, eyes glued back to the screen.","","Without looking, Coco reach${r_es} into the bowl.","At the exact same moment, you reach in too.","","Your hands brush against each other inside the bowl.","Fingers tangle for a split second amidst the warm, salty popcorn.","","*if (eating_disorder_flag = true)","    You freeze.","    The contact doesn't feel romantic. It feels like hitting a wall at a hundred miles an hour.","    ","    You look at the greasy popcorn glistening with oil. Then at Coco's hand.","    Your throat tightens. The smell of the butter suddenly shifts your focus from the 70 inch screen to the 200 calories every ounce of butter costs.","    [i]Calories. Fat. Butter. Grease.[/i]","    ","    You pull your hand back as if you've been burned, clutching it to your chest.","    ","    Coco tear${r_s} ${r_his} eyes away from the screen. ${r_he} see${r_s} your face pale, wide eyed, breathing shallowly.","    \"Hey,\" ${r_he} say${r_s}, voice dropping to a gentle whisper, abandoning the fake American accent for a split second of pure worry.","    \"You okay? You look like you've seen a ghost.\"","    ","    ${r_he} reach${r_es} out, concerned. \"It's just popcorn. Did you chip a tooth or something?\"","    ","    \"I can't,\" you stammer, backing away until you hit the doorframe. \"I have to go.\"","    ","    You turn and run before ${r_he} can see the panic in your eyes.","    \"Wait! ${name}!\"","    You don't stop. You run to the nearest bathroom and wash your hands and face , its ok, but is it? you wonder. you take your time getting back to your room . ","    *goto bedroom_scene","","*else","    The static electricity sparks between you.","    Neither of you pulls away immediately. Your fingers are still touching inside the bowl.","","    *choice","        # Let your hand linger. Make it a moment. ","            *set rel_rival %+ 10","            *set romance_coco true","            *set charisma %+ 5","            ","            You don't grab the popcorn. You just let your fingers rest against the back of ${r_his} hand.","            Coco slowly turn${r_s} to look at you. The chaotic shouting from the TV fades into background noise.","            ","            \"My popcorn,\" ${r_he} whisper${r_s}, but ${r_he} ${r_don} move ${r_his} hand.","            ${r_he} swallow${r_s} hard, ${r_his} usual confidence wavering.","            \"But... I guess I can share.\"","            ","            The tension is thicker than the hair gel on the guidos on the screen. You slowly pull back, holding a single popcorn, maintaining eye contact. Coco looks 3 shades pinker than before you entered the room.","            *goto coco_end_scene","","        # \"Rock, Paper, Scissors for the big piece.\"","            *set rel_rival %+ 10","            ","            You slap ${r_his} hand away playfully. \"I saw that big kernel first. Back off, rookie.\"","            ","            Coco laugh${r_s}, the tension breaking instantly. \"Oh, you want a war? I'm from the streets, darling. I fight dirty.\"","            ","            \"Rock, Paper, Scissors! Shoot!\"","            You end up wrestling over the bowl, spilling half of it on the expensive rug. It's the first time you've laughed for real in days.","            *goto coco_end_scene","","        # Pull back and roll your eyes. \"Personal space, Coco.\" ","            *set rel_rival %- 5","            *set ruthless %+ 5","            ","            You snatch your hand back. \"Watch it. Don't make it weird.\"","            ","            Coco blink${r_s}, looking slightly hurt, then shrug${r_s} it off with a forced grin.","            \"Right. Sorry. Just hungry.\"","            ${r_he} shift${r_s} away from you, creating a wall of distance with the blanket.","            *goto coco_end_scene","","*label coco_end_scene","Coco turn${r_s} off the TV as the credits roll.","\"Thanks,\" ${r_he} say${r_s} quietly.","\"For watching the trash with me.\"","","${r_he} stand${r_s} up, brushing crumbs off ${r_his} pajamas.","\"Tomorrow, we go back to being perfect robots. But tonight? Tonight we are watching orange people fight.\"","*goto bedroom_scene","","","*label scene_haneul_drums_sexy","*disable_reuse","","*comment --- Grammar Setup for NB verbs ---","*temp h_s \"s\"","*temp h_es \"es\"","*temp h_has \"has\"","*temp h_haven \"hasn't\"","*temp h_don \"doesn't\"","*temp h_does \"do\"","","*if (haneul_gender = \"nb\")","    *set h_s \"\"","    *set h_es \"\"","    *set h_has \"have\"","    *set h_haven \"haven't\"","    *set h_don \"don't\"","    *set h_does \"do\"","","The music room is a paradise lost tonight. ( why you ask ?) ","","Haneul is there. But not the cool and calculated Haneul you know.","The person behind the drum kit is lost in a trance of violence and rhythm. ${h_He} ${h_haven} noticed you yet.","","*if (haneul_gender = \"male\")","    He has discarded his shirt somewhere in the corner. His back is to you, muscles rippling under the studio lights with every strike of the snare.","    Sweat traces the line of his spine, soaking into the waistband of his practice pants. He looks powerful, raw=a beast caged in a 5/4 time signature.","    ","*if (haneul_gender = \"female\")","    She is wearing a thin tank top that clings to her damp skin. Her hair is a wild halo around her face, sticking to her neck and collarbone.","    She hits the cymbals with her eyes closed, her chest heaving with every breath. There is something mesmerizing about the way she moves=fluid yet explosive, biting her lower lip in concentration.","","*if (haneul_gender = \"nb\")","    They are a flurry of motion and sharp angles. Sweat drips from their jawline, catching the light like diamonds.","    Their expression is twisted in beautiful agony eyes squeezed shut, brows furrowed. Its the most unguarded, human, and devastatingly attractive you have ever seen them.","","You stand by the door, unseen. The rhythm is deafening.","[i]kick, snare , triple hi-hat a beat down on the toms and then back to an unrelenting beat on the cymbals and kick drum [/i]","","You feel like an intruder, or a perv ( take your pick).","What do you do?","","*choice","    # I stay quiet. I want to watch.","        *set charisma %+5","        *set rel_haneul %+3","        *set stress %-5","        You lean against the doorframe, crossing your arms.","        You let your eyes trace the lines of ${h_his} body, the tension in ${h_his} arms, the sheer focus.","        ","        It takes a full minute before Haneul hit${h_s} the crash cymbal and spin${h_s} the stool around.","        ${h_He} freeze${h_s}.","        ${h_He} see${h_s} the way you are looking at ${h_him}.","        ","        For a second, ${h_he} ${h_don} cover up. ${h_he} just breathe${h_s}, chest rising and falling, staring back at you with dark, dilated pupils. The silence is louder than the drums.","        *goto haneul_reaction_check","","    # I walk up and place a hand on ${h_his} sweating shoulder.","        *set per_bold %+10","        *set rel_haneul %+5","        You don't announce yourself. You just walk into the heat of the room.","        You reach out, your fingers brushing against the damp, hot skin of ${h_his} shoulder.","        ","        Haneul jump${h_s} as if electrocuted.","        ${h_He} spin${h_s} around, eyes wide, almost dropping the sticks.","        \"${name}!\" ${h_he} gasp${h_s}, breathless.","        ","        ${h_He} look${h_s} at your hand, still lingering near ${h_his} skin. ${h_He} ${h_don} pull away.","        \"You... you possess zero survival instincts,\" ${h_he} whisper${h_s}, voice rough. \"Startling a drummer is dangerous.\"","        *goto haneul_reaction_check","","    # I clear my throat loudly. \"Nice beat, Your Highness.\"","        *set per_gentle %+5","        *set rel_haneul %+2","        You decide to break the tension before it suffocates you.","        Haneul snap${h_s} out of the trance instantly. The \"Royal\" mask tries to slide back on, but it slips on the sweat.","        ","        ${h_He} wipe${h_s} ${h_his} face with a towel, hiding ${h_his} expression.","        \"The door,\" Haneul says, voice trying to find its usual calm facade but failing. \"It was... unlocked?\"","        ${h_He} refuse${h_s} to look you in the eye, ears burning red.","        *goto haneul_reaction_check","","    *if (hobby = \"Music\") # I grab the acoustic guitar in the corner.","        If ${h_he} wants to speak in rhythm, I'll answer.","        *set rel_haneul %+12","        *set charisma %+10","        *set vocals %+5","        *set romance_haneul true","        ","        You pick up the beaten up acoustic guitar in the corner.","        You listen to the 5/4 violence ${h_he} is unleashing. It's chaotic, angry.","        You sit on the floor and start with a whisper.","        Finger picking. [i]Em9... Bm7...[/i]","        ","        Soft, liquid arpeggios that slip through the cracks of ${h_his} aggressive snare hits.","        Haneul ${h_don} open ${h_his} eyes.","        The tension in ${h_his} shoulders melt${h_s} instantly. ${h_He} think${h_s} the melody is internal.A soothing hallucination generated by ${h_his} own tired brain to fix the chaos.","        ${h_He} soften${h_s} ${h_his} touch on the hi hat, unconsciously syncing with the \"ghost\" in ${h_his} head.","        For a minute, it's peaceful. Too peaceful.","        You get bored of being a ghost.","        ","        You tighten your grip. You switch from picking to strumming. [i]Strum[/i] C Major. D Major. Open chords.","        The acoustic body resonates like a cannon in the small room.","        ","        Haneul's eyes snap open.","        The hallucination is staring right at ${h_him}.","        ","        Panic flashes across ${h_his} face.","        Not anger, something else that you can't quite decipher yet.","        ","        ${h_His} instinct is to retreat.","        ${h_He} stop${h_s} the kick drum.","        ${h_He} pull${h_s} back, the sticks hovering, ready to end the session and kick you out.","        ","        You don't let ${h_him}.","        Before the silence can settle, you slide your hand up the fretboard. Two frets. [i]Modulation.[/i]","        ","        You hit an F# minor.","        It's not just a chord. It's a musical question. It hangs in the air, unresolved, demanding a resolution.","        Haneul stare${h_s} at you. ${h_His} chest is heaving. ${h_He} know${h_s} ${h_he} should stop.","        But the musician in ${h_him} cannot leave a question unanswered. It goes against ${h_his} code.","        ","        ${h_He} bit${h_s} ${h_his} lip, and surrender${h_s}.","        ${h_He} attack${h_s} the toms. A thunderous, rolling fill that matches your new key.","        ","        You strum harder. ${h_He} play${h_s} faster.","        It's a chase. Em to F#m. Wood against plastic.","        ","        The crescendo builds. It's messy, raw, and desperate.","        Haneul goes for the crash cymbal to end it, a massive, final strike to regain control.","        ","        But ${h_his} hands are shaking. ${h_He} misse${h_s} the sweet spot.","        The stick clips the edge of the metal and flies out of ${h_his} hand.","        ","        CLATTER.","        The stick skids across the floor and hits your shoe.","        The music dies instantly.","        Haneul freeze${h_s}, ${h_his} hand still in the air, grasping at nothing.","        The \"Robot\" just malfunctioned. ${h_He} dropped a stick.","        The ultimate amateur mistake.","        ","        ${h_He} look${h_s} at the stick by your foot, then up at your face. ${h_He} look${h_s} horrified.","        Naked.","        ","        \"You...\" ${h_he} whisper${h_s}, lowering ${h_his} hand slowly. \"You changed the key. I didn't calculate for...\"","        ","        ${h_He} stop${h_s}.","        There is no logical excuse.","        ${h_He} look${h_s} at the empty stool next to ${h_him}, then kicks it toward you with a mix of frustration and defeat.","        \"Sit. Before I realize how embarrassing this is.\"","        *goto haneul_drum_lesson","    ","*label haneul_reaction_check","*if (rel_haneul >= 42)","    Haneul grab${h_s} a water bottle, downing half of it in one go. Throat bobbing.","    ","    \"I usually require absolute isolation for recalibration,\" Haneul says, wiping ${h_his} mouth.","    ${h_He} look${h_s} at you, and the gaze is intense, calculating, but hungry.","    ","    \"But... my data suggest${h_s} your presence improves my performance metrics.\"","    ${h_He} kick${h_s} the stool toward you with a sneaker. It spins and stops inches from your legs.","    \"Sit. I'll teach you the polyrhythm. Don't slow me down.\"","    ","    *goto haneul_drum_lesson","","*else","    Haneul stand${h_s} up abruptly, grabbing a towel to cover ${h_him}self.","    The moment is broken. The walls are back up.","    ","    \"I am in the middle of a private session,\" ${h_he} says coldly, turning away to fiddle with the amp settings.","    \"Please close the door on your way out. I need to focus.\"","    ","    You feel the chill return to the room.","    *goto night_1_fin","","*label haneul_drum_lesson","*comment --- This is the new interaction ---","","You sit on the stool. The space is tight.","Haneul hold${h_s} out the drumsticks.","\"Take them. The grip is fundamental.\"","","How do you handle the lesson?","","*choice","    # I play dumb. I hold the sticks wrong on purpose to make ${h_him} come closer.","        *set rel_haneul %+10","        *set charisma %+5","        *set romance_haneul true","        ","        You pick up the sticks, holding them like hammers. Clumsy. Heavy.","        \"Like this?\" you ask innocently, letting the tip droop completely off the snare.","        ","        Haneul let${h_s} out a sharp, impatient exhale. The perfectionist in ${h_him} cannot withstand the error.","        \"Inefficient,\" ${h_he} mutter${h_s}. \"You will fracture a metacarpal.\"","        ","        ${h_He} ${h_don} explain. ${h_He} move${h_s}.","        Suddenly, Haneul is behind you. ","        ${h_He} reach${h_es} over your shoulders, ${h_his} chest pressing against your back. You can feel the heat radiating off ${h_him} through the thin t-shirt.","        ","        ${h_He} wrap${h_s} ${h_his} large, calloused hands over yours, forcing your fingers into the correct position.","        \"Fulcrum here,\" ${h_he} whisper${h_s} right next to your ear. ${h_His} breath is hot.","        \"Let the stick do the work. Don't choke it.\"","        ","        For a moment, ${h_he} forget${h_s} to let go. You are trapped in the cage of ${h_his} arms, surrounded by the smell of sweat, clean laundry, and heated electronics.","        *goto night_1_fin","","    # I maintain eye contact and smile mischivously. \"Convince me it's worth the effort.\"","        *set rel_haneul %+5","        *set the_mask %+5","        *set charisma %+5","        ","        You don't take the sticks immediately. You lean back, twirling a loose strand of hair, looking at ${h_him} with a challenge in your eyes.","        You aren't a student. You are an audience waiting to be impressed.","        ","        Haneul freeze${h_s}. The sticks hover, mid air.","        ","        If this were Coco, you would have gotten a smirk and a witty comeback. Coco is a cat, they love a game. They thrive on the chase.","        ","        But Haneul? Haneul look${h_s} at you with a slight tilt of the head, blinking rapidly.","        ${h_He} look${h_s} like a golden retriever trying to understand quantum physics. An analytical puppy.","        ","        \"Worth... the effort?\" ${h_he} repeat${h_s}, genuinely confused by the subtext. \"Drumming increases neuroplasticity by 15%. The benefits are empirically proven.\"","        ","        You suppress a laugh. ${h_He} missed the banter completely. It's adorable.","        \"Just play, Haneul,\" you say softly. \"I'm watching.\"","        *goto night_1_fin","","    # I get shy. The room is too small and ${h_he} is too... much.","        *set rel_haneul %+10","        *set per_gentle %+5","        ","        You sit on the stool, but you pull your knees together, making yourself small.","        You take the sticks, but you can't look at ${h_him}. Up close, the intensity of ${h_his} focus is overwhelming.","        ","        \"Like... like this?\" you stammer.","        ","        Haneul watch${h_es} your hands shaking slightly.","        ${h_He} tilt${h_s} ${h_his} head, clinical curiosity mixing with something softer.","        ","        \"Your heart rate appears elevated,\" ${h_he} observe${h_s} quietly.","        ${h_He} ${h_don} mock you. ${h_He} reach${h_es} out and tap${h_s} your wrist with one finger. A light, grounding touch.","        ","        \"Breathe, ${name}. It is just physics. Gravity and rebound. Trust the physics.\"","        ${h_He} stay${h_s} close, watching you like you are a fragile instrument ${h_he} is afraid to break.","        *goto night_1_fin","","    # I tease ${h_him}. \"So this is your dirty little secret? Hiding in the dark to smash things?\"","        *set rel_haneul %+5","        *set per_bold %+5","        *set rebellion +2","        ","        You don't take the sticks. instead, you lean back, shaking your head with mock disapproval.","        \"The fans think you're meditating on a cloud somewhere. If they saw you sweating like this... the illusion would shatter.\"","        ","        You pause, watching ${h_him}. The truth is, it's incredible. It makes ${h_him} look real.","        But you won't admit that.","        \"It's barely music,\" you lie, hiding a smile. \"It's just... violence.\"","        ","        Haneul stare${h_s} at you, caught off guard. Then, ${h_he} look${h_s} at the sticks in ${h_his} hands.","        The robot doesn't glitch this time. The robot smiles.","        ","        \"Controlled violence,\" ${h_he} correct${h_s}, and there is a glint of amusement in ${h_his} eyes.","        \"And don't pretend you don't like it. I saw your foot tapping to the beat, ${name}.\"","        *goto night_1_fin","","*label night_1_fin","*page_break","You leave the music room, thinking wtf did I just witness.","*goto bedroom_scene","","*label scene_minjae_garden","*disable_reuse","You watch from the shadows as a dark figure attempts to scale the west fence.","He swings one leg over, hesitating for a moment to calculate the drop.","","It should be graceful.","It isn't.","","scuff","\"F******* hell.\"","THUD.","","He lands in the mud with the elegance of a rhinoceros.","But it gets worse. As he tries to regain his balance, his foot hooks onto something sticking out of the ground.","","SKADUSH!","He goes down again, face-first into a bush.","","He scrambles up, wild eyed, and glares at his attacker: a tacky, neon pink plastic flamingo buried in the mud.","He curses in three different languages and kicks the plastic bird.","","\"Stupid... pink... demon!\" he hisses, clutching his shin. \"Who puts a tropical bird in a Seoul garden?! Who?!\"","","You step into the light. \"I think the flamingo won that round.\"","","He freezes. He drops the injured leg instantly, forcing his posture into a rigid, magazine cover pose. He pulls his hood down.","It's Han Minjae. The heartthrob.","Currently covered in mud and fighting a lawn ornament.","","\"You saw nothing,\" he says, his voice dropping an octave to his red carpet tone. \"I was... testing the durability of the decor.\"","","*fake_choice","    # Take a steadying breath. Keep your face blank. Internal screaming only.","        *set the_mask %+ 5","        *set rel_minjae %+ 5","        You nod slowly, matching his serious tone. \"Of course. Safety first. That flamingo looked dangerous.\"","        ","        Minjae narrows his eyes, checking for mockery. When he finds none, he relaxes slightly.","        \"Exactly. It was a structural hazard.\"","","    # Burst out laughing. You can't help it.","        *set rel_minjae %- 5","        *set charisma %+ 5","        You double over, laughing until your sides hurt.","        \"You... vs... the bird...\" you gasp.","        ","        Minjae crosses his arms, looking annoyed. \"Enjoying yourself?\" he mutters, but there's a flicker of amusement in his eyes.","","    # \"Are you okay? That looked painful.\"","        *set rel_minjae %+ 5","        *set per_gentle %+ 5","        You step closer, looking at his leg.","        \"I'm fine,\" he snaps quickly, backing away. He brushes the mud off his jacket aggressively.","","He sighs, looking at the fence.","\"I just needed five minutes,\" he admits, his voice losing the act. \"Five minutes where no one is filming me, looking at me, or asking me to be THE Han Minjae.\"","","*fake_choice","    # \"I get it. It's exhausting pretending to be perfect.\"","        *set rel_minjae %+ 5","        *set per_gentle %+ 5","        \"Sometimes I wonder if I'm a person or a product,\" you say quietly.","        ","        Minjae looks at you sharply. For a second, the mask falls completely. He looks tired.","        \"Both,\" he says. \"We're expensive products. Don't forget that.\"","","    # \"Is that why you're fighting plastic birds? Existential crisis?\"","        *set rel_minjae %+ 10","        *set charisma %+ 5","        He stiffens. \"It's not an existential crisis. It's... aggressive stress relief.\"","        ","        He looks away, staring at the dark windows of the dorms.","        \"It's like the frog and the boiling water,\" he murmurs. \"If you're in it, you don't notice until it's too late.\"","","    # \"Well, I'm solid. Flesh and blood. You can stop projecting now.\"","        *set rel_minjae %+ 10","        *set charisma %+ 5","        *set per_bold %+ 5","        Minjae blinks. A slow, genuine grin tugs at the corner of his mouth. Not the rehearsed smile, but something sharper.","        ","        \"Solid,\" he echoes. He steps back, looking relieved.","        \"Good. Keep it that way. I hate working with AI.\"","        He shudders dramatically. \"They can't write prose and suck at emoting.\"","","He pulls his hood up, hiding his face again.","\"Don't tell anyone I was here,\" he says. \"I have an image to maintain.\"","","He glances at the wall, then gives the pink flamingo one last, hateful glare.","\"And seriously. Burn that bird.\"","","He disappears into the shadows.","*goto bedroom_scene","","*label bedroom_scene","*page_break The Empty Bunk","","You walk into your room.","*if room_vibe = \"Playful\"","    Rio and Coco have finally calmed down. They are lying on their beds, scrolling through NAVER.","    *goto bedroom_desc_end","*elseif room_vibe = \"Serious\"","    Kang and Jiwon are already in bed, eye masks on. The room is perfectly silent.","    *goto bedroom_desc_end","*else","    Haneul and Yuri are drinking tea by the small table. The lights are dim and warm.","    *goto bedroom_desc_end","","*label bedroom_desc_end","You crawl into your expensive, soft bed.","It's infinitely better than the bunk beds in the basement dorms. But it feels wrong.","","As you close your eyes, you instinctively turn to check the bottom bunk, expecting to see Jun sneaking a snack or smiling at you.","But there is no Jun. Just an empty, perfectly made bed.","","[i]\"We're going to make it, right?\"[/i]","The memory of ${j_his} voice echoes in your head.","$!{j_he}'s probably back at ${j_his} parents house right now. Maybe eating ramen. Maybe crying.","But ${j_he} isn't here. You made it. ${j_he} didn't.","","A sharp pang of Survivor's Guilt hits you. It's heavy in your chest.","","*if room_vibe = \"Playful\"","    \"Hey,\" Rio's voice comes from the top bunk. It's soft, stripped of the usual jokes.","    \"You thinking about Jun?\"","    \"Yeah,\" you admit.","    \"$!{j_he}'s tough,\" Coco says from across the room, staring at the ceiling. \"$!{j_he}'ll be okay. Probably watching us on TV right now, judging my outfit.\"","    *goto bedroom_talk_end","","*elseif room_vibe = \"Serious\"","    You hear rustling. Kang sits up.","    He doesn't ask what's wrong. He knows.","    \"You can't carry everyone,\" he says in the dark. It's harsh, but his tone is not unkind.","    \"Focus on your debut. That's the only way to make ${j_his} sacrifice worth it.\"","    *goto bedroom_talk_end","","*else","    Haneul is by your side in an instant. A warm hand touches your shoulder.","    \"It's quiet without ${j_him}, isn't it?\" Haneul whispers.","    \"Yeah. Too quiet.\"","    Yuri silently places a cup of warm chamomile tea on your nightstand.","    \"$!{j_he}'s rooting for you,\" she says softly. \"Don't forget that.\"","    *goto bedroom_talk_end","","*label bedroom_talk_end","You curl up under the blanket.","You made it to the Villa.","But the climb is lonely.","","*label day_2_morning_reveal","*page_break Day 2 dun dun dun - the Caste System","","The wake up call isn't a song. It's a war decleration.","At 6:00 AM sharp, the lights in the dorms turn on. Full brightness.","","\"Gisang! Wake up!\" The PD's voice booms through the speakers. \"Main Hall. 5 minutes. Pali-pali!\"","","Your body screams. Your muscles are stiff from yesterday.","But you are in Korea, you know the drill. If you are one minute late, you are dead.","","Ten minutes later, everyone is standing in the massive living room.","Most trainees look like zombies in expensive silk pajamas.","And then there is Noa.","","She enters wearing a sharp white suit. She looks perfect. Annoyingly perfect.","Her ponytail is pulled back so tight, it probably acts as a natural facelift.","She definitely didn't just wake up. She probably recharges in a dock like a Tesla.","","\"Good morning\" she says. Her voice is calm, but the room goes silent instantly.","\"Last night, you slept. The internet didn't.\"","","She points to the massive digital Scoreboard on the wall.","\"The footage from the Intro Challenge is out. The Netizens have voted.\"","","*comment --- UPDATE FEED LOGIC ---","*gosub_scene social_logic update_feed","","*temp rank_tier \"Unknown\"","*gosub_scene social_logic check_rank","","*if (followers >=19000)","    *set rank_tier \"Top\"","    *set role_pool_party \"Master\"","    The screen stops.","    Your name is glowing in Gold near the top of the list.","    ","    [b]RANK: ${rank_title}[/b]","    [i]Follower Count: ${followers} (Trending)[/i]","    ","    You breathe out. You aren't just safe. You are royalty.","    ","    Around you, the vibe changes. Kang looks at you with sharp eyes. Haneul gives a small, polite nod.","    You just put a target on your back. But at least it's a golden ;) target.","    *goto pool_party_announcement","*else","    *set rank_tier \"Bottom\"","    *set role_pool_party \"Servant\"","    The screen stops.","    Your name is sitting in dull grey in the bottom half of the list.","    ","    [b]RANK: ${rank_title}[/b]","    [i]Follower Count: ${followers} (Low Visibility)[/i]","    ","    Ouch.","    You have a long way to go, sucks to be you right now.","    You look around. Most trainees are in the grey zone with you. They look sick.","    *goto pool_party_announcement","","*label pool_party_announcement","Noa steps forward.","\"Tonight, to celebrate the launch, we are having a pool party.\"","","A ripple of excitement goes through the room. A party? Already?","Noa smiles. It doesn't reach her eyes.","","\"But a party needs guests... and it needs staff.\"","","She snaps her fingers.","Staff members walk in carrying two boxes of wristbands.","Gold velvet wristbands and cheap plastic ones.","","\"Top Tier,\" Noa points to the Gold box. \"You are the masters. You will enjoy the pool, the open bar, and the massage chairs.\"","\"Survival Tier,\" she points to the Plastic box. \"You are the Servants. You will pour the drinks, fan the Masters, and cut their fruit.\"","","The room freezes.","\"Does labor law exist in this universe?\" you wonder.","Probably not.","","\"This is your lesson for today,\" Noa says coldly. \"Hierarchy. If you don't like serving... work harder.\"","","\"CUT!\" The PD yells from behind the camera. \"Hold on, check the audio on mic 2.\"","","The moment the camera stops rolling, the \"Ice Queen\" melts.","Noa slumps her shoulders instantly. She looks at the terrified trainees, puffing out her cheeks and crossing her eyes in a goofy, derp face.","She wiggles her fingers mockingly at her own script. \"So dramatic, right? \"Work harder!\" she whispers to you with a wink. \"I hate saying that stuff.\"","","\"We're rolling in 3... 2...1...\"","","SNAP.","Noa straightens her back. The terrifying smile returns instantly.","\"Choose your bands. Now.\"","","*choice","    *selectable_if (rank_tier = \"Top\") # I take the Gold band. I worked for this status. I own it.","        *set self_belief %+5","        *set rel_rival %-5","        *set ruthless %+5","        ","        You strap the velvet band onto your wrist. It feels soft.","        You catch the eye of a trainee in the 'survival' group. You don't apologize.","        ","        You won this round. Why should you feel bad?","        *goto day_2_afternoon","","    *selectable_if (rank_tier = \"Top\") # I take the Gold band, but I hide it under my sleeve. This feels wrong.","        *set per_gentle %+5","        *set rel_kang %+5","        *set rel_haneul %+5","        ","        You put it on, but you feel heavy.","        Making your friends serve you drinks? It's humiliating for them.","        You resolve to make it as easy as possible for the \"servants\" tonight.","        *goto day_2_afternoon","","    *selectable_if (rank_tier = \"Bottom\") # I take the Plastic band and salute mockingly. \"At your service, Your Highness.\"","        *set the_mask %+5","        *set charisma %+5","        *set rel_noa %+5","        ","        You snap the cheap plastic onto your wrist. It scratches your skin.","        \"Okay,\" you say loud enough for the cameras. \"I make a terrible Mojito, but I'm great at spilling things accidentally.\"","        ","        A few trainees laugh. You reclaimed the power by making it a joke.","        Even Noa's lip twitches, she definitely liked that one.","        *goto day_2_afternoon","","    *selectable_if (rank_tier = \"Bottom\") # I glare at the gold team. I will remember every face that orders me around.","        *set rebellion %+5","        *set ruthless %+5","        ","        You put on the plastic band. It feels like a handcuff.","        You look at the top tier trainees. They are smiling.","        ","        [i]Enjoy your massage,[/i] you think. [i]This band is temporary. My rage is forever.[/i]","        *goto day_2_afternoon","","*label day_2_afternoon","*page_break Day 2: The Hierarchy","","The cameras retreat for the afternoon.","The Villa is open to you, but the wristbands create an invisible wall. The Gold Rank trainees are lounging on the leather sofas. The Plastic Rank trainees are huddled in the kitchen.","","You have some free time. What do you do?","","*choice","    # I go to the Home Gym. (Interaction: Kang)","        *goto scene_gym_kang","","    # I look for a quiet place in the Garden. (Interaction: Jiwon & Yuri)","        *goto scene_garden_jiwon","","    # I check out the Game Room. (Interaction: Rio)","        *goto scene_gameroom_rio","","*label scene_gym_kang","You walk into the state-of-the-art gym. It smells of iron and sweat. Kang is there, of course.","${kang_He} is doing pull-ups with a weight belt strapped to ${kang_his} waist. ${kang_He} is wearing a Gold band.","","\"105... 106...\" ${kang_he} grunts, muscles straining. ${kang_He} hasn't seen you yet.","","*choice","    # I stay silent and start my own workout. Let the weights speak.","        *set physical %+5","        *set ruthless +5","        You grab a set of dumbbells. Kang pauses at the top of the bar, glancing at you in the mirror. ${kang_He} appreciates the silence.","        ${kang_He} drops down, wiping sweat with a towel. \"Good form,\" ${kang_he} grunts.","        *goto kang_conversation_serious","","    # \"I saw you reading a romance novel in the locker room. 'The Duchess's Secret Love'?\"","        *set rel_kang %+15","        *set per_bold +5","        *set charisma %+5","        Kang freezes mid-air. ${kang_He} drops down, landing clumsily. ${kang_His} face turns bright red.","        \"It... it helps me visualize emotional expression!\" ${kang_he} stammers defensively. \"For ballads!\"","        \"Right,\" you grin. \"Especially the chapter about the [i]forbidden gazebo[/i].\"","        Kang groans, burying ${kang_his} face in a towel. \"If you tell anyone, I will crush you in the next evaluation.\"","        But when ${kang_he} looks up, the robot mask is gone. ${kang_He} looks human.","        *goto day_2_night","","*label kang_conversation_serious","${kang_He} sits on the bench press, unbuckling the heavy belt.","\"I turned 18 last week,\" ${kang_he} says suddenly. The voice is flat.","\"In the real world, I'm barely an adult. In this building? I'm a fossil. The PDs want fresh meat. If I don't debut in this group... I'm done.\"","","*choice","    # \"Then stop training like a robot. Show them you have something the kids don't: Experience.\"","        *set rel_kang %+10","        *set self_belief %+5","        Kang looks up. \"Maybe you're right. I need to stop being perfect and start being dangerous.\"","        ${kang_He} stands up, looking focused.","        *goto day_2_night","","    # \"You're the best dancer here. Don't let the numbers scare you.\"","        *set rel_kang %+5","        *set per_gentle +5","        \"Skill isn't enough,\" Kang sighs. \"But thanks.\"","        ${kang_He} goes back to the weights.","        *goto day_2_night","","*label scene_garden_jiwon","You find Jiwon sitting on a bench near the artificial waterfall, holding a heavy book. Yuri is napping on ${jiwon_his} shoulder.","Jiwon is wearing a Plastic band. ${jiwon_He} is staring at a page, but ${jiwon_he} hasn't turned it in ten minutes.","","\"Oh, ${name},\" ${jiwon_he} whispers, freezing so ${jiwon_he} doesn't wake Yuri. \"I was just... trying to study.\"","","*choice","    # \"Is that calculus? In a survival show? You're wild.\"","        *set rel_jiwon %+5","        *set charisma %+5","        Jiwon gives a small, tired smile. \"It keeps me sane. Numbers have rules. This place has no rules.\"","        *goto jiwon_conversation","","    # Sit silently next to them. Offer Jiwon a vitamin drink.","        *set rel_jiwon %+10","        *set per_gentle +5","        You hand over the drink. Jiwon takes it with shaking hands. \"Thank you,\" ${jiwon_he} mouths.","        *goto jiwon_conversation","","*label jiwon_conversation","\"We made a pact,\" Jiwon whispers to you. \"In middle school. We debut together, or not at all. But what if I'm the one holding ${yuri_him} back? ${yuri_He} is a natural genius. I just work hard.\"","","*choice","    # \"Don't break the pact. A duo bond is your unique selling point. Use it.\"","        *set rel_jiwon %+10","        *set the_mask %+5","        \"A storyline...\" Jiwon muses. \"You're right. The producers love 'friendship'. We need to sell the package deal.\"","        *goto day_2_night","","    # \"You can't carry ${yuri_him} forever. Eventually, you have to fight for yourself.\"","        *set ruthless +10","        *set self_belief %+5","        Jiwon flinches. \"I know. I know that. But I can't be selfish yet.\"","        *goto day_2_night","","*label scene_gameroom_rio","Rio is sprawled on a beanbag chair, staring intensely at the TV. On the screen, a 2D anime character is blushing.","\"Take the cookies, Kenji,\" Rio whispers aggressively. \"Just take them, I spent 372 coins on flour!\"","","*choice","    # \"Are you... playing a dating simulator?\"","        *set charisma %+5","        *set rel_rio %+5","        Rio jumps. \"It's a Visual Novel! And don't look at me like that. This is serious character study.\"","        *goto rio_game_moment","","    # \"I think you need to choose the 'Shy' dialogue option.\"","        *set per_bold +5","        *set rel_rio %+15","        Rio turns to you, eyes wide. \"Exactly! Finally, someone with taste.\"","        *goto rio_game_moment","","*label rio_game_moment","On screen, Kenji accepts the cookies. [b]AFFINITY +50![/b]","Rio drops the controller. ${rio_He} actually tears up. A single, dramatic tear rolls down ${rio_his} cheek.","\"He took them,\" Rio chokes out. \"Beautiful. I'm not crying. You're crying. Look at that pixelated smile.\"","","Then, the screen fades to black for a second. In the reflection, you see Rio's face. The smile is gone. ${rio_He}'s off.","The music starts again. The smile snaps back onto ${rio_his} face instantly. \"Okay! Beach date. Let's go.\"","","*choice","    # Observe the reflection. Don't say anything, just sit with ${rio_him}.","        *set rel_rio %+10","        *set per_gentle +5","        You sit on the other beanbag. Rio glances at you. ${rio_He} knows you saw something. ${rio_He} passes you the second controller quietly.","        *goto day_2_night","","    # \"You are obsessed. I'm going to get a snack.\"","        *set ruthless +5","        \"Your loss!\" Rio calls out cheerfully.","        *goto day_2_night","","*label day_2_night","The sun sets over the Villa.","Dinner is served. The masters are eating ribeye steak with truffle butter, while the servants are looking at bowls of white rice and spicy kimchi.","","*if (eating_disorder_flag=\"true\")","    You look at your plate. Its a standard portion, but your brain doesn't see \"food\", it sees data points.","    [i]Rice: 204 calories (assuming 150g). Kimchi: 23 calories. Total for this sitting: 227.[/i]","    ","    You eat precisely three-quarters of the rice, leaving a neat little mound on the left side of the bowl. Its not that you aren't hungry the hunger is a dull roar in the back of your mind but the math has to be right. 227 is a \"safe\" number for a Thursday. ","    ","    You chew slowly, counting the jaw movements. 32 times per bite. Optimal digestion. Minimum bloat. Its just a routine. No big deal.","    *goto day_3_morning","*else","    You eat quickly, grateful for the fuel. The food disappears in record time, and you head to bed before the cameras catch you yawning.","    *goto day_3_morning","","","","*label day_3_morning","*page_break Day 3","","Ahh morning. The sun is up, the birds are singing, and there is a high-definition camera lens exactly three inches away from your drooling face. ","","You still haven't quite gotten used to the fact that the camera staff are basically your permanent tail. You are, however, deeply moved by the fact that the staff already knows your coffee order by heart. Small wins.","","Still, no rest for the wicked. ","","As you brush your hair and comb your teeth apparently reality tv brain fog is finally affecting your basic motor skills you begin to plan the rest of your stat enhancing day. I mean, your totally relaxing \"free day off\", of course. ","","You catch a glimpse of Yuri in the hallway, looking like a deer in headlights as a boom mic hovers just a bit too close to her head. Even the seasoned pros are looking a bit twitchy today.","","Time to make the most of the silence. What is the plan?","","*choice","    # I lock myself in the karaoke room and sing until the staff starts checking their earplugs.","        *set vocals %+10","        *set stress %+5","        You run scales until your throat feels like glass, then you drink some lukewarm water and do it again. It's not glamorous, but your pitch is finally stable. ","        *goto day_3_night","","    # I hit the dance studio and sweat until the floor becomes a genuine safety hazard.","        *set dance %+10","        *set physical %-5","        *set stress %+5","        You practice the same isolation move 500 times. Then 500 more. Pain is just a great narrative arc for the viewers at home, right? You look sharp.","        *goto day_3_night","","    # I spend the morning practicing my \"spontaneous\" idol expressions in the mirror.","        *set visual %+10","        *set charisma %+5","        You spend hours mastering the art of the accidental wink. It feels ridiculous with a camera operator standing right behind you, but in this industry, your face is your primary weapon.","        *goto day_3_night","","    # I find a blind spot and sleep like a person who actually values their sanity.","        *set physical %+15","        *set stress %-15","        *set self_belief %+5","        You find a sunbed in a tiny corner of the garden. You actually sleep. Real sleep. You wake up feeling like a human being instead of a caffeinated ghost. ","        *goto day_3_night","","*label day_3_night","The sun sets on Day 3. The Villa is a pressure cooker. Everyone is preparing for tomorrow. The Pool Party. ","","*if (eating_disorder_flag=\"true\") ","    You pull a protein bar from your bag. Youve memorized the label already, but you check it again.","    [i]212 calories. 18g protein. 7g sugar.[/i]","    ","    You don't throw it away. You need the energy for the pool tomorrow, but you can't just eat it. That would be chaotic. ","    Using a small plastic knife, you cut the bar into exactly eight equal squares. Each square is 26.5 calories. ","    ","    You eat four of them. 106 calories exactly. ","    You feel a strange sense of peace as you put the other four back in the wrapper. Everything is under control. The math adds up. You fall asleep calculating your intake and training sessions per muscle group for the week.","    *goto day_4_morning","*else","    You eat a protein bar that tastes like flavored cardboard. It's not a gourmet meal, but it's fuel. You wash it down with water and go to sleep.","    *goto day_4_morning","","","","*label day_4_morning","*page_break Day 4","","08:00 AM. Hi wake up , you hear Jun's voice , but then a ringing sound invades your dream.","","The intercom shrieks, vibrating through your pillow. ","\"Good morning, Trainees,\" the automated voice announces. \"The Styling Room is now open. Please report immediately to select your outfit for the party.\"","\"The event begins at 10:00 AM sharp. Don't be late.\"","","You drag yourself out of bed. Your hair is a mess, and you have two hours to become a god. Showtime.","","*goto party_prep","","*label party_prep","Noa is waiting by the wardrobe racks. She is wearing a white linen suit and looking like she has never experienced a bad hair day in her life. ","","*if (rank_tier = \"Bottom\")","    \"Servants,\" Noa says, not even looking up. She points to a pile of folded clothes. \"You will be wearing the staff uniform. White polo shirts and beige shorts - clean, professional, invisible.\"","    ","    You pick up the uniform. Rio stands next to you, holding the shorts with two fingers. \"I look like a slice of toast with jam ${name}.\"","    *goto party_prep_end","","*else","    \"masters\" Noa says (with an eye roll so small only you and Coco noticed), gesturing to a rack of designer swimwear. \"You are the stars. Choose something that makes them look.\"","    ","    *temp swimsuit_style \"none\"","    ","    *fake_choice","        # The sleek black designer piece.","            *set swimsuit_style \"Intimidating\"","            *set rel_rival %+1","           ","            *set ruthless +5","            You hold it up. It looks like it belongs on a runway. Coco walks by and nods. \"Classy.\"","","        # The bright, colorful outfit.","            *set swimsuit_style \"Fun\"","          ","            *set rel_rio %+5","            It pops perfectly. Rio lets out a long, tragic sigh. \"Okay, I see you. Save me a dance?\"","","        # The modest and elegant white lace piece.","            *set swimsuit_style \"Elegant\"","            *set per_gentle %+2","            *set rel_haneul %+1","            Haneul glances at it and smiles. \"It suits you. You don't need to shout to be noticed.\"","        # The vintage, crochet-knit boho ensemble.","            *set swimsuit_style \"Boho\"","            *set rel_noa %+1","            ","            It looks more like a Vogue editorial than a reality show pool party. But the rule is simple: if they give, you take. If they strike, you run.","","            Noa pauses as she passes you. Her eyes narrow, inspecting the earthy textures. Her brows furrow. The corners of her mouth pull down in that universal, begrudging look of \"not bad.\" ","","            She gives a single, sharp nod. \"Looks nice.\"","","            She moves on before you can even blink. Not that you care. ","            ","            (Or do you?)","            ","   ","","*label party_prep_end","\"Get changed,\" Noa commands. \"Cameras are live in 30 minutes.\"","","You head to the stalls. The hierarchy is set. The sun is out. ","Let's see who sinks and who swims.","","*page_break The Pool Party Begins","*label pool_party_start","The sun is a blinding white spotlight. The air smells like a toxic mix of chlorine, SPF 50, and the heavy scent of classism.","","The courtyard is the epitome of luxury. White leather sunbeds line the turquoise water for the Gold Bands. For the Plastic Bands? There isn't even a patch of shade. Waiters circulate with trays of neon-colored cocktails, but they have a sixth sense for the hierarchy, gold gets a drink while plastic gets a sympathy nod.","","High above, on the second-floor balcony, a figure appears. ","Hes wrapped in a floral silk robe that costs more than my EDUCATION, holding a feathered fan and an Iced Americano.","","Hes the PD, a Roman Emperor staring down at a pit of gladiators, wondering will his thumb will go up or down.","","\"Welcome, my little icons!\" his voice booms. \"Do you like the decor? Its Luxurious Minimalism. It means we spent the budget on 8K lenses to see your pores, so we couldn't afford chairs for the Servants. Life is a beach and mine is in St. Tropez, anyways where were we?\"","","He snaps his fingers. ","\"Masters! Take your seats. Try to look wealthy and unbothered. Servants? Oh, honey... you are the Extras today. And extras don't sit. They SWEAT.\"","","*if (rank_tier = \"Bottom\")","    The white polo shirt is scratchy and fits like a damp paper bag. Around you, the other Servants are staring at the floor, realizing that the \"dream\" involves a lot more standing in the sun than they expected.","    *goto 1","","*else","    The padded sunbeds are plush, but the contrast is jarring. From under the shade of your umbrella, you watch the servants gather on the hot concrete, the hierarchy of the show finally feeling like a reality.","","    *if (ruthless > per_gentle)","        This is exactly why you've been killing yourself in every evaluation. You didn't come here to make friends, you came to be the Center. If the others want the shade, they'll have to work hard enough to take it from you next time.","        *goto 1","    *elseif (per_gentle > ruthless)","        You can practically feel the \"evil edit\" the PDs are trying to cook up right now. Youve been in their shoes before, and youre already looking for a chance to sneak them some iced americanos or snacks when the cameras aren't looking. Being a Master doesn't mean you have to lose your soul.","        *goto 1","    *else","        *goto 1","","*label 1","Suddenly, a screech cuts through the music. The PD is pointing his fan at a trainee in the back trying to hide bloodshot eyes behind dark shades.","","\"You! With the sunglasses! OFF! NOW!\"","","He leans so far over the railing hes practically airborne. \"I want to see the despair in your eyes in 8K resolution! Sunglasses are for Masters only! If I don't see your soul breaking, the viewers in Busan won't feel a thing! Do you want to be a star or a burger flipper? MOVE!\"","","The trainee rips the glasses off, blinking like a deer caught in the headlights of a very expensive car.","\"Better,\" the PD purrs, taking a long sip of his coffee.","","In the corner, Benji the scrawny PA tries to sneak a water bottle to a trainee who looks ready to faint. The PD grabs a megaphone.","","\"BENJI!\" ","The scream makes everyone jump. \"Is that... an UNBRANDED water bottle in my frame?!\"","","Benji freezes. \"Sir, they were literally vibrating from thirst\"","","\"I don't care if they are spontaneously combusting!\" The PD roars. \"If I see another logoless bottle, I am selling your kidney on eBay! Do you know how much shipping costs from Seoul to LA? Focus, for God's sake! This is art, not a charity!\"","","He tosses the megaphone aside and fans himself dramatically. ","\"Action in 5 minutes! Don't be boring! The drones are hungry!\"","","Drones buzz overhead like angry, high-tech hornets. The heat is rising. The fakeness of this \"party\" is so thick you could cut it with a knife. ","","How do you handle the start of the madness?","","*choice","    # I dive in. If the world is a snake pit, I'll be the one with the sharpest fangs.","        *set zen_mode false","        *set stress %+5","        *set ruthless %+5","        You clench your fists. If they want a show, I'll give them a blockbuster. ","        You step into the crowd, ready to fight for every second of airtime.","        *goto visual_reveal_pool","","    # I disconnect. I sit in the center of the storm and let the world burn around me. (Zen Guru Path: Be warned , this option will skip a significant gameplay but will give a unique angle instead + infinite chill )","        *set zen_mode true","        *set vocals %+5","        *set stress %-15","        *set self_belief %+10","        ","        This isn't real. The PD is just a loud manifestation of someone's mid-life crisis.","        ","        You drop to the floor, right in the middle of the frantic walkway. You sit in a lotus position. You close your eyes. You become one with the universe. Age is a factor, but so many reincarnations have prepared you for this exact moment, you feel the weight of your body until you feel nothing at all.","       ","        ","        \"OOOMMM,\" you vibrate softly.","        ","        The screams of the PD fade into background noise, like the chirping of very angry, very stylish birds. You aren't a trainee anymore. You are a ghost, floating above the pool, watching these beautiful, broken children drown in their own ambition.","        *goto visual_reveal_pool","","*label visual_reveal_pool","*page_break The Art of Forced Fun","","The PD leans over the marble railing, fanning himself with a silk fan. He doesn't look angry; he looks bored. Which is worse.","\"Darlings, please,\" his voice purrs through the speakers. \"This is supposed to be Youthful Radiance, not a funeral for your hopes and dreams. Give me something that doesn't look like a stock photo of a depression clinic!\"","","The trainees scramble. But then... something shifts.","Yuri quiet, elegant Yuri who is currently wearing a Gold Band walks to the edge of the pool.","Usually, ${yuri_he} is composed. But maybe the heat is getting to ${yuri_him}.","\"You know what?\" Yuri says, a mischievous glint in ${yuri_his} eyes. \"It's just water.\"","","SPLASH.","Yuri jumps in. Not an elegant dive, but a messy, happy jump.","The Masters cheer. Rio grabs a water gun.","\"Defend yourself, Yuri!\" Rio screams.","For a few minutes, the Villa actually feels like a party.","","*if (zen_mode)","    *if (rank_tier = \"Top\")","        You are sitting in the lotus position on your plush white sunbed, your designer silk robe draping elegantly around you.","        *goto 6","    *else","        You are sitting in the lotus position on the boiling hot marble, ignoring the burning sensation through your cheap servant shorts.","        *goto 6","    *label 6","    To the naked eye, you are a trainee sitting on the floor. But in reality? You are a cloud. A very chic cloud.","    ","    You observe the splash.","    \"Ah,\" you vibrate internally. \"The Water Element embraces the Soul. A cleansing of the chakras.\"","    ","    Suddenly, a cameraman running to film Yuri's splash trips over your crossed legs.","    He stumbles hard, barely saving the expensive camera.","    \"Jesus! Watch it!\" he snaps, sweating profusely.","    ","    You don't get angry. You open one eye slowly.","    \"Peace, brother,\" you whisper with genuine concern. \"Your center of gravity is chaotic today. Perhaps Mercury is in retrograde?\"","    ","    The cameraman stares at you, confused and terrified, before running away.","    \"Namaste,\" you bless his retreating figure.","    *goto jiwon_natural_reveal","","*else","    You find yourself grinning. You grab a water gun and form a temporary alliance with Rio.","    The water is cold, the sun is hot, and for a split second, you forget that you are fighting for your life.","    *goto jiwon_natural_reveal","","*label jiwon_natural_reveal","In the middle of this chaos, Jiwon watches Yuri laughing in the water.","They are friends. They have been training together for years.","Seeing Yuri so happy, Jiwon forgets.","${jiwon_He} forgets the Plastic Band on ${jiwon_his} wrist. ${jiwon_He} forgets the rules.","${jiwon_He} just runs.","\"Wait for me!\" Jiwon shouts.","","SPLASH.","Jiwon does a cannonball right next to Yuri.","They surface together, high-fiving, hair plastered to their faces.","\"The water is amazing!\" Jiwon laughs.","","The laughter cuts off instantly.","Rio freezes. The other Masters stop splashing.","Everyone looks at the balcony.","","The PD hasn't moved. He just slowly lowers his Iced Americano.","\"Yuri, darling,\" his voice slides through the speakers like oil. \"Exquisite entry. Very joie de vivre.\"","","Then, his gaze shifts three inches to the left. To Jiwon.","The tone drops ten degrees.","\"Jiwon... sweetie.\"","He sighs, sounding deeply exhausted. \"I know the education system failed many of you, but I assumed you could read.\"","","Jiwons smile dies. ${jiwon_He} looks at Yuri, then down at the water, suddenly realizing ${jiwon_he} is the [i]only[/i] Servant in the pool.","\"I... Sir, I\"","","\"The sign says Masters Only,\" the PD continues, his voice dripping with condescension. \"Yuri is allowed to frolic. Yuri is a Master. You? You are contaminating my VIP aesthetic with your... peasant enthusiasm. Its giving anarchy, and not the chic kind.\"","","He waves his fan dismissively.","\"Get out. Before I deduct the cost of the pool cleaning from your non-existent paycheck.\"","","Jiwon scrambles toward the ladder, face burning red. Yuri tries to grab ${jiwon_his} hand to comfort ${jiwon_him}, but Jiwon pulls away, mortified.","\"I'm sorry, I'm sorry,\" Jiwon mumbles.","To climb out faster, ${jiwon_he} grabs the hem of the heavy, soaking-wet hoodie ${jiwon_he} was wearing over the uniform.","\"It's choking me,\" ${jiwon_he} whispers, and pulls it off in one smooth motion to toss it onto the tiles.","","The wet hoodie hits the floor with a squelch.","And then... the PD stops fanning himself.","","*if (gender = \"male\")","    Under the baggy clothes, Jiwon is a revelation.","    Water runs down a chest that looks like it was sculpted by a Renaissance artist with an obsession for anatomy. Lean muscle, defined abs, veins tracing paths over skin that glows in the sun.","    *goto 3","*else","    Under the baggy clothes, Jiwon is a revelation.","    ${jiwon_his} damp tank top clings to a body that screams power. Sculpted shoulders, a core of steel, and the kind of athletic definition that usually takes a team of trainers to achieve.","    *goto 3","*label 3","The PD takes off his sunglasses. He squints.","\"Wait,\" he whispers. The mic picks up the sudden shift in his tone. \"Is that... an 8-pack?\"","","He throws his coffee over his shoulder. SMASH.","\"FORGET THE RULES!\"","He leans over the rail, his eyes wide.","\"Camera 2! Why are you filming the water? ZOOM IN ON THE TORSO!\"","","Jiwon, realizing everyone is staring, instinctively crosses ${jiwon_his} arms, shrinking back.","\"Sir? I'm getting out...\"","","\"No, no, no,\" the PD interrupts, his voice suddenly honey-sweet. \"Don't hide it. We missed the reveal. It was too fast. It was too... messy.\"","He points a manicured finger.","\"Benji! Mist ${jiwon_him}! We are doing a reshoot.\"","","\"Jiwon, back in the water. Put the hoodie back on.\"","\"But it's wet...\"","\"I don't care if it's made of lead! Put it on! And this time... take it off [i]slowly[/i]. Give me Megan Fox opening the car hood vibes. Give me Pride and prejudice Colin Firth. Give me captain america summons thor's hammer . Annnnnd action!\"","","Jiwon sighs, the light leaving ${jiwon_his} eyes.","The fun is over. The factory is back open.","${jiwon_He} repeats the move, staring dead eyed into the lens, turning a moment of joy into a thrist trap.","","\"YES!\" the PD screams, ecstatic. \"That is the thumbnail! I am a god! Benji, buy yourself a cookie, youre not fired today!\"","","\"Now,\" he snaps, boredom returning instantly. \"Enough frolicking. SWIMMING RACE! Masters vs Servants! If a Servant wins, Ill let you stand in the shade for five minutes. GO!\"","","*goto swimming_challenge","","*label swimming_challenge","*page_break The Visual Battle Royale","","The whistle blows.","The pool explodes into chaos.","","Let's be honest: putting 30 aspiring idols in one infinity pool isn't a swimming race. Its a mosh pit.","It is tighter than a rookie group's van. It is more chaotic than a music show ending stage where everyone is fighting for the 'Center' position.","There is no water left. Only limbs, waterproof mascara, and desperate ambition.","","*if (zen_mode)","    You do not fight for space.","    While the others claw at each other, you simply... cease to participate.","    ","    You lie back. Your friends (or perhaps just people who needed a raft) drag you along.","    You float on your back, eyes closed, hands folded on your chest.","    ","    A Master kicks you in the shin. You accept it as a physical manifestation of their insecurity.","    A Servant uses your shoulder as a launchpad. You offer them silent support.","    ","    \"Look at that!\" The PDs voice cuts through the noise. ","    \"Is ${name} conscious? No, don't check! I love it! Its giving Ophelia Drowning in a Fashion Editorial. Its morbid! Its chic! Its the stillness we need in this chaotic world!\"","    ","    You hit the wall with a gentle thud. You arrived last, but your mental state is Grandmaster.","    *set stress %-5","    *goto pd_secret_reveal","","*else","    The water is freezing, the elbows are sharp, and the desire to drown your competitors is rising.","    ","    *choice","        # I fight for the Center position. Get out of my way.","            *set physical %+10","            *set ruthless %+5","            *set stress %+5","            You bury your head and kick. You channel \"Main Dancer\" energy.","            You don't care who you hit. You are fighting for screen time.","            You emerge from the crush of bodies, gasping for air, hair plastered to your face, looking like you just survived a zombie apocalypse.","            ","            The PD yawns into the microphone. ","            \"You made it. You swim with the grace of a malfunctioning blender. Fast, but aesthetically offensive.\"","            *goto pd_secret_reveal","","        # I swim for the Fancam. Slow, pretty, and useless.","            *set visual %+10","            *set charisma %+5","            *set self_belief %+5","            You realize there is no point in racing in this human soup.","            So you tread water. You find a pocket of space. You make sure your wet hair looks styled and not drowned rat.","            You give the drone a slow, smoldering look.","            ","            You finish last. Dead last.","            But you emerge from the water like a slow-motion shampoo commercial.","            ","            The PD claps lazily. \"Finally! Someone who understands that cardio is the enemy of a good close-up. 10 points for holding the visual.\"","            *goto pd_secret_reveal","","*label pd_secret_reveal","As the trainees drag themselves out of the pool, coughing up chlorine and pride, you happen to drift near the balcony.","The PD thinks no one is watching. He has lost interest in the carnage. ","He is hunched over his phone, giggling.","Not his usual cruel, villainous giggle. A... teenage fangirl giggle?","","*if (zen_mode)","    From your floating vantage point, your vision is surprisingly sharp. You vibrate your consciousness toward his screen.","    He is on NAVER.","    He is looking at a photo of Eden (The Genius Producer) sitting in a recording studio, looking exhausted and brooding.","    ","    You squint spiritually.","    The PD is logged into an account named: [b]@Eden_Is_My_Garden_99[/b] (Level 7 Super Fan).","    He is typing a comment: [i]\"The bags under his eyes are designer bags!! Genius at work!! Please produce me next!! <3 <3\"[/i]","    ","    \"Interesting,\" you vibrate. \"The Emperor bows to the Producer. The hierarchy is a circle of thirst.\"","    *goto coco_la_moment","","*else","    You catch a glimpse of his screen through the glass railing.","    Is that... Eden?","    The PD is zooming in. Aggressively zooming in. On Eden's hands over the mixing console.","    ","    He types furiously, his face flushed with a weird mix of excitement and shame.","    You catch the username before he swipes away: [b]@Eden_Is_My_Garden_99[/b].","    ","    He hits Post and lets out a dreamy sigh.","    *goto coco_la_moment","","*label coco_la_moment","*temp c_s \"\"","*temp c_es \"\"","*temp c_ies \"\"","*temp c_is \"\"","*temp c_has \"\"","","*if (r_he = \"they\")","    *set c_s \"\"","    *set c_es \"\"","    *set c_ies \"y\"","    *set c_is \"are\"","    *set c_has \"have\"","    *goto 7","*else","    *set c_s \"s\"","    *set c_es \"es\"","    *set c_ies \"ies\"","    *set c_is \"is\"","    *set c_has \"has\"","    *goto 7","    ","*label 7","Suddenly, a shadow falls over the PD. ","Its Coco.","","Coco ${c_has} climbed out of the pool and walked up the stairs to the lower balcony, a towel draped casually over one shoulder. ${r_He} look${c_s} cool, unbothered, and completely unaware that ${r_he} ${c_is} about to interrupt an intense fanboy moment.","","\"Yo, PD-nim,\" Coco say${c_s}, leaning against the railing.","","The PD JUMPS. He shrieks, fumbling his phone and nearly dropping it into the water. He slams it against his chest, eyes wide.","\"COCO! Don't sneak up on me! I was... checking stocks! High-stakes business stocks!\"","","Coco raise${c_s} an eyebrow. \"Right. Stocks. Anyway, I had a question about the vibe.\" ${r_He} gesture${c_s} to the pool chaos. \"Is this it? Because in LA, we usually have better music. This playlist is a bit... tired.\"","","The PD recovers, smoothing his silk robe. \"Tired? This is a curated Tropical House playlist, were both from the west coast , how could you not know that ? \"","","Coco laugh${c_s}. Its a practiced, easy sound. \"In LA? We wouldn't be doing this forced swimming rubbish. We'd just vibe. No drama, just\"","","Coco stop${c_s}. ","The word hangs in the humid air like a heavy mist.","Rubbish.[","","The PD blinks. \"Rubbish?\" He tilts his head. \"That sounded very... colonial of you, darling.\"","","Coco freeze${c_s}. The color drains from ${r_his} face for a micro second. ${r_He} realize${c_s} the slip-up immediately.","","\"Trash!\" Coco correct${c_s} loudly, forcing an exaggerated American accent. \"I meant trash! Rubbish... is just what my... uh... British nanny used to say. Yeah. Nanny. She was awful. A total hag.\"","","Coco laugh${c_s} nervously. \"Anyway. LA vibes. You know?\"","","*if (zen_mode)","    [i](Zen Path: The Vibration of Deceit)[/i]","    You hear the lie vibrating in the air like a discordant string on a sitar. ","    \"The throat chakra blocked the truth,\" you observe silently. \"The nanny narrative is structurally weak.\"","    Your rival might have fooled everyone else, but your higher self knows... [b]London's calling.[/b]","    *goto chicken_fight_setup","*else","    You shrug, your mind drifting with the gentle current of the pool. ","    A British nanny? It sounds exactly like the kind of pretentious, over the top thing a rich kid from LA would have. ","    The PD seems to buy it too, or maybe he's just too busy fumbling with his phone to care about linguistics.","    *goto chicken_fight_setup","","The PD rolls his eyes, eager to end the conversation and go back to his Eden fan account.","\"Fine, fine! You want a vibe? I'll give you violence! That's a vibe!\"","","He grabs the megaphone.","\"OKAY! Enough chatting! Coco is bored! Let's spice it up!\"","\"CHICKEN FIGHT! Get on someone's shoulders! Masters vs Servants! Knock each other down! Last pair standing gets the VIP bed!\"","","*label chicken_fight_setup","*page_break The Friction Point","*temp partner \"\"","*temp partner_type \"\"","*temp h_is \"is\"","*temp h_s \"s\"","*temp r_is \"is\"","*temp r_s \"s\"","*temp h_es \"es\"","*temp c_is \"is\"","*temp c_s \"s\"","","*comment --- Grammar Logic for Non-Binary & Grammar ---","*if (haneul_gender = \"nb\")","    *set h_is \"are\"","    *set h_s \"\"","    *set h_es \"\"","*if (r_he = \"they\")","    *set r_is \"are\"","    *set r_s \"\"","*if (r_he = \"they\")","    *set c_is \"are\"","    *set c_s \"\"","","*temp c_he r_he","*temp c_his r_his","*temp c_him r_him","*if (r_he = \"they\")","    *set r_is \"are\"","    *set r_s \"\"","    *set c_is \"are\"","    *set c_s \"\"","    ","","Sang-ho claps his hands twice. The sound cuts through the humid air.","\"Listen up! I want violence. I want betrayal. I want high stakes drama.\"","","He licks his lips, scanning the crowd, briefly glancing at his phone.","\"Chicken Fight. Horse and Rider. Knock the others down. Last pair dry(ish) gets the VIP bed.\"","He pauses, smirking. \"And forget the ranks. Masters, Servants... touch each other. Mix it up. I want to see chemistry, or lack thereof.\"","","The pool turns into a frenzy. But your eyes, and everyone else, snap to the shallow end.","","Rio and Coco have already paired up.","And god, its unfair.","Rio is the horse, solid, muscular, grinning like a feral wolf.","Coco is the rider, perched on Rio's shoulders, looking down at the rest of us like royalty.","","Coco slick${c_s} back ${r_his} wet hair, winking at the camera. \"Come and get it, losers.\"","","*comment --- ZEN MODE CHECK ---","*if (zen_mode)","    *goto zen_chicken_observation","","*goto choose_partner_normal","","*label zen_chicken_observation","","The whistle blows.","To the unenlightened, it is a signal for war.","To you, it is merely a shift in the vibrational frequency of the universe.","","While the others scramble for dominance, locking limbs and screaming in fear, you surrender.","You do not fight the water. You \"become\" the water.","","You float on your back, arms spread wide, exposing your heart chakra to the drone above.","You feel the chlorine molecules dancing against your skin. You feel the sun feeding your soul.","You are connected to everything. To the tiles, to the sky, even to the PD's expensive loafers.","","Rio charges like a bull. Coco cackles on top.","You watch them not with fear, but with profound compassion.","\"Look at them,\" you think, your mind expanding. \"Two beautiful souls, trapped in the illusion of competition.\"","","A stray wave hits your face.","A trainee splashes you violently in their panic.","You do not flinch. An invisible Shield of Love surrounds you. The water simply slides off your aura.","\"I forgive you,\" you whisper with a serene, terrifying smile. \"Your hatred is like a Tumblr troll waiting for my next update=a lie projected into a reality that doesn't even exist.\"","","The PD screams, his veins popping.","\"${name}! STOP FLOATING! THIS IS A DEATH MATCH, NOT A SPA DAY! ATTACK SOMEONE!\"","","You open your eyes slowly. His voice does not annoy you. It sounds like a bird chirping.","\"Sang-ho is suffering too,\" you realize. \"He screams because he needs a hug.\"","","You raise a wet hand and offer him a silent blessing.","\"Namaste, PD-nim. May you find the peace you seek.\"","","The chaos rages around you, bodies flying, egos bruising.","But you remain untouched. You are the Lotus flower blooming in the mud of reality TV.","You drift aimlessly, carried by the current of destiny.","","Eventually, the silence returns.","You have lost the bed, but you have won something far greater:","Transcendence.","","*set victory false","*set stress %-20","*goto pool_party_aftermath","","*label choose_partner_normal","","You need a partner. And you need one fast.","","*if (p_height = \"Really Short\") or (p_height = \"Short\")","    You look at the water level. It is... concerning.","    Most trainees are standing chest-deep. You are neck-deep, bobbing like a cork.","    Whoever gets on your shoulders is going to have a very wet, very panic inducing ride.","    The PD notices and cackles. \"Can someone get ${name} a snorkel? We don't have insurance for drowning!\"","","*choice","    # Haneul. (Platonic) \"We stick together, buddy.\"","        *set rel_haneul %+10","        *set partner \"Haneul\"","        *set partner_type \"platonic\"","        ","        You wade toward Haneul.","        \"${name}!\" Haneul gasp${h_s}. \"Rio is huge. We're going to get crushed.\"","        ","        \"Not if we're faster,\" you grin, slapping Haneul's shoulder. \"I'll be the horse. You're light. Hop on.\"","        ","        Haneul swallow${h_s} hard. \"Okay. But if I scream, just ignore it.\"","        ","        Haneul climb${h_s} onto your shoulders.","        *if (p_height = \"Really Short\") or (p_height = \"Short\")","            Haneul screech${h_es}. \"Why is the water touching my chin?! ${name}, I'm not a submarine!\"","            \"Hush,\" you strain under the weight, blowing bubbles. \"It's stealth mode.\"","            *goto chicken_fight_start","        *else","            \"I'm shaking,\" Haneul whisper${h_s}.","            \"Just hold my hair. Don't pull it out.\"","            *goto chicken_fight_start","        ","","    # Haneul. (Romantic) \"I want you close.\"","        *set rel_haneul %+15","        *set romance_haneul true","        *set partner \"Haneul\"","        *set partner_type \"romantic\"","        Youre both in the pool.","        You step into Haneul's personal space.","        \"So are you in?\" you murmur, placing a hand on ${h_his} waist, beneath the water lvl where nobody can see.","        ","        Haneul blush${h_es} so hard ${h_he} turn${h_s} pinker than Rio's hair.","        \"O-okay.\"","        ","        As Haneul slide${h_s} onto your shoulders, the contact is electric.","        *if (p_height = \"Really Short\") or (p_height = \"Short\")","            Although, the romance is slightly under cut by Haneul sputtering water.","            \"I'm... cough... I'm drowning in your love, literally,\" ${h_he} joke${h_s} nervously, trying to keep ${h_his} nose above the surface.","            ","        *goto chicken_fight_start","        *else","            \"Is this okay?\" Haneul whisper${h_s}, breath hot against your ear.","            \"Perfect,\" you murmur.","        *goto chicken_fight_start","","    *selectable_if ((visual > 50) or (charisma > 50)) # Noa. The Host. (Its just business) \"Let's save the ratings.\"","        *set rel_noa %+5","        *set partner \"Noa\"","        *set partner_type \"platonic\"","        ","        You walk up to the cabana where Noa is looking at her phone.","        \"This footage is unusable,\" you say flatly, dripping water on the expensive tile.","        ","        Noa looks up. \"Tell me about it. It's like watching toddlers fight in soup.\"","        ","        \"Join me,\" you offer. \"Let's show them how a Pro does variety. Good airtime for me, good image branding for you.\"","        ","        Noa considers it. She looks at the chaos, then at you.","        \"Fine. I need to get my engagement numbers up anyway. But don't make me look stupid.\"","        ","        She steps into the water.","        *if (p_height = \"Really Short\") or (p_height = \"Short\")","            She stops. She looks at you. She looks at the water level reaching your chin.","            \"Absolutely not,\" she sighs. \"I ordered a stallion, I got a pony. Crouch down, I'm not ruining my hair.\"","        *goto chicken_fight_start    ","            ","        *else","            \"Shoulders,\" she commands efficiently. \"And don't wobble. I'm wearing vintage.\" ","        *goto chicken_fight_start","","    *selectable_if ((visual > 40) and ((per_bold > 60) or (rebellion > 60))) # Noa. The Host. (Power couple) \"Make me.\"","        *set rel_noa %+15","        *set rebellion %+10","        *set partner \"Noa\"","        *set partner_type \"romantic\"","        ","        You walk right up to the cabana. Water drips from your clothes onto the pristine white tiles, forming a puddle at her feet.","        ","        Noa looks up. For a split second, her face lights up, a reflexive, warm, almost girlish smile.","        \"Oh! Hi did you need...\" She quiets down.","        ","        Then she sees the look in your eyes. She sees you aren't a fan or an assistant. You are a threat.","        The smile vanishes instantly. The temperature drops. She slides her sunglasses back up her nose.","        ","        \"The kiddy pool is that way, trainee,\" she draws out, checking her nails. \"Don't drip on the Gucci. It's vintage.\"","        ","        \"I don't care about the Gucci, UNNIE/NOONA.\"","","        *if (entry_method = \"medical_wildcard\")","            [i](Internal Monologue: She told you to use it only when the cameras were off. You just broke the only rule she gave you.)[/i]","            Noas grip tightens on her coffee cup. The gentle woman from the Rolls Royce is gone, replaced by a professional who looks like she wants to kill you.","            *set rel_noa %-4","            *set scandal_risk %+5","            *goto 5","        *else","            The silence is absolute. Noa looks at you like you're a glitch in the system that needs to be erased.","            *set rel_noa %-7","            *set scandal_risk %+10","            *goto 5","","*label 5","","\"Excuse me?\" She lowers the glasses slowly, her eyes flashing dangerously. \"You realize I can end your career with a phone call?\"","","How do you disarm the Queen?","","*fake_choice","    # The Raw Honesty. \"I'm just looking at you.\"","        *set per_gentle %+5","        \"Go ahead,\" you whisper. \"Make the call.\"","        You lean in, voice dropping to a murmur only she can hear.","        \"Everyone else is looking at the VIP bed. They want the prize.\"","        ","        You lock eyes with her.","        \"I'm just looking at you. And I'd ruin a thousand vintage dresses just to get your attention.\"","        ","        Noa's breath hitches. She searches your face for the lie, for the strategy. She finds only hunger.","        Her \"Host\" mask cracks. A flush creeps up her neck.","        ","        \"You...\" she starts, her voice losing its icy edge. She looks away, flustered.","        \"You are impossibly annoying.\"","","    # The Fan Twist. \"One sentence. Then I leave.\"","        *set rebellion %+5","        *set charisma %+5","        \"I just came to say one thing,\" you say, holding your hands up in surrender. \"Then I'll walk away and leave you alone.\"","        ","        Noa sighs, not looking up from her phone. She sounds exhausted.","        \"Fine. Make it quick. You have ten seconds.\"","        ","        \"I've followed you since your acting days,\" you say softly. \"You were incredible in 'My Dad is the Antichrist'. The only one on that screen who could actually cry on cue.\"","        ","        Noa freezes. Her thumb stops scrolling.","        She slowly lowers her sunglasses, looking at you with genuine surprise.","        \"You... you watched that?\" Her voice is softer, almost vulnerable. \"The special effects were literal cardboard.\"","        ","        \"The effects didn't matter,\" you correct her.","        You take a step closer.","        \"But I don't want an autograph, Noa.\"","        ","        She raises an eyebrow, intrigued. \"No? Then what?\"","        ","        \"I want the honor of playing with you,\" you smile, extending a hand. \"Be my scene partner one last time?\"","        ","        Noa stares at you. A slow, delighted smile spreads across her face.","        \"A scene partner...\" she muses, putting her phone away. \"I haven't had a good one of those in years.\"","","    # The Silent Invitation. Just extend your hand and wait.","        *set charisma %+5","        You don't say another word.","        You simply stand there, dripping wet, and extend your hand toward her. Palm open. Waiting.","        ","        Noa stares at your hand. She looks genuinely confused.","        \"What?\" she asks, frowning. \"Do you want a tip? A napkin? Use your words, trainee.\"","        ","        You just smile, keeping your hand steady.","        It's a silent challenge. Trust me.","        ","        Noa looks at your hand, then up at your eyes. She realizes you aren't asking for something [i][b]from her. You are offering something to her.[/b][/i]","        She bites her lip, trying to suppress a smile. It's... kind of cute. In a weird, confident way.","        \"You're weird,\" she mutters, shaking her head.","        \"Totally weird.\"","        But she reaches out.","","The silence stretches.","Her fingers brush yours.","","\"Fine,\" she whispers, kicking off her heels.","\"But turn around.\" She puts a hand on your shoulder to spin you around.","\"If you drop me,\" she says, her breath hot against your neck, \"I will kill you.\"","","The Villa goes silent as the Host enters the water.","She mounts you. Her legs wrap around your neck.","","*if (p_height = \"Really Short\") or (p_height = \"Short\")","    As she settles, the water rises perilously close to her waist.","    She stiffens, clutching your head with both hands.","    \"Wait,\" she hisses into your ear. \"Why is the water so deep? Or are you just... compact?\"","    \"I'm travel-sized,\" you grunt, standing on your tiptoes. \"Aerodynamic.\"","    \"Oh my god,\" she suppresses a snort of laughter, pressing her forehead against the back of your head. \"I'm going to die on a hobbit. Just drive.\"","    *goto pd_announcement","*else","    She leans forward, her chest brushing the back of your head.","    Its intimate. Heavier than you expected.","    \"Don't get any ideas,\" she whispers, but her fingers tangle gently in your wet hair. \"Just drive.\"","    *goto pd_announcement","","*label pd_announcement","The PD screams: \"THE HOST IS IN THE POOL?! I LOVE IT! ZOOM IN ON THE TENSION!\"","*goto chicken_fight_start","","*label chicken_fight_start","\"FIGHT!\"","","Rio charges like a bulldozer. Coco laughs maniacally on top.","Your partner tightens their grip.","","*if (p_height = \"Really Short\") or (p_height = \"Short\")","","    You are barely keeping your nose above the surface.","    ","    *if (partner = \"Noa\")","        \"Don't you dare go under!\" Noa shrieks, her nails digging into your scalp. \"My earrings are not waterproof!\"","    *if (partner = \"Haneul\")","        \"Blargh!\" Haneul sputters as a wave hits him. \"I'm drinking the pool! ${name}, periscope up! Periscope up!\"","","    Rio is aiming for your chest, but you are so low in the water he can barely find a target.","    *goto chicken_fight_mechanics","","*else","    You brace your legs against the pool floor. You are the wall.","    *goto chicken_fight_mechanics","","*label chicken_fight_mechanics","","The collision happens in slow motion.","Rio slams into the water like a cannonball, creating a wave that hits you in the face.","Coco leans forward, reaching out to shove your partner.","","*choice","    # Use my Dance balance (and low center of gravity). (Dance > 50)","        *if (dance > 50)","            *set victory true","            Rio expects you to fight force with force. But you? You are fluid.","            ","            *if (p_height = \"Really Short\") or (p_height = \"Short\")","                You take a deep breath and... sink. You squat down underwater. Rio swings at empty air.","                ","                *if (partner = \"Noa\")","                    *set rel_noa %+5 ","                    *comment --- Physical Competence Boost ---","                    \"Filho da pu**!\" Noa snaps as she tilts back, the sound cut short by the splash. ","","                    Then, you surge back up like a hydraulic lift.","","                    She breaks the surface, blinking away the water with a sharp, competitive grin. ","","                    \"Surprise, MF\" she hisses, using the momentum to shove a confused Coco.","                    *goto victory_dance_end","                *elseif (partner = \"Haneul\")","                    *set rel_haneul %+5","                    *comment --- Protector Boost ---","                    Haneul screams as he dips into the water, then laughs hysterically as you pop back up. \"Submarine attack!\" he yells, flailing his arms and accidentally smacking Coco in the face.","                    *goto victory_dance_end","                *else","                    *goto victory_dance_end","","            *else","                You pivot your hips, shifting your weight with the grace of a main dancer. Rio stumbles, unable to stop his momentum. Your partner shoves Coco at the perfect moment.","                ","                *comment --- Logic for Normal Height Win ---","                *if (partner = \"Noa\")","                    *set rel_noa %+5","                *if (partner = \"Haneul\")","                    *set rel_haneul %+5","                ","                *goto victory_dance_end","","            *label victory_dance_end","            SPLASH. Coco loses balance. Rio trips over his own feet. They go down in a heap of limbs and neon hair dye.","            ","            You stand tall (or as tall as you can).","            *goto chicken_fight_outcome","            ","        *else","            *set victory false","            You try to pivot, but the water resistance is too strong.","            ","            *if (p_height = \"Really Short\") or (p_height = \"Short\")","                Rio simply walks [i]over[/i] you. \"Wait, where did they go?\" Rio asks, looking around.","                You are currently underwater, being crushed by the defeat.","                *goto chicken_fight_outcome","            *else","                Rio hits you like a truck. Balance lost. \"Timber!\" Coco laughs.","                You and your partner topple backward into the chlorine abyss.","                *goto chicken_fight_outcome","","    # Use Charisma. Psychological Warfare. (Charisma > 55)","        *if (charisma > 55)","            *set victory true","            *set ruthless %+5","            Rio is charging. You don't move. You just scream.","            ","            \"COCO! YOUR HAIR!\"","            ","            Coco freezes, hands flying to ${c_his} head. \"What? Is it flat?\"","            ","            \"IT'S TURNING GREEN!\" you lie with the conviction of an Oscar winner. \"THE CHLORINE IS REACTING WITH THE BLEACH!\"","            ","            *if (p_height = \"Really Short\") or (p_height = \"Short\")","                You add: \"I can see the roots from down here! It's moss green!\"","            ","            \"NO!\" Coco shrieks, letting go of Rio to check the reflection in the water.","            ","            Rio, confused by the sudden lack of rider participation, loses balance. Gravity does the rest. ","            Coco falls backward with a dramatic, cinematic scream.","            ","            *if (partner = \"Noa\")","                *set rel_noa %+8","                *comment --- Ruthless/Cunning Boost (Noa likes mean) ---","                Noa laughs, a small unnoticed, delighted sound. \"Cruel. I love it.\"","            ","            *if (partner = \"Haneul\")","                *set rel_haneul %+5","                *comment --- Relief Boost ---","","            *goto chicken_fight_outcome","        *else","            *set victory false","            \"Your hair is green!\" you scream.","            Coco smirks, not missing a beat. \"Honey, this is 'Mint Breeze'. It's intentional.\"","            Rio tackles you. Game over.","            *goto chicken_fight_outcome","","    # Rely on Synchronization. (Relationship Check)","        *if (partner = \"Noa\")","            *if (rel_noa > 20)","                *set victory true","                *set rel_noa %+10","                *comment --- Connection/Sync Boost (Highest) ---","                Noa doesn't need words. She leans left. You move left. It's telepathy born of arrogance.","                ","                *if (p_height = \"Really Short\") or (p_height = \"Short\")","                    \"Jump!\" she commands. You launch yourself off the bottom. It gives her the high ground for one second. She pushes Coco's forehead with a single finger. \"Down.\"","                    *goto synchronization_end","                *else","                    You lock your legs. She locks her core. You are a statue. Rio bounces off you.","                    *goto synchronization_end","            *else","                *set victory false","                Noa leans left. You lean right. \"The other left, idiot!\" Noa screams as you capsize.","                *goto chicken_fight_outcome","","        *elseif (partner = \"Haneul\")","            *if (rel_haneul > 40)","                *set victory true","                *set rel_haneul %+10","                *comment --- Connection/Trust Boost (Highest) ---","                \"Haneul, duck!\" you scream. Haneul ducks blindly, trusting you completely.","                Coco swings at air, loses balance, and takes Rio down with ${r_him}.","                ","                *if (p_height = \"Really Short\") or (p_height = \"Short\")","                    \"We didn't die!\" Haneul gasps, hugging your head. \"I can see the sky!\"","                *goto synchronization_end","            *else","                *set victory false","                \"Duck!\" you scream. \"Quack?\" Haneul asks, confused.","                SMACK. You get hit by a beach ball and fall over.","                *goto chicken_fight_outcome","        *else","            *goto chicken_fight_outcome","","        *label synchronization_end","        Coco splashes down. Noa barely got her hands wet.","        *goto chicken_fight_outcome","","*label chicken_fight_outcome","The splash clears. The winner is decided.","","*if (victory)","    \"WE HAVE A WINNER!\" The PD screams, practically vibrating.","    ","    *if (partner = \"Noa\")","        Noa slides off your shoulders. But she doesn't step back. She doesn't pose.","        The adrenaline hits her. The victory hits her. She forgets the cameras. She forgets the Gucci.","        ","        \"YES!\" she screams, grabbing your shoulders and shaking you. \"Did you see that?! We destroyed them!\"","        ","        She is laughing, a real, breathless, uncurated laugh. Before you can react, she throws her arms around your neck.","        ","        *if (partner_type = \"romantic\")","            For a moment, time stops. [i](Internal Monologue)[/i] You freeze. The Host is hugging you.","            ","            *if (p_height = \"Short\") or (p_height = \"Really Short\")","                Her wet body is pressed flush against yours, but... your face is currently buried directly in her cleavage. ","                She smells like expensive vanilla and chlorine. Her heart is hammering a frantic rhythm right against your ear.","                You stiffen, arms hovering awkwardly. \"Don't make it weird,\" you chant internally.","                *goto victory_post_hug","            *else","                Her wet body is pressed flush against yours. You instinctively wrap your arms around her waist. For three seconds, she isn't Noa the Host. She's just a girl who loves winning.","                *goto victory_post_hug","        *else","            She high-fives you, then realizes she broke character. She clears her throat.","            *if (p_height = \"Really Short\") or (p_height = \"Short\")","                \"You are,\" she pants, \"a very effective travel-sized weapon. Good job, pocket rocket.\"","                *goto victory_pd_comment","            *else","                \"Good job, trainee. Adequate performance.\"","                *goto victory_pd_comment","","        *label victory_post_hug","        \"OH MY GOD!\" The PD's voice booms. \"THE CHEMISTRY! THE TENSION! KISS HER!\"","        The sound snaps Noa back. She stiffens and shoves you away, hard.","        \"Don't touch me!\" she snaps, trying to regain her composure. \"It meant nothing.\"","        *set romance_noa true","        *set rel_noa %+10","        *goto victory_pd_comment","","    *elseif (partner = \"Haneul\")","        Haneul lets out a long, shaky breath, pushing wet hair back. The perfect \"Royal\" mask cracks, revealing a genuine smile. \"We survived,\" ${h_he} laughs.","        ","        *if (partner_type = \"romantic\")","            ${h_he} doesn't hug you. Instead, ${h_he} steps closer, sliding ${h_his} hand into yours underwater. The grip is tight. Possessive.","            \"I would have fallen without you,\" ${h_he} murmurs. \"Don't let go yet.\"","            *set romance_haneul true","            *goto victory_pd_comment","        *else","            Hanuel offers you a firm, respectful handshake. \"You are a fortress, ${name}. Thank you for protecting me.\"","            it is a compliment from a monarch to his knight.","            *goto victory_pd_comment","","    *label victory_pd_comment","    *if (romance_coco)","        From the water, Coco wipes hair out of ${c_his} eyes. ${c_he} isn't mad. ${c_he} is grinning. \"Rough,\" Coco mouths at you. \"I like it.\"","    ","    *set stress %-10","    *set victory true","    *goto pool_party_aftermath","","*else","    You surface, coughing up chlorine. Coco is high-fiving Rio.","    ","    *if (romance_coco)","        Coco swims over, looking smug. \"Nice try, babe,\" ${c_he} winks.","        *if (p_height = \"Really Short\") or (p_height = \"Short\")","            Coco rests ${c_his} elbow on top of your head. \"Aww, you're the perfect height for an armrest,\" ${c_he} teases.","            *goto defeat_reaction_start","        *else","            \"Don't worry about the bed. You can always sneak into mine.\" ${c_he} splashes water in your face.","            *goto defeat_reaction_start  ","    *else","        \"Nice try, babe,\" Coco winks. \"But the bed is mine.\"","        *goto defeat_reaction_start     ","","*label defeat_reaction_start","*if (partner = \"Noa\")","    Noa surfaces, looking like a drowned rat. The loss hits her hard. \"Useless,\" she whispers, pushing you aside and storming out.","    *set rel_noa %-5","    *goto defeat_common","    ","*elseif (partner = \"Haneul\")","    Haneul surfaces slowly, maintaining poise. ${h_he} wipes ${h_his} eyes and offers a tired nod. \"A disappointing outcome. My balance was... insufficient.\"","    *goto defeat_common","","*label defeat_common","The PD sighs. \"Coco and Rio take the win! Everyone else... enjoy your mediocrity.\"","*set victory false","*goto pool_party_aftermath","","*label pool_party_aftermath","*page_break The Calm Before the Storm","*temp coco_nickname \"\"","","The water settles. The adrenaline fades.","The losers are toweling off, shivering in the LA breeze. The winners are gloating.","","*if (zen_mode)","    You are still floating.","    You have transcended the pool. You are a biological buoy.","    Your skin is pruning. You have officially been wet for too long.","    ","    Suddenly, a shadow blocks your sun.","    \"Excuse me?\" A voice drips with disdain from above. \"Sleeping Beauty?\"","    ","    Something taps your forehead. Its the PDs fan.","    ","    \"Hello? Is anyone home?\" The PD snaps his fingers.","    \"Honey, look at you. You are marinating. You are literally a tandoori chicken\"","    ","    He recoils dramatically as you open your eyes.","    \"Ugh. Look at that texture. Someone get a towel! I asked for Fresh Idol, not Soggy Bread! Get this wet moppet out of my composition, it's ruining the feng shui!\"","    *set stress %-15","    *set visual %-2","    [i](Zen Outcome: Stress reduced, but the PD roasted your commitment to being the dragon warrior)[/i]","    *goto 2","","*else","    You climb out of the pool, grabbing a towel.","    Your muscles ache, but the camera is still rolling. There is no rest.","    *goto 2","","*comment --- Step 6: Background Moments ---","*label 2","Suddenly, a loud SPLASH echoes from the other side of the pool.","","You turn to see Haneul.","$!{h_he} @{(h_he = \"they\") were|was} trying to climb onto a giant inflatable pink flamingo with Royal-like elegance.","$!{h_he} flopped. The flamingo flipped. shame, shame, shame (jk).","Haneul is now face-down in the water, legs flailing.","","\"YES!\" The PD screams into his megaphone, delighted.","\"THE FLAMINGO STRIKES AGAIN!","","Haneul @{(h_he = \"they\") surface|surfaces}, hair plastered to ${h_his} face, looking utterly betrayed by the bird.","","*comment --- Noa's Branching Logic (Only Platonic/Other Partner) ---","*if (partner != \"Noa\") or (partner_type != \"romantic\")","    The DJ switches the track. The aggressive EDM fades into a slow, heavy, hypnotic R&B beat.","","    Noa is standing on the sidelines.","    She didn't participate (or she washed off the peasant dirt) She is pristine, wrapped in a silk robe, looking down at the wet trainees.","    ","    She starts to walk toward the villa to escape the noise.","    But then the bass kicks in.","    ","    Its a reflex. She stops.","    She closes her eyes. The tough girl act vanishes .","    Her body moves before her mind does. A sharp isolation of the ribcage. A fluid, liquid roll of the hips.","    ","    She drops her robe onto a chair.","    She walks to the center of the empty dance floor. She is the only dry person there, electric and magnetic.","    She dances like she doesn't care who is watching. For a moment, she isn't a celebrity. She is just an artist.","    ","    Suddenly BZZZZZ.","    A camera drone drops from the sky, buzzing inches from her face to get the \"money shot.\"","    ","    The trance breaks.","    Noa's eyes snap open. She doesn't scream. She doesn't recoil.","    Her eyes narrow into dangerous slits.","    ","    She reaches out to a nearby table and grabs a silver champagne bucket.","    With the reflexes of a viper, she swings.","    ","    CLANG.","    ","    She catches the drone in mid-air, slamming the bucket down onto the table, trapping the buzzing machine inside like a bug.","    ","    The music stops. The PD gasps.","    Noa looks straight into the main camera lens. A single tear of frustration escapes her eye, but her voice is steady as steel.","    ","    \"Deduct it from my paycheck\" she says coldly.","    ","    She turns and storms toward the villa, leaving a stunned silence in her wake.","","*comment --- Step 7: The PD Intervenes ---","","*if (zen_mode)","    The PD raises a hand, and the music cuts out, leaving only the sound of water lapping against the tiles. He walks over to the edge of the pool, crouches down, and looks at you with what almost looks like genuine concern. ","","    He reaches out, his fingers light as a feather as he adjusts a stray damp hair from your forehead. \"Oh, honey,\" he coos, his voice a soft, velvet purr. \"Look at you. You look like a painting. So... serene. So untouched by the chaos of this industry. Its almost spiritual.\"","","    He pauses, giving you a small, encouraging smile before his eyes go cold. ","","    \"Its a beautiful vibe, darling. Truly. But heres the thing...\" He tilts his head, the smile never leaving his face. \"This is a survival show, not a mid-life crisis memoir. Youre giving me spiritual awakening in a Bali ashram, but sweetie, youre not Julia Roberts, and we aren't flying to Italy to find ourselves over a bowl of pasta.\"","","    His hand drops away as he stands up, smoothing his own outfit. \"Go dry off. Youre not here to Eat, Pray, or Love. Youre here to be an idol, and right now? Your inner peace is giving me zero screen time. And we both know thats a tragedy I won't allow.\"","    *goto 4","*else","    The PD marches up to you. He looks bored.","    \"Okay, the water fight was cute. But I need meme worthy content\"","    *goto 4","","*label 4","*temp s \"s\"","*temp es \"es\"","*temp is \"is\"","*temp does \"does\"","*temp has \"has\"","*temp royal_title \"Prince\"","","*comment ---    / Non-binary (They/Them) ---","*if (r_he = \"they\") or (r_he = \"They\")","    *set s \"\"","    *set es \"\"","    *set is \"are\"","    *set does \"do\"","    *set has \"have\"","    *set royal_title \"Royal\"","","*comment ---    (  ) ---","*if (r_he = \"she\") or (r_he = \"She\")","    *set royal_title \"Princess\"","The PD points his fan at Coco.","","Coco is sprawling on the sunbed like a bored ${royal_title}. ","${r_He} ${is} sixteen, holding a glass of blue gin on national television, and look${s} like ${r_he} would rather be literally anywhere else.","","No plotting. No evil mastermind smirk. Just pure, unadulterated apathy mixed with a \"try me\" attitude.","","\"Go,\" the PD bark${s}. \"Friction. Now.\"","","You walk over.","","*if (rank_tier  = \"Master\")","    Coco glance${s} up. ${r_He} ${does}n't sit up. ${r_He} ${does}n't bow.","    \"Great,\" ${r_he} mutter${s}, popping a piece of ice into ${r_his} mouth. \"My 'Master' is here. Do me a favor and block the sun, will you? It's too bright.\"","    *goto coco_confrontation","","*else","    Coco ${does}n't even look at you. ${r_He} just stretch${es} a leg out, blocking your path.","    \"You're in my way, Servant. Unless you're bringing me a refill, get lost.\"","    *goto coco_confrontation","","*label coco_confrontation","How do you handle the brat?","","*fake_choice","    # \"Oi, Lucifer.\" ","        *set rebellion %+5","        *set rel_rival %-7","        *set rival_nickname \"Lucifer\"","        ","        You kick the leg of the sunbed. Hard. The gin splash${es} onto ${r_his} hand.","        \"Wake up, Lucifer. You're not at home.\"","","        Coco flinch${es}, staring at the spilled drop of alcohol like you just shot a puppy. Then ${r_he} look${s} up, eyes wild.","        \"You owe me a drink,\" ${r_he} snap${s}, wiping ${r_his} hand on the expensive upholstery. \"Do that again and I'll bite you. I'm not kidding.\"","        ","        It's not a smooth threat. It's a teenage promise of violence.","","    # \"Hey, Honeypoo.\" ","        *set the_mask %+5","        *set rel_rival %-3","        *set rival_nickname \"Honeypoo\"","        ","        You grab the glass. \"No booze for you, Honeypoo. You have school tomorrow.\"","        You dump the gin into the pool.","","        Cocos jaw drop${s}. ${r_He} look${s} at the empty glass, then at you, genuinely baffled by the audacity.","        \"Did you just...?\" ${r_he} stammer${s}, face flushing red. \"That was a 50-dollar shot, you psycho! Who do you think you are?!\"","        ","        ${r_He} look${s} less like a villain and more like a kid whose toy just got smashed.","","    # \"Sunbae... my Sunflower (Haebaragi).\" ","        *set rel_rival %+10","        *set rival_nickname \"Haebaragi\"","        *set charisma %+5","        \"My Haebaragi,\" you coo, poking ${r_his} cheek. \"You look so cute when you're trying to be edgy.\"","","        Coco swat${s} your hand away, looking genuinely grossed out. \"Don't touch me. You're weird.\" ","        ${r_He} shift${s} away, but keep${s} watching you from the corner of ${r_his} eye, intrigued despite ${r_him}self. \"Like, seriously weird. Do it again.\"","","    # \"Jagiya.\" ","        *set charisma %+5","        *set rel_rival %+5","        *set romance_coco true","        *set rival_nickname \"Jagiya\"","        ","        You don't say anything. You just grab ${r_his} glass, lock eyes, and down the rest of the gin in one go.","        You slam the empty glass back on the table. \"Thanks, Jagiya.\"","","        Coco stare${s} at the empty glass. Then at your lips. ${r_He} blink${s}, processing what just happened.","        Slowly, a real, jagged grin break${s} through the boredom. ","        \"Okay,\" ${r_he} laugh${s}, a rough, surprised sound. \"You're crazy. I think I hate you. Sit down.\"","","*comment --- Step 8: The Staged Drama & Yuri ---","","Before you can continue the banter, a shadow falls over you both.","","It's Min-ho. The Red Shirt trainee with the desperate eyes.","He steps between you and Coco, blocking your view.","","\"Back off,\" Min-ho snaps at you, checking the reflection in the camera lens.","\"Can't you see Coco is tired? Stop bothering the visuals.\"","","Yuri, who was sitting quietly nearby tuning a guitar, stands up nervously.","\"Min-ho, stop,\" Yuri whispers. \"They were just talking. Don't make a scene.\"","","Min-ho spins around. \"Oh Jiwon's little shadow decides to speak\"","","The pool area goes silent.","Min-ho sneers. \"Who asked you? You're lucky to even be here.\"","","Yuri shrinks back. \"I... I just...\"","","\"We all know the truth\" Min-ho shouts, his voice echoing off the water.","\"You're not an idol. You're just a [i]Ghost Singer[/i] in a trainee's costume. You're here to sing the high notes for the pretty ones and then disappear.\"","","Yuri freezes. ","\"Min-ho!\" Coco stands up, the playful mask gone. \"That's too far.\"","","But the damage is done.","Yuri drops the guitar and runs toward the gardens, shoulders shaking.","","*label pool_party_cut","*page_break The Magic of Editing","","\"AND... CUT!\"","","The PD's voice slashes through the tension like a guillotine.","The music stops abruptly.","Min-ho, who was looking furious a second ago, immediately relaxes his shoulders and checks his hair in a pocket mirror.","Coco yawns, scratching ${r_his} nose.","","The PD looks at the sky. The sun is dipping below the horizon.","\"We are losing the light!\" he screams at the lighting crew. \"I can't film a climax in this lighting! I look washed out!\"","","He turns to the trainees.","\"Listen up, Angels! We are wrapping for today. We will pick up the Aftermath scene tomorrow morning at 6:00 AM sharp.\"","","He points his fan at everyone aggressively.","\"Do. Not. Change. Your. Clothes.\"","","A murmur of disgust ripples through the group.","\"I want Continuity!\" the PD barks. \"I want you in the same crusty swimsuits, with the same smeared makeup. If anyone showers and looks too fresh, I will sue them for breach of contract!\"","","He claps his hands. \"Go away darlings, Don't look at me. I need wine and a facial\" ","","The cameras stop rolling.","The illusion breaks.","Suddenly, you aren't characters in a drama. You are just exhausted teenagers smelling of chlorine.","","*label night_choices","","*page_break Behind the Scenes nighttime","","The Villa is quiet.","Outside the glass walls, the lights of Seoul shimmer in the distance.","Most trainees have collapsed in the common room, careful not to ruin their \"Continuity Look\" too much.","","But two people are missing.","","Yuri never came back after running to the gardens. (well she did sneak into the pool area to take her guitar but thats it I swear)","","Noa was seen heading up to the secluded VIP balcony with a bottle of something expensive.","","You have a moment before you pass out. Who do you look for?","","*choice","    # Go find Yuri in the gardens.","        *set per_gentle %+5","        *set rel_yuri %+10","        You grab a bottle of water and head into the dark, curated gardens.","        The steam from the tropical heat lamps creates a misty, surreal atmosphere.","        ","        It doesn't take long to find ${yuri_him}.","        ","        Yuri is sitting on a stone bench, hugging knees to chest.","        On ${yuri_his} wrist, the gold velvet band of the \"Master\" rank glitters in the moonlight.","        ","        The guitar is lying on the grass, forgotten.","        ","        \"Go away,\" Yuri croaks. The voice is thick with tears. \"The cameras aren't here.\"","        ","        \"That's why I'm here,\" you say softly, sitting on the other end of the bench.","        ","        Yuri looks down at the Gold Band.","        \"Min-ho was right,\" ${yuri_he} whispers. \"I'm a fraud. I'm wearing this Gold band, but I'm just a ghost.\"","        ","        ${yuri_He} wipes ${yuri_his} eyes aggressively.","        \"I recorded the high notes for lets kill this dove and the idols lip-synced. I got paid, they got the fame. And now... now I'm here, pretending I'm a star.\"","        ","        ${yuri_He} looks at you, eyes hollow.","        \"I feel like I tricked everyone. Like any moment now, the PD is going to walk in and say it was all a mistake.\"","        ","        The air is too heavy. You need to break the tension before ${yuri_he} spirals completely.","        How do you try to make ${yuri_him} smile?","        ","        *fake_choice","            # Do a brutal impression of Min-ho's voice crack.","                *set charisma %+5","                *set rel_yuri %+5","                You stand up and puff out your chest.","                \"YOU!\" you shout in a cracked, whiny voice, pointing a finger. \"How DARE you be talented! My hair gel is more important than your vocals!\"","                ","                Yuri blinks, startled. Then, a snort escapes ${yuri_him}.","                \"He doesn't sound like that,\" ${yuri_he} protests weakly, but the corners of ${yuri_his} mouth twitch.","                \"He sounds worse\" you correct, sitting back down.","","            # Tell ${yuri_him} about your own embarrassing moment today.","                *set per_gentle %+5","                *set rel_yuri %+8","                \"If we're talking about mistakes\" you say dryly \"I spent twenty minutes today thinking the bidet was a drinking fountain.\"","                ","                Yuri turns to look at you, eyes wide. \"You didn't.\"","                \"I might have\" you shrug. \"So if you're a fraud, I'm a public health hazard. We make a great team.\"","                Yuri lets out a breathless, wet laugh. \"You're an idiot, ${name}.\"","","            # Make a dark joke. Being a ghost is better than being a puppet.","                *set ruthless +5","                *set rebellion +5","                \"You're looking at it wrong,\" you say, a cold smirk touching your lips.","                \"The [b]stars[/b] are the ones who get stalked, criticized, and starved. They are the targets.\"","                ","                You lean in.","                \"Being a Ghost? You're the sniper. You do the damage, you get the check, and nobody shoots back. Sounds like a win to me.\"","                ","                Yuri stares at you, stunned by the cynicism.","                Then, a micro expression of a smile spreads across ${yuri_his} face.","                \"A sniper...\" ${yuri_he} murmurs. \"I guess... I guess Min-ho is just moving target practice, then?\"","","        The mood shifts. It's still sad, but the panic has subsided.","        Yuri takes a deep breath. \"So... what do I do? How do I walk in there tomorrow?\"","        ","        *choice","            # \"The voice IS the Star Quality. Everything else is just packaging.\"","                *set rel_yuri %+10","                *set vocals %+5","                \"Without you, their songs are empty,\" you say firmly.","                \"You aren't a fraud. You're the engine. Now it's time to drive the car.\"","                Yuri looks at you, touching the Gold band. A small glimmer of hope returns.","                *goto yuri_resolved","","            # \"I feel the same way. Like I'm just acting the part until I get caught.\" [Acquire Trait: Imposter Syndrome]","                *set per_gentle +5","                *set rel_yuri %+15","                *set self_belief %-10","                *set imposter_syndrome true","                You look at your own hands.","                \"I wake up every morning terrified,\" you admit, your voice barely a whisper.","                \"I look in the mirror and I don't see an Idol. I just see... me. And I'm scared everyone else sees it too.\"","                ","                Yuri stares at you. The isolation in ${yuri_his} eyes breaks.","                \"You too?\" ${yuri_he} breathes.","                \"Yeah. Me too.\"","                ","                [b]TRAIT GAINED: IMPOSTER SYNDROME[/b]","                [i](System: You have internalized the fear of being a fraud. Future losses to Self-Belief will be doubled.)[/i]","                *goto yuri_resolved","","        *label yuri_resolved","        \"Thanks, ${name},\" Yuri whispers, picking up the guitar.","        \"I... I think I'll stay here a bit longer. Practice until I feel like I deserve this Gold.\"","        *goto sleep_before_morning","","    # Go find Noa on the VIP Balcony.","        *goto balcony_scene_start","    ","        ","*label balcony_scene_start","[i]The Balcony[/i]","","Shes leaning over the railing, a crystal glass loosely held in her fingers. A heavy bottle of vintage red rests on the concrete floor beside her.","","She takes a sip, swirling the dark liquid. She looks calm. Too calm for someone who just demolished a drone.","\"2018 Vintage,\" she murmurs. \"Supposed to have notes of oak and blackberry. I just taste the headache.\"","","*if (origin = \"gyopo\")","    [i](Author: Gyopo recognize Gyopo. Its a vibe check.)[/i]","    She tilts her head, squinting at you. \"You look like you need a drink too. The air here... it's too thin for people like us. We bow, but not deep enough.we work, but not hard enough,we speak but not clear enough. Always half-and-half.\"","","*comment --- THE SPLIT LOGIC ---","*if (rel_noa < 30)","    *goto scene_noa_low","*elseif (rel_noa >= 30) and (romance_noa = false)","    *goto scene_noa_friend","*else","    *goto scene_noa_romance","","*comment ==========================================================","*comment PATH 1: ROMANCE (The Chess Match)","*comment ==========================================================","*label scene_noa_romance","","[i](Romance Path: The Chess Match)[/i]","[i](Oh god. You are actually walking toward her. I'm covering my eyes. If you cry, don't say I didn't warn you. This is a walking Red Flag )[/i]","","She doesn't turn around. She taps her nails against the glass. in a rhythmic pattern.","","\"I can hear you breathing, Agaya,\" she draws out the nickname, making it sound like a threat and a caress at the same time.","\"It's loud. Are you nervous?\"","","She finally glances over her shoulder. Her eyeliner is sharp enough to kill a man.","\"Well? Are you lost? Or do you have a death wish?\"","","*choice","    # \"I saw a Red Flag and I thought: That looks like a fun challenge.\" ","        *set rel_noa %+5","        *set charisma %+5","        *set ruthless %+5","        ","        [i](Author's Note: MC... please go to therapy.)[/i]","        ","        Noa turns fully, blinking at you.","        Then, a short, rich people laugh escapes her.","        \"At least you're honest,\" she smirks, leaning back against the railing. \"Come here then, trouble. If you get burned, it's on you.\"","        *goto noa_siblings_talk","","    # \"I came to see the view. You're just blocking it.\" ","        *set rel_noa %+5","        *set rebellion %+5","        ","        Noa rolls her eyes, but she shifts slightly to the side.","        \"Rude,\" she murmurs, hiding a smile. \"Most people would pay to have me block their view.\"","        ","        \"I'm not most people,\" you say, stepping next to her.","        *goto noa_siblings_talk","        [i](Author's Note: congrats , the cheesy line worked , I think >_<)[/i]","","    # \"I just wanted to see if you were okay.\" ","        *set rel_noa %+5","        *set per_gentle %+5","        ","        Noa pauses. The performance falters for a second.","        She looks at you, searching for the angle, the strategy, the lie. But she finds none.","        ","        \"Don't look at me like that,\" she whispers, turning back to the city abruptly.","        [i](Author's Note: See? Even she knows this is too healthy for this if.)[/i]","        ","        \"It makes it harder to be mean to you.\"","        *goto noa_siblings_talk","","    # \"I brought you a theoretical stress ball. You look like you're about to explode.\" ","        *set rel_noa %+5","        *set per_gentle %+5","        ","        Noa pauses. She looks at the glass in her hand. She isn't gripping it tightly she's holding it delicately, like she's deciding where to throw it.","        \"Explode? Me?\" She lets out a high, fake laugh.","        \"I am the picture of mental stability, darling. I am the Perfect Idol. We don't explode. We just... edit it out\"","        ","        She sighs, her shoulders dropping just an inch. \"Okay, maybe a small explosion. A controlled demolition.\"","        *goto noa_siblings_talk","","*comment ==========================================================","*comment PATH 2: FRIENDSHIP (The Safety Net)","*comment ==========================================================","*label scene_noa_friend","","She hears your footsteps. She doesn't stiffen she just sighs, a long sound of despair that isn't entirely unwelcome.","","\"Oh. It's you.\"","She kicks the empty chair next to her with her heel. It scrapes against the concrete.","","She picks up the bottle and holds it out.","\"Drink. It's expensive and it tastes like sadness and capitalism , you'll hate it.\"","","*choice","    # Sit quietly and take the bottle.","        *set rel_noa %+5","        *set per_gentle %+5","        You sit. You take a swig. It's bitter.","        \"Gross\" you say.","        \"I know\" she replies, a ghost of a smile on her lips. \"Pass it back.\"","        *goto noa_siblings_talk","","    # \"I prefer cheap soju. But I'll make an exception.\" ","        *set rel_noa %+10","        *set rebellion %+5","        You sit down, taking the glass.","        Noa snorts. \"Don't we all. But the sponsors insist on Class.\"","        She clinks her bottle against your glass. A silent toast to cheap tastes.","        *goto noa_siblings_talk","","*comment ==========================================================","*comment PATH 3: LOW RELATIONSHIP (The Wall)","*comment ==========================================================","*label scene_noa_low","","","She glances back at you. Her face is a mask of perfect sun tanned skin. Unreadable.","\"You\" she says flatly. \"I came here for silence, not to babysit.\"","","She turns back to the city, clearly dismissing you.","\"Go away. I'm off the clock.\"","","*choice","    # \"I'm not asking for your time. I'm just standing here.\" (Self Belief Check)","        *if (self_belief > 50)","            *set rel_noa %+5","            She pauses. She turns slowly, analyzing you from head to toe.","            You don't flinch. You hold her gaze.","            ","            \"Hmph\" she makes a non-committal sound. \"At least you have a spine. Rare.\"","            She gestures vaguely at the railing. \"Fine. Stand there. Just don't breathe too loud.\"","            *goto noa_siblings_talk","        *else","            *set rel_noa %-5","            She laughs, and it sounds like glass breaking.","            \"You're shaking,\" she notes cruelly. \"You don't belong on this balcony. Go back to the kids table.\"","            *goto sleep_before_morning","","    # \"You don't own the air up here, Unnie/Noona.\" (Bold/Rebellion Check)","        *if (rebellion > 50) or (per_bold > 50)","            *set rel_noa %+5","            *set ruthless %+5","            Noa raises an eyebrow. The irritation in her eyes shifts to mild interest.","            \"Touch,\" she mutters.","            \"Fine. Breathe my air. Just don't expect me to share the wine.\"","            *goto noa_siblings_talk","        *else","            *set rel_noa %-10","            She turns fully, her eyes icy.","            \"Actually, tonight? I own everything. Including your contract. Get out.\"","            *goto sleep_before_morning","","*comment ==========================================================","*comment CONVERGENCE POINT: THE BROTHER","*comment ==========================================================","*label noa_siblings_talk","*line_break","","You stand together in the silence.","\"Do you have siblings?\" she asks suddenly. She's swirling the wine, watching the vortex. It's a calculation, not small talk.","","*fake_choice","    # \"No, only child.\"","    # \"Yeah, unfortunately one\"","    # \"A whole pack of them.\"","","\"I have a brother,\" Noa says. She states it like a fact on a resume. Detached.","\"He's older. Eight years gap. He has kids now. My nieces.\"","","She takes a sip, her eyes narrowing at the city lights.","\"He won't let me see them.\"","","She taps a fingernail against the glass. ","\"He found God\" she says, and the word God leaves a bitter taste in her eyes .","\"Or rather, he found a version of God that doesn't like mini skirts or crop tops. He thinks what I do... this whole industry...\"","","She gestures at her outfit, at the Villa, at the cameras in the distance.","\"He calls it Immodest. Sinful.\"","","She turns to you. An unreadable expression is coloring her face.","\"My dad... he was the only one who mediated. He used to say, \"Noa isn't bad, she's just loud.\" But he's gone.\"","","She looks vulnerable for a split second, before the walls try to come back up.","\"So tell me, Agaya. Am I a sin? Or am I just loud?\"","","*choice","    # \"You aren't a sin, Noa. You're a force of nature.\"","        *set rel_noa %+10","        *set charisma %+5","        ","        Noa looks at you, surprised.","        \"A force of nature...\" she repeats, testing the words.","        She smiles, a sad, crooked thing. \"I like that better. Disasters are powerful, at least.\"","        ","        *if (rel_noa >= 40)","            She doesn't say anything else.","            Slowly, hesitantly, she leans her head on your shoulder.","            She smells like wine and expensive shampoo. It's a heavy weight.","            ","            *fake_choice","                # Hold her hand.","                    *set romance_noa true","                    You reach down and cover her hand with yours on the railing.","                    She flinches, but doesn't pull away. Her fingers lace through yours. Cold skin against warm.","                ","                # Stay still. Be the pillar she needs.","                    You stay rock still.","                    Noa closes her eyes, breathing out. \"Just for a minute,\" she whispers. \"Don't get used to it.\"","            ","            *goto sleep_before_morning","","        *else","            She nods to herself. \"Right. Powerful. I can work with that.\"","            *goto sleep_before_morning","","    # \"Honestly? You're kind of scary.\" ","        *set rel_noa %+15","        *set per_gentle +5","        ","        Noa blinks, taken aback. She stands up straighter, looking offended.","        \"Scary? I'm the most generous Host in history!\"","        ","        *if (entry_method = \"medical_wildcard\")","            \"I gave you towels! I smile at you!\"","            *goto after_entry_comment","        *else","            \"I opened my villa to you! I smile at you!\"","            *goto after_entry_comment","","        *label after_entry_comment","        \"That's why,\" you say, scratching the back of your neck awkwardly. \"It... it doesn't make sense.\"","        You gesture vaguely at her, feeling clumsy under her gaze.","        \"This industry is cold. Everyone is fake. And then there's you... loving everyone so aggressively. It's overwhelming. It's like standing next to the sun.\"","        ","        Noa stares at you. Her mouth opens slightly, then closes.","        A deep flush rises in her cheeks not from anger, but from being truly seen.","        ","        *if (romance_noa)","            She steps closer, invading your personal space. You can smell the vintage wine and her perfume, warm vanilla.","            ","            \"The sun burns, Agaya,\" she whispers, her voice dropping to a dangerous purr.","            She reaches out. Her warm fingers trace the line of your jaw, tilting your face up.","            ","            Her eyes lock onto yours. Brown. warm. all-knowing.","            She leans in. You feel the warmth of her hand on your cheek, the slight look that drops to your lips .","            The world narrows down to just the two of you.","            ","            SWOOSH.","            ","            A black shape dives from the roof, screeching past your heads. A bat.","            Noa pulls back sharply, but she doesn't scream.","            ","            \"What are the chances?\" she laughs, a breathless, elegant sound, hand over her heart.","            ","            She looks back at you. Her cheeks are flushed a deeper shade of red, but her posture remains perfect. She smooths her hair back, regaining her composure instantly.","            ","            \"I suppose the universe thinks it's a bad idea ...\" she murmurs, a playful glint returning to her eyes.","            [i](Author: Cockblocked by a bat. Sucks ba-dom-tsss)[/i]","            *goto sleep_before_morning","        ","        *else","            She looks away quickly, hiding her eyes.","            \"The sun...\" she whispers.","            She clears her throat, composing herself. \"You are a very strange kid. Very strange. But... thank you.\"","            *goto sleep_before_morning","","    # \"Prove him wrong. Be so successful he can't look away.\"","        *set rel_noa %-5","        *set ruthless +5","        ","        Noa stares at you for a second.","        Then, she throws her head back and laughs. ","        It's a sharp, cynical sound.","        ","        \"Wow,\" she looks at you sideways. \"You really are green, aren't you? That sounded like a line from a bad Shonen anime.\"","        ","        She shakes her head, looking at you with amused pity.","        \"You think success cures loneliness? That's cute.\"","        ","        But then, her expression shifts. The amusement fades into something sharper. Steel.","        \"But you're wrong\" she murmurs.","        She clinks her glass against the railing.","        ","        \" I'll just buy the building he lives in. That works too.\"","        *goto sleep_before_morning","","*label sleep_before_morning","*page_break Day 5: The Morning After","","The sun rises over the Villa. 6:00 AM.","\"WAKE UP, ANGELS!\" The speakers vibrate.","","*label day_5_start","The PD is waiting by the pool. He is wearing a neon pink visor and holding an Iced Americano like it's a scepter.","\"Hello, Hello, Hello!\" he calls out, his voice sing-song and loud.","","He scans the group of exhausted trainees and claps his hands dramatically.","\"Look at this lineup! Giving me Survivor: Fashion Week realness. I love the bags under the eyes, very chic, very I haven't slept since 2019.\"","","He waves his feathered fan toward the buffet table.","\"Fuel up, Queens and Kings! I need energy! If you faint, you better do it gracefully, or I'm editing it out. Choices!\"","","*comment --- SECTION 10: OCD & BENJI'S SECRET ---","*label benji_secret_scene","","You walk toward the buffet.","It is a spread of greasy bacon, sugary pancakes, and heavy cream.","","*if (eating_disorder_flag)","    [i](Trait: Eating Disorder active)[/i]","    You look at the food.","    You don't see breakfast. You see an equation.","    ","    Pancakes + Syrup = A number that ruins the week.","    Bacon = Variable X (Grease).","    ","    It's not fear. It's just... math.","    If the math doesn't add up, the control slips. And if you lose control here, you lose everything.","    ","    *set stress %+10","    You grab a single slice of melon (30 calories, safe, verified data) and walk away.","","As you turn around, you bump into Benji, the stressed PA.","\"Oh god, sorry, ${name},\" he whispers.","He leans in close, checking if the PD is watching.","","\"Off the record,\" he murmurs. \"Step it up this weekend.\"","","\"Why?\"","","\"I saw the schedule. They're bringing in focus groups on Saturday, civilians.\"","He swallows hard.","\"They aren't looking for the Villain. TV needs villains. They are looking for the furniture.\"","Benji eyes the cameras nervously.","\"The PD wants to eliminate the boring ones. If you don't make them feel something=love, hate, anything you're gone.\"","","\"BENJI!\" The PD screams. \"Why is my cup empty?! I don't pay you to gossip!\"","\"Coming, sir!\" Benji yelps and runs off.","","","*comment --- SECTION 11: THE COLLAPSE (THE PLUMMET) ---","*label sumin_finale","*temp jump_rescue false ","*temp jump_drama false ","*temp jump_freeze false","The filming continues for hours. ","By 14:00, the heat is a physical weight, pressing down on the Villa. The air is thick with the smell of chlorine,SPF50, and despair.","","You are standing near the deep end of the pool, adjusting your cap.","Suddenly, someone gasps. You look up.","","High above the pool, on the second-floor terrace railing, stands Su-min.  ","She isn't a bully. She isn't a star. Shes the quiet girl whose name the cameras always skip. And she knows it. The look in her eyes isn't just heatstroke, it's a breakdown. Sometimes its not those who scream the loudest that suffer the most , sometimes its the ones who sit in the back of the bus in silence","","\"I can do it,\" Su-min mutters, her voice thin and cracked, barely audible over the drones hum. \"Just give me one shot. even if its a split screen.\"","","She is balancing on the very edge of the marble ledge, thirty feet above the water. Shes trying to replicate that iconic, effortless high-dive Noa did in her last music video. Su-min smiles for the drone, a haunting, porcelain-doll smile that doesn't reach her glazed eyes.","","\"Su-min, get down from there!\" Coco shouts, ${r_his} voice surprisingly raw. ","","Its the first time youve heard ${rival_nickname} sound genuinely scared, the usual competitive edge completely gone. For a second, the race for the center position doesn't matter.","","Su-min ignores ${r_him}, preparing to jump. ","But then, her knees buckle. Her eyes roll back. ","","There is no scream. ","Just the terrifying sight of her body going limp, tipping forward like a marionette whose strings were suddenly cut. ","","She falls. ","","It feels like an eternity before the heavy, dead thud of her body hitting the water-not a graceful dive, but a violent, flat impact that echoes against the Villa walls. She doesn't resurface. ","","[b]A streak of red begins to surface in the water.[/b]","","The Villa erupts into pure, unfiltered chaos.","Trainees are screaming. Rio is sprinting toward the edge, yelling for a medic. ","","*fake_choice","    # Dive in immediately. Screw the cameras.","        *set per_gentle %+15","    ","        *set followers + 2500","        *set rel_noa %+15","        *set stress %+15","        *set jump_rescue true","        *set trauma_points + 1","        *comment --- Relationship Changes: The Hero ---","        *set rel_haneul %+15","        *set rel_rio %+12","        *set rel_rival %+8","        *set rel_jiwon %+10","        *set rel_yuri %+10","        *set rel_eden %+10","        *set rel_minjae %+10","        *set rel_kang %-5","","        You don't think. You don't wait for permission. ","        The impact with the water shocks your system, but you swim hard toward the lifeless Su-min. You grab her limp arm and drag her toward the surface. ","        You're doing CPR until the ambulance arrives. Its nerve-wracking; you tire out your arms, every press of your palms is a last attempt to mend this little girl, shes younger then you by half a year","        . You cant let her die.","        ","        \"She's breathing!\" you yell, your heart hammering. The show is starting to take its toll on you, on everyone with a shred of decency left.","","    # Freeze. Analyze the situation. ","        *set ruthless %+10","        *set stress %+5 ","        *set jump_freeze true","        ","        *comment --- Relationship Changes: The Stoic ---","        *set rel_haneul %-12","        *set rel_rio %-10","        *set rel_rival %-8","        *set rel_jiwon %-5","        *set rel_yuri %-5","        *set rel_eden %-5","        *set rel_minjae %+12","        *set rel_noa %+5","        *set rel_kang %+5","","        You stay on the tiles, your eyes darting between the water and the PD. ","        If you jump, you're just another body in the water. You watch Hanuel dive in instead, their hero-act perfect for the edit. You remain the calm center of the storm, staying dry and professional. Some see focus; others see a hollow space where a heart should be.","","    # Scream for help but stay in frame. Make her tragedy your stage.","        *set the_mask %+15","        *set ruthless %+10","        *set followers + 5000","        *set rel_noa %-15","        *set jump_drama true","        ","        *comment --- Relationship Changes: The Shark ---","        *set rel_haneul %-25","        *set rel_rio %-20","        *set rel_rival %-15","        *set rel_jiwon %-10","        *set rel_yuri %-10","        *set rel_eden %-10","        *set rel_minjae %-12","        *set rel_kang %+15","","        \"Oh my god! Su-min!\" ","        You fall to your knees at the edge of the pool, hand over your mouth, looking directly into Camera 3 with wide, watery eyes. You look terrified, vulnerable, and absolutely stunning in your grief. The viewers are going to go crazy for this shot, a perfect \"Ending Fairy\" moment in the middle of a disaster. You feel the cold stares of the other trainees, but the lens is locked on you.","The PD, Sang-ho, stands on the balcony overlooking the carnage. ","He doesn't look worried. He looks electrified.","","\"Don't you dare cut!\" he bellows, leaning over the railing. ","\"Keep rolling! Look at that panic! Look at the blood in the water! This is raw! This is Art!\"","","The medics drag a pale, unconscious Su-min out. Shes coughing up pink-tinged water.","\"Gorgeous,\" Sang-ho whispers into his headset, a sharp, predatory grin on his face. \"Now that is an episode cliffhanger.\"","","He waits until the stretcher is gone before addressing the trembling group.","\"Wrap it up!\" he shouts. \"We have more than enough content. The collapse is going to lead every teaser from here to Sunday.\"","","He looks down at you all. \"Go inside. Get some rest. Youre off the clock until Sunday morning. Use the time to... process.\"","","---","","The group stands in silence as the production crew packs up. Everyone looks broken.","","You remember what Benji whispered to you earlier: [i]The Focus Groups are tomorrow, Saturday.[/i] The PD didn't mention them. He wants everyone to relax so the Focus Groups can catch them off guard.","","What will you do with this information?","","*choice","    #  Tell the others. We all need to be ready.","        *set rel_rival %-7","        \"Wait, guys,\" you whisper, gathering the others. \"Don't get too comfortable. Focus Groups are tomorrow. We need to stay sharp even if the cameras seem off.\"","        They look at you with surprised gratitude.","        *goto noa_pov_end","","    # Keep it to yourself. Let them fail.","        *set ruthless %+5","        *set rel_rival %+5","        You say nothing. If they fail the Focus Groups, its just fewer people standing between you and the center.","        *goto noa_pov_end","*label noa_pov_end","*page_break","[b]POV: NOA[/b]","","23:00. ","The pool deck is finally quiet. The cameras are sleeping, at least, the ones the crew controls are. ","","The glass doors slide open with a heavy, expensive thud. ","","I step out, shed of the glittering armor I wear for the world. The gown is gone, and the diamonds are locked in the safe. Im wearing an expensive, oversized streetwear hoodie that cost more than the lead cameramans annual salary, but looks like it was stolen from a boyfriend I never had time for. Paired with loose sweatpants and bare feet, I look like a runaway. My hair is a disaster, tangled and salty, falling over my eyes in a way Id never allow a stylist to see. ","","I walk to the edge of the pool, kicking a plastic cup left behind by the crew like its a minor peasant uprising in my kingdom. This is my house. My water. My silence.","","\"You missed the action, honey!\" I look at the spot where the ambulance sat.","","I don't turn. I don't give him the satisfaction of a flinch. I just watch the moon ripple on the surface, the water perfectly still except for where the filters hum. ","","\"I saw the pixels in real-time, Sang-ho,\" I say, using his first name like a dull blade. \"Your pacing was off. You let the girl stay blue for too long.","","I hear the quiet scuff of his designer loafers on the stone tiling. He doesn't stop at a respectful distance, he sashays right up to the edge of the water, a glass of cognac in one hand and his tablet in the other.","","The artificial blue glow of his tablet hits his face from below, illuminating a smile that looks like it practiced being charming in a mirror.","","\"Oh, Mother, please\" he says, rolling his eyes with dramatic flair. He takes a delicate sip of his cognac, pinky finger extended. \"The audience lives for the blue tones. It makes them feel like theyre seeing something raw. Something they aren't supposed to see. She was giving [i]tragic mermaid[/i] and the servers were eating it up.\"","","He waves a hand dismissively at his tablet. \"But Ill check the pixels, darling. Since youre so concerned about the quality of my work.\"","","\"I'm concerned about the girl\" I snap, the words slipping out before I can filter them. \"Shes a teenager, Sang-ho. Not a prop. If you push them until they break, you don't have a show, you have a crime scene.\"","","The air between us shifts.","","The flamboyant tilt of his head disappears. His spine straightens, and that fabulous sparkle in his eyes vanishes, replaced by a cold, professional void. The sassy PD is gone, the man who survived 15 years in showbiz is back.","","\"Don't get it twisted, Noa\" he says, his voice dropping an octave, flat and dangerously quiet. \"Youre at the top of every chart, the biggest star in this hemisphere. You could be doing anything right now. And yet, the board at Titan is still wondering why you decided to host a summer camp for nobodies in your own private sanctuary.\"","","He turns his head just enough to catch my profile, his eyes sharp in the digital light.","","\"They're wondering if youre looking for a successor because you're losing your edge, or if youve actually gone soft. And trust me, honey, in this industry, soft is just another word for expired.\"","","I take a long sip of my chocolate milk from the crystal glass, the cold sweetness a sharp contrast to the biting night air.","","\"I was bored,\" I lie, making the lie sound like the most fascinating thing hes ever heard. \"My hiatus was getting too quiet. I needed fresh energy to consume.\"","","The switch flips back. Sang-ho lets out a sharp, high pitched giggle, the diva mask sliding back into place as if it never left. He clicks his tongue, looking at me with that fake, admiring warmth.","","\"Well, your energy just broke the servers. Su-min's collapse is the clip of the year. Im going to make it look legendary.\"","","\"Make it look like I planned it\" I say, a sharp edge to my smile. \"Goodnight, Sang-ho.\"","","He retreats, his footsteps fading until the villa finally stops pretending to be a television set. ","","Im alone.","The silence here is different now. It isnt the hollow, ringing silence of the two years I spent staring at my mothers empty chair. Its... crowded. ","","I look up at the massive structure. [i]Damn[/i] I think, the thought tasting like copper in my mouth. [i]Am I really recreating Neverland like some kind of Peter Pan creep?[/i]","","I remember the day, age 10, when the noise stopped for the first time. The sound of a car pulling out of the driveway and never coming back. Then, years later, the sound of a hospital monitor turning into a flat, steady hum. I hope those kids wont hear that hum , from the looks of it I need to be more on my toes for that to happen.","","[i]Na-ri isn't bad, she's just loud,[/i] my father used to say.","Well, Ive been loud enough to drown out the ghosts for years. But today, the silence won.","*if (romance_noa) and (rel_noa >= 40)","    My eyes drift to a specific window on the second floor. ${name}. ","    A soft, addictive, irresistible pull flares in my chest. ","","    [i]That one.[/i]","    I kick a stray rock into the bushes. ","    Its exhilarating, in a twisted way. Finally, someone who doesn't just bask in the golden glow I provide, but actually looks back. They didn't even squint at the brightness. ","    ","    But its also infuriating. Its a breach of my borders. I didn't give them permission to squat in my head or look through the glass at the girl underneath. Its scary how much I want them to do it again.","","    [i]Its a game of chicken,[/i] I decide, my ego tightening like a bowstring. [i]They want to see the real me? They want to SEE YOON NA-RI? Fine. Let's see who will bow lower.[/i]","","I look at the dark water. This constant state of high alert, the skin-tight performance I wear for the world it all feels like a lead weight. My brain is too sharp for its own good, dissecting every emotion before I can even feel it.","\"Enough\" I whisper to the moon.","","I dont dive. I dont perform. ","I turn my back to the pool, close my eyes, and let go. ","","I just fall backward. A trust fall into the nothingness.","","[b]SPLASH.[/b]","I sink until the marble floor presses against my spine. ","","The water is loud in my ears, a heavy pressure that feels like those long, silent drives in the back of the embassy cars.","[i]","(Twenty years.)","*line_break","I kick the marble bottom, the vibration traveling up my legs.","","(They were together for twenty years. They had nine whole years before I was even a \"mistake\" in Malibu. My","","brother was eight when I was born. He got eighteen years of them being \"real.\" I only got ten. Then the strings snapped.)","[/i]","I notice a cracked tile near the drain. I pick at it with my thumb, obsessing over the sharp edge. Its broken. I want to fix it.","I want to glue it back so no one cuts their feet, because I couldn't fix the house in Seoul when the walls started bleeding silence. ","","Then, theres [i]you[/i]. ${name}.","","*if (rel_noa >= 50)","    I wrap my arms around my shins, tucking my head into my knees. Im a ball. A stone.","    *if (jump_rescue)","        [b]Oxygen. Thief.[/b] [i]You jumped. You didn't even think. You reached for Su-min the way my brother used to reach for me when the shouting started downstairs. Messy. Human. I hate that you made me feel that safety again. To care is to drown, but I'm holding my breath for you.[/i]","    *if (jump_freeze)","        [b]Static. Ice.[/b] [i]You didn't move. You just watched the red bloom in the water. People call it cold, I call it home. You know the silence of the black cars. You know that jumping doesn't save anyone. Were the same kind of broken, aren't we?[/i]","    *if (jump_drama)","        [b]Mirror. Monster.[/b] [i]You cried for the cameras. A doll smile, just like my mothers at the gala. It hurts more coming from you. I thought you were different. I want to kick you away from me.[/i]","    ","    [i]Im losing air,[/i] I think, my thumb still pressing into the broken tile until it starts to bleed. [i]But I don't want to leave this quiet yet.[/i]","    *goto exit_pool","","*if (rel_noa >= 30)","    I let my hair drift like seaweed, my eyes fixed on the lights above.","    *if (jump_rescue)","        [b]Pulse. Reckless.[/b] [i]A hero act. Youve got too much heart for a place where everyone is a predator. Youre going to get hurt, and I don't want to be the one standing near you when the fallout hits.[/i]","    *if (jump_freeze)","        [b]Anchor. Still.[/b] [i]You didn't react, you observed. Youre calculating the cost, just like I am. I respect the focus. Let's see if you have the stamina to stay dry when the rest of us are drowning.[/i]","    *if (jump_drama)","        [b]Shark. Sharp.[/b] [i]You found the camera in a heartbeat. A professional predator. Youre dangerous, ${name}. I need to make sure Im the one holding the knife when we finally collide.[/i]","    ","    [i]The morning is coming,[/i] I realize. I hope you're ready for the blood to turn into a storyline.","    *goto exit_pool","","*else","    I kick off the bottom, my lungs screaming. I'm done with this.","    *if (jump_rescue)","        [b]Clich.[/b] [i]Boring. You think jumping in makes you a lead? This isn't a drama, it's a cage match. You won't last a week.[/i]","    *if (jump_drama)","        [b]Thirsty.[/b] [i]Cheap acting. Ive seen better performances in the mirror during a bad hair day. Get off my stage.[/i]","    *if (jump_freeze)","        [b]Void. Empty.[/b] [i]Useless. A blank space. Youre just background noise in a world that belongs to me.[/i]","    ","    [i]Yesterday's news,[/i] I decide, rising fast. [i]I'm not wasting another breath on a blob.[/i]","    *goto exit_pool","","*label exit_pool","I break the surface, gasping for the humid air. The chaos is still there, but I'm already gone. ","","I climb out, my movements sharp and jagged against the biting midnight air. The water on my skin feels like needles as the wind hits me. ","","I grab my thick white robe, wrapping it tight around myself like a shroud, pulling the hood low until my face is nothing but a shadow. ","","I walk toward the Villa, my wet footsteps leaving a cold, shimmering trail of \"broken\" all the way to the door.","","Wow, that was ruff. R U OK, sweety? ","*label day_6_living_room","*page_break Day 6: The Red Morning","","The sky outside the floor to ceiling glass isn't blue. Its a bruised, bleeding red a Rayleigh scattering Armageddon that makes the entire Villa look like its being consumed by fire. ","","You look at the salt-crusted footprints on the marble. They stop exactly at the edge of the silk rug. Who tracks dirt into a house like this? Su-min is in a hospital bed, and you're mentally calculating the cleaning bill. The irony is gross.","","Noa is leaning against the mahogany island. Even in her hoodie and bare feet, she looks like a million euros-that \"Icon\" glow is apparently permanent, even if her eyes look dead.","","*if (rel_noa >= 50) ","    Your eyes linger on the Minions band-aid on her thumb. Caught, she tugs her hoodie up and busies herself peeling the label off a bottle of chocolate milk.","","The door clicks open. Its Eden. He sets a carrier of black coffees on the grand piano, no coaster, and tries to lean against it coolly. He misses the edge slightly, his elbow slipping, but he coughs and pretends it was a stylistic choice. ","","\"Sit,\" Eden says, his voice flat. \"Su-min is 'exhausted' according to the news. Sang-ho is currently deep frying her tragedy to make it \"pop\" for the fans. I'm not the PD. I don't need a script. Talk to me.\"","","[b]Rio:[/b] ${rio_he} isn't pacing anymore. ${rio_he} is just sitting there, rubbing ${rio_his} chest, ${rio_his} breathing loud and shallow. \"I keep hearing the splash. It's on a loop. I think I forgot how to breathe normally.\"","","[b]Kang:[/b] ${kang_he} is scrubbing ${kang_his} glasses with terrifying force. ${kang_he} looks like the only adult in the room, but ${kang_his} hands are shaking. \"The agency doesn't have insurance for this,\" ${kang_he} mutters, eyes fixed on a smudge. \"Not for her, and definitely not for us. We're on our own.\"","","[b]Coco:[/b] ${r_he} @{(r_he = \"they\") are|is} staring at ${r_his} phone with pure disgust. \"I gained 10k followers while she was being loaded into an ambulance. Its pathetic. We're just content for the midnight slot.\"","","[b]Ji-won:[/b] ${jiwon_he} is hugging ${jiwon_him}self so tight ${jiwon_his} knuckles are white, rocking slightly. \"They're going to erase her, aren't they? Like a bad take. Delete. Cut. Gone. Tomorrow there will be a new girl in her bed and we'll all pretend we didn't see the water turn red.\"","","[b]Yuri:[/b] ${yuri_he} is staring at a vase of flowers, ${yuri_his} fingers twitching. \"I tried to play today,\" ${yuri_he} whispers. \"The notes sounded... like glass breaking. I can't do it. The silence is too loud.\"","","And then, [b]Haneul[/b] stands up. ","The Royal.","","$!{h_he} @{(h_he = \"they\") try|tries} to bow to Eden, a reflex of politeness, but ${h_he} @{(h_he = \"they\") stumble|stumbles}, ${h_his} legs turning to lead.","\"I apologize,\" Haneul says, ${h_his} voice trembling violently. \"I apologize for the atmosphere. We should be professional.\"","","$!{h_he} @{(h_he = \"they\") try|tries} to smile, but ${h_his} face crumples. Tears start streaming down, ruining ${h_his} perfect posture.","\"My mother called me yesterday,\" ${h_he} @{(h_he = \"they\") babble|babbles}, the words spilling out fast, uncontrollable. \"She asked if I was eating well. She's borrowing money from the neighbors to pay for my vocal lessons. From the [b]neighbors[/b], Eden.\"","","${h_he} @{(h_he = \"they\") grab|grabs} the lapel of ${h_his} blazer with a white-knuckled grip.","\"This suit? It's not mine. The agency rented it. If I sweat in it, they charge me. If I fall like Su-min, my family starves. I'm not a Prince. I'm a stock option that's about to crash. I can't breathe in this suit. I can't...\"","","Haneul sinks back onto the sofa, burying ${h_his} face in ${h_his} hands, shaking silently. The mask didn't just crack; it dissolved.","","Eden looks at ${h_him}, eyes wide, looking like he wants to hide behind the piano. He is clearly in over his head. After a long, painful silence, he awkwardly shoves a lukewarm coffee toward Haneul.","\"Uh... do you want a coffee? Its black. Like... reality.\"","","He turns to you, looking desperate to change the subject. \"And you, ${name}? What's your flavor of trauma today?\"","","*choice","    # \"I'm just numb. I keep waiting for someone to say it's a prank.\"","        *set stress %+15","        *if (imposter_syndrome)","            *set self_belief %-10","            *goto eden_nods_text","        *else","            *set self_belief %-5","            *goto eden_nods_text","","        *label eden_nods_text","        Eden nods, looking relieved you didn't cry. \"Its not a prank. Its just Tuesday in this industry.\"","        *goto eden_session_end","","    # \"I'm just exhausted. This place is breaking us.\"","        *set stress %+5","        *set physical %-15","        \"Welcome to the machine,\" Eden says dryly, trying to sound deep.","        *goto eden_session_end","","    # \"She was stupid to jump for a camera. Now she's a statistic.\"","        *set ruthless %+15","        *set rel_yuri %-10","        *set rel_haneul %-10","        *set self_belief +2","","        Eden offers a sharp, dark grin, finally back in his comfort zone. \"Cold. At least you're realistic.\"","        *goto eden_session_end","","    # \"The PD is a monster. He's making content out of her blood.\"","        *set rebellion %+8","        *set stress %+10","","        Eden lets out a hollow laugh. \"He's not a monster. He's a businessman. Thats why hes more dangerous.\"","        *goto eden_session_end","","    *if (the_mask >= 35) and (trauma_points >= 3)","        # (Breakdown) I can't hold the pretense anymore. I just start sobbing on the floor.","            *set stress %-30","            *set trauma_points -2","            *set the_mask %-25","            *set scandal_risk %+25","            *set followers +7500","            *set rel_rio %+15","            *set rel_noa %+10","            *if (imposter_syndrome)","                *set self_belief %-10","                *goto breakdown_description","            *else","                *set self_belief %-5","                *goto breakdown_description","            ","            *label breakdown_description","            You crumble to the floor. The sound of your sobbing echoes off the marble.","            Eden freezes. He looks at you, then at Haneul, then at his coffee. ","            \"Is this... is this about me?\" Eden asks, sounding genuinely confused. \"Because I kind of feel like this is about me. My vibe is very intense today, I know.\"","","            Instantly, the mechanical whine of motors fills the air. A swarm of camera drones drops from the ceiling to catch the 4K tears.","","            *if (rel_rio >= 63) and (rel_noa >= 15)","                [i](Soundtrack: Imagine the \"He's a Pirate\" theme swelling aggressively. Everything goes slow-motion.)[/i]","                ","                Suddenly, Rio snaps. He lunges for the kitchen island and grabs a heavy marble [b]rolling pin[/b]. ","                \"GET AWAY FROM ${him_her}!\" he bellows, swinging it like a broadsword. ","                [b]CRUNCH.[/b]","                ","                Noa isn't far behind. She snatches a cast-iron frying pan from the stove. She isn't the Host anymore- she is a Berserker in a silk hoodie. ","                \"DAMACIAAAA\" she screams, vaulting over the sofa with a pan held high.","                ","                Its pure, cinematic chaos. Rio and Noa stand back-to-back over your sobbing form, swatting drones out of the air like metal flies. Rio is laughing maniacally. Noa is roaring. Plastic rains down like confetti.","                ","                The glass doors slide open. Sang-ho, the PD, stands there with his Iced Americano, watching Rio decapitate a drone mid-air.","                ","                \"I'll pay for the drones, Sang-ho!\" Noa snarls, chest heaving. \"Cut the feed. Now.\"","                ","                Sang-ho sighs, rubbing his temples. \"Fine. Well cut the crying. Benji! Give them a Therapy Hour. No cameras.\"","                ","                He looks at Noa and Rio, who are still holding their weapons. \"And you two? Im signing you up for an anger management workshop. This is ridiculous.\"","                ","                Rio drops the rolling pin and sits next to you, breathing hard. \"You okay, mate?\"","                *goto eden_session_end","            *else","                Noa stands over you, blocking the cameras. \"Enough,\" she snarls. She pulls you into her shadow until the buzzing stops.","                She walks you back all the way to your room and hold your hand until you stop shivering.","                *goto eden_session_end","","*label eden_session_end","","*label focus_group_final_fixed","*page_break The Human Zoo ( a few hours later)","","The living room lights die. Total darkness.","Then a beam of light hits Noa on the staircase. She looks like an angelic assassin in her black givenchy suit.","","\"Grief is a luxury,\" she booms. \"And you are over budget.\"","","She leads you to the Annex. A long, narrow observation deck shrouded in shadow.","One wall is entirely made of glass. On the other side, brightly lit and completely oblivious to your presence, sit thirty people.","","\"They cannot see you,\" Noa whispers. \"To them, this is just a mirror. To you, it is a judgment.\"","","You scan the room. The cameras are focused on the seven most chaotic people in Seoul:","","[b]1. Mrs. Park (The Thirsty Ajumma):[/b] Fanning herself, looking specifically for young talent to \"sponsor.\"","","[b]2. Sang-min (The Conspiracy Theorist):[/b] Checking the fried chicken for tracking chips.","","[b]3. Dong-wook (The Pizza Guy):[/b] Has a whole pizza box on his lap. He is looks like the star of his own Mukbang .","","[b]4. Ji-hoon (The Hongdae Hipster):[/b] Wearing a scarf indoors. Smells like pretentiousness and lukewarm frappuccino.","","[b]5. Director Shin (The Spy):[/b] Suit, sunglasses inside, scribbling in a black notebook.","","[b]6. Grandma Ok-ja (The Savage):[/b] Knitting aggressively, but her eyes are sharp as a hawk.","","[b]7. Ha-eun (The Stan):[/b] Holding a ring light and screaming internally (and externally).","","---","","*page_break The Roast... I mean focus group.","","Your audition tape starts playing on the screen inside the lit room.","","[i][b]Item 1: The SKILLS Roast[/b][/i]","","*if (dance >= 60)","    [b]Grandma Ok-ja:[/b] \"Aigoo, look at those knees! Too stiff! In my day, we danced with our hips! Eat some kimchi, loosen up!\"","","    [b]Ji-hoon:[/b] \"It's too athletic. It insists upon itself. I prefer a dancer who looks like they are about to weep existential tears.\"","","    [b]Dong-wook:[/b] \"I tried that move once getting out of the shower. Pulled a hamstring. 6/10. Pass the radish.\"","    *goto item_2_focus","","*elseif (visual >= 60)","    [b]Mrs. Park:[/b] (Fanning herself) \"Omo... isn't ${he_she} charming? Reminds me of my third husband. The one with the yacht in Busan.\"","","    [b]Sang-min:[/b] \"That's Deepfake. Look at the pixels around the ear. Nobody is that symmetrical. It's CGI! Wake up sheeple!\"","","    [b]Director Shin:[/b] \"Visuals confirmed. High marketability in Asia. Poach potential: 85%.\"","    *goto item_2_focus","","*elseif (vocals >= 60)","    [b]Grandma Ok-ja:[/b] \"Loud! Good lungs! Like a fishmonger in Jagalchi Market! Finally, someone who isn't whispering!\"","","    [b]Ji-hoon:[/b] \"Pitchy. I heard a micro tone of joy. Real art should sound like a funeral in the rain.\"","","    [b]Dong-wook:[/b] \"It's kinda loud. Can they lower the volume? I'm trying to focus on the crust.\"","    *goto item_2_focus","","*else","    [b]Director Shin:[/b] \"Skill set undefined. Filler member. Discard.\"","","    [b]Dong-wook:[/b] \"Wait, is this the waiter from the intro? Can I order a refill?\"","    *goto item_2_focus","","*label item_2_focus","---","","[i][b]Item 2: The Pool Party Moment[/b][/i]","","The footage of the drowning plays.","","*if (jump_rescue)","    [b]Mrs.Park:[/b] \"Oh, I love a hero. Look at those wet clothes clinging... mmm. Does ${he_she} need a towel?\"","","    [b]Sang-min:[/b] \"Staged. Look at the water physics. That's Unreal Engine 5 water. They are actors in a simulation!\" ","","    [b]Dong-wook:[/b] (Chewing loudly) \"Bro, I could have saved her faster. Easy. I just didn't want to get my Yeezys wet.\" ","","    (In the dark room, you look down at Dong-wook's shoes. They are knock-off plastic sandals.) ","    *goto item_3_focus","","*elseif (jump_freeze)","    [b]Ji-hoon:[/b] \"The stillness... it represents the paralysis of youth in a dying society. Finally, some art.\"","","    [b]Grandma Ok-ja:[/b] \"Tsk tsk! Why isn't ${he_she} moving? Is ${he_she} hungry? I have cut fruit in my bag! Eat!\" ","    *goto item_3_focus","","*elseif (jump_drama)","    [b]Mrs. Park:[/b] \"Oh, I love a hero. Look at those wet clothes clinging... mmm. Does ${he_she} need a towel?\"","","    [b]Grandma Ok-ja:[/b] \"Look at this one! Aigoo, Ive seen more genuine emotion from a tax collector. Thats not a tear, thats a calculated business move! You think she's bleeding? I think you're just thirsty for a close up. If you spent as much time practicing as you do looking for Camera 3, you'd already been debuted!\"","","    [b]Sang-min:[/b] (Pointing frantically at the screen) \"Did you see the trajectory? She didn't fall, she was [i]ejected[/i]! And the grief? Look at the hand placement! Thats a Freemason signal for Execute Phase 2. Su-min is a holographic body double, and the blood is just a ritual sacrifice to appease the Naver algorithm gods. We are watching a live action MK-Ultra experiment, people! Wake up!\"","","    [b]Ji-hoon:[/b] \"The performative nature of this grief... it's meta-art. Using a tragedy to secure a center frame close-up. It's so cynical, I actually respect it.\"","","    [b]Director Shin:[/b] \"Visuals confirmed. Even in a crisis, ${he_she} found the lens. High marketability in Asia. Poach potential: 20%.\"","    *goto item_3_focus","","*else","    *goto item_3_focus","","*label item_3_focus","---","","[i][b]Item 3: Let's build a ship[/b][/i]","","*temp top_ro_name \"None\"","*temp runner_up_ro \"None\"","*temp max_score 0","*temp second_score 0","","*comment --- Logic block (invisible to player) ---","*temp h_weight rel_haneul ","*temp n_weight rel_noa ","*temp c_weight rel_rival ","*temp r_weight rel_rio ","","*if (romance_haneul) ","    *set h_weight + 100","*if (romance_noa) ","    *set n_weight + 100","*if (romance_coco) ","    *set c_weight + 100","","*if (h_weight > max_score)","    *set max_score h_weight","    *set top_ro_name \"Haneul\"","*if (n_weight > max_score)","    *set max_score n_weight","    *set top_ro_name \"Noa\"","*if (c_weight > max_score)","    *set max_score c_weight","    *set top_ro_name \"Coco\"","*if (r_weight > max_score)","    *set max_score r_weight","    *set top_ro_name \"Rio\"","","*if (h_weight < max_score) and (h_weight > second_score)","    *set second_score h_weight","    *set runner_up_ro \"Haneul\"","*if (n_weight < max_score) and (n_weight > second_score)","    *set second_score n_weight","    *set runner_up_ro \"Noa\"","*if (c_weight < max_score) and (c_weight > second_score)","    *set second_score c_weight","    *set runner_up_ro \"Coco\"","*if (r_weight < max_score) and (r_weight > second_score)","    *set second_score r_weight","    *set runner_up_ro \"Rio\"","","*if (top_ro_name = \"Haneul\")","    The screen shows Haneul staring at you intently during the practice. ","    [b]Ha-eun:[/b] \"THE EYE CONTACT! BLINK TWICE IF YOU'RE IN LOVE! I AM SCREAMING!\" ","","    [b]Mrs. Park:[/b] \"Oh, ${h_he} @{(h_he = \"they\") are|is} cute. Rich, right? Look at that blazer.\" ","    [b]Dong-wook:[/b] \"Why @{(h_he = \"they\") do|does} the rich kid look constipated? @{(h_he = \"they\") Do they need|Does ${h_he} need} fiber?\" ","","","","    [i]Meanwhile in the Annex...[/i]","","    Haneul turn@{(h_he = \"they\") |s} a violent shade of red while watching the live comments. ","    \"I... I do not look constipated,\" @{(h_he = \"they\") they whisper|${h_he} whispers}, horrified. ","    @{(h_he = \"they\") They reach|${h_He} reaches} for a water bottle to cool down, ${h_his} hands shaking. ","","    [b]SPLASH.[/b]","    Water goes everywhere, soaking right into your lap and the hem of your top. ","    *if (romance_haneul = false)","        \"Oh god! The costume department will kill us!\" ","        Haneul yelp@{(h_he = \"they\") |s}, jumping back. ","        @{(h_he = \"they\") They grab|${h_He} grabs} a towel and throw@{(h_he = \"they\") |s} it at you. ","        Not gently. ","","        \"Dry off! Quickly! If Director Park sees water damage, he'll deduct it from my nonexistent paycheck.\" ","        *goto post_ro_scenes ","","    *else","        \"Oh god! The thermodynamics!\" ","        Haneul panic@{(h_he = \"they\") |s}, grabbing a towel and stepping close, too close. ","        @{(h_he = \"they\") They start|${h_He} starts} frantically trying to dry your lap, hands moving in a panicked blur. ","        *if (second_score < 100)","            Suddenly, Haneul freezes. ","            ${h_His} hand is still pressed against your damp knee, right where the fabric is clinging to your skin. ","            Haneul look@{(h_he = \"they\") |s} at ${h_his} hand, then up at your eyes. ${h_His} pupils are blown wide. ","            \"I... I think you're dry,\" @{(h_he = \"they\") they squeak|${h_he} squeaks}. ","            *goto post_ro_scenes ","","        *elseif (runner_up_ro = \"Coco\")","            Coco snort@{(r_he = \"they\") |s} from the shadows. ","            \"Wow, Your Highness. Taking the shipping seriously?\" ","            ","            Coco @{(r_he = \"they\") step|steps} forward, swiping Haneul's hand away from your leg with a sharp flick. ","            \"I think ${he_she} is dry enough, Haneul,\" Coco @{(r_he = \"they\") purr|purrs}. ","            *goto post_ro_scenes ","","        *else","            Suddenly, a hand grabs Haneul's wrist, pulling it away from your lap. ","            It's [b]${runner_up_ro}[/b]. ","            \"${he_she} is dry enough, Haneul,\" ${runner_up_ro} says, voice low and dangerous. ","            *goto post_ro_scenes","","*elseif (top_ro_name = \"Noa\")","    The screen shows Noa fixing your mic and getting close, real close...","","    [b]Ha-eun:[/b] \"MOMMY? MOMMY? MOM? IS THIS LEGAL? I'M CALLING THE POLICE (TO SAY THANK YOU).\"","","    [b]Director Shin:[/b] \"Unprofessional. This is a workplace lawsuit waiting to happen.\"","","    [b]Dong-wook:[/b] \"Wait, the host is hot. She looks like she smells like caviar.\"","","    ---","    [i]Meanwhile in the Annex...[/i] ","","    Noa crosses her arms, her face unreadable. \"You wish,\" she says loudly, with a scoff. \"I was fixing a wire.\"","","    *if (rel_noa >= 70)","        But as the group moves on, she hangs back for a split second.","        She leans in close to your ear, her scent of vanilla overwhelming your senses.","        \"Sorry,\" she whispers, her breath hot against your neck.","        *goto post_ro_scenes","    *else","        *goto post_ro_scenes","","*elseif (top_ro_name = \"Coco\")","    The screen shows you and Coco.","","    [b]Grandma Ok-ja:[/b] \"Aigoo, too skinny! Both of them! Sticks! I want to cook them Galbi-jjim!\" ","","    [b]Ji-hoon:[/b] \"It's narcissism as performance art. It makes me sick. I love it.\" ","","    [b]Dong-wook:[/b] \"They look like the couple that would bully me in high school. I'm scared.\" ","","    ---","    [i]Meanwhile in the Annex...[/i] ","","    Coco flip@{(r_he = \"they\") |s} ${r_his} hair, delighted. \"He's right. I would have bullied him.\" ","    @{(r_he = \"they\") They lean|${r_He} leans} on your shoulder. \"See? We're intimidating. It's our brand now.\" ","    *goto post_ro_scenes","","*elseif (top_ro_name = \"Rio\")","    The screen shows Rio grinning at you.","","    [b]Grandma Ok-ja:[/b] \"Omo! Look at that smile! He looks like a good grandson!\"","","    [b]Sang-min:[/b] \"Impossible. Nobody is that happy. He is a robot. Check his neck for a USB port!\"","","    [b]Dong-wook:[/b] \"Yo, that guy looks fun. I bet he'd share his pizza.\"","","    ---","    [i]Meanwhile in the Annex...[/i] ","","    Rio laughs, a big, suppressed sound. \"Did you hear that?! Grandma loves me!\" ","    ${rio_he} pulls you into a crushing bear hug. ","    ","    [b]${runner_up_ro}[/b] rolls their eyes nearby. \"Put ${him_her} down, Rio. You're crushing ${his_her} ribs.\"","    *goto post_ro_scenes","","*label post_ro_scenes","---","","*page_break The Execution","","Noa snaps her fingers. The screen goes black.","Inside the lit room, Dong-wook looks disappointed. \"Is it over? I didn't finish my crust.\"","","Noa turns to you all in the dark.","\"You see?\" she whispers. \"To them, you are just background noise while they eat pizza. You are thumbnails. Nothing more.\"","","The lights in the Annex stay off as Noa reads the names from a tablet.","\"Min-ho. Wei. Hoshi. Sarah. Elara. Goodbye.\"","","Security guards enter. There are no hugs. The five Red Shirts are dragged out.","The door slams shut. The silence is deafening.","","The gang: Rio, Kang, Coco, Haneul, Ji-won, Yuri, and You, is left standing in the dark. ","","\"Week 1 is over,\" Sang-ho says, appearing with an iced americano. \"Congratulations. You survived the pilot.\"","","*gosub_scene social_logic update_week_1","","[b]Ello Gov'nor, check your feed.[/b]","","","[i]Thumbnails. Just thumbnails.[/i]","","The word rattles in your skull as you walk down the hallway. The fluorescent lights feel too bright, too clinical. You pass Min-hos locker. Its already hanging open, empty. ","","[i]Min-ho. He played it like a villain in a K-drama. He pushed, he shoved, he made sure everyone hated him because he thought that made him the Main Character. He thought being the monster made him indispensable.[/i]","","You look at the floor. [i]It didn't. Hes gone. His strategy was just a louder way to fail.[/i]","","Then theres So-min. You remember the smell of her muscle relief cream in the dorms. And you cant forget the blood, she jumped. ","","[i]So-min practiced until her knees clicked like clockwork. She thought if she suffered enough, the universe would have to give her a debut. She treated her body like a sacrifice. But the industry doesn't want a sacrifice, it wants a toy that doesn't break. And she broke. She just... snapped. Is that what happens when you try too hard? You just disappear? [/i] ","","Your heart hammers against your ribs. Youre sixteen, and youre already learning how to calculate the cost of a breath.","","*choice","    # I need to pace myself. If I burn out like So-min, Im just a tragic footnote.","        *set stress %-5","        *set per_gentle %+10","        [i]Slow down. Breathe. This isn't a sprint, it's a siege. I won't let them drain me until there's nothing left but a shell.[/i]","        *goto day_8_the_complete_sanctuary","","    # Min-ho was a sledgehammer. I need to be like water. Calm. Cold. The star of every ecosystem.","        *set trauma_points +1","        *set ruthless %+10","        *set the_mask %+10","        [i]He was too loud. Too messy. To survive Sang-ho, I have to be wiser. Ill play their game, but Ill do it so quietly they won't even feel my constant control.[/i]","        *goto day_8_the_complete_sanctuary","","    # I'm still here. That has to be enough for tonight. Just don't think.","        *set stress %+10","        *set trauma_points +1","        [i]Don't think about the empty beds. Don't think about the security guards hands on their shoulders. Just get to the room. Just stay alive until tomorrow.[/i]","        *goto day_8_the_complete_sanctuary","","*label day_8_the_complete_sanctuary","*page_break The Sanctuary","*temp partner_name","*temp p_he \"\"","*temp P_he \"\"","*temp p_him \"\"","*temp p_his \"\"","*temp P_his \"\"","*temp p_is \"\"","*temp p_s \"\"","","The inside terrarium is different at daylight, less warming, more like a divider showing who is there to sit and who is there to work. ","Han Minjae paces the space, his voice low but filling every corner.","","\"Every action leads to a reaction,\" he says, stopping in the center. \"When I act, I don't just do. I react to my co-star. If they push, I pull. If they retreat, I chase.\"","","He turns to you all.","\"Tomorrow, at the shoot, you will do the same. You won't be models posing for a camera. You will be partners reacting to each other's steps, it's a dance and you are the choreographers. So let's practice that as much as we can today.\"","","He points to the center of the terrarium, where twenty chairs form a wide, silent circle. Inside it, two lone chairs face each other.","","\"But first: Consent.\" Minjaes expression is serious. \"Look at your partner. If you are not comfortable being touched today, signal now. No questions asked. We are here to build trust, not break it.\"","","The room is quiet. A collective nod ripples through the trainees. For a moment, the toxic competition of the Villa is replaced by a shared, fragile safety.","","*label choose_partner_final","[i]Who steps into the sanctuary with you?[/i]","","*choice","    # Haneul.","        *set partner_name \"Haneul\"","        *set p_he h_he ","        *set p_him h_him ","        *set p_his h_his ","        *set p_is \"is\"","        *set p_s \"s\"","        *goto mirror_phase","    # Coco.","        *set partner_name \"Coco\"","        *set p_he r_he ","        *set p_him r_him ","        *set p_his r_his ","        *set p_is \"is\"","        *set p_s \"s\"","        *goto mirror_phase","    # Jiwon.","        *set partner_name \"Jiwon\"","        *set p_he jiwon_he ","        *set p_him jiwon_him ","        *set p_his jiwon_his ","        *set p_is \"is\"","        *set p_s \"s\"","        *goto mirror_phase","    # Kang.","        *set partner_name \"Kang\"","        *set p_he kang_he ","        *set p_him kang_him ","        *set p_his kang_his ","        *set p_is \"is\"","        *set p_s \"s\"","        *goto mirror_phase","    # Rio.","        *set partner_name \"Rio\"","        *set p_he rio_he ","        *set p_him rio_him","        *set p_his rio_his ","        *set p_is \"is\"","        *set p_s \"s\"","        *goto mirror_phase","    # Yuri.","        *set partner_name \"Rio\"","        *set p_he rio_he ","        *set p_him rio_him","        *set p_his rio_his ","        *set p_is \"is\"","        *set p_s \"s\"","        *goto mirror_phase","","*label mirror_phase","*comment ---        ---","*if (p_he = \"he\")","    *set P_he \"He\"","    *set P_his \"His\"","*if (p_he = \"she\")","    *set P_he \"She\"","    *set P_his \"Her\"","*if (p_he = \"they\")","    *set P_he \"They\"","    *set P_his \"Their\"","    *set p_is \"are\"","    *set p_s \"\"","","You both walk to the center. You sit. ${partner_name} sits. ","The silence is weird, even the staff is on the edge of their seats, the only sound that comes is that of Sang-ho fanning himself. The room feels small, the silence of the other trainees a warm weight around you.","","\"Step One: Connection,\" Minjae whispers. \"Two minutes. No words. No touch. Just look.\"","","You lock eyes. ","One minute passes. The masks you both wear, the \"Prince,\" the \"Clown,\" the \"Survivor\", the \"kawaii\" start to slip. ","Two minutes. You are staring into ${p_his} soul, and ${p_he} ${p_is} staring into yours.","","\"Step Two: The action,\" Minjae commands.","He points at ${partner_name}. \"Stand up.\"","","${partner_name} rises slowly. ${P_he} move${p_s} to stand directly in front of you. ","The dynamic shifts instantly. ${P_he} loom${p_s} over you, blocking the light. You feel small, ${p_he} feel${p_s} like a guardian. ","Minjae lets you sit in this for twenty seconds. The air between your knees and ${p_his} legs vibrates with heat.","","\"Step Three: The Reaction,\" Minjae says softly. ","\"Reach out. Place your hand on the back of ${p_his} thigh. High up. Anchor ${p_him}.\"","","You reach out. Your palm slides behind ${p_his} leg, gripping the upper thigh. ","It is a grounding, intense spot to touch. You can feel the muscle tension skin on skin, it's almost as if you share the same thought when you look at ${p_him}.","","[i]What is passing through your mind while you stare into ${partner_name}'s eyes?[/i]","","*choice","    *if (partner_name = \"Haneul\") or (partner_name = \"Coco\")","        #  [i]I want you closer. I want to break the distance.[/i]","            *set charisma %+10 ","            *if (partner_name = \"Haneul\")","                *set romance_haneul true ","                *set rel_haneul %+15 ","            ","            *if (partner_name = \"Coco\")","                *set romance_coco true","                *set rel_rival %+15 ","            *goto final_romance","","    #  [i]I feel safe with you. Be my anchor.[/i]","        *if (partner_name = \"Coco\")","            *set rel_rival %+15 ","        *goto final_gentle","        *else","            *set rel_${partner_name} %+15 ","        *set per_gentle %+10 ","        *goto final_gentle","","    #  [i]I am terrified. Please don't hurt me.[/i]","        *if (partner_name = \"Coco\")","            *set rel_rival %+8 ","        *goto final_hesitant","        *else","            *set rel_${partner_name} %+8 ","        *set per_gentle %+5 ","        *goto final_hesitant","","    #  [i]I respect you. We are equals in this war.[/i]","        *if (partner_name = \"Coco\")","            *set rel_rival %+5 ","        *goto final_professional","        *else","            *set rel_${partner_name} %+5 ","        *set the_mask %+5 ","        *goto final_professional","","    #  [i]I dare you. Try to dominate me.[/i]","        *if (partner_name = \"Coco\")","            *set rel_rival %+5 ","        *goto final_rivalry","        *else","            *set rel_${partner_name} %+5 ","        *set ruthless %+10 ","        *goto final_rivalry","*label final_romance","Your fingers tighten on the back of ${p_his} thigh. You pull slightly, a silent, magnetic command.","","${partner_name} reacts to the pull. ${p_he} step${p_s} in, one leg moving between yours.","${p_he} bend${p_s} down, boxing you into the chair, ${p_his} hands gripping the armrests. ","${p_his} face is inches from yours. ${p_he} cup${p_s} your cheek, ${p_his} thumb brushing your lower lip.","The room is dead silent. The tension is thick enough to burn.","","\"Cut!\" ","*if (romance_noa) ","    Noa's voice is sharp from the door. \"Okay. We get it. Save it for the shoot.\"","*goto exercise_end_final","*else","    Minjae whispers. \"Electric. Hold that.\"","*goto exercise_end_final","","*label final_gentle","Your grip is soft, reassuring. You look up with open, unguarded eyes.","","${partner_name} melts. ${p_he} sink${p_s} to ${p_his} knees so ${p_he} ${p_is} lower than you, then your instinct tells you to meet ${p_him} at the ground, two trainees in the bottom of the sea of stress and competition. ${p_he} rise${p_s} slightly to meet you, in the middle you hug, knees bent on the floor, a ceremony where in the end: ","Forehead touches forehead. Eyes close.","Its a \"Twin Flame\" moment. The audience in the circle vanishes. Two breaths syncing in the dark.","*goto exercise_end_final","","*label final_hesitant","Your hand trembles. You look up with fear, then pull back, sliding off the chair to the floor. You lie there, like a newborn, unprotected, naive, alone.","","${p_he} doesn't judge. ${p_he} sit${p_s} on the floor beside you, shielding you from the room.","${p_he} open${p_s} ${p_his} arms. You lean in.","A floor hug. Safe. Raw. Protective.","*goto exercise_end_final","","*label final_professional","Your grip is firm. An anchor. You stand up smoothly to meet ${p_his} level.","","You stand eye to eye. ${p_he} take${p_s} your hand.","Fingers interlace tight. A handshake that is a blood pact. ","[i]I have your back.[/i]","*goto exercise_end_final","","*label final_rivalry","You dig your fingers in. A warning. You launch yourself up, invading ${p_his} space.","","${p_he} step${p_s} into the challenge. Foreheads touch in a silent understanding.","Push. Pull.","Its a dance of fire. Breath for breath. ","You shove ${p_him} away. ${p_he} stare${p_s} at you, eyes blazing, chest heaving.","*goto exercise_end_final","","*label exercise_end_final","Minjae steps into the circle, placing a hand on your shoulder.","\"Pain, joy, and heartache, a safe place is found only by those among us who are willing to trust and take what's theirs \" he says to the silent trainees, \"is the only truth you will ever find in this industry. Don't lose it.\"","","*set stress %-10 ","*set trauma_points -1","","The heavy silence following Minjae's words is shattered by a sharp, rhythmic clapping. ","","\"Bravo! Simply... [i]magnifique[/i]!\" ","","The PD swaggers into the center of the terrarium, his flamboyant silk robe billowing. He takes a long, loud sip of his Iced Americano, eyes sparkling with a frantic, artificial delight.","","\"Minjae-ssi, that line about heartache? The cherry ontop for this session. Well put a slow-reverb filter on it for the teaser. And the touch on the thigh? High tier fanservice! The trending tags are writing themselves!\"","","The PD stops smiling. He lowers his coffee, and the theatrical mask slides off, revealing the cold, clinical producer underneath.","","\"But let's be clear,\" he says, his voice dropping into a flat, dangerous register. \"Minjae, keep the philosophy lessons short. We have a schedule. And you\" ","","\"Then I'm out,\" Minjae says, his voice cutting through the PD's authority like a blade. \"Consider the lesson over.\"","","The PD narrows his eyes, the coffee cup frozen halfway to his lips. \"We still have twenty minutes of filming, Minjae-ssi. Contractual obligations\"","","\"I don't care about your schedule,\" Minjae interrupts, already walking toward the exit of the terrarium. \"I'm only doing this as a favor to Noa. Don't push it.\"","","The PD stares at Minjaes back, the silence in the room becoming razor-sharp. For a second, you see a flash of genuine rage in the PD's eyes, but it's quickly replaced by that same clinical calculation.","","\"Fine,\" the PD mutters, turning his gaze back to you and the other trainees. \"The rest of you? You don't have a slew of lawyers to protect you. Clear the Sanctuary. Dinner is in twenty minutes, and yes, calories will be monitored. Move it!\"","","*page_break POV Minjae","*label minjae_pov_start","","[i]POV: Han Minjae[/i]","","[b] (Age 16) on the set of : \" the devil is an unemployed tsundre\" [/b]","","Some people remember dates. I remember colors and secrets. At sixteen, the set of \"The devil\" was a blinding, suffocating neon yellow the expectations were too much.","","Every time the phone in my pocket buzzed with a message from my father, the world turned that sickly, fluorescent shade. [i]Smile wider, you lame exuse of an actor. Your stock price is dropping.[/i] Hed be sitting at home, three beers deep by 10 AM, managing my jawline from across the city while my mother hid her bruises under layers of foundation.","","When Noa locked that dressing room door and caught me with my then secret boyfriend, the neon yellow vanished. Her voice was a steady, deep ocean blue. ","","\"He's cute,\" shed said, leaning against the wood to block out the world. \"But his styling is tragic. And Minjae? Stop shaking. I don't work for the company, her smile was sincere for once, I work for myself.\" ","","That was the day our contract was signed. Not on paper, but in the sanctuary of a shared secret. In the silence of that double closet, Noa became my shield, and I became the only person allowed to see the girl behind the Empress. Two kids who promised to keep each other human in a world that only buys our colors as if they were theirs to begin with.","","[b]Present Day[/b]","","My apartment is the only place where the colors don't lie. [b]Bami[/b] waits by the door, his bark is an earthy, grounded brown, the color of wet soil after rain. Hes missing an eye and walks with a limp he got from the streets, but hes the only one who knows the boy under the makeup. ","","And then theres [b]Gurum[/b]. A white, tangled ball of fur that looks like a small cloud got electrocuted and landed in my living room. Gurum sneezes whenever hes happy, a spark of pure, untainted lilac. They are the only honest things I own.","","When the world gets too loud, I watch carpet cleaning videos. I watch the rotating brushes churn and the black, muddy water get sucked out of the fibers. In my head, that mud is the smell of my fathers beer. Its the stain of every fake smile Ive given a camera. I watch until the carpet is white again, praying that one day, I can scrub my own soul just as clean.","","*label sanctuary_scene","","*comment --- DEFINE TEMP VARIABLES FOR GRAMMAR ---","*temp p_he \"\"","*temp p_him \"\"","*temp p_his \"\"","*temp p_is \"\"","*temp p_was \"\"","","*if (gender = \"male\")","    *set p_he \"he\"","    *set p_him \"him\"","    *set p_his \"his\"","    *set p_is \"is\"","    *set p_was \"was\"","    *goto start_narrative","*elseif (gender = \"female\")","    *set p_he \"she\"","    *set p_him \"her\"","    *set p_his \"her\"","    *set p_is \"is\"","    *set p_was \"was\"","    *goto start_narrative","*else","    *comment --- NON-BINARY ---","    *set p_he \"they\"","    *set p_him \"them\"","    *set p_his \"their\"","    *set p_is \"are\"","    *set p_was \"were\"","    *goto start_narrative","","*label start_narrative","[b]The Sanctuary[/b]","","[b]The Sanctuary[/b]","","I stood in the center of that terrarium, looking at ${name}. In the middle of the Villas fake glitter, ${p_he} ${p_is} transparent. ","","I didn't want ${p_him} to just feel a touch; I wanted ${p_him} to feel [b]trust[/b]. I wanted to give ${p_him} what I never had: a place where there are no contracts, no fines, and no producer screaming at you to throw champagne at someone just because the ratings are dipping. I wanted ${p_him} to see that there could be a safe place in the middle of this storm, without a hidden agenda.","","*if (romance_minjae)","    *goto minjae_romance_reaction","*else","    *goto minjae_neutral_reaction","","*label minjae_romance_reaction","The jealousy burned a sharp, jagged purple in my vision. It wasn't just that ${p_he} touched ${partner_name}, it was that I craved that trust for myself. I wanted ${p_him} to see the boy hiding under the cynic, the one still waiting for the screaming to stop. I wanted ${p_his} colors to bleed into mine.","*goto the_switch","","*label minjae_neutral_reaction","Seeing ${p_him} reach out to ${partner_name} felt like watching a reflection of my own past. A fragile connection built on a stage of glass. I hoped ${p_he} ${p_was} stronger than I was. I hoped ${p_he} wouldn't let the glass cut ${p_him} when it eventually shattered.","*goto the_switch","","*label the_switch","","Then the PD entered. His smirk was a muddy, arrogant green. His applause splashed neon yellow over everything Id built. ","","He called ${p_his} pain content and ${p_his} touch fanservice. He looked just like my father, same eyes, better suit. To them, we aren't humans, were just street dogs theyve trained to fight so they can bet on our blood. They want to own every breath we take.","","\"I'm out,\" I said. My voice was steady, but I was falling apart. ","","I built them a sanctuary of glass, and he shattered it with a single clap. And the rage... it isn't just for him. Its for me. Because just like always, I turned around and walked away. I left ${p_him} in the mud. I failed to protect ${p_him} exactly like I failed to protect my mother.","","I need to go home. To Bami and Gurum. I need to find a video of a truly filthy carpet and watch the mud disappear. I need to scrub the color of that producer out of my mind before I lose control entirely.","","*page_break","*label update_1_finale","[b]END OF UPDATE 1[/b]","","Thank you for playing the first week of Project: Supernova. ","The journey has just begun.","","[i]Don't forget to use the new [b]Save System[/b] to explore different paths or prepare for the upcoming photo shoot![/i]","","*finish"]},"prologue_childhood":{"crc":-1578617637,"labels":{"prologue_start":0,"age_3":3,"age_3_end":34,"age_5":40,"age_5_end":74,"age_7":77,"age_7_end":101,"age_9":104,"age_9_end":131,"age_10":134,"age_10_end":161,"age_11":162,"age_11_end":202,"age_12":205,"age_12_end":229},"lines":["*label prologue_start","*image header_prologue.png center","","*label age_3","Age 3. Grandma's Living Room.","","The carpet is scratchy under your bare feet. Grandma sits in her armchair, her hands warm as she holds your tiny wrists. The afternoon sun filters through the lace curtains.","","\"Ainsi font, font, font...\" she sings, her voice raspy but gentle.","She moves your hands in rhythm. Left. Right. Twirl.","\"Les petites marionnettes...\"","","You are only three years old, but you remember this moment with terrifying clarity. It was the first time you felt the music.","","What did you feel in that moment?","","*choice","    # I felt like the center of the universe. I loved the attention.","        *set visual %+5","        *set charisma %+5","        *set per_bold %+5","        *set archetype \"Born Star\"","        *goto age_3_end","    # Her voice enchanted me. I tried to mimic every pitch and tone.","        *set vocals %+5","        *set per_gentle %+5","        *set archetype \"Vocalist\"","        *goto age_3_end","    # My body moved on its own. I had to dance.","        *set dance %+5","        *set per_bold %+5","        *set archetype \"Dancer\"","        *goto age_3_end","","*label age_3_end","The memory fades. Grandma is gone.","Only the cold silence of your parents' house remains.","","*page_break oh shit","","*label age_5","Age 5. Friday Night.","","The TV is blaring the evening news. Your father is slumped on the sofa, exhausted from work. Your mother is in the kitchen, stress radiating off her like heat.","You climb onto the low coffee table. This is your stage. You hold a wooden spoon like a microphone.","","\"Look at me!\" you scream. \"Look at me!\"","","You start to perform the dance you saw on the cartoon show. You give it everything you have.","","How did your parents react?","","*choice","    # Mom looked up. She didn't smile. \"Your leg is crooked.\"","        *set the_mask %+5","        *set per_gentle %-5","        *set rel_mother %+5","        You learned right then: Love is a reward for perfection.","        *goto age_5_end","    # Dad sighed. \"Get down. You're blocking the news.\"","        *set self_belief %-5","        *set rel_father %-10","        *set rebellion %+5","        *set per_bold %+5","        You learned right then: I have to scream to be heard.","        *goto age_5_end","    # They ignored me completely. So I closed my eyes and danced for myself.","        *set per_bold %-5","        *set dance %+4","        *set rebellion %+4","        *set self_belief %+5","        You were alone in the room, even with them there. But you felt like royalty.","        You learned right then: The stage is the only safe place. ","        *goto age_5_end","*label age_5_end","*page_break school's out","","*label age_7","Age 7. The Elementary School Gym.","","It smells of rubber mats and sweat. Parents line the back wall with camcorders.","The kids in your class always teased you, but now, the room is quiet. It's your turn.","","What did you do on that stage?","","*choice","    # I sang a sad ballad. I let all the loneliness in the house spill out.","        *set vocals %+7","        When you finished, there was total silence. Then, you saw the music teacher wiping a tear. Your power is emotion.","        *goto age_7_end","    # I danced a pop routine with military precision. I was a machine.","        *set dance %+5","        *set the_mask %+4","        You didn't miss a single beat. You felt total control over your body.","        *goto age_7_end","    # I just stood there, winked, and posed. The charisma did the work.","        *set charisma %+5","        *set visual %+4","        The parents clapped louder for you than anyone else. The other kids stared in jealousy. You realized you had \"It.\"","        *goto age_7_end","","*label age_7_end","*page_break if life was a garden","","*label age_9","Age 9. Your Bedroom.","","Outside your door, the fighting has started again. Shouting about money. The sound of a plate shattering.","You crawl under your duvet cover with an old MP3 player and big headphones.","You press PLAY. The world disappears.","","What are you watching to survive the night?","","*choice","    # A video of a perfect Idol group. Everyone is smiling, beautiful, and rich.","        *set visual %+4","        *set self_belief %-3","        *set the_mask %+7","        You don't just want to sing. You want their lives. You want to escape the ugliness of your reality into their fantasy.","        *goto age_9_end","    # A raw, acoustic track about pain and survival.","        *set vocals %+4","        *set the_mask %-3","        You realize you aren't alone. If they can turn pain into art, so can you.","        *goto age_9_end","    # A hardcore dance practice video. The sweat, the synchronization, the order.","        *set dance %+4","        *set the_mask %-3","        Out there, it's chaos. In here, there are rules. If you move exactly on the beat, nothing bad can hurt you.","        *goto age_9_end","","*label age_9_end","*page_break dance,dance revolution","","*label age_10","Age 10. The Community Center.","","You begged your mother to pay for lessons. The mirrors are cracked.","The instructor grabs your shoulder after class, a little too roughly.","\"You have talent\" he says. \"But in Seoul, talent is cheap. Are you ready to bleed for this?\"","","*choice","    # \"I will sleep in the studio if I have to. I won't get tired.\"","        *set dance %+5","        *set rebellion %+3","        *set self_belief %+5","        He nods. \"We'll see how long you last.\"","        *goto age_10_end","    # \"Just tell me what to do, Teacher. I will be perfect.\"","        *set vocals %+5","        *set the_mask %+2","        *set rebellion %-15","        He sighs. \"Good. The agencies like soldiers.\"","        *goto age_10_end","    # \"I'm going to be so beautiful they won't be able to say no.\"","        *set visual %+5","        *set charisma %+2","        *set rebellion %+10","        He chuckles darkly. \"Beauty fades. Work on your basics.\"","        *goto age_10_end","","*label age_10_end","*label age_11","Age 11. The Kitchen Table.","You sit your parents down. The community center isn't enough anymore. You need a real coach to get to the next level.","Your father looks at the glossy brochure for the private academy. He taps his finger on the price tag.","\"Do you know how many shifts I have to work to pay for this?\" he asks, his voice heavy.","Your mother crosses her arms. \"If we pay for this, you cannot quit. Ever. You treat this like a job.\"","","How do you convince them?","","*choice","    # \"I won't quit. I'll work harder than anyone else.\" (Focus: Dance)","        *set dance %+5","        *set physical %+3","        *set rel_father %-5","        *set rel_mother %+5","        *set self_belief %+5","        Your father sighs and opens his wallet. \"This is your inheritance,\" he grumbles. \"Don't waste it.\"","        Your mother nods approvingly. She likes the ambition, even if it costs them.","        *goto age_11_end","","    # \"I need this. My voice is my future.\" (Focus: Vocals)","        *set vocals %+5","        *set physical %+2","        *set rel_father %-5","        *set rel_mother %+5","        *set self_belief %+5","        \"It better be,\" your father mutters, signing the check with a frown.","        Your mother smooths your hair. \"Then make us proud. No mistakes.\"","        *goto age_11_end","","    # \"Think of it as an investment. I'll pay you back tenfold.\" (Focus: Boldness)","        *set charisma %+5","        *set rebellion %+5","        *set rel_father %+5","        *set rel_mother %-5","        Your father stops writing. He looks at you, surprised, then lets out a dry laugh.","        \"Big words,\" he says, closing the checkbook but looking impressed. \"Okay. I like that attitude. Make me rich, kid.\"","        Your mother frowns. \"It's not about money. It's about discipline.\"","        *goto age_11_end","    ","*label age_11_end","*page_break busk to me","","*label age_12","Age 12. Hongdae Street.","","You dragged a small speaker to the busy shopping district.","Suddenly the speaker dies. The music cuts out in the middle of the chorus.","Panic rises in your throat. What did you do?","","*choice","    # I froze. I grabbed my bag and ran home, crying.","        *set self_belief %-10","        *set stress %+10","        The shame burned for weeks. It planted a seed of stage fright deep in your chest.","        *goto age_12_end","    # I kept singing a cappella, louder than before.","        *set vocals %+5","        *set self_belief %+3","        The crowd cheered for your bravery. You learned you are stronger than your fear.","        *goto age_12_end","    # I laughed, made a joke about \"cheap equipment,\" and charmed the crowd.","        *set charisma %+5","        *set the_mask %+5","        You made them smile. You learned that personality can save you when talent fails.","        *goto age_12_end","","*label age_12_end","*goto_scene chapter1_start"]},"chapter3_Jun":{"crc":0,"labels":{},"lines":[""]},"social_logic":{"crc":1374094813,"labels":{"update_feed":4,"check_visual":34,"check_vocal":45,"check_dance":56,"check_charisma":67,"check_fallback":78,"end_feed":89,"end_feed_func":100,"generate_chapter3_comments":105,"slot2":130,"slot3":151,"combine_3":169,"append_chapter3":183,"end_chapter3_func":195,"update_week_1":200,"h_check":221,"c_check":230,"finish_week_1":239,"end_week_1_func":258,"check_rank":263},"lines":["*comment ==================================================","*comment SOCIAL LOGIC FILE","*comment ==================================================","","*label update_feed","*comment --- Variable for REAL Line Break ---","*temp br ","*set br \"        |         \"","*temp feed_accumulator \"\"","*temp roll_scandal","*temp roll_visual","*temp roll_vocal","*temp roll_dance","*temp roll_charisma","*temp comments_count 0","","*rand roll_scandal 1 10","*rand roll_visual 1 10","*rand roll_vocal 1 10","*rand roll_dance 1 10","*rand roll_charisma 1 10","","*set feed_accumulator \"\"","","*if (scandal_risk >= 35)","    *if (roll_scandal <= 6)","        *set feed_accumulator \"@kill_idol: why is titan keeping them?? toxic af  #Disband\"","        *set comments_count + 1","        *goto check_visual","    *else","        *goto check_visual","*else","    *goto check_visual","","*label check_visual","*if (visual >= 50)","    *if (roll_visual <= 5)","        *set feed_accumulator (feed_accumulator & \" @facelover: face card is INSANE... i am dizzy \")","        *set comments_count + 1","        *goto check_vocal","    *else","        *goto check_vocal","*else","    *goto check_vocal","","*label check_vocal","*if (vocals >= 50)","    *if (roll_vocal <= 5)","        *set feed_accumulator (feed_accumulator & \" @vocal_police: vocals were crazy good?? hello?? \")","        *set comments_count + 1","        *goto check_dance","    *else","        *goto check_dance","*else","    *goto check_dance","","*label check_dance","*if (dance >= 50)","    *if (roll_dance <= 5)","        *set feed_accumulator (feed_accumulator & \" @main_slayer: the body lines... main dancer material fr\")","        *set comments_count + 1","        *goto check_charisma","    *else","        *goto check_charisma","*else","    *goto check_charisma","","*label check_charisma","*if (charisma >= 50)","    *if (roll_charisma <= 5)","        *set feed_accumulator (feed_accumulator & \" @variety_king: they are so funny pls  need them on variety shows immediately\")","        *set comments_count + 1","        *goto check_fallback","    *else","        *goto check_fallback","*else","    *goto check_fallback","","*label check_fallback","*if (comments_count = 0)","    *if (followers < 500)","        *set feed_accumulator \"No new notifications yet.\"","        *goto end_feed","    *else","        *set feed_accumulator \"@titan_stan: waiting for debut!!! ${name} let's goooo \"","        *goto end_feed","*else","    *goto end_feed","","*label end_feed","*comment --- FIX: Append instead of overwrite ---","*if (social_feed_content = \"No new notifications.\")","    *set social_feed_content feed_accumulator","    *goto end_feed_func","*else","    *set social_feed_content (social_feed_content & br)","    *set social_feed_content (social_feed_content & br)","    *set social_feed_content (social_feed_content & feed_accumulator)","    *goto end_feed_func","","*label end_feed_func","*return","","*comment ==================================================","","*label generate_chapter3_comments","*temp br ","*set br \"        |         \"","*temp comment_3_1 \"\"","*temp comment_3_2 \"\"","*temp comment_3_3 \"\"","*temp combined_3_feed \"\"","","*comment --- PART 1: INTRO STYLE ---","*if (intro_style = \"Funny\")","    *set comment_3_1 \" @memegod: asking noa for CATERING is wild  idol comedian confirmed\"","    *goto slot2","*elseif (intro_style = \"Rebel\")","    *set comment_3_1 \" @drama_queen: walking out on noa?? the audacity... i am sat though  #Supernova\"","    *goto slot2","*elseif (intro_style = \"Sweet\")","    *set comment_3_1 \" @uwu_hours: protect this baby!! too pure for this snake show \"","    *goto slot2","*elseif (intro_style = \"Visual\")","    *set comment_3_1 \" @visuals_only: the chemistry with noa... visual attack overload\"","    *goto slot2","*else","    *set comment_3_1 \" @watcher: interesting intro... keeping an eye on them\"","    *goto slot2","","*label slot2","*comment --- PART 2: PERFORMANCE ---","*if (performance_type = \"Dance\")","    *set comment_3_2 \" @dance_machine: ATE that choreo. left no crumbs.\"","    *goto slot3","*elseif (performance_type = \"Vocal\")","    *set comment_3_2 \" @vocals_only: that tone color... expensive. need the full version rn.\"","    *goto slot3","*elseif (performance_type = \"Rest\")","    *set comment_3_2 \" @critic: just talking? flop behavior tbh. show us something.\"","    *goto slot3","*elseif (performance_type = \"Injured_Visual\")","    *set comment_3_2 \" @save_them: looking like a fallen angel on that bench... my heart hurts \"","    *goto slot3","*elseif (performance_type = \"Skipped\")","    *set comment_3_2 \" @nugu_hunter: barely saw them today. getting eliminated soon?\"","    *goto slot3","*else","    *set comment_3_2 \"\"","    *goto slot3","","*label slot3","*comment --- PART 3: SPECIAL MOMENTS ---","*if (social_special_moment = true)","    *set comment_3_3 \" @dispatch_intern: analysis: noa's gaze softened?? i smell a favorite...\"","    *goto combine_3","*elseif (treasure = \"Smartphone\")","    *set comment_3_3 \" @gen_z: 'my fans are in here' - iconic line fr. they know the game.\"","    *goto combine_3","*elseif (treasure = \"iPod Classic\")","    *set comment_3_3 \" @retro_vibes: ipod classic?? okay taste. respect.\"","    *goto combine_3","*elseif (followers >= 14000)","    *set comment_3_3 \" [TRENDING #1]: the gap is huge... debut secured already??\"","    *goto combine_3","*else","    *set comment_3_3 \" @expert: meh. needs more grit to survive noa.\"","    *goto combine_3","","*label combine_3","*comment --- Combine using the 'br' variable for real spacing ---","*set combined_3_feed (comment_3_1 & br)","*set combined_3_feed (combined_3_feed & br)","*set combined_3_feed (combined_3_feed & comment_3_2)","","*if (comment_3_3 != \"\")","    *set combined_3_feed (combined_3_feed & br)","    *set combined_3_feed (combined_3_feed & br)","    *set combined_3_feed (combined_3_feed & comment_3_3)","    *goto append_chapter3","*else","    *goto append_chapter3","","*label append_chapter3","*comment --- FIX: Check if feed is empty/default, otherwise append ---","*if (social_feed_content = \"No new notifications.\")","    *set social_feed_content combined_3_feed","    *goto end_chapter3_func","*else","    *comment --- Adds new text below old text with double line break ---","    *set social_feed_content (social_feed_content & br)","    *set social_feed_content (social_feed_content & br)","    *set social_feed_content (social_feed_content & combined_3_feed)","    *goto end_chapter3_func","","*label end_chapter3_func","*return","","*comment ==================================================","","*label update_week_1","*temp feed_text \"\"","*comment --- Create a literal newline variable ---","*temp br ","*set br \"        |         \"","","*comment --- 1. GENERAL COMMENTS (Appears for everyone) ---","*set feed_text \" @TrashTV_Lover: Min-ho eliminated?? He was the villain! Who am I supposed to hate now? \"","*set feed_text (feed_text & br)","*set feed_text (feed_text & br)","*set feed_text (feed_text & \" @Star_Watcher: 7 trainees gone in one day... Titan isn't playing games. #Survival\")","","*comment --- 2. IDENTITY CHECKS ---","*if (gender = \"nonbinary\")","    *set feed_text (feed_text & br)","    *set feed_text (feed_text & br)","    *set feed_text (feed_text & \" @FluidVibes: A Non-Binary idol in the final lineup? Titan is actually doing something right for once! \")","    *goto h_check","*else","    *goto h_check","","*label h_check","*if (haneul_gender = \"nb\")","    *set feed_text (feed_text & br)","    *set feed_text (feed_text & br)","    *set feed_text (feed_text & \" @Haneul_Fan: Seeing Haneul as a non-binary icon makes me so emotional. Representation matters! \")","    *goto c_check","*else","    *goto c_check","","*label c_check","*if (rival_gender = \"nonbinary\")","    *set feed_text (feed_text & br)","    *set feed_text (feed_text & br)","    *set feed_text (feed_text & \" @CocoVibe: Coco's gender-fluid aesthetic is the future of K-pop. No crumbs left. \")","    *goto finish_week_1","*else","    *goto finish_week_1","","*label finish_week_1","*comment --- 3. CRITICAL FIX: APPEND TO EXISTING FEED (Do not overwrite) ---","*if (social_feed_content = \"No new notifications.\")","    *set social_feed_content feed_text","    *goto end_week_1_func","*else","    *comment --- This adds separators + new content to the BOTTOM of the list ---","    *set social_feed_content (social_feed_content & br)","    *set social_feed_content (social_feed_content & br)","    *set social_feed_content (social_feed_content & \"------------------------------\")","    *set social_feed_content (social_feed_content & br)","    *set social_feed_content (social_feed_content & \"[b]WEEK 1 RECAP[/b]\")","    *set social_feed_content (social_feed_content & br)","    *set social_feed_content (social_feed_content & \"------------------------------\")","    *set social_feed_content (social_feed_content & br)","    *set social_feed_content (social_feed_content & br)","    *set social_feed_content (social_feed_content & feed_text)","    *goto end_week_1_func","","*label end_week_1_func","*return","","*comment ==================================================","","*label check_rank","*if (followers < 1000)","    *set rank_title \"Nugu (Who?)\"","    *return","*elseif (followers < 10000)","    *set rank_title \"Hidden Gem\"","    *return","*elseif (followers < 20000)","    *set rank_title \"Trending Trainee\"","    *return","*elseif (followers < 100000)","    *set rank_title \"Viral Sensation\"","    *return","*elseif (followers < 500000)","    *set rank_title \"Rising Star\"","    *return","*elseif (followers < 1000000)","    *set rank_title \"National Idol\"","    *return","*else","    *set rank_title \"Global Icon\"","    *return"]},"chapter3_survival":{"crc":-1981597309,"labels":{"chapter3_start":0},"lines":["*label chapter3_start","*image header_chapter3.png center","[b]CHAPTER 3: THE VILLA[/b]","","You have arrived at the filming location. The gates close behind you, locking you in.","The real survival game begins now.","","*line_break","","[b] END OF DEMO [/b]","Thank you for playing the demo of i-doll!","This version covers the Prologue through the end of Chapter 2.","","Follow the project on the forum for updates on Chapter 3 & 4!","","","*finish"]},"choicescript_stats":{"crc":1950120757,"labels":{"main_stats":8,"check_rank":26,"check_trend":49,"show_menu":57,"menu_choices":67,"tab_profile":83,"tab_skills":106,"personality_chart":131,"tab_social":149,"tab_relationships":163,"tab_characters":188,"side_profiles":239,"tab_glossary":260},"lines":["*temp group_type \"Unknown\"","*temp warning_text \"\"","*temp visual_boldness 50","*temp visual_rebellion 0","*temp rank_title \"Unknown\"","*temp trend_icon \"\"","*temp confirm_load false","","*label main_stats","*if (stats_unlocked = false)","    [b] SYSTEM ERROR 404[/b]","    [i]Identity Not Found.[/i]","    Please return to Chapter 1 and finish your registration.","    *finish","","*if (gender = \"male\")","    *set group_type \"Boy Group\"","    *goto check_rank","*elseif (gender = \"female\")","    *set group_type \"Girl Group\"","    *goto check_rank","*else","    *set group_type \"Co-ed Group\"","    *set warning_text \" SYSTEM NOTE: High Risk Project.\"","    *goto check_rank","","*label check_rank","*if (followers < 1000)","    *set rank_title \"Nugu (Who?)\"","    *goto check_trend","*elseif (followers < 10000)","    *set rank_title \"Hidden Gem\"","    *goto check_trend","*elseif (followers < 19000)","    *set rank_title \"Trending Trainee\"","    *goto check_trend","*elseif (followers < 50000)","    *set rank_title \"Viral Sensation\"","    *goto check_trend","*elseif (followers < 500000)","    *set rank_title \"Rising Star\"","    *goto check_trend","*elseif (followers < 1000000)","    *set rank_title \"National Idol\"","    *goto check_trend","*else","    *set rank_title \"Global Icon\"","    *goto check_trend","","*label check_trend","*if (followers > 15000)","    *set trend_icon \"\"","    *goto show_menu","*else","    *set trend_icon \"\"","    *goto show_menu","","*label show_menu","*if (chapter < 3)","    [b] TITAN ENTERTAINMENT[/b]","    [i]Trainee Management Portal[/i]","    *goto menu_choices","*else","    [b] PROJECT: SUPERNOVA[/b]","    [i]Survivor Interface: Active[/i]","    *goto menu_choices","","*label menu_choices","*line_break","*choice","    #  PROFILE (Data & Visuals)","        *goto tab_profile","    #  SKILLS & STATUS","        *goto tab_skills","    #  SOCIAL FEED","        *goto tab_social","    #  RELATIONSHIPS","        *goto tab_relationships","    #  DOSSIERS (CHARACTERS)","        *goto tab_characters","    #  GLOSSARY","        *goto tab_glossary","","*label tab_profile","[b] TRAINEE DATA[/b]","*stat_chart","    text full_name Name","    text hobby Hidden Talent","    text origin Origin","    text group_type Role","","[i]${warning_text}[/i]","*line_break","","[b] APPEARANCE[/b]","You have ${skin_tone} skin and ${hair_style} ${hair_color} hair.","","[b]Height:[/b] ${p_height}","","[b]Build:[/b] ${p_body_type}","","*line_break","*choice","    # Back to Menu","        *goto main_stats","","*label tab_skills","[b] SKILL SET[/b]","*stat_chart","    percent vocals Vocals","    percent dance Dance","    percent visual Visual","    percent charisma Charisma","","[b] MENTAL STATE[/b]","*stat_chart","    percent physical HP (Health)","    percent stress Stress","    percent the_mask The Mask","    percent scandal_risk Netizen Heat","","*if (scandal_risk < 15)","    [i]K-Netz Verdict: \"Clean.\"[/i]","    *goto personality_chart","*elseif (scandal_risk < 55)","    [i]K-Netz Verdict: \"Rumors starting...\"[/i]","    *goto personality_chart","*else","    [i]K-Netz Verdict: \"CANCELLED.\"[/i]","    *goto personality_chart","","*label personality_chart","*line_break","[b] PERSONALITY[/b]","*set visual_boldness (50 + per_bold) - per_gentle","*set visual_rebellion rebellion","*stat_chart","    opposed_pair visual_boldness","        Bold","        Gentle","    opposed_pair visual_rebellion","        Rebellious","        Obedient","","*line_break","*choice","    # Back to Menu","        *goto main_stats","","*label tab_social","[b] SOCIAL FEED[/b]","@${name}_official","","[b]${followers}[/b] Followers | [b]Status:[/b] ${rank_title} ${trend_icon}","","[b] LATEST NOTIFICATION[/b]","[i]${social_feed_content}[/i]","","*line_break","*choice","    # Back to Menu","        *goto main_stats","","*label tab_relationships","[b] RELATIONSHIP CHART[/b]","","[b] SQUAD[/b]","*stat_chart","    percent rel_rival Coco","    percent rel_jun Jun","    percent rel_haneul Haneul","    percent rel_kang Kang","    percent rel_rio Rio","    percent rel_jiwon Ji-won","    percent rel_yuri Yuri","","[b] THE STARS[/b]","*stat_chart","    percent rel_minjae Min-jae","    percent rel_noa Noa","","[b] THE SUITS[/b]","*stat_chart","    percent rel_manager Manager","    percent rel_eden Eden","","*goto main_stats","","*label tab_characters","Who do you want to stalk?","*choice","    #Mother & Father","        [b]MOTHER:[/b] Sharp elegance. Her love language is criticism.","        [b]FATHER:[/b] Quiet confidence. Worn down by capitalism.","        *if (rel_mother > 60)","            Mom is actually smiling. It's terrifying.","            *goto tab_characters","        *elseif (rel_mother < 40)","            Mom looks at you like a failed investment.","            *goto tab_characters","        *else","            Professional distance.","            *goto tab_characters","    #Jun (The Roommate)","        [b]JUN (16)[/b]","        [i]Sleepy eyes, sharp jawline. Looks cool, is actually a soft marshmallow. Likely to be found eating ramen in a closet.[/i]","        *goto tab_characters","    #Coco (The Ace)","        [b]COCO (17)[/b]","        [i]Lethal dancer. Cat eyes. Expensive aura. Or maybe they're just better than you.[/i]","        *goto tab_characters","    #Haneul (The Royal)","        [b]HANEUL (17)[/b]","        [i]Dewy skin, tea-colored eyes. Looks like they were born in a castle, but secretly hates the spotlight.[/i]","        *goto tab_characters","","    #Noa","        *if (chapter < 3)","            Locked until Chapter 3.","            *goto tab_characters","        *else","            *if (noa_name_known)","                [b]YOON NA-RI (17)[/b]","                [i]Now known by her real name, Yoon Na-ri is a teenage prodigy who debuted at 13. Her tall, feminine frame and sun-kissed tan skin remain striking, but her soulful brown eyes now carry the weight of her legacy. Underneath the \"Perfect Idol\" mask, she is rebellious and treats you as an equal.[/i]","                *goto tab_characters","            *else","                [b]MENTOR NOA (17)[/b]","                [i]A famous solo artist and judge on Project: Supernova. Known for her harsh critiques and incredible stage presence, her soulful, deep brown eyes radiate a warmth that provides a subtle contrast to the cold efficiency of the survival show.[/i]","                *goto tab_characters","","    #Minjae (The Actor)","        [b]HAN MIN-JAE (19)[/b]","        [i]Wolf cut, green eyes. Warned you to run away. You didn't listen.[/i]","        *goto tab_characters","    #Side Characters (Rio, Kang, Jiwon, Yuri, Eden)","        *goto side_profiles","    #Back to Main Stats","        *goto main_stats","","*label side_profiles","*choice","    #Rio & Kang","        [b]RIO (17):[/b] Short, explosive energy. A walking vitamin shot.","        ","        [b]KANG (18):[/b] Built like a tank. Stoic. Practices dance moves in their sleep.","        *goto side_profiles","","    #Jiwon & Yuri","        [b]JI-WON (17):[/b] Analytical eyes. Calculates debut probability while eating salad.","        ","        [b]YURI (15):[/b] Fairy visual. The sharpest 'Golden Maknae' in the business.","        *goto side_profiles","","    #Eden","        [b]EDEN (28):[/b] Genius producer. Looks like a vampire who lives in the studio.","        *goto side_profiles","","    #Back","        *goto tab_characters","    ","*label tab_glossary","[b] THE DICTIONARY OF SUFFERING[/b]","[i](A guide to K-Pop terminology used in the game)[/i]","","[b] HONORIFICS (FAMILY & RESPECT)[/b]","*line_break","[b]Sunbae / Hoobae ( / ):[/b]","Senior / Junior. The hierarchy is absolute. If they debuted one day before you, they are your Sunbae. Bow 90 degrees or die socially.","","[b]Hyung / Oppa ( / ):[/b]","\"Older Brother\". Used by males (Hyung) or females (Oppa) to address an older male. Can be affectionate or just polite.","","[b]Noona / Unnie ( / ):[/b]","\"Older Sister\". Used by males (Noona) or females (Unnie) to address an older female.","","[b]-Nim ():[/b]","A suffix of high respect (e.g., \"Sunbae-nim\", \"Teacher-nim\"). Adding it shows you know your place.","*line_break","","[b] DAILY LIFE & SLANG[/b]","*line_break","[b]Daebak ():[/b]","\"Awesome\" or \"Huge Success\". Used when something goes viral or when you are genuinely shocked.","","[b]Hwaiting ():[/b]","\"Fighting!\" A phrase used to cheer someone on or wish them luck before a performance.","","[b]Pali-pali ():[/b]","\"Hurry, hurry!\" The unspoken motto of Korean society. If you aren't running, you're late.","","[b]Aegyo ():[/b]","Acting overly cute and childlike to charm fans. Required even if you are a 25-year-old rapper with a deep voice.","","[b]Skinship ():[/b]","Physical intimacy between friends (holding hands, hugging). Fans obsess over analyzing these moments.","","[b]Nugu ():[/b]","Literally \"Who?\". A derogatory term for unpopular groups or idols that nobody knows.","","[b]T-Time / Ment:[/b]","The \"Talking Time\" during a concert or show where idols stop singing to talk to the audience. Usually scripted.","","*line_break","[b] INDUSTRY TERMS[/b]","*line_break","","[b]Maknae ():[/b]","The youngest member. Responsible for being cute (Aegyo) and doing the chores, but often secretly runs the group (\"Maknae on Top\").","","[b]All-Rounder:[/b]","An idol who has no weaknessgood at Vocals, Dance, and Rap. The rarest type of trainee.","","[b]Visual / Face Genius:[/b]","A member so undeniably good-looking that their face alone is considered a talent.","","[b]Ending Fairy:[/b]","The member who gets the final close-up shot. You must stare into the camera and pant heavily (even if you aren't tired).","","[b]Kkondae ():[/b]","An older person who is condescending, rigid, and demands respect just because of their age. A \"Boomer\".","","*line_break","[b] CONCEPTS & EMOTIONS[/b]","*line_break","[b]Han ():[/b]","A deep sorrow, resentment, and injustice that builds up over time. It is the fuel for great art.","","[b]Jeong ():[/b]","A deep connection. It goes beyond loveit is loyalty and shared attachment, even towards people you might hate.","","[b]Nunchi ():[/b]","The art of \"reading the room\". The ability to gauge the mood instantly. Essential for survival.","","[b]Kki ():[/b]","The \"X-Factor\" or star quality. You can't learn it in a classroom; you have to be born with it.","","[b]Eumsaek ():[/b]","\"Vocal Tone\" or \"Voice Color\". Having a unique vocal texture that is instantly recognizable.","","[b]4D Personality:[/b]","Someone eccentric and quirky (thinking in the 4th Dimension). Fans love them because they are unpredictable.","","[b]Sasaeng ():[/b]","Obsessive \"fans\" who stalk idols, invade privacy, and commit crimes to get attention.","","*line_break","*choice","    # Back to Menu","        *goto main_stats"]},"startup":{"crc":1687811298,"labels":{"prologue_start":176},"lines":["*title i-doll","*author Mfein","","*scene_list","    startup","    prologue_childhood","    chapter1_start","    chapter2_trainee","    chapter3_solo","    chapter3_jun","    chapter4_debut","    chapter5_idol_life","    chapter6_scandal","    chapter7_burnout","    chapter8_finale","    chapter9_interview_end","    epilogues","    social_logic","","*create chapter 1","*create full_name \"Unknown\"","*create name \"Unknown\"","*create surname \"Unknown\"","*create treasure \"Unknown\"","*create performance_type \"none\"","","*comment --- Physical & Stats ---","*create vocals 5","*create dance 5","*create visual 5","*create charisma 5","*create physical 100","*create stress 15","*create self_belief 10","*create the_mask 0","","*comment --- Personality ---","*create ruthless 0","*create per_bold 50","*create per_gentle 50","*create rebellion 50","*create obedience 50","*create imposter_syndrome false","*comment --- Status & Social ---","*create followers 0","*create social_feed_content \"No new notifications.\"","*create scandal_risk 0","*create scandal_mult 1","*create rank_title \"Trainee\"","","*comment --- Relationships ---","*create rel_father 50","*create rel_mother 50","*create rel_jun 30","*create rel_haneul 30","*create rel_kang 30","*create rel_rio 30","*create rel_jiwon 30","*create rel_yuri 30","*create rel_manager 50","*create rel_eden 30","*create rel_minjae 30","*create rel_noa 15","*create rel_rival 25","*create romance_status \"single\"","*create romance_commitment \"none\"","*create victory false","*comment --- Plot Flags ---","*create entry_method \"merit\"","*create cut_reason \"none\"","*create dissociated_pass false","*create hidden_injury false","*create passed_eval false","*create stats_unlocked false","*create collapse_count 0","*create noa_name_known false","*create intro_style \"none\"","*create room_vibe \"none\"","*create role_pool_party \"none\"","*comment --- Character Variables ---","*create gender \"female\"","*create he_she \"she\"","*create him_her \"her\"","*create his_her \"her\"","*create boy_girl \"girl\"","*create man_woman \"woman\"","*create son_daughter \"daughter\"","*create honorific_older_male \"Sunbae\"","*create romance_minjae false","*create p_body_type \"unknown\"","*create p_height \"average\"","*create skin_tone \"fair\"","*create eye_color \"brown\"","*create hair_color \"black\"","*create hair_style \"natural\"","*create heterochromia false","*create tattoos false","*create piercings false","*create hobby \"None\"","*create origin \"Local\"","*create archetype \"None\"","*create motivation \"None\"","","*create haneul_gender \"male\"","*create h_he \"he\"","*create h_him \"him\"","*create h_his \"his\"","","*create jun_nickname \"Jun\"","*create j_he \"he\"","*create j_him \"him\"","*create j_his \"his\"","*create j_boy \"boy\"","","*create rival_nickname \" \"","*create rival_name \"Coco\"","*create rival_gender \"unknown\"","*create r_he \"he\"","*create r_him \"him\"","*create r_his \"his\"","","*create kang_he \"he\"","*create kang_him \"him\"","*create kang_his \"his\"","*create rio_he \"he\"","*create rio_him \"him\"","*create rio_his \"his\"","*create jiwon_he \"she\"","*create jiwon_him \"her\"","*create jiwon_his \"her\"","*create yuri_he \"she\"","*create yuri_him \"her\"","*create yuri_his \"her\"","","*create biology \"male\"","*create dorm_ward \"boys\"","*create has_chest false","*create lower_anatomy \"penis\"","*create romance_coco false","*create romance_haneul false","*create romance_noa false","*create romance_minjae false","*create mental_state \"Stable\"","*create trauma_points 0","*create eating_disorder_flag false","*create social_special_moment false","*create  zen_mode false","*sm_init idoll | 14"," CONTENT WARNINGS & GAME MECHANICS (i-doll)","i-doll is an interactive drama intended for mature audiences. It explores the high-pressure, often predatory environment of the K-pop industry.  Due to the addition of new Psychological and Physical Realism mechanics, this story contains themes that may be distressing to some players.",""," Mental Health & Body Image Warnings","The narrative includes detailed depictions of:","","Eating Disorders & Body Dysmorphia: The game simulates extreme weight standards, public weigh-ins, and the development of unhealthy coping mechanisms such as self-starvation.","","Psychological Breakdown: The story tracks mental deterioration through states of Mania, Emotional Dissociation, and Severe Depression.","","","Physical Self-Harm: The abuse of medication (specifically high-strength painkillers) to force an injured body to continue performing. ","","Institutional Abuse: Verbal and emotional abuse from authority figures and a rigid social hierarchy.",""," Hidden Mechanics: Trauma & Mental States","Unlike the temporary Stress meter, which can be managed through rest, this game utilizes a permanent Trauma System:","","Trauma Points: Extreme actions or traumatic events accrue hidden, permanent points that do not reset.","","Mental State Flags: Once Trauma or Stress crosses specific thresholds, your characters Mental State will shift based on their personality (e.g., a \"Masked\" character may dissociate, while a \"Ruthless\" character may enter a manic state).","","Narrative Locking (Consequences): Having an active Eating Disorder or a compromised Mental State will permanently lock certain choices. Your character may become \"too ill\" or \"too detached\" to react in a healthy or social manner.","","[!IMPORTANT] This game does not encourage or romanticize these behaviors. They are depicted as the destructive and harmful consequences of a brutal industry. Later chapters will offer opportunities to seek help and attempt recovery, though the path to healing is difficult and depends on your choices.","","By clicking \"Next,\" you acknowledge that you are aware of these themes and wish to proceed.","*page_break ok ok now let the fun begin","*label prologue_start","","The red \"ON AIR\" light buzzes to life.","\"The world knows the legend,\" the host says. \"But where did it really begin?\"","","You close your eyes.","","*page_break Yeepi kye A ...","*goto_scene prologue_childhood"]},"mechanics":{"crc":866436427,"labels":{"check_stress_threshold":0,"total_body_failure":14,"severe_breakdown":32,"mild_burnout":49,"physical_injury":60,"update_mental_state":70,"safe_stat_clamp":98},"lines":["*label check_stress_threshold","[i](System: Emergency Vitals Scan...)[/i]","","*if (physical <= 0)","    *goto total_body_failure","*elseif (stress >= 85)","    *goto severe_breakdown","*elseif (stress >= 65)","    *goto mild_burnout","*elseif (physical <= 15)","    *goto physical_injury","*else","    *return","","*label total_body_failure","*page_break BLACKOUT","Everything goes dark. You don't even feel your body hitting the floor.","","You wake up three days later in a private clinic. A manager is sitting by your bed, looking at a tablet. \"You missed seventy-two hours of training,\" he says coldly. \"The CEO is considering replacing you. You are a liability now.\"","","*set physical 25","*set stress 50","*set dance %-20","*set vocals %-20","*set charisma %-20","*set visual %-10","*set self_belief %-20","*set rel_manager %-25","*set collapse_count +1","[b]CRITICAL PENALTY: Massive Stat Loss (-20%). Manager trust is broken.[/b]","*return","","*label severe_breakdown","*page_break CRITICAL CONDITION","Your body refuses to obey. It's a total system shutdown. ","You wake up in the infirmary with an IV drip in your arm. ","","\"Disappointing,\" Director Park says. \"Take 3 days off.\"","","*set physical %+15","*set stress %-20","*set dance %-12","*set vocals %-12","*set charisma %-12","*set self_belief %-10","*set rel_manager %-15","[b]MAJOR PENALTY: -12% to All Skills due to Hospitalization.[/b]","*return","","*label mild_burnout","*page_break WARNING: HIGH STRESS LEVEL","The exhaustion is catching up to you. Your mind feels like it's full of fog.","\"Focus!\" the instructor yells. \"${name}, you're dragging behind!\"","","*set dance %-5","*set vocals %-5","*set self_belief %-5","[b]PENALTY: -5% to Skills due to Brain Fog.[/b]","*return","","*label physical_injury","*page_break INJURY ALERT","SNAP. A sharp pain shoots through your leg. You have a stress fracture.","You are forced to sit out of dance practice for a week.","","*set dance %-15","*set physical %+10","*set stress %+10","[b]PENALTY: -15% to Dance. Stress Increased.[/b]","*return","*label update_mental_state","*comment ---  :     ,   ---","*if (stress < 70) and (trauma_points < 3)","    *set mental_state \"Stable\"","    *return","","*comment ---       ,     ---","","*comment 1.   \"\" ->  (Dissociation)","*if (the_mask >= 60)","    *set mental_state \"Dissociated\"","    *return","","*comment 2.  \"\" -> / (Manic)","*elseif (ruthless >= 60)","    *set mental_state \"Manic\"","    *return","","*comment 3.  \"\" -> / (Depressed)","*elseif (per_gentle >= 60)","    *set mental_state \"Depressed\"","    *return","","*comment 4.     ->  (Burnout)","*else","    *set mental_state \"Burnout\"","    *return","    ","*label safe_stat_clamp","*comment --- SILENT FIX: Math only, no text ---","","*comment --- Basic Stats ---","*if (physical < 0)","    *set physical 0","*if (physical > 100)","    *set physical 100","*if (stress < 0)","    *set stress 0","*if (stress > 100)","    *set stress 100","*if (dance > 100)","    *set dance 100","*if (vocals > 100)","    *set vocals 100","*if (visual > 100)","    *set visual 100","*if (charisma > 100)","    *set charisma 100","*if (self_belief > 100)","    *set self_belief 100","","*comment --- Relationships (The 102 fix) ---","*if (rel_kang > 100)","    *set rel_kang 100","*if (rel_jun > 100)","    *set rel_jun 100","*if (rel_rio > 100)","    *set rel_rio 100","*if (rel_haneul > 100)","    *set rel_haneul 100","*if (rel_rival > 100)","    *set rel_rival 100","*if (rel_noa > 100)","    *set rel_noa 100","*if (rel_minjae > 100)","    *set rel_minjae 100","","*comment --- Personality Stats ---","*if (per_bold > 100)","    *set per_bold 100","*if (per_gentle > 100)","    *set per_gentle 100","*if (rebellion > 100)","    *set rebellion 100","","*return"]}}</script></head>
<body>
<div id="advertisement">
</div>
<div id="header">
  <div id="identity"><a href="#" id="email">you@example.com</a><a href="#" id="logout">Sign Out</a></div>

  <h1 class="gameTitle"><!-- My First ChoiceScript Game --></h1>
<h2 id="author" class="gameTitle"><!--by INSERTINSERTINSERT --></h2>

  <p id="headerLinks">
      <!-- <a href="credits.html" id="aboutLink" class="spacedLink">About</a> -->
    </p>
  <p id="buttons"><button id="statsButton" class="spacedLink" onclick="showStats()">Show Stats</button> <button id="restartButton" class="spacedLink" onclick="restartGame('prompt')">Restart</button> <button id="achievementsButton" onclick="showAchievements()" class="spacedLink" style="display: none">Achievements</button> <button id="bugButton" onclick="reportBug()" class="spacedLink" style="display: none">Report Bug</button></p>
</div>
<div id="main">
<div id="text">
</div>
<script>
startLoading();
</script>
</div>
<div id="mobileLinks" class="webOnly">
</div>
<noscript>
<p>This game requires JavaScript; please enable JavaScript and refresh this page.</p>
</noscript>
<a href="https://www.choiceofgames.com/make-your-own-games/choicescript-intro/">Make your own games with ChoiceScript</a>
<script src="idoll-save.js"></script>
</body>
</html>
